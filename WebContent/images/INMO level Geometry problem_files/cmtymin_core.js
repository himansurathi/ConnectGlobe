AoPS.hasOwnProperty("Community")||(AoPS.Community={}),AoPS.Community.Constants={base_url:"http://"+location.hostname,community_main_color:"#356cb5",community_secondary_color:"#dae7f6",privates_main_color:"#356cb5",privates_secondary_color:"#dae7f6",time_limits:{watched_times_short:3600,watched_times_long:21600},max_times_to_watch:{watched_times_short:1e3,watched_times_long:1500},very_large_time:6e9,intervals:{current:{new_item_check_interval:60103,topic_update_interval:18652,topic_update_interval_long:218741,reported_posts_interval:20341,watchers_updates_check_interval:95401,fetch_forum_users_interval:81137,put_community_to_sleep_limit:12e5},active:{new_item_check_interval:60103,topic_update_interval:18652,topic_update_interval_long:218741,reported_posts_interval:20341,watchers_updates_check_interval:95401,fetch_forum_users_interval:81137,put_community_to_sleep_limit:12e5},slow:{new_item_check_interval:180103,topic_update_interval:50652,topic_update_interval_long:218741,reported_posts_interval:120341,watchers_updates_check_interval:295401,fetch_forum_users_interval:281137,put_community_to_sleep_limit:9e5},disabled:{new_item_check_interval:6e9,topic_update_interval:6e9,topic_update_interval_long:6e9,reported_posts_interval:6e9,watchers_updates_check_interval:6e9,fetch_forum_users_interval:6e9}},idle_monitor_interval:24e4,moment_offset:0,base_delay_internet_issue:10,time_limit_for_calendar_style:172800,time_limit_edit_own:1209600,time_limit_delete_own:1209600,watched_times_short_interval:59800,watched_times_long_interval:1200137,new_item_check_interval:60103,new_item_check_interval_short:60103,new_item_check_interval_long:240103,topic_update_interval:38741,topic_update_interval_long:218741,reported_posts_interval:20341,watchers_updates_check_interval:195091,fetch_forum_users_interval:81137,phone_mode_max_width:768,min_preview_height:320,min_draggable_reply_height:290,min_posts_window_height:50,min_stupid_view_reply_textarea:50,max_conversation_participants:10,max_forums_user_update:50,min_topic_list_initial_length:6,max_num_shown_topics:78,num_topics_to_hide:20,num_topics_to_reveal:10,master_category_id:2,portal_category_id:89,private_messages_id:1,aops_forums_id:11,other_forums_id:9,olympiad_forum_id:6,college_math_forum_id:7,recycle_bin_id:22,blog_recycle_bin_id:104,aops_videos_id:64,aops_wiki_id:65,aops_blogroll_id:88,halp_user_id:10,unsearchable_fora:[50,63],essential_tags_olympiad:["algebra","geometry","combinatorics","number theory","inequalities","imo"],essential_tags_college:["calculus","real analysis","linear algebra","superior algebra","complex analysis","advanced fields","probability and stats","number theory","topology","putnam","college contests"],private_archive_url:"/my-messages-archive/",reply_jump_to_bottom_window:100,move_topic_quick_links:{3:[4,5,6,7],4:[3,5,6,7],5:[3,4,6,7],6:[3,4,5,7],7:[3,4,5,6]},min_topic_title_length:8,max_topic_title_length:60,max_tags_per_topic:7,min_poll_question_length:8,max_poll_question_length:255,min_post_length:8,max_post_length:4e4,max_source_length:128,posting_ajax_timeout:6e4,posting_warn_limit:20,time_hack_nudge:2e4,new_topic_modal_delay:1200,new_reply_modal_delay:1200,message_readability_delay:1200,message_readability_delay_short:1200,num_posts_to_fetch:20,topic_move_length_limit:250,user_path:"/community/user/",max_shout_length:255,itembox_input_width:150,max_categories_to_load:10,category_autocomplete_width:275,tag_autocomplete_width:250,num_users_whois_online:120,profile_field_length_limit:120,min_password_length:4,max_password_length:128,max_avatar_file_size:24,max_attachment_size:512,max_attachments_per_post:3,default_avatar:"//avatar.artofproblemsolving.com/no-avatar.png",attachment_path:"//cdn.artofproblemsolving.com/attachments/",max_length_feed_list_read_check:100,view_post_max_label_len:12,view_post_max_hide_label_len:255,can_oneclick_ban:[1163,29411,225249,236600,267794],max_category_name_length:50,min_category_name_length:3,max_category_description_length:240,max_blog_comments_text_length:40,cat_admin_save_input_delay:1e3,categories_with_private_roles:["forum","forum_class","blog"],monitor_tags:[{item_id:6,item_text:"/not_monitored"},{item_id:5,item_text:"/closed"},{item_id:4,item_text:"/open"}],monitoring_tag_id_array:[4,5,6],monitored_topic_tag_ids:{open:4,closed:5,not_monitored:6},bbCode:{smileys:[[":D","icon_mrgreen.gif"],[":blush:","redface_anim.gif"],[":maybe:","unsure.gif"],[":-D","biggrin.gif"],[":)","smile.gif"],[":(","sad.gif"],[":o","ohmy.gif"],[":mad:","mad.gif"],[":P","tongue.gif"],[":oops:","blush.gif"],[":roll:","rolleyes.gif"],[";)","wink.gif"],[":!:","exclaim.gif"],[":idea:","idea.gif"],[":arrow:","icon2.gif"],[":|","mellow.gif"],[":rotfl:","rotfl.gif"],[":huh:","huh.gif"],[":ninja:","ph34r.gif"],[":no:","sleep.gif"],[":love:","wub.gif"],[":wacko:","wacko.gif"],[":what?:","blink.gif"],[":alien:","alien_grn.gif"],[":cool:","cool.gif"],[":first:","first.gif"],[":dry:","dry.gif"],[":laugh:","laugh.gif"],[":coolspeak:","coolspeak.gif"],[":oops_sign:","oops.gif"],[":whistling:","whistling.gif"],[":yinyang:","yinyang.gif"],[":w00t:","w00t.gif"],[":pilot:","plane.gif"],[":play_ball:","play_ball.gif"],[":police:","police.gif"],[":read:","read.gif"],[":showoff:","showoff.gif"],[":sleep2:","sleep2.gif"],[":sleeping:","sleeping.gif"],[":spam:","spam.gif"],[":spidy:","spidy.gif"],[":starwars:","starwars.gif"],[":stink:","stink.gif"],[":stretcher:","stretcher.gif"],[":cleaning:","suck_kr.gif"],[":surf:","surfing.gif"],[":surrender:","surrender.gif"],[":thumbup:","thumbup.gif"],[":trampoline:","trampoline.gif"],[":w00tb:","w00tbrows.gif"],[":wallbash:","wallbash.gif"],[":wallbash_red:","wallbash_red.gif"],[":weightlift:","weightlift.gif"],[":welcome:","welcome.gif"],[":welcomeani:","welcomeani.gif"],[":winner_first:","winner_first_h4h.gif"],[":winner_second:","winner_second_h4h.gif"],[":winner_third:","winner_third_h4h.gif"],[":wow:","wow.gif"],[":huuh:","wtf.gif"],[":yankchain:","yankchain.gif"],[":yup:","yes3.gif"],[":10:","10.gif"],[":heli:","heli.gif"],[":agent:","agent.gif"],[":bomb:","bomb.gif"],[":bruce:","bruce_h4h.gif"],[":bye:","byebye.gif"],[":censored:","censored.gif"],[":chief:","chieftain.gif"],[":clap:","clap.gif"],[":clap2:","clap2.gif"],[":coool:","cool1.gif"],[":ddr:","ddr.gif"],[":diablo:","diablo.gif"],[":evilgrin:","evilgrin.gif"],[":ewpu:","ewpu.gif"],[":flex:","flex.gif"],[":fool:","fool.gif"],[":football:","football.gif"],[":furious:","furious.gif"],[":gathering:","gathering.gif"],[":gleam:","gleam.gif"],[":harhar:","harhar.gif"],[":help:","helpsmilie.gif"],[":icecream:","icecream.gif"],[":juggle:","juggle[1].gif"],[":jump:","jump.gif"],[":moose:","mf_moose.gif"],[":nhl:","nhl.gif"],[":noo:","no.gif"],[":omighty:","notworthy.gif"],[":yoda:","yoda.gif"]],font_colors:["#f00","#ff9a00","#ff0","#0f0","#0ff","#00f","#9a00ff","#f0f","#600","#783F04","#7f6000","#274E13","#0C343D","#073763","#20124D","#4C1130","#960000","#B45F06","#BF9000","#38761D","#134F5C","#0B5394","#351C75","#741B47","#c00","#E69138","#F1C232","#6AA84F","#45818E","#3D85C6","#674EA7","#A64D79","#E06666","#F6B26B","#FFD966","#93C47D","#76A5AF","#6FA8DC","#8E7CC3","#C27BA0","#EA9999","#F9CB9C","#FFE599","#B6D7A8","#A2C4C9","#9FC5E8","#B4A7D6","#D5A6BD","#F4CCCC","#FCE5CD","#FFF2CC","#D9EAD3","#D0E0E3","#CFE2F3","#D9D2E9","#EAD1DC","#000","#222","#444","#666","#888","#aaa","#ccc","#eee"]},other_forums_id:9,special_collections_id:12,BIG:1e8},AoPS.Community.Lang={"Add-Note":"Add Note",Admin:"Admin",Administrators:"Administrators",At:"At","Back-to":"Back to",Banned:"Banned",blog:"blog",Bookmarks:"Bookmarks",Build:"Build",by:"by",By:"By",cancel:"cancel",Cancel:"Cancel",collection:"collection","command-click":"command-click",Community:"Community",Contributors:"Contributors","control-click":"control-click",Conversations:"Conversations",create:"create",Create:"Create",Custom:"Custom","data-saved":"Data saved!","data-saved-reload":"Data saved!  You will see your changes when you reload the community",Delete:"Delete",Email:"Email","Enter-username":"Enter username",FAQ:"Help",Flyout:"Flyout",forum:"forum",Forum:"Forum",Full:"Full","in":"in",Info:"Info",information:"information",IP:"IP","logged-out":"You have been logged out.  Please log back in and try again.","Login/Join":"Login / Join",Message:"Message",Messages:"Messages",Mod:"Mod",Modal:"Modal",Moderators:"Moderators",MyAoPS:"My AoPS",no:"No",No:"No",NO:"NO",None:"None",Note:"Note",Notes:"Notes","permanent-link":"Permanent Link",Popup:"Pop-up",Private:"Private","Private-Messages":"Private Messages","Private-Message-Search":"Private Message Search",Profile:"Profile",Public:"Public",Readers:"Readers",Reason:"Reason",Reset:"Reset",Save:"Save",saved:"saved","saving-blocker":"Saving data...  Back soon.",SEARCH:"SEARCH","search-no-match":"Nothing matches your input.",Search:"Search","Search-Results":"Search Results",Short:"Short",Submit:"Submit",Subscribe:"Subscribe",Tag:"Tag",Tall:"Tall","unexpected-error-code":"There has been an unexpected error.  Please tell the webmaster exactly		 what you were doing to trigger this, and give the webmaster this magic code: ","unexpected-logout":"You have been logged out					by nefarious computer gremlins.  If you are in the middle					of entering text, you should copy your work before logging back in.",Users:"Users",Unsubscribe:"Unsubscribe",Username:"Username",views:"views",viewing:"viewing",view:"view",Welcome:"Welcome",yes:"Yes",Yes:"Yes",YES:"YES","month-01":"January","month-02":"February","month-03":"March","month-04":"April","month-05":"May","month-06":"June","month-07":"July","month-08":"August","month-09":"September","month-10":"October","month-11":"November","month-12":"December","admin-validation":'<div>Enter magic admin phrase<br><input name="admin-validate" type="password"></input></div>',"admin-validate-failed":"Validation failed","ajax-error-delay":"Error talking to the server.  Check your internet connection.  We'll try again in {0} seconds.","ajax-error-E_AJAX_UNKNOWN":"An error has occurred that is preventing your computer from connecting to the 		AoPS site.  Please check your internet connection and then refresh the page.  If you are working on something, please save your work 		before refreshing.","user-item-online":'<span class="cmty-user-online">Online</span>',"invalid-user":"The username <b>{0}</b> is not a valid username.","tag-tooltip-forum":"In forum: ","error-timeout":"The server has timed out while working on your request. Please		refresh the page to see if it finished what it was supposed to do before so		ignominiously giving up.","err-dropzone-fallback":"Sorry, attaching documents in our community is not supported by your browser.  Please choose another browser.","err-unknown":"Unknown error occurred.  Here's the code they gave me: <b>{0}</b>.","err-no-permission":"Sorry, you do not have permission to perform this action.","editable-length-limit-exceeded-on-paste":"You pasted too much!  I'm cutting some out.","user-list-validation-blocker":"Validating username...","err-bookmark-limit-reached":"Bookmark limit reached.  This item was not bookmarked.","err-community-disabled":AoPS.bootstrap_data.hasOwnProperty("community_inactive_message")?AoPS.bootstrap_data.community_inactive_message:"Sorry, but the community is currently disabled.  Please try again later.","category-deleted":"The page you are viewing has just been deleted.  Sorry about that. 		I'm going to take you back to the front of the community.","please-wait":"Hold on a sec while I take care of this.","private-search-results":"Private Message Search Results","unwatch-success":"Unwatch successful.  You will no longer receive email notifications regarding this {0}. It will miss you.  This {0} is 		still bookmarked, but you won't receive emails notifications any more.","cmty-itembox-loader":"Loading more...","my-profile-home":"My AoPS","initial-fetch-err-E_SEARCH_SERVER_INACTIVE":"Sorry, the search server is down right now.  We're working on it.","initial-fetch-err-E_BAD_SEARCH_QUERY":'Sorry, you sent the search server something that it cannot parse.  Please try something different. 		<a href="/community/search" data-cmty>Click here</a> to go to the Advanced Search page. ',"initial-fetch-err-E_DONT_KNOW_CHARACTERS":'Sorry, your search term only includes special characters that our search engine ignores. 		<a href="/community/search" data-cmty>Click here</a> to go to the Advanced Search page.',"initial-fetch-blog-err-E_SEARCH_SERVER_INACTIVE":"Sorry, the search server is down right now.  We're working on it.","initial-fetch-blog-err-E_BAD_SEARCH_QUERY":'Sorry, you sent the search server something that it cannot parse.  Please try something different. 		<a href="/community/c{0}">Click here</a> to go back to the blog. ',"initial-fetch-blog-err-E_DONT_KNOW_CHARACTERS":'Sorry, your search term only includes special characters that our search engine ignores. 		<a href="/community/c{0}">Click here</a> to go back to the blog.',"initial-fetch-blog-err-E_AJAX_TIMEOUT":"Sorry, your request for blog posts is taking too long.  Please try again in a bit.","topic-fetch-err-E_SEARCH_SERVER_INACTIVE":"Sorry, the search server is down right now.  We're working on it.","initial-fetch-err-E_AJAX_TIMEOUT":"Sorry, your request for community topics is taking too long.  Please try again in a bit.","topic-fetch-err-E_AJAX_TIMEOUT":"Sorry, your request for more topics is taking too long.  Please try again in a bit.","community-asleep":"The AoPS Community has gone to sleep due to inactivity.  		If you are in the middle of working on something, 		then we recommend that you close this message and save your work on your own computer before 		refreshing the page to reactivate the Community.","community-asleep-reminder":"The AoPS Community has gone to sleep due to prior inactivity.  Please 		refresh the page to reactivate the community.","community-asleep-save":"The AoPS Community has gone to sleep due to inactivity.  		If you are in the middle of working on something, 		then we recommend that you close this message and save your work on your own computer before 		refreshing the page to reactivate the Community.","view-pdf-tooltip":"View as PDF","router-err-topic-deleted":"You have requested a topic that has been deleted. I am not into dumpster-diving, so I can't get the topic for you.","router-err-no-topic":"You have requested a topic that does not exist.  Perhaps it never existed.  Perhaps it was deleted.  Perhaps I'm just tired and don't feel like looking for it.  These AoPS people work me like a dog.","router-err-no-perms-logged-in":"You have requested a top secret page for which you have not received security clearance.  Sorry about that.  Perhaps if you do 10 push-ups, I will let you in.","router-err-no-perms-logged-out":'You have requested a top secret page for which you have not received security clearance.  Or maybe you have clearance, but you are not logged in. <a class="cmty-login">Click here to log in</a>.',"router-err-no-such-category":"I looked and looked, and looked some more.  I'm afraid that the page you requested does not exist.","router-err-no-such-user":"I looked and looked, and looked some more.  I'm afraid that the user you requested does not exist.","router-err-no-perms":"You do not have permission to view this page."+(AoPS.session.logged_in?"":' This may be because you are not logged in! <a class="cmty-login">Click here to log in</a>.'),"router-err-no-post":"You have requested a post that does not exist.  Maybe it was deleted.  Maybe it never existed in the first place.  At any rate, I cannot find it.  Sorry about that.","router-err-not-logged-in":'You are not logged in to AoPS.  You cannot access this page unless you are logged in. <a class="cmty-login">Click here to log in</a>.',"router-err-cat-admin-no-create-type":"You cannot create a category of type ","router-err-not-participant":"You are not a participant of this private conversation.","router-err-unwatch-E_NO_HASH_FOUND":"Sorry, this link has expired.  That makes me sad, too.","router-edit-profile-crumb":"Edit Profile and Account","router-edit-settings-crumb":"Edit Community Settings","breadcrumbs-reported-posts":"Reported Posts","breadcrumbs-tag-info":"Tags","breadcrumbs-terms":"Terms->Tags Map","breadcrumbs-tagmap":"Tags->Terms Map","breadcrumbs-log":"Log: Be careful, yo","master-other-forums":"Other Forums and Collections ","master-whois-title":"Who is online?","master-whois-FAQ-link":"Help","master-statistics-title":"Statistics:","master-statistics-data":"Total posts: <b>{0}</b> | Total topics: <b>{1}</b> | Total members: <b>{2}</b>","master-whois-dataline":"There are <b>{0}</b> users online, including the <b>{1}</b> registered members listed below and {2} other hidden registered users.","master-registered-online":"Registered users online: ","master-collections-modal-title":"What Are Collections and Other Forums?","master-whois-memberlist-link":"View Memberlist","master-featured-content":"Featured Content ","portal-featured-help-title":"Feature Olympiad Content","portal-extra-content":"Other Forums and Collections ","portal-extra-help-title":"Other Forums and Collections","portal-extra-note":"","portal-extra-logged-in":'  <a data-cmty href="/community/edit-settings">Click here</a> to visit your 		Community settings page, where you can set your default Community homepage view.',"folder-empty-bookmark_forums":"You have no forums bookmarked.  Bookmarked forums will appear on this page.","folder-empty-bookmark_users":"You have no users bookmarked.","folder-empty-folder":"Nothing here yet!","folder-empty-folder_forums":"Nothing here yet!","folder-empty-folder_collections":"Nothing here yet!","folder-empty-blogroll":"No blogs here yet!","folder-empty-my_forums":"No forums here...  Yet!","folder-empty-my_blogs":"No blogs here...  Yet!","folder-empty-my_collections":"No collections here...  Yet!","folder-empty-view_posts":"No posts here yet!","cat-cell-no-perm-start-topic":"You do not have permission to start a topic in this forum.","cat-cell-no-perm-limited-user":'You have a limited account, so you cannot post new topics or replies. 		You can upgrade your account for free <a href="/user/upgrade.php">here</a>.',"cat-cell-new-topic":"New Topic","cat-cell-new-message":"New Message","cat-cell-mark-read":"Mark All Read","cat-cell-topic":"topic","cat-cell-topics":"topics","cat-cell-post":"post","cat-cell-posts":"posts","cat-cell-user":"user","cat-cell-users":"users","cat-cell-num-user-title":"Number of users viewing a topic in this\n forum in the last five minutes.","cat-cell-no-tag-match":"No tags match your search","cat-cell-filter-placeholder":"Filter by tag","cat-cell-mark-read-title":"Mark all topics in this forum read","cat-cell-bookmark-title":"Bookmark this ","cat-cell-new-topic-title":"Post a new topic to this forum","cat-cell-new-pm-title":"Write a new private message","cat-cell-more-options-title":"More options","cat-cell-create-collection":"Create Collection","cat-cell-help-title":"Learn more about this page","cat-cell-no-tags-yet":" No tags here yet!","cat-cell-no-posts-yet":" No posts here yet!","cat-cell-no-items-yet":" Nothing here yet!","cat-cell-search-forum":"Search this forum","cat-cell-search-pm":"Search private messages","cat-cell-forum-locked-title":"This forum is locked.","cat-cell-forum-locked-title-mod":"This forum is locked, but you can post here because you are special.","cat-cell-Locked":"Locked","cat-cell-locked-modal":"This forum is currently locked, so you cannot post new topics here right now.","cat-cell-tag-view-topics":"Topics with these tags","cat-cell-forum-view-topics":"Topics in these forums","cat-cell-forum-topics":"Topics in this forum","cat-cell-tags-title":"Tags in this forum","cat-cell-items-title-tag-view":"Tags in this collection","cat-cell-items-title-tag-bookmark":"Tags that I have bookmarked","cat-cell-items-title-forum-view":"Forums in this collection","cat-cell-items-title-forum-bookmark":"Forums that I have bookmarked","cat-cell-no-users-bookmarked":"You have no users bookmarked yet!","cat-cell-view_tags-help-title":"About Tag Collections","cat-cell-view_topics-help-title":"About Topic Collections","main-crumb-search-placeholder":"Search Community","main-crumb-advanced-search":"Advanced search","cat-search-placeholder-9":"Search Forums","cat-search-placeholder-12":"Search Collections","tagbox-not-logged-in":"You must be logged in to edit a topic's tags.","tagbox-no-permission":"You do not have permission to edit tags of topics in this forum.","tagbox-new-user":"Once you have been a member of the AoPS Community for at least two weeks, you will be able 		to edit the tags of existing topics.","bookmark-not-logged-in":"When you are logged in to AoPS, you will be able to bookmark topics, tags, forums, and users.","bookmark-remove":"Remove","bookmark-follow":"Bookmark","bookmark-limited-user":'You have a limited account, so you cannot bookmark items on the site. 		You can upgrade your account for free <a href="/user/upgrade.php">here</a>, and then you 		will be able to bookmark items.',"bookmark-modal-topic":', you are bookmarking the topic "<b>{0}</b>" in the forum <b>{1}</b>. ',"bookmark-modal-tag":', you are bookmarking the tag "<b>{0}</b>" in the forum <b>{1}</b>. ',"bookmark-modal-forum":", you are bookmarking the forum <b>{0}</b>. ","bookmark-remove-user-title":"Remove this user from Bookmarked Users","bookmark-user-title":"Add this user to Bookmarked Users","bookmark-modal-title":"Bookmark ","bookmark-modal-title-tag":"Bookmark Tag","bookmark-modal-title-topic":"Bookmark Topic","bookmark-modal-title-forum":"Bookmark Forum","bookmark-modal-info-text":"All of your bookmarks are available on your My AoPS page.		You may also choose to add bookmarked items to your feed and/or receive email notifications.","bookmark-modal-feed":"Add this to my feed.","bookmark-modal-email":"Email me when this gets a new ","bookmark-modal-email-tag":"Email me when a new topic gets this tag.","bookmark-modal-email-topic":"Email me when this topic gets a new post.","bookmark-modal-email-forum":"Email me when there is a new post or topic in this forum.","bookmark-modal-cancel":"CANCEL","bookmark-modal-ok":"ADD BOOKMARK","bookmark-no-forums-bookmarked":"You have no forums bookmarked!","bookmark-no-tags-bookmarked":"You have no tags bookmarked!","bookmark-no-topics-bookmarked":"You have no topics bookmarked!","bookmark-tag-tooltip":"Bookmark this tag (subscribe)","remove-bookmarked-tag-tooltip":"Remove tag from bookmarks (unsubscribe)","mod-topic-title":"Moderate Topic","mod-topic-move":"Move Topic","mod-topic-unlock":"Unlock Topic","mod-topic-lock":"Lock Topic","mod-topic-delete":"Delete Topic","mod-topic-hard-delete":"Hard Delete Topic","mod-topic-announce":"Make Announcement","mod-topic-global":"Make Global Announcement","mod-topic-normal":"Make Normal Topic","mod-topic-add-target":"Add Target Url","mod-topic-replace-target":"Replace Target Url","mod-topic-remove-target":"Remove Target Url","mod-topic-add-hidden":"Add Hidden Tag","mod-topic-hidden-tags":"Hidden Tags","mod-topic-log":"View Log","mod-topic-soft-delete-warning":"Are you really sure you want to delete this topic?","mod-topic-hard-delete-warning":"Are you really sure you want to hard delete this topic?		This will completely wipe out all posts.  It is irreversible.","mod-topic-soft-delete-title":"Delete Topic","mod-topic-hard-delete-title":"Hard Delete Topic","mod-topic-delete-pending":"Hold on a sec while I take out the trash.","mod-topic-delete-err-E_NO_PERMISSION":"You do not have permission to delete this topic.","mod-topic-delete-err-E_NOT_LOGGED_IN":"Ack!  You are no longer logged in.  You'll have to log in again to delete this topic.","mod-topic-delete-err-E_TOPIC_TOO_LONG":"You must be a site admin to move or delete long topics. 		If you wish to move or delete this topic, use the Report Topic functionality to report the 		topic to site admins.","mod-long-topic-admin-warning":"You should not move or delete long topics during class time or 		when the site is very busy. Are you sure you want to move or delete this?","mod-long-topic-admin-OK":"YES I AM SURE","mod-long-topic-admin-no":"No - do nothing","mod-topic-set-announce-through":"Last date of announcement (leave blank for none):","mod-topic-move-title":"Move Topic","mod-topic-move-input-heading":"Move To: ","mod-topic-move-quick":"Quick move: ","mod-topic-move-in-progress":"Moving crew at work, hold on a minute.","mod-topic-move-err-E_NO_PERMISSION":"You do not have permission to move this topic.","mod-topic-move-err-E_NOT_LOGGED_IN":"Ack!  You are no longer logged in.  You'll have to log in again to move this topic.","mod-topic-move-err-E_NO_MOVE_TO_LOCKED":"Your target forum is locked. The topic has not been moved.","mod-topic-move-err-E_ALREADY_MOVED":"Someone just beat you to it!  They already moved this topic.  I won't ruin the suspense and tell you where they moved it.  Hit refresh to find out!","mod-topic-move-err-E_MAX_ANNOUNCEMENTS":"Sorry, your target forum already has the maximum number of announcements.","mod-topic-move-err-E_TOPIC_TOO_LONG":"You must be a site admin to move or delete long topics. 		If you wish to move or delete this topic, use the Report Topic functionality to report the 		topic to site admins.","mod-topic-announce-err-E_NO_PERMISSION":"You do not have permission to change the announce status of this topic.","mod-topic-announce-err-E_MAX_ANNOUNCEMENTS":"Sorry, this forum already has the maximum number of announcements.","mod-topic-announce-err-E_NOT_LOGGED_IN":"Ack!  You are no longer logged in.  You'll have to log in again to change the announcement status of this topic.","mod-topic-remove-target-confirm":"Are you sure you wish to remove the link between this topic 		 and an object on the site? ","mod-topic-remove-target-extra":"This operation will also remove all hidden tags, so you will have to 		 re-add any hidden tags you wish to keep.","mod-topic-remove-target-with-text":"Are you sure you wish to remove the link between this topic and {0}? ","mod-topic-remove-target-blocker":"Hold on while I take care of this target for you.  Back in a sec.","mod-topic-edit-target-instructions":'Edit the target URL by entering the new target below.  When a topic 		already has a target, I\'ll give you that URL as a hint.  Please make sure you know what you 		are doing before using this.  Richard will make you do 10 push-ups if you screw up here. Note: 		a restricted tag is one that has permissions attached.  Think "discussions attached to solutions 		to homework problems." <b>Entering a blank URL here will not delete the current target.</b> 		This operation will also remove all hidden tags, so you will have to 		 re-add any hidden tags you wish to keep.',"mod-topic-edit-target-url":"New Target:","mod-topic-edit-target-text":"New Target Descriptor:","mod-topic-edit-target-is-restricted":"Check if target is restricted:","mod-topic-hidden-tag-instructions":"Enter text below.  Make sure you know what you're doing 		before using this.  Or maybe shortly after using this.","mod-topic-hidden-tag-text":"Tag text: ","mod-topic-hidden-tag-is-restricted":"Check if tag is restricted: ","mod-topic-hidden-tag-blocker":"Adding tag; back in a sec...","mod-topic-no-state-tags":"You cannot add state tags here.","mod-topic-announce-blocker":"Setting announcement status of this topic.","topics-list-no-more-items":"No more topics!","topics-list-no-items-at-all":"No topics here!","topics-list-no-more-privates":"No more private messages.","topics-list-no-privates":"No private messages here!","topics-list-nothing-bookmarked":"Nothing bookmarked!","topic-cell-moved-topic":"THIS TOPIC HAS MOVED; CLICK HERE TO GO TO ITS NEW LOCATION.","topic-cell-recycled-topic":"THIS TOPIC HAS BEED DELETED; CLICK HERE TO VIEW IN RECYCLE BIN.","topic-cell-reading-now":"Reading now: ","topic-cell-reply":"reply","topic-cell-replies":"replies","topic-cell-no-replies":"0 replies","topic-cell-title-close":"Close topic","topic-cell-title-settle":"Settle reports","topic-cell-title-jump-end":"Jump to end of topic","topic-cell-title-unread":"Jump to first unread","topic-cell-source":"Source","topic-cell-Posted-at":'Posted by <a data-cmty title="{2}" href="/community/user/{1}"><b>{0}</b></a> on',"topic-cell-1-reader":"{0} user reading this topic.","topic-cell-not-1-reader":"{0} users reading this topic.","topic-cell-reading-now":"Reading now: ","topic-cell-visit-in-forum":"Visit this topic in its forum","topic-cell-view-user-profile":"View user profile","topic-full-bookmark-tooltip":"Bookmark this (subscribe)","topic-full-remove-bookmark-tooltip":"Remove from bookmarks (unsubscribe)","topic-full-locked-tooltip":"Topic locked","topic-full-locked-forum-tooltip":"Topic's forum is locked","topic-full-reply-tooltip":"Reply to this topic","topic-full-expand-tooltip":"Expand/collapse topic","topic-full-close-tooltip":"Close topic","topic-full-moderate-tooltip":"Moderate topic","topic-full-reply":"Reply","topic-full-locked":"Locked","topic-full-post-reply":"Quick Reply","topic-full-message-deleted":"The topic you are viewing has just been deleted.","topic-full-deleted-extra":" Since you are in the middle of writing a new post, I will give you 		a chance to copy your work from the textarea below. After you close this dialog box, the page will 		reload and you will have to restart your new post.<br><br>","topic-full-deleted-loss-permission":"You do not have permission to view this topic anymore.","topic-full-deleted-not-logged-in":"You do not have permission to view this topic anymore.  This may be because you are no longer logged in.","topic-full-just-locked":"Sorry!  This topic has just been locked!","topic-full-undelete-title":"Undelete Post","topic-full-new-reply-blocker":"Sending reply... Back soon.","topic-full-reply-confirm":"Are you sure you want to quit your reply?","topic-full-reply-confirm-OK":"Yes","topic-full-reply-confirm-cancel":"No","topic-full-edit-confirm":"Are you sure you want to quit editing?","topic-full-edit-confirm-OK":"Yes","topic-full-delete-post-pending":"Hold on a sec while I take out this trash...","topic-full-undelete-message":"Are you sure you want to undelete this message?","topic-full-already-reported":"This post has already been reported.  A community administrator will address the report soon.","topic-full-already-reported-title":"Post already reported.","topic-full-report-post-title":"Report post","topic-full-report-report-sent":"Your report has been filed; a moderator will take a look at it soon.","topic-full-report-item-spam":"Spam: Advertising or some other nonsense.","topic-full-report-item-warez":"Warez: Shares copyrighted content without permission.","topic-full-report-item-cheat":"Possible cheating: posted problem comes from an active contest.","topic-full-report-item-other":"Other: Please include reason below.","topic-full-settle-report-title":"Settle report","topic-full-unregistered-reply":"You must be logged in to make a reply to this topic.","topic-full-reply-to-locked":"Sorry, this topic has just been locked, so you cannot reply.","topic-full-reply-to-forum-locked":"Sorry, this topic's forum has just been locked, so you cannot reply.","topic-full-locked-tooltip-mod":"Topic locked, but you can reply\nby clicking here because you are special.","topic-full-locked-forum-tooltip-mod":"Topic's forum is locked, but you can reply\nby clicking here because you are special.","topic-full-not-logged-in-reply":"You must be logged in to reply to topics.","topic-full-title-tooltip":"Click to view topic in its own forum,\n","topic-full-post-with-target-url":'This topic is linked to <a {2} href="/feed/{1}{0}">{3}</a>.',"topic-full-target-text-default":"an item on AoPS","topic-full-remove-target":"Click here to unlink this topic.","topic-full-source":"Source","topic-full-state-tooltip":"Click to Toggle\nCurrent topic state: ","topic-full-undelete-hard":"Yikes; someone already hard deleted that post.","topic-full-click-for-tags":"Reveal topic tags",
"topic-full-no-post-found":"Well, that's embarrassing.  I can't find the post you were looking for. 		I suspect someone just deleted it, but you can still check out the rest of the topic.","topic-edit-locked":"Sorry, this topic has just been locked, so you cannot edit this post.","topic-edit-forum-locked":"Sorry, this topic's forum has just been locked, so you cannot edit this post.","snipe-option-never":"Never","snipe-option-close":"Close","snipe-option-flyout":"Flyout","snipe-option-not-this-time":"Not This Time","snipe-title":"You've Been Sniped!","snipe-warning-body":"Another user has just replied to this topic.  Their							comment has been loaded in your browser; you might want to check it out							before submitting your reply. <br /><br />							&bull; Click <b>Never</b> to stop the warnings on all topics"+(AoPS.session.logged_in?". You can turn warnings back on in your profile. ":" during this visit. ")+"<br>							&bull; Click <b>Flyout</b> to change these warnings from pop-ups to flyouts.<br>							&bull; Click <b>Not This Time</b> to block warnings only for this topic, and only during this site visit.<br>							&bull; Click <b>Close</b> to close this window but keep the warnings coming.<br /><br />							<b>Scroll to the bottom of the topic to see the new posts.</b>","snipe-warning-flyout":"Another user has just replied to this topic.","topic-full-edited-1":"This post has been edited ","topic-full-edited-2":" time","topic-full-edited-3":" times","topic-full-edited-4":". Last edited by ","topic-full-target-tooltip":"This topic is about an item on the AoPS site.\nClick here to visit that item.","topic-list-jump-top":"Jump to First Topic","post-direct-link":'The <a href="{0}">direct link to this post</a> is:',"post-direct-click-ip":"Admin: Click For IP","post-direct-loading-ip":"Loading IP","post-number-title":"Get Post URL","post-attachments":"Attachments:","post-unread-tootip":"This post unread prior to this visit.","post-thanked-by":'<span class="aops-font">Y</span> by',"post-thank-this":"Give thumbs up","post-unthank-this":"Remove thumbs up","post-nothank-this":"Give thumbs down","post-unnothank-this":"Remove thumbs down","post-user-tooltip-admin":" is a site admin.\nClick to view user profile.","post-user-tooltip-forum-admin":" is an admin of this forum.\nClick to view user profile.","post-user-tooltip-mod":" is a moderator of this forum.\nClick to view user profile.","post-user-tooltip-regular":"\nClick to view user profile.","edit-post-reason-heading":"Edit Post Reason","edit-post-reason-info":"Enter your reason for editing the post here.  This reason will		be displayed with the post.","edit-post-no-post":"Sorry, I can't find this post.  Maybe someone just deleted it!","edit-post-no-permission":"You don't have permission to edit this post.","edit-post-nothing-changed":"I looked very closely, but nothing has changed!","edit-send-blocker":"Sending edits... Back shortly.","edit-post-logged-out-warning":"You have been logged out.  To edit this post, 						you should log back in. Here is the edited text you submitted, so						you can copy/paste it: ","delete-post-no-permission":"You do not have permission to delete this post.","delete-post-not-last-post":"You can only delete your own post if it is the last post in the topic. 		Someone has posted after you, so you cannot delete this post.","delete-post-sniped":"You cannot delete the first post of a topic once someone has responded. 		If you don't see a reply to this post, refresh the browser.  The reply probably just came in.","new-topic-subject":"Subject","new-topic-tags":"Tags","new-topic-to":"To","new-topic-preview":"PREVIEW","new-topic-close-preview":"CLOSE PREVIEW","new-topic-post-anon":"Post anonymously (instructors will still know who posted)","new-topic-refresh-preview":"REFRESH","new-topic-not-logged-in":"You must be logged in to AoPS in order to start a new topic.","new-topic-are-sure":"Are you sure you want to quit your new topic?","new-topic-confirm-cancel":"No!","new-topic-confirm-OK":"Yes! Close the window.","new-topic-title-too-short":"Your title is too short; it must be at least "+AoPS.Community.Constants.min_topic_title_length+" characters.","new-topic-post-too-short":"Your post is too short; it must be at least "+AoPS.Community.Constants.min_post_length+" characters.","new-topic-post-too-long-python":"Your post is too long.  Unfortunately, rendering Python 		nicely requires adding a bunch of markup to your post; that extra markup is causing your 		post to be too long.  Try a shorter program.","new-topic-post-too-long":"Your post is too long; please trim it down a bit.","new-topic-remove-link-confirm":"If you remove this tag, then this topic will not 		be linked to a particular item and will not appear in the page feed on any page. 		 The topic will still be posted in the forum <b>{0}</b>.  Is it still OK to delete the tag?","new-topic-send-blocker":"Sending new topic...  Back shortly.","new-pm-send-blocker":"Sending private message.  Back soon.","new-blog-post-send-blocker":"Sending new blog post.  Back soon.","new-topic-post-as-sheriff":"PM as AoPS Sheriff","new-topic-banned-term":"You have used a banned term.  Please edit and resubmit.","new-topic-invalid-character":"You have used a weird character that I don't understand.		For example, the AoPS people didn't teach me about those wacky Emoji symbols because 		some browsers can't handle them.","new-topic-no-tags-message":"You have not added any tags to your new topic.		Tags help people find your post.  Are you sure you want to post a new topic without tags?","new-topic-no-tags-confirm-yes":"Post without tags","new-topic-no-tags-confirm-no":"Add tags","new-topic-category-deleted":"Sorry, this forum has just been deleted!","new-topic-no-permission":"You do not have permission to post new topics in this forum.","new-pm-no-permission":"You do not have permission to send new private messages.","new-pm-no-permission-limited":'You have a limited account, so you cannot send private messages. 		You can upgrade your account for free <a href="/user/upgrade.php">here</a>.',"new-topic-timeout":"Sorry, the call to the server timed out.  There's a good chance your post		was saved before I gave up, though.  So, here's what I recommend.  Close this warning, then		copy your post.  Then refresh the window and navigate to where you expect to see your post. 		If the post is not there, then try posting again.","new-topic-err-E_NEW_USER_NEW_TOPIC_LIMITED":"New users may only post 5 new topics every 24 hours. 		This restriction will be lifted after you have been a member of the AoPS Community for 2 weeks.","new-topic-err-E_MAX_ANNOUNCEMENTS":"This forum already has the maximum number of 		allowed announcements. Either post this as a normal topic or remove one of the current 		announcements before posting.","new-topic-no-category":"Uh-oh.  Those AoPS programmers goofed again.  Let the		webmasters know that they forgot to preload a category on this page.  Give them		the URL of the page you are on, and tell them which button you clicked to get this message.","new-topic-source-placeholder":"Optional.  If posting a problem from a book or contest, enter the source of the problem here","new-topic-pm-archived":"Message sent and archived","new-topic-forum-locked":"This forum has been locked.  I'm leaving the new topic window open 		for you to give you a chance to copy your post.","new-topic-preview-bar-attachments":"VIEW ATTACHMENTS","new-topic-college-tag-warning-title":"College Forum Tag Warning","new-topic-olympiad-tag-warning-title":"Olympiad Forum Tag Warning","new-topic-olympiad-tags-warning":"Many people use the tags below to navigate the High School Olympiads forum. 		We strongly recommend that you add at least one of these tags to your topic.  Click on a tag to add it to your topic.","new-topic-college-tags-warning":"Many  people use the tags below to navigate the College Math forum. 		We strongly recommend that you add at least one of these tags to your topic.  Click on a tag to add it to your topic.","new-topic-blacklist-trigger":"Sorry, you can't post right now. If you continue having this 		problem, please send a copy of this note to the site administrator.","new-topic-blacklist-text-trigger":"Sorry, you can't post right now. Perhaps there is something wrong with your 		post. If you continue having this 		problem with other posts, please send a copy of this note to the site administrator.","new-reply-logged-out-warning":"You have been logged out.  To post a 							reply, you should log back in. Here is the text you submitted, so							you can copy/paste it: ","new-reply-no-permission":"You do not have permission to reply to this topic.","new-reply-no-permission-limited":'You have a limited account, so you cannot post new topics or replies. 		You can upgrade your account for free <a href="/user/upgrade.php">here</a>.',"new-reply-locked":"Sorry, the topic was locked right before you submitted your reply!","new-reply-timeout":"Sorry, the call to the server timed out.  There's a good chance your post		was saved before I gave up, though.  So, here's what I recommend.  Close this warning, then		copy your post.  Then refresh the window.  If your post was saved, you should see it when you		go to the end of the topic.","new-reply-err-E_NEW_USER_LIMITED":"Sorry, but new users may only post 10 times every 24 hours. 		This restriction will be lifted after you have been a member of the AoPS Community for 2 weeks.","new-reply-forum-locked":"This forum has just been locked, so you cannot reply to this topic.","posting-quote-depth":"You cannot nest more than three quotes.","posting-hide-depth":"You cannot nest more than three hides.","posting-latex-error":"You have a LaTeX error in your message.  I have rendered it in red.","posting-asy-error":"You have an Asymptote error in your message.  I have rendered it in red.","posting-no-flooding-error":"You cannot post so soon after your last post.  Take a break.  Do some push-ups.  Solve an interesting math problem.","error-latex-posting-confirm":"You have an error in your {0} code.  I have rendered it in red. 		You can <b>POST WITH ERROR</b> 		and hope someone will tell you how to fix it, of you can <b>TRY TO FIX</b> the error yourself.","error-latex-i-will-fix":"TRY TO FIX","error-latex-post-anyway":"POST WITH ERROR","polymath-new-topic-confirm":"You are trying to post a new topic in the forum for the MIT PRIMES/AoPS CrowdMath Project.","polymath-force-choice":"You must confirm you are a student and indicate that you have read the rules in order to proceed.","polymath-reply-confirm":"You are trying to reply to a topic in the forum for the MIT PRIMES/AoPS CrowdMath Project.","polymath-confirm-blocker":"Registering you for the Polymath Project.  Please wait a moment.","polymath-confirm-unknown-error":"Sorry, there has been an error of some sort.  If this issue persists, please contact webmaster@aops.com, and tell them you received the following code: {0}.","private-adding-user-blocker":"Adding user to this private message.","private-no-username":"You have not entered a username.","private-from-post":"This message is regarding [url={0}]this post[/url].","private-add-user-confirm-OK":"Add","private-add-participant":"Add a user to this conversation","private-need-recipients-err":"You must specify some recipients.  You want to be heard, don't you?","private-already-added-active":"The user <b>{0}</b> is already included on this private message.","private-already-added-self-removed":"The user <b>{0}</b> is already included on this private 		message, but has chosen not to follow the message anymore. You cannot re-add 		<b>{0}</b> to this discussion.","private-no-add-self":'You are automatically included in any			private message you start.   Leave the "To" line blank to talk just to yourself.',"private-validation-blocker":"Validating recipient...","private-category-name":"My Private Messages","private-archived-category-name":"My Archived Private Messages","private-archive-title":"View archived messages","private-View-Archive-btn":"View Archived Messages","private-Archive-btn":"Archive","private-Unarchive-btn":"Unarchive","private-user-removed":"This user left the conversation and will not receive replies.","private-remove-me":"Remove me from this conversation.  Forever.  Please.","private-remove-from-archived":"Are you sure you wish to be removed from this conversation?  <b>You will		not be able to access this message in the future, and will receive no replies to the message.</b>","private-remove-from-active":'Are you sure you wish to be removed from this conversation?  <b>You will		not be able to access this message in the future, and will receive no replies to the message.</b>		You may instead choose to archive this message by first clicking "Cancel", then clicking		"Archive" on the message.  This will remove the message from your inbox and place it in your Archive.',"private-remove-me-ok":"Remove Me","private-remove-blocker":"Removing you from the conversation.","private-archive-topic":"Archive this conversation","private-unarchive-topic":"Unarchive this conversation","private-message-archived":"Message archived.","private-message-unarchived":"Message unarchived, moved to inbox.","private-reply-no-listeners":"Everyone else has left this conversation; no one will see your comment unless you add		new participants.","private-user-excluded":'The user <b>{0}</b> is not accepting new private messages, 		so cannot be added to this discussion.  The user has been removed from your "To" list. 		You must hit <b>Submit</b> again to send.',"private-user-excluded-by-system":'The user <b>{0}</b> cannot receive private messages, 		so cannot be added to this discussion.  The user has been removed from your "To" list. 		You must hit <b>Submit</b> again to send.',"private-new-msg-too-many-participants":"You have listed too many recipients.  A private message can have		at most "+AoPS.Community.Constants.max_conversation_participants+" participants, including yourself.","private-cant-add-more":"You have reached the maximum number of message participants. 		A private message can have at most "+AoPS.Community.Constants.max_conversation_participants+" participants, including yourself.","pm-notify":"You have received a new private message, <b>{1}</b>, from <b>{0}</b>.","pm-notify-flyout":'You have received a new private message, <b>{1}</b>, from <b>{0}</b>. 		<a data-cmty href="/community/c1h{2}">Click here to view</a>',"pm-notify-title":"New Private Message","pm-notify-btn-OK":"VIEW MESSAGE","pm-notify-btn-cancel":"CLOSE","post-attachments-default":"Drag your files here, or <a>click here</a> to select files from your computer.  Max three files per post.","post-attachments-title":"Attach Files","post-attachments-spoofed":"I don't trust a file you've attached, so you cannot upload it.","post-attachments-bad-file-type":"Sorry, but the file {0} has a file type that I don't like.","post-attachments-no-permission":"You do not have permission to post attachments on this site.","post-attachments-already-attached":"Existing Attachments","post-attachments-file-too-big":"This file is too large.  The maximum file size is "+AoPS.Community.Constants.max_attachment_size+"KB.","post-attachments-done":"DONE","post-attachments-invalid-character":"Sorry, your file name has an invalid character. 		The only characters that are allowed are letters, numbers, spaces, dashes, underscores, and periods.","page-title-my-aops":"My AoPS","page-title-reported-posts":"Reported Posts","page-title-search":"Search","user-profile-title":"User Profile","user-profile-browser-title":" User Profile","user-profile-activity":"Activity","user-profile-joined_at":"Joined","user-profile-email":"Email","user-profile-location":"Location","user-profile-status":"Status","user-profile-occupation":"Occupation","user-profile-school":"School","user-profile-goals":"Goals","user-profile-interests":"Interests","user-profile-signature":"Signature","user-profile-friends":"Friends","user-profile-last-visit":"Last Visited","user-profile-total-posts":"Total Posts","user-profile-blog":"Blog","user-profile-website":"Website","user-profile-INACTIVE":"INACTIVE","user-profile-BANNED":"BANNED","user-profile-LIMITED":"LIMITED","user-profile-add-note":"Adding note; page will reload when finished.","user-profile-COPPA":"COPPA","user-profile-thanks-given":'<span class="aops-font">Y</span> Given',"user-profile-thanks-received":'<span class="aops-font">Y</span> Received',"user-profile-no-such-user":"No such user!  You asked for user <b>{0}</b>.","user-profile-friend-toggle-off":"Your friends are on your public profile. \nClick to hide them from your public profile.","user-profile-friend-toggle-on":"Your friends are not on your public profile. \nClick to show them on your public profile.","user-profile-add-friend":"Add Friend","user-profile-friend-request":"Has sent you a friend request.","user-profile-friend-ACCEPT":"ACCEPT","user-profile-friend-DECLINE":"DECLINE","user-profile-no-friends":"No AoPS friends yet.","user-profile-unfriend-confirm":"Are you sure you wish to cancel your friendship with <b>{0}</b>?","user-profile-add-friend-instructions":"Make a friend request by entering the username of your potential new		friend below, and then click OK.<br><br><b>Warning</b>: All your friends can see your Alcumus profile, including your Alcumus statistics.","user-profile-new-friend":"New friend","user-profile-add-friend-modal-title":"Make Friend Request","user-profile-add-friend-title":"Add Friend","user-profile-no-friend-self":"No friending yourself!  Choose someone else...","user-profile-add-friend-none-chosen":"Either choose a username or click CANCEL, please.","user-profile-request-sent":"Friend request sent to <b>{0}</b>.","user-profile-friend-request-pending":"Sending your friend request.","user-profile-err-no-perm-friend":"You do not have permission to make friend requests.","user-profile-err-already-friend":"You are already friends with <b>{0}</b>.","user-profile-err-they-asked-you":"The user <b>{0}</b> has already asked you to be friends, so I went ahead and made the		two of you friends.  You should see <b>{0}</b> among your friends if you refresh the page.","user-profile-err-already-asked":"You have already asked <b>{0}</b> to be your friend.","user-profile-err-not-taking-requests":"The user <b>{0}</b> has left the friends system and is therefore not receiving friend requests.","user-profile-send-request-check":"Send friend request to user <b>{0}</b>?<br><br><b>Warning</b>: Your friends can access your Alcumus profile, including your Alcumus statistics.","user-profile-err-no-request-available":"Uh-oh, I couldn't find the friend request from <b>{0}</b>.  That probably means that 		<b>{0}</b> just opted out of the friends system.","user-profile-friend-request-accepted":"Friend request from <b>{0}</b> accepted.","user-profile-friend-request-denied":"Friend request from <b>{0}</b> declined.","user-profile-no-my-forums":'<b>My Forums</b> consists of forums you have created, forums you moderate or administrate, or private forums you can access. 			You currently have no such forums.  Once you have some, you can manage the <b>My Forums</b> page by clicking 			<span class="aops-font cmty-text">3</span> again.',"user-profile-no-my-collections":'<b>My Collections</b> consists of collections you have created, collections you moderate or administrate, or private collections you can access. 			You currently have no such collections.  Once you have some, you can manage the <b>My Collections</b> page by clicking 			<span class="aops-font cmty-text">3</span> again.',"user-profile-no-my-blogs":'<b>My Blogs</b> consists of blogs you created or contribute to, or private blogs you can access. 			You currently have no such blogs.  Once you have some, you can manage the <b>My Blogs</b> page by clicking 			<span class="aops-font cmty-text">3</span> again.',"user-profile-click-for-posts":"Click to view posts","user-profile-no-count-note":"*Not included in total","user-profile-no-search-note":"**Forum not searchable","user-profile-add-friend-title":"Make a friend request to this user","user-profile-pm-title":"Send a private message to this user","user-cell-visit-profile":"Visit user profile","user-bookmark-err-E_ITEM_NUM_LIMITED":"Sorry, you have reached the limit of the number of users that can be bookmarked.","user-bookmark-err-E_NOT_LOGGED_IN":"Sorry, you have been logged out.  Please log back in and try again.","friends-warning":'<div class="cmty-friends-heading">Friend Requests</div>		<b>Warning</b>: All your friends can view your Alcumus profile, including your Alcumus statistics.',"edit-profile-title":"Edit Profile And Account","edit-profile-profile-info":"Profile Information","edit-profile-edit-avatar":"Edit Avatar","edit-profile-delete-avatar":"Delete Avatar","edit-profile-delete-avatar-confirm":"Are you sure you want to delete {0} avatar?","edit-profile-your":"your","edit-profile-this-user":"this user's","edit-profile-limited-user":'You currently have a limited account, so you cannot edit your profile. 		You can only edit your password on this page.  You will be able to edit your profile if 		you upgrade your account.  You can upgrade your account for free <a href="/user/upgrade.php">here</a>.',"edit-profile-deleting-avatar":"Deleting avatar, back in a sec...","edit-profile-change-password":"Change Password","edit-profile-location-placeholder":"Enter your location.","edit-profile-school-placeholder":"Enter your school.","edit-profile-interests-placeholder":"Enter your interests.","edit-profile-website-placeholder":"Enter your website.","edit-profile-occupation-placeholder":"Enter your occupation.","edit-profile-email-placeholder":"You cannot leave this field blank!","edit-profile-goals-placeholder":"Enter your goals.","edit-profile-status-placeholder":"Enter your status.","edit-profile-inappropriate-term":"Inappropriate language used when setting <b>{0}</b>. 		This field has been reset to its original value.","edit-profile-unknown-error":"Unknown error occurred when setting <b>{0}</b>. 		The error code is <b>{1}</b>.","edit-profile-email-not-available":"The email address <b>{0}</b> is already attached to another		username.  Each email address can be associated with only one user.","edit-profile-current-password":"Current Password","edit-profile-new-password":"New Password","edit-profile-retype-password":"Confirm Password","edit-profile-invalid-common-password":"Sorry, you have selected a new password that is too common.  Please select a different one.  Your password has not been reset yet.","edit-profile-retype-password-placeholder":"Enter your new password again.","edit-profile-new-password-placeholder":"Enter your desired new password.","edit-profile-current-password-placeholder":"Enter your current password.","edit-profile-passwords-dont-match":"Confirm password does not match new password.","edit-profile-enter-password":"You must enter your current password.","edit-profile-submit-new-password":"Validating new password...","edit-profile-invalid-password":"The current password you entered is not correct.  Please try again.","edit-profile-password-changed":"Password changed!","edit-profile-password-too-short":"New password is too short.  It must be at least "+AoPS.Community.Constants.min_password_length+" characters.","edit-profile-email-not-valid":"New email is not a valid email address.  No change made.","edit-profile-email-not-changed":"New email is the same as the old one.  No change needed.","edit-profile-new-email":"A confirmation email has been sent to your requested new address, <b>{0}</b>. 		Until you confirm this new address, the email address associated with this account will remain <b>{1}</b>.","edit-profile-email-change-title":"Change Email","edit-profile-email-change=blocker":"Submitting new email address...","edit-profile-no-perm":"You do not have permission to edit your profile.","edit-profile-not-logged-in":"You are not logged in.  You have to log in to edit your profile.","new-user-my-forums":"  New users may create new forums after being members of the AoPS Community for at least two weeks.","new-user-my-blogs":" New users may create new blogs after being members of the AoPS Community for at least two weeks.","new-user-my-collections":" New users may create new collections after being members of the AoPS Community for at least two weeks.","edit-avatar-file-too-big":"This file is too large.  The maximum file size is "+AoPS.Community.Constants.max_avatar_file_size+"KB.","edit-avatar-default-message":"Drag your new avatar here, or <a>click here</a> to select a file on your computer.","edit-avatar-dimensions-too-big":"This image's dimensions are too big.  The width and height must both be 		no more than 100px.","edit-avatar-bad-file-type":"Sorry, we only take JPG and PNG image files.","edit-avatar-too-many":"Whoa!  You should only send one file!!","edit-avatar-no-file":"Um, I think you forgot something.  I didn't receive a file.","edit-avatar-no-permission":"You do not have permission to change this avatar.","edit-avatar-title":"Upload Avatar","search-page-title":"Advanced Community Search","search-page-private-title":"Private Message Search","search-results-title-with-text":"for {0}","search-results-edit":"Edit search settings","search-err-no-such-user":"Sorry, I don't know any user with the username <b>{0}</b>.","search-err-no-such-forum":"Sorry, we don't have a forum with the name <b>{0}</b>.","search-validation-blocker":"Validating search parameters...","user-search-posts-category-username":"Posts by {0}","user-search-posts-category-user-id":"Posts by the User with Id {0}","edit-settings-page-title":"Edit Community Settings","edit-settings-general-heading":"General Settings","edit-settings-friends-heading":"Friends","edit-settings-posting-heading":"Posting and Reading","edit-settings-feed-heading":"Feed","edit-settings-pm-heading":"Private Messages","edit-settings-hidden-label":"Hide my online status","edit-settings-hide_feed-label":"Hide the feed","edit-settings-show_tags_on_feed-label":"Show tags in the feed","edit-settings-global_feed_type-label":"Global Feed type","edit-settings-enable_advanced_hotkeys-label":'Enable <a href class="cmty-advanced-hotkeys">Advanced Hotkeys</a>',"edit-settings-friends_show_profile-label":"Show my friends on my public profile","edit-settings-friends_exclude-label":"Exclude me from the friends system (and delete all my existing friendships)","edit-settings-posting_subscribe_new_topic-label":"Email me upon replies to any topic I start","edit-settings-posting_subscribe_reply-label":"Email me upon replies to any topic I reply to","edit-settings-posting_fullscreen_reply-label":"Always use full reply (except in feed)","edit-settings-hide_avatars-label":"Hide user avatars on posts and topics","edit-settings-hide_tags_on_topic-label":"Hide the tags on topics","edit-settings-pm_email-label":"Email me whenever anyone sends me a private message","edit-settings-pm_archive_on_send-label":"Archive new private messages I send (not replies; only new topics)","edit-settings-pm_live_notify-label":"Notification method when I receive a private message when I am logged in to AoPS","edit-settings-pm_exclude_self-label":"Prevent users from sending me new private messages (Admins will still be able to send you messages, and users		can reply to existing messages)","edit-settings-warn_on_snipes-label":"Warning type when a new reply comes in for a topic while I'm typing a reply to topic.","edit-settings-forum_view-label":"Topic cell view style when browsing topics (page will reload on change)","edit-settings-turn_off_autotagging-label":"Turn off autotagging for new topics I post","edit-settings-archive-pm-btn":"Archive All","edit-settings-remove-from-pm-btn":"Remove All","edit-settings-archive-pm-label":"Archive all private messages","edit-settings-remove-from-pm-label":"Remove self from all existing private messages 		 (you will not be able to access the messages again)","edit-settings-privates-archived":"All private messages archived","edit-settings-archive-confirm":"Are you sure you want to archive all of your private messages? 		You will still be able to access them in your private messages archive.","edit-settings-remove-confirm":"Are you sure you want to remove yourself from all of your private 		messages?  This is irreversible; you will not be able to access the messages in the future, 		though the other participants in each message will still be able to access them. You will 		be removed from the messages in both your inbox and your private message archive.","edit-settings-privates-removed":"You have been removed from all of your private messages.","edit-settings-hotkeys-modal-title":"Advanced Hotkeys","edit-settings-no-friends-confirm":"Are you sure you want to remove yourself from the friends system? 		All of your existing friendships will be deleted. They will be reinstated if you return to the friends system.","edit-settings-no-friends-confirm-title":"Leave Friends System?","edit-settings-main-base-view":"Main","edit-settings-portal-base-view":"Portal","edit-settings-base_view-label":'Home page for community (<a data-cmty href="/community/main">Main</a> 		is the primary view of the community, and <a data-cmty href="/community/portal">Portal</a> is the Olympiad &amp; College Portal.)',"edit-settings-please-wait-bkmk":"Hold on a sec...  The page will reload when I'm finished 		cleaning your bookmarks.","edit-settings-bkmk-all-confirm":"Are you sure you want to delete all {0} from your bookmarks?  This 		will remove all {0} from your feed and unsubscribe you from all {0}.","edit-settings-bkmk-feed-confirm":"Are you sure you want to delete all bookmarked {0} from your feed? 		These {0} will still be in your bookmarks, and your email subscriptions will not be changed.","edit-settings-bkmk-email-confirm":"Are you sure you want to unsubscribe from all email notifications 		about your currently bookmarked {0}? These {0} 		will still be in your bookmarks, and your bookmark feed will be unchanged.","edit-settings-bkmk-heading":"Bookmarked {0}","edit-settings-bkmk-link-all":"Delete All","edit-settings-bkmk-link-feed":"Empty Feed","edit-settings-bkmk-link-email":"Unsubscribe","edit-settings-bkmk-all-label":"Delete all {0} from your bookmarks.","edit-settings-bkmk-feed-label":"Remove all {0} from your feed.","edit-settings-bkmk-email-label":"Unsubscribe from all {0}. (End email notification.)","add-participant-instructions-start":"Enter a username below to add someone to this message.			The new participant will be able to read the entire			thread, including posts that occurred before the new participant was			added to the discussion.  Also, each private			message can have no more than","add-participant-instructions-end":"participants.","add-participant":"Add participant","add-participant-add-user":"Add user:","add-participant-placeholder":"Enter username","add-participant-logged-out":"You have been logged out.  You will have to log		back in and try again.","add-participant-no-permission":"You do not have permission to add a participant		to this discussion.","add-participant-too-late":"You waited too long!  It is now past the time limit		to add a user to this discussion.","add-participant-no-more":"Someone beat you to it!  This private message now has		the maximum allowed number of participants.","add-participant-no-self":"You cannot add yourself to a private message!","add-participant-recipient-exclude-self":"The user <b>{0}</b> is not accepting new private messages, 		so cannot be added to this discussion.","add-participant-recipient-exclude-system":"The user <b>{0}</b> cannot receive private messages, 		so cannot be added to this discussion.","poll-question":"Poll Question","poll-options":"Poll Options","poll-options-desc":"Place each option on a new line.  Enter up to 20 options.","poll-options-per":"Options Per User","poll-length":"Poll Length",
"poll-unlimited":"Unlimited","poll-len-1-day":"1 day","poll-len-2-days":"2 days","poll-len-3-days":"3 days","poll-len-1-week":"1 week","poll-len-2-weeks":"2 weeks","poll-len-1-month":"1 month","poll-revoting":"Allow Revoting?","poll-cancel":"CANCEL POLL","poll-cancel-title":"Cancel Poll?","poll-cancel-confirm":"Are you sure that you want to cancel this poll?		Canceling the poll only removes the poll options.  It does not		cancel the whole topic window.","poll-cancel-no":"DON'T CANCEL","poll-no-question-error":"You must include a Poll Question when posting a poll.","poll-no-inputs-error":"You must include some options for the voters to choose from in your poll.","poll-question-too-short":"Your poll question is not long enough.  It must be at least "+AoPS.Community.Constants.min_poll_question_length+" characters.","poll-question-too-long":"Your poll question is too long.  It must no more than "+AoPS.Community.Constants.max_poll_question_length+" characters.","poll-display-heading":"Poll:","poll-Vote":" Vote","poll-Votes":" Votes","poll-select-one":"Select <b>{0}</b> option.","poll-select-many":"Select up to <b>{0}</b> options.","poll-revote-btn":"CHANGE VOTE","poll-vote-btn":"VOTE","poll-hide-results":"Hide Results","poll-loading":"Loading poll details...","poll-show-results":"Show Results","poll-not-logged-in":"You must be logged in to vote.","poll-nothing-selected":"Work with me here.  You have to choose something to vote!","poll-revote-directions":"You have already voted, but are allowed to change your vote.  To change your		vote, make a new selection and click CHANGE VOTE above.","poll-vote-processing":"Recording your vote and tabulating new results.  Back in a sec!","poll-err-not-logged-in":"You are not logged in.  You must be logged in to vote.","poll-err-closed":"Sorry, but the poll closed while you were voting!","new-item-too-short":"Your entry is too short; it must be at least 2 characters.","new-item-already-added":"You have already added ","new-item-too-many-1":"You can only have ","new-item-too-many-2":"s. You'll have to delete some to add new ones.","post-environ-extra-announce":"Make announcement","post-environ-global-announce":"Make global announcement","post-environ-announce-through":"Announce through:","post-environ-invalid-announce-date":"Invalid announcement end date.  The date must be in yyyy-mm-dd format.","post-environ-announce-date-too-early":"The last date of the announcement cannot be in the past!  Please try again.","post-environ-announce-date-too-late":"The last date of the announcement cannot be more than 2 years in the future.  (Leave date field blank for permanent announcements.)","post-environ-image-error":"Sorry, there is something wrong with one of your img tags.  You 		may have entered in an invalid URL, or you might be using the tag incorrectly.  Please 		read your post closely and try again.","bbcode-title-bold":"Bold text\n[b]text[/b]","bbcode-title-underline":"Underline text\n[u]text[/u]","bbcode-title-italic":"Italic text\n[i]text[/i]","bbcode-title-text-size":"Text size\n[size=NUMBER FROM 50 TO 200]text[/size]","bbcode-title-text-color":"Text color\n[color=#HEX COLOR CODE]text[/color]","bbcode-title-quote":"Quote text\n[quote]quoted text[/quote] -or-\n[quote=<person quoted>]quoted text[/quote]","bbcode-title-list":"List\n[list]Your list here, each item on its own line[/list]","bbcode-title-hide":"Hide text\n[hide]hidden text[/hide] -or-\n[hide=<text for the link>]hidden text[/hide]","bbcode-title-code":"Code formatting\n[code]code[/code] -or-\n[code=<language>]code[/code]","bbcode-title-smiley":"Smileys!","bbcode-title-img":"Image\n[img]image url[/img]","bbcode-title-url":"Link\n[url]<your URL>[/url] -or-\n[url=<your URL>]text for link[/url]","bbcode-title-attachment":"Add an attachment","bbcode-title-has-attachments":"Attachments:","bbcode-title-poll":"Start a poll","view-posts-click-hidden":"Click to reveal hidden content","post-report-admin-reported-by":"Reported by","post-report-admin-reported-date":"When","post-report-admin-details":"Details","post-report-admin-for":"For","post-report-admin-confirm":"Are you sure you want to resolve this post report?		If so, you can add notes about the report resolution below.","post-report-admin-confirm-title":"Resolve Post Report","post-report-admin-block":"Hold on a sec; sending your resolved post report to the database.","post-report-admin-page-title":"Reported Posts","post-report-admin-loading":"Hold on a sec, I'm going to see if there are any more reports		for you.","post-report-no-more":"No more reported posts.","post-report-admin-none":"No reported posts found.","post-report-admin-notes":"Notes","post-report-admin-no-permission":"You do not have permission to resolve this post report.","post-report-admin-page-text":"On this page are the reported posts in the forums		you moderate and the blogs you administrate.  If you reached this page by clicking a report notification on a post or topic,		but you see no report here, then someone else has beaten you to it!  When you return to the		topic, the notification for that post should no longer appear.","post-report-first-post-note":"<b>Note:</b> This post is the first post in its topic, so		you cannot simply delete this post. 		Please visit the topic by clicking the topic title, to determine whether or not you		should delete the whole topic.","post-report-admin-pm":"PM","post-report-admin-pm-poster":"Poster","post-report-admin-pm-reporter":"Reporter","poll-too-many-selected":"You have chosen too many options.  You can only choose up to <b>{0}</b> options.","tag-edit-title":"Edit tags","autocomplete-new-tag":"No tags match.<br>Press Enter to create tag.","my-aops-Community-Settings":"Edit Community Settings","my-aops-Edit-Profile":"Edit Profile and Account","my-aops-MyForums":"My Forums","my-aops-MyCollections":"My Collections","my-aops-MyBlogs":"My Blogs","my-aops-MyBooks":"My Books","my-aops-MyClasses":"My Classes","my-aops-phone-PM":"PM","my-aops-phone-Bkmk":"Bkmk","my-aops-phone-Fora":"Fora","my-aops-phone-Coll":"Coll.","my-aops-phone-Blogs":"Blogs","cat-admin-general-info":"General Information","cat-admin-description-heading":"Description","cat-admin-in-global-feed":"In Global Feed","cat-admin-global-feed-help":'(See the Feeds section of <a data-cmty href="/community/faq">Community Help</a> for more information.)',"cat-admin-create-button":"CREATE","cat-admin-soft-delete":"Soft Delete","cat-admin-delete":"Delete","cat-admin-hard-delete":"Hard Delete","cat-admin-reported-posts":"Reported Posts","cat-admin-global-automatic":"(Class forums are always included in the Global Feed.)","cat-admin-global-err-E_ALL_GLOBAL_FORA_REMOVED":"You have removed all forums from 		your global feed, so you will have your global feed reset to the default set of forums.","cat-admin-global-err-E_NOT_VALID_FORUM":"Sorry, this category is not a forum 		and cannot be added to the global feed.","cat-admin-global-err-E_CLASS_FORA_ALWAYS_IN_GLOBAL":"All class forums are automatically 		added to the global feed.","cat-admin-global-err-E_NOT_LOGGED_IN":"You are no longer logged in.  No change made.","cat-admin-global-err-E_GLOBAL_SET_TO_FULL":"Your global feed is currently set to 		the full feed, so you cannot customize it.  Edit your Community Settings in the 		My AoPS page to switch to a custom global feed.","cat-admin-global-err-E_TOO_MANY_FEED_FORA":"Sorry, you have reached the limit 		of the number of forums you can have in your global feed.  The limit is currently 		75 forums.","cat-admin-view-log":"View Category Log","cat-admin-delete-blocker":"Deleting now; you will be redirected to the Community homepage when I am finished.","cat-admin-soft-delete-confirm":"Do you really want to delete <b>{0}</b>? This action 		is not reversible!","cat-admin-delete-protected":"This is protected; it cannot be deleted.","cat-admin-delete-not-found":"Someone beat you to it.  This has already been deleted.","cat-admin-delete-no-permission":"You do not have permission to delete this.","cat-admin-hard-delete-confirm":"Do you really want to <b>HARD</b> delete <b>{0}</b>? This action 		is impossible to revert, as it deletes entries from the database entirely.","cat-admin-cat-name-warning":'NOTE: Forum and collection names must be unique.  If you choose a name that 		site admins need later, such as "2023 IMO", then we\'ll ask you change the name at that time.',"cat-admin-create-public-forum-warning":"You have marked this forum <b>public</b>. Any registered		users will be able to read, post, and reply in this forum.  You cannot		change this forum to private once you have created it.  Are you sure you want to create this		forum as <b>public</b>?","cat-admin-create-private-forum-warning":"You have marked this forum <b>private</b>. Only users		who are granted permission to access this forum, and AoPS administrators, will be able to		access this forum.  You cannot		change this forum to public once you have created it.  Are you sure you want to create this		forum as <b>private</b>?","cat-admin-create-public-collection-warning":"You have marked this collection <b>public</b>. Any registered		users will be able to access this collection.  You cannot		change this collection to private once you have created it.  Are you sure you want to create this		collection as <b>public</b>?","cat-admin-create-private-collection-warning":"You have marked this collection <b>private</b>. Only users		who are granted permission to access this collection, and AoPS administrators, will be able to		access this collection.  You cannot		change this collection to public once you have created it.  Are you sure you want to create this		collection as <b>private</b>?","cat-admin-create-public-blog-warning":"You have marked this blog <b>public</b>. Any registered		users will be able to read, shout, and reply in this blog.  Are you sure you want to create this		blog as <b>public</b>?","cat-admin-create-private-blog-warning":"You have marked this blog <b>private</b>. Only users		who are granted permission to access this blog, and AoPS administrators, will be able to		access this blog.  Are you sure you want to create this		blog as <b>private</b>?","cat-admin-forum-name-too-short":"Your Forum Name is too short.  It must have at least 3 characters.","cat-admin-blog-name-too-short":"Your Blog Name is too short.  It must have at least 3 characters.","cat-admin-collection-name-too-short":"Your Collection Name is too short.  It must have at least 3 characters.","cat-admin-create-category-blocker":"Hold on a sec while I build this!","cat-admin-back-to-class":"CLASS","cat-admin-back-to-cmty":"COMMUNITY","cat-admin-label-include_in_count":"Include in Post Count","cat-admin-label-include_in_thank_count":'Include in <span class="aops-font">Y</span> Count',"cat-admin-label-include_in_nothank_count":'Include in <span class="aops-font">_</span> Count',"cat-admin-label-include_in_dynamic_collections":"Include in Dynamic Coll.","cat-admin-admin-item-warning":"Admin-only items; only edit these if you know what you are doing.","cat-admin-forum-name":"Forum Name","cat-admin-forum-name-placeholder":"Name your forum.","cat-admin-forum-desc-placeholder":"Enter a brief description of your forum.","cat-admin-blog-name":"Blog Name","cat-admin-blog-name-placeholder":"Name your blog.","cat-admin-blog-desc-placeholder":"Enter a brief description of your blog.","cat-admin-collection-name":"Collection Name","cat-admin-collection-name-placeholder":"Name your collection.","cat-admin-collection-desc-placeholder":"Enter a brief description of your collection.","cat-admin-permissions-title":"Permissions","cat-admin-permissions-header-forum":"You cannot change the Public/Private setting of a forum once the forum		has been created, so <b>make sure you set it correctly now</b>."+(AoPS.session.a?'   Any		administrators will have this forum added to their "My Forums" automatically.':""),"cat-admin-permissions-header-blog":AoPS.session.a?'  Any		administrators will have this blog added to their "My Blogs" automatically.':"","cat-admin-permissions-header-collection":"You cannot change the Public/Private setting of a collection once the collection		has been created, so <b>make sure you set it correctly now</b>. "+(AoPS.session.a?'  Any		administrators will have this collection added to their "My Collections" automatically.':""),"cat-admin-permissions-public-heading":"Public/Private","cat-admin-permissions-is-locked":"Status","cat-admin-permissions-open":"Open","cat-admin-permissions-locked":"Locked","cat-admin-permissions-has-source":"Has Source","cat-admin-permissions-inherit-head":"Inherit Roles From","cat-admin-permissions-remove-self":"Are you sure you want to remove yourself from the <b>{0}</b> of <b>{1}</b>?","cat-admin-permissions-close-userlist-early":"I hate leaving things half-finished.  You started entering		a username, but stopped before you finished.  Please either finish entering the username or delete		what you have entered.","cat-admin-perms-existing-user":"The user <b>{0}</b> is already among the <b>{1}</b>. ","cat-admin-set-role-inherit":"Setting role inheritance and assigning roles from parent...","cat-admin-set-inherit-no-perm":"You do not have permission to set role inheritance.","cat-admin-set-inherit-invalid-parent":"Sorry, you have chosen an invalid parent from which to inherit roles.","cat-admin-no-inherit-from-self":"Nice try.  You can't set this to inherit from itself.","cat-admin-inheritance-info":"You can set this {0} to inherit roles from some forum or collection. Any user 		that is given a role on the parent will have the same role here, and any user that loses a role 		on the parent will lose that role here.","cat-admin-perms-existing-user-3":"Click OK to switch the user to the list of","cat-admin-perms-help-title":"Permissions Help","cat-admin-is-public-confirm-warning":"Only site admins can toggle public/private status.  This should be done <b>very</b> sparingly.","cat-admin-is-public-blocker":"Changing public/private status.  Back shortly...","cat-admin-set-blog-public-warning":"Are you sure you want to make this blog public? 		All users will be able to see all posts in your blog.","cat-admin-set-blog-private-warning":"Are you sure you want to make this blog private? 		Only owners and contributors will be able to see the blog, and the blog will 		be removed from all collections it is in.","cat-admin-no-add-admin-start":"The user <b>","cat-admin-no-add-admin-end":"</b> is an AoPS administrator.  The AoPS administrators have phenomenal powers, so they need not		be added to any of your user groups.","cat-admin-lock-blocker":"Calling the locksmith.  Hold on for a minute.","cat-admin-permissions-forum-public-helper":"Any user can read this forum.  Any registered user can post and edit tags.","cat-admin-permissions-forum-private-helper":"Only users who are given permission to access this forum can read, post, or edit tags.","cat-admin-permissions-forum-locked-helper":"No one can post in a locked forum.","cat-admin-permissions-forum-open-helper":"Forum is unlocked; anyone who can access can post.","cat-admin-permissions-forum-has-source-helper":"Topics have a source field.","cat-admin-permissions-forum-no-source-helper":"Topics do not have a source field.","cat-admin-permissions-blog-public-helper":"Any user can read this blog.  Any registered user can reply to posts and shout.","cat-admin-permissions-blog-private-helper":"Only users who are given permission to access this blog can read posts and reply to them.","cat-admin-permissions-blog-locked-helper":"No one can reply to posts or shout; only owners can post.","cat-admin-permissions-blog-open-helper":"Blog is unlocked; anyone can reply or shout.","cat-admin-permissions-collection-public-helper":"Any user can read this collection.","cat-admin-permissions-collection-private-helper":"Only you can access this collection.","cat-admin-permissions-collection-locked-helper":"Only collection administrators and moderators can edit the contents of this collection.","cat-admin-permissions-collection-open-helper":"Experienced users can edit the contents of this collection.","cat-admin-user-types-forum-owner":"Administrators","cat-admin-user-types-forum-mod":"Moderators","cat-admin-user-types-forum-registered_user":"Users","cat-admin-user-types-forum-deny":"Banned","cat-admin-user-types-collection-owner":"Administrators","cat-admin-user-types-collection-mod":"Moderators","cat-admin-user-types-collection-deny":"Banned","cat-admin-user-types-blog-owner":"Administrators","cat-admin-user-types-blog-contributor":"Contributors","cat-admin-user-types-blog-deny":"Banned","cat-admin-user-types-blog-reader":"Readers","cat-admin-error-E_NO_PERMISSION":"You no longer have permission to create a new ","cat-admin-error-E_PROTECTED":"This category is protected.  Even with your admin superpowers, you cannot delete it or change its public/private status.","cat-admin-error-E_NAME_NOT_AVAILABLE":"The name you have chosen is not available.","cat-admin-error-E_NO_SUCH_CATEGORY_TYPE":"No such category type : ","cat-admin-error-E_NAUGHTY_TERM_USED":"You have a disallowed term in your name or description.","cat-admin-error-E_NAME_TOO_SHORT":"The name is too short. It must be at least "+AoPS.Community.Constants.min_category_name_length+"characters.","cat-admin-error-E_NAME_TOO_LONG":"The name is too long.  It cannot be more than "+AoPS.Community.Constants.max_category_name_length+"characters.","cat-admin-error-E_DESCRIPTION_TOO_LONG":"The description is too short. It cannot be more than "+AoPS.Community.Constants.max_category_description_length+"characters.","cat-admin-gen-info-error-E_NO_PERMISSION":"You do not have permission to make these changes.","cat-admin-error-nothing-saved":"Nothing has been saved!","cat-admin-blog-settings-title":"Blog Settings","cat-admin-blog-label-show_profile_info":"Show Profile","cat-admin-blog-label-is_primary_blog":"Set As Blog In My Profile","cat-admin-blog-label-show_stats":"Show Stats","cat-admin-blog-label-show_shoutbox":"Show Shoutbox","cat-admin-blog-label-show_contributors":"Show Contributors","cat-admin-blog-label-show_tags":"Show Tags","cat-admin-blog-label-show_custom_block":"Show Custom Block","cat-admin-blog-label-blog_post_comment_text":"Post Comment Text","cat-admin-blog-label-blog_comments_text":"Comments Text","cat-admin-blog-label-blog_one_comment_text":"One Comment Text","cat-admin-blog-label-blog_no_comments_text":"No Comments Text","cat-admin-blog-settings-help-title":"Blog Settings Help","cat-admin-blog-css-title":"Blog Custom CSS","cat-admin-blog-css-new-info":"Once you have created a blog, you can edit its CSS here.","cat-admin-blog-css-existing-info":"Edit your blog's CSS in the textarea below.","cat-admin-blog-css-save-sure":"Are you sure you want to save this CSS? This will 		overwrite any old CSS you have.","cat-admin-blog-css-save-block":"Hold on a sec while I save this CSS for you...","cat-admin-blog-css-delete-sure":"Are you sure you want to delete this CSS? This blog will then 		have the default AoPS Blog CSS.","cat-admin-blog-css-delete-block":"Hold on a sec while I delete this blog's CSS for you...","cat-admin-blog-css-enter":"Enter CSS for this blog here.","cat-admin-blog-css-none":"This blog does not have any custom CSS.","cat-admin-blog-css-no-perm":"This blog's custom CSS is shown below.","cat-admin-blog-css-no-perm-err":"You do not have permission to edit this blog's CSS.","cat-admin-blog-css-help-title":"Blog CSS Help","cat-admin-blog-css-default-css":"/** This sets the background color of your blog posts.  Try changing the color and see what happens! **/\ndiv .entrywrap, div .entrywrap-hover {\nbackground-color : #dedede;\n}","cat-admin-private-collection-perms":"This is a private collection; only you may access it.","cat-admin-location-title":"Location","cat-admin-location-add-to":"Add to","cat-admin-location-contained-in":"Contained in","cat-admin-delete-container-1":"Do you really want to remove this from the collection ","cat-admin-location-help-title":"Location Help","cat-admin-add-to-location-placeholder":"Enter collection name","cat-admin-location-exists":"This {0} has already been added to <b>{1}</b>.","cat-admin-no-description":"<i>None</i>","cat-admin-contents-title":"Contents","cat-admin-contents-title-editing":'Contents: <span class="cmty-content-edit">Editing</span>',"cat-admin-contents-help-tooltip":"View Contents Help","cat-admin-add-content-folder-placeholder":"Enter forum, collection, or blogroll name","cat-admin-add-content-my_collections-placeholder":"Enter collection or blogroll name","cat-admin-add-content-my_forums-placeholder":"Enter forum name","cat-admin-add-content-folder_forums-placeholder":"Enter forum name","cat-admin-add-content-bookmark_forums-placeholder":"Enter forum name","cat-admin-add-content-folder_collections-placeholder":"Enter collection or blogroll name","cat-admin-add-content-blogroll-placeholder":"Enter blog name","cat-admin-add-content-my_blogs-placeholder":"Enter blog name","cat-admin-add-content-topic-placeholder":"Enter topic url","cat-admin-contents-building-info":"After creating this collection, you will be redirected to 		this page, and will be able to add items to your collection in this box.","cat-admin-contents-save-blocker":"Saving your changes; back shortly.","cat-admin-contents-save-error":"Sorry, something went wrong while I was trying to save. 		I tried to do as much as I could before hitting the error.  After you hit OK, the page will 		reload and you'll see what I finished before crashing.<br><br>","cat-admin-contents-unexpected-error":" The only additional detail I have is an error code: <b>{0}</b>.","cat-admin-contents-save-error-E_ITEM_NUM_LIMITED":"<b>Error details</b>: You have exceeded the number of items allowed in 		this collection.","cat-admin-contents-save-error-E_NO_SUCH_POST":"<b>Error details</b>: You have added 		a post that no longer exists; perhaps it was just deleted.","cat-admin-contents-save-error-E_NO_PERMISSION":"<b>Error details</b>: You have attempted to 		add a post that you do not have permission to view.","cat-admin-contents-save-error-E_ONLY_PUBLIC_POSTS_ALLOWED":"<b>Error details</b>:  You have tried to add a non-public post to this collection. 		However, this collection is public, 		so you can only add public posts to this collection. ","cat-admin-contents-save-error-E_NON_FORUM_POST":"<b>Error details</b>: Only forum posts are allowed in 		this collection.  No private messages or blog material is permitted.","cat-admin-contents-no-adding-to-self":"You cannot add this to itself!!!","cat-admin-contents-already-holds":"<b>{0}</b> is already in this collection.","cat-admin-view_posts-already-holds":"Post ID {0}","cat-admin-contents-help-title":"Contents Help","cat-admin-contents-tag-placeholder":"Enter tag","cat-admin-contents-add-tag-error":"Something went wrong when I tried to add tag <b>{0}</b> of Forum <b>{1}</b>. You may		want to refresh and try again.","cat-admin-contents-remove-tag-error":"Something went wrong when I tried to delete 		<b>{0}</b>.  You may want to refresh and try again.","cat-admin-add-content-tag-forum-placeholder":"Enter forum whose tags you'd like to add","cat-admin-contents-tag-placeholder":"Enter tag","cat-admin-contents-added-tag-already":"The tag <b>{0}</b> of forum <b>{1}</b> has already		been added to this collection.","cat-admin-contents-locked-error":"Sorry, this collection has just been locked, so		you can no longer edit its contents.","cat-admin-contents-add-category-error":"Something went wrong when I tried to add <b>{0}</b> to this collection. You may		want to refresh and try again. Error code: <b>{1}</b>.","cat-admin-no-empty-collections":"You cannot create an empty collection; please add something to this collection.","cat-admin-contents-limit-exceeded":"Sorry, this collection cannot hold more than <b>{0}</b> items.","cat-admin-one-more-step":"After you click OK, I'll build this collection for you, then 		bring you right back to this page so you can add items to it.","cat-admin-contents-subscribe":"Receive email notifications if checked","cat-admin-contents-feed":"Appears in Bookmark Feed if checked","cmty-admin-delete-item":"Remove this item.","cat-admin-site-admins-are-admins":"<i>AoPS site admins</i>","cat-admin-no-users-with-this-role":"<i>None</i>","cat-admin-contents-desc-heading":"Contents Description","cat-admin-contents-desc-folder":"This collection can hold other collections and forums.","cat-admin-contents-desc-view_topics":"This collection can hold only forum topics.","cat-admin-contents-desc-view_posts":"This collection can hold posts and custom text.","cat-admin-contents-desc-blogroll":"This collection can hold only blogs.","cat-admin-contents-desc-view_tags":"This collection can hold only tags.","cat-admin-contents-desc-my_forums":"This collection can hold any forum you own or moderate, as well as 		any private forum to which you have access.","cat-admin-contents-desc-my_collections":"This collection can hold any collection you own or moderate, as well as 		any private collection to which you have access.","cat-admin-contents-desc-bookmark_forums":"This collection holds all the forums you have 		bookmarked.","cat-admin-contents-desc-bookmark_users":"This collection holds all the users you have 		bookmarked.","cat-admin-contents-desc-bookmark_tags":"This collection holds all the tags you have 		bookmarked.","cat-admin-contents-desc-bookmark_topics":"This collection holds all the topics you have 		bookmarked.","cat-admin-category-colors":[{label:"Community",color:"#356cb5"},{label:"School",color:"#6db101"},{label:"Games",color:"#c20078"},{label:"Books",color:"#008345"},{label:"Resources",color:"#1f3d7b"}],"cat-admin-contents-desc-my_blogs":"This collection can hold any blog you own or contribute to, as well as 		any private blog to which you have access.","cat-admin-contents-desc-folder_forums":"This collection can hold only forums.","cat-admin-contents-desc-folder_collections":"This collection can hold only collections.","cat-admin-contents-sort-heading":"Sorting","cat-admin-contents-current-state":"Current State","cat-admin-contents-edit-btn":"EDIT CONTENTS","cmty-cat-admin-edit-contents-fetch":"Preparing edit window...","cat-admin-contents-current-tab":"Current Contents","cat-admin-contents-available-tab":"Available Contents","cmty-admin-add-topic-error":"You must enter a valid topic id or a URL to a topic 		that is in a forum.","cmty-admin-add-topic-err-not-forum":"You can only add forum topics to this collection.","cmty-admin-add-topic-err-private":"This collection is public, so you cannot topics in 		private forums.","cmty-admin-add-topic-err-no-topic":"Sorry, I cannot find this topic.","cmty-admin-add-topic-err-no-permission":"Sorry, you do not have permission to access this topic.","cmty-admin-add-topic-blocker":"Hold on while I fetch this topic for you...","cmty-admin-new-post-error-E_LABEL_TOO_LONG":"Your post label is too long; it cannot be more than "+AoPS.Community.Constants.view_post_max_label_len+" characters","cmty-admin-new-post-error-E_INVALID_POST_ID":"You must enter a valid post id or a URL to a forum 		post.  To find a post URL, click the post number indicator at the top right of a post. The post 		id is the integer following the p.","cmty-admin-new-post-error-E_HIDE_LABEL_TOO_LONG":'Your "Hide Link Text" is too long.  It cannot be more than '+AoPS.Community.Constants.view_post_max_hide_label_len+" characters.","cmty-admin-new-post-error-E_NO_CUSTOM_TEXT_ENTERED":"To enter a row of custom text, you must 		enter some custom text!","cmty-admin-new-post-error-E_INVALID_POST_TYPE":"You have sent an invalid post type.","cmty-admin-new-post-error-E_BANNED_TERM":"You have submitted a banned term.","cmty-admin-new-post-error-E_NO_SUCH_POST":"Sorry, that post doesn't appear to exist.","cmty-admin-new-post-error-E_NON_FORUM_POST":"You can only add posts that are in forum topics. No 		blog posts, blog comments, or private messages are allowed.","cmty-admin-new-post-error-E_NO_PERMISSION":"You do not have permission to 		access this post.","cmty-admin-new-post-error-E_ONLY_PUBLIC_POSTS_ALLOWED":"This collection is public, so you can 		only add public posts to it.","cmty-admin-new-post-error-E_POST_IS_DELETED":"Sorry, that post has been deleted.","cmty-admin-new-post-error-E_LATEX_ERROR":"Sorry, your custom text has a LaTeX error; please fix it and re-submit.","cat-admin-post-construct-blocker":"Constructing post item for this collection.","cat-admin-sort-type-system-my_blogs":"Last blog post time","cat-admin-sort-type-system-view_topics":"Last post time","cat-admin-sort-type-system-bookmark_topics":"Last post time","cat-admin-sort-type-system-blogroll":"Last blog post time","cat-admin-sort-type-system-default":"Special","cat-admin-sort-type-manual":"Manual","cat-admin-sort-type-abc":"Alphabetical","cat-admin-sort-type-manual_then_abc":"Some manual, rest alphabetical","cat-admin-sort-type-yyyy":"By year (all items should start with a year)","cat-admin-sort-type-system-other_forums":"Recent Usage","cat-admin-add-heading-blogroll":"Add blog:","cat-admin-add-heading-view_tags":"Tag forum:","cat-admin-add-heading-my_blogs":"Add blog:","cat-admin-add-heading-topic":"Add topic:","cat-admin-add-heading-folder":"Add item:","cat-admin-add-heading-my_forums":"Add forum:","cat-admin-add-heading-folder_forums":"Add forum:","cat-admin-add-heading-folder_collections":"Add collection:","cat-admin-add-heading-my_collections":"Add collection:","feed-topic-full-message-deleted":"The topic you are viewing in the feed has just been deleted.","feed-no-bookmark-options-checked":"Work with me here.  If you aren't going to check any options, then I can't fetch you any topics.","feed-new-private-conversation":"Start new message","feed-close":"Close feed","feed-tab-global-title":"Global feed\nRecent topics in any forum\nSee Community Help to customize","feed-tab-global-custom-title":"Global feed\nRecent topics in select forums\nSee Community Help to customize","feed-tab-my-topics-title":"My Topics feed\nTopics I have posted in","feed-tab-private-title":"Private feed\nMy private messages","feed-tab-bookmark-title":"Bookmark feed\nTopics from bookmarked tags, forums, and topics","feed-tab-page-feed-title":"Page feed\n Topics about items on this page","feed-topic-title-tooltip":"Click to visit this topic in main window.","feed-forum-title-tooltip":"Click to visit this forum in main window.","feed-page-subfeed-header":"Page Feed","feed-bookmarks-subfeed-header":"My Bookmarks","feed-global-subfeed-header":"Global Feed","feed-ego-subfeed-header":"My Topics","feed-messages-subfeed-header":"My Messages","feed-no-forum":"Sorry, this object does not have a forum attached yet, so you cannot create a new topic.","feed-no-read-permission":"Sorry, you don't have permission to read this topic.","feed-no-topic":"Well, that's embarrassing.  I can't find the topic attached to this object.","feed-community-disabled":"The community has been disabled.","feed-re-sort":"Re-sort this feed","feed-my-topics-onclick":"With {0} of a topic in your My Topics feed, you 		may either open the topic in another tab or remove the topic from the 		My Topics feed.  If you remove the topic from the My Topics feed, it 		will reappear in the My Topics feed if you post in the topic again.","feed-my-topics-open-new":"Open in new tab","feed-my-topics-remove":"Remove from My Topics","blog-post-new-entry":"Post New Entry","blog-edit-post":"Edit","blog-delete-post":"Delete","blog-moderate-post":"Moderate","blog-report-post":"Report","blog-post-comment":"Comment","blog-shout":"shout","blog-shout-err-E_LATEX_ERROR":"Sorry, you have a LaTeX error in your message.","blog-shout-err-E_ASY_ERROR":"Sorry, you have an Asymptote error in your message.","blog-shouts":"shouts","blog-Tags":"Tags","blog-Comment":" Comment","blog-Comments":" Comments","blog-default-comments":"%s Comments","blog-default-one-comment":"One Comment",
"blog-default-no-comments":"No Comments","blog-default-post-comments":"(Post Your Comment)","blog-about-owner":"About Owner","blog-posts":"Posts:","blog-joined":"Joined:","blog-location":"Location:","blog-stats":"Blog Stats","blog-created":"Blog created:","blog-entries":"Total entries:","blog-visits":"Total visits:","blog-comments":"Total comments:","blog-archive-title":"Archives","blog-shoutbox-title":"Shouts","blog-one-char-left":"character left","blog-characters-left":"characters left","blog-no-shoutbox-spamming":"You must wait until someone else shouts to shout again!","blog-Entries":"Entries","blog-Entry":"Entry","blog-no-topics":"No posts in this blog.  Yet!","blog-no-results":"No results found.","blog-shout-blocker":"Sending your shout.  Back shortly....","blog-contributors-title":"Contributors","blog-search-heading":"Search Blog","blog-search-placeholder":"Enter term","blog-search-button":"Search","blog-search-advanced":"Advanced Search","blog-search-advanced-tooltip":"View advanced search options","blog-subscribed-notify":"You will now receive email notifications when this blog has new posts.","blog-unsubscribed-notify":"You will no longer receive email notifications when this blog has new posts.","blog-subscribe-tooltip":"Click to receive email notifications for new posts in this blog","blog-unsubscribe-tooltip":"Click to stop receiving email notifications for new posts in this blog","change-blog-err-E_NO_PERMISSION":"Sorry, you no longer have permission to change this setting. Your changes have not been saved.","blog-shout-no-permission":"You do not have permission to shout in this blog.","blog-shout-no-permission-limited":'You have a limited account, so you cannot shout in blogs. 		You can upgrade your account for free <a href="/user/upgrade.php">here</a>.',"cmty-tag-term-no-tags":"No tags found; press Enter to add as a new tag.","cmty-tag-info-no-match":"No matches found","cmty-tag-info-no-tag":"No tag found","cmty-tag-info-tag":"Tag: ","cmty-tag-mapper-enter-term":"Enter term to attach to tag (hit enter to add): ","cmty-tag-info-delete":"DELETE FROM ALL FORUMS","cmty-tag-info-delete-in-checked":"DELETE FROM CHECKED CATEGORIES","cmty-tag-info-delete-everywhere":"DELETE EVERYWHERE (RARE)","cmty-tag-edit-capitalization":"New capitalization of tag (enter to submit): ","cmty-tag-info-merge-prompt":"Merge to tag (hit enter to submit): ","cmty-term-add-edit":"Add/edit term","cmty-tag-add-edit":"Add/edit tag","cmty-tag-info-delete-all-fora-confirm":"This will delete the tag <b>{0}</b> 		in all forums.  It will not delete the tag in private messages, nor in blogs. 		<b>NOT EASILY REVERSIBLE, DO NOT SCREW THIS UP.</b>  Are you sure you want to 		do this?","cmty-tag-info-recapitalization-fail":"The new tag text must be exactly the same as 		the original text, but with different capitalization. No change will be made until you do it right.","cmty-tag-info-recapitalization-confirm":"Are you sure you want to re-capitalize all tags of the 		form <b>{0}</b> as <b>{1}</b> instead?","cmty-tag-info-recapitalization-blocker":"Being the Fed, back shortly.","cmty-tag-term-mapper-warning":"<b>Warning</b>: Changes will not take effect for you until reloading the community in your browser.","cmty-tag-info-delete-some-fora-confirm":"This will delete the tag <b>{0}</b> 		in the following categories: <b><i>{1}</i></b>.<br><br>  		<b>NOT EASILY REVERSIBLE, DO NOT SCREW THIS UP.</b>  Are you sure you want to 		do this?","cmty-tag-info-delete-everywhere-confirm":"<b>YOU SHOULD ONLY DO THIS WITH A TAG YOU 		WANT TO PUT ON THE BLACKLIST</b>.  If you go ahead with this, this tag will be removed 		from everything, and you should immediately talk to a webmasterish person about putting 		the term on the blacklist in CmtyTags.","cmty-tag-info-delete-blocker":"Deleting tag, back shortly...","cmty-tag-info-merge-tag-confirm":"Are you sure you want to merge the tag <b>{0}</b> into the tag 		<b>{1}</b>?  This will only affect tags in forums.<br><br>  <b>THIS IS NOT REVERSIBLE</b>, unless you 		go through every single topic hand by hand.  Have fun with that. Note: Tag counts for the merged-to 		tag will not be updated until another topic gets that tag in a forum.  That's because I don't like 		counting things.","cmty-tag-info-merge-tag-forums-confirm":"Are you sure you want to merge the tag <b>{0}</b> into the tag 		<b>{1}</b>?  This will only affect tags in the following forums: <b><i>{2}</i></b>.<br><br>  <b>THIS IS NOT REVERSIBLE</b>, unless you 		go through every single topic hand by hand.  Have fun with that. Note: Tag counts for the merged-to 		tag will not be updated until another topic gets that tag in a forum.  That's because I don't like 		counting things.","cmty-tag-info-merge-note":'<b>Notes on merging</b>: <span style="color:#900"><b>DO NOT USE THIS FOR RESTRICTED/HIDDEN TAGS</b></span>. Also, 		the system will only recompute tag counts if you manually select fora below, and there are fewer than 5 of them.  Counting is hard, yo. 		Otherwise, tag counts won\'t get reset until something gets tagged with the merged-to tag.  Most notably, if the 		merged-to tag did not exist prior to merge, it will only appear in the box after merge if you manually choose few 		fora for merging.',"view-posts-view-topic":"view topic","embed-err-no-topic":"Sorry, the topic you seek is not in this forum anymore.  Maybe it never was here...","memberlist-page-title":"Memberlist","memberlist-user-search":"User Search","memberlist-user-search-placeholder":"Enter a username.  Use * as a wildcard.","memberlist-joined":"Joined","memberlist-last-visit":"Last Visit","memberlist-posts":"Posts","memberlist-thanks":"<span>Y</span> Received","memberlist-no-matches":"No users match your search, sorry!","memberlist-posts-tooltip":"Number of posts in the community. \nDoes not include posts in the \npink games-related forums.","memberlist-thanks-tooltip":"Number of times this user has received a thumbs-up.","userlist-edit":"Edit user list","my-bookmarks-long-desc":'Bookmarks allow you to collect content that you would like to access easily from your My AoPS page or your feed.<br>		Bookmark a forum, tag, topic, or user by clicking the <span class="aops-font">B</span>Bookmark icon associated with the item.',"log-admin-confirm-revert":"Are you sure you want to revert these {0} action(s)? Make sure you 		have chosen the correct action(s) to revert; you can't easily reverse this...","log-admin-nothing-to-revert":"Um, you have to choose something to revert...","log-admin-blocker-revert":"Hold on while I clean up this mess.","log-admin-page-title":"Log Admin","log-admin-time":"The previous query took <b>{0}</b> milliseconds."},AoPS.Community.Constants.bbCode.font_sizes=[{size:50,text:"Too small"},{size:75,text:"Small"},{size:100,text:"Medium"},{size:150,text:"Large"},{size:200,text:"Too large"}],AoPS.Community.Constants.bbCode.extra_options=[{property:"disable_bbcode",text:"Disable bbCode",class_id:"cmty-post-extra-disable-bbcode"},{property:"notify_email",text:"Subscribe to this topic",class_id:"cmty-post-extra-email"},{property:"bookmark_feed",text:"Add topic to Bookmarks feed",class_id:"cmty-post-extra-add-feed"}],AoPS.hasOwnProperty("Community")||(AoPS.Community={}),AoPS.Community.is_active=AoPS.bootstrap_data.hasOwnProperty("is_community_active")&&AoPS.bootstrap_data.is_community_active,AoPS.Community.Utils={ajax_runner:new AoPS.Ajax.ScriptRunner("/m/community/ajax.php"),onclick_latex_activated:!1,activateLatexOnclick:function(){AoPS.Community.Utils.onclick_latex_activated||($(document).on("click","img.latex, img.latexcenter",function(e){e.metaKey||e.ctrlKey||$(this).attr("alt")&&0===$(this).closest(".aops-modal-body").length&&AoPS.Community.Utils.throwLaTeXOnModal({event:e,latex_image:this})}),$(document).on("click","img.asy-image",function(e){e.metaKey||e.ctrlKey||$(this).attr("alt")&&0===$(this).closest(".aops-modal-body").length&&AoPS.Community.Utils.throwAsyOnModal({event:e,asy_image:this})}),AoPS.Community.Utils.onclick_latex_activated=!0)},throwLaTeXOnModal:function(e){var t=e.latex_image.cloneNode(!1),o=$.trim(_.escape(e.latex_image.alt)).replace(/(?:\r\n|\r|\n)/g,"<br />");$output=$('<div class="latex-modal"></div>').append(t),$output.append('<div class="latex-modal-bottom">							<div class="latex-modal-bottom-title"><u>LaTeX code below</u></div>							<div class="latex-modal-code">'+o+"</div>						</div>"),$output.showModal({frame_class:"latex-modal-wrapper",max_width:"500px",scrollable:!0})},formatUrl:function(e){return"http://"===e.substr(0,7)||"https://"===e.substr(0,8)?e:"http://"+e},idler_started:!1,is_cmty_asleep:!1,putCommunityToSleep:function(){AoPS.Community.Utils.cmty_ajax.ajax_active=!1,AoPS.Community.Utils.is_cmty_asleep=!0,AoPS.Ui.Modal.showMessage(AoPS.Community.Lang["community-asleep"],{width:"450px"}),_.isUndefined(AoPS.Community.Utils.idle_monitor_interval)||(clearInterval(AoPS.Community.Utils.idle_monitor_interval),this.idler_started=!1),"object"==typeof AoPS.Community.MasterModel&&AoPS.Community.MasterModel.set("cmty_status","disabled")},startIdleMonitor:function(){function e(){idle_counter++,idle_counter*AoPS.Community.Constants.idle_monitor_interval>=AoPS.Community.Constants.intervals.current.put_community_to_sleep_limit&&AoPS.Community.Utils.putCommunityToSleep()}idle_counter=0,this.idler_started||($(document).on("mousemove touchmove click keypress",function(e){idle_counter=0}),AoPS.Community.Utils.idle_monitor_interval=setInterval(e,AoPS.Community.Constants.idle_monitor_interval))},throwAsyOnModal:function(e){var t=e.asy_image.cloneNode(!1),o=$.trim(_.escape(e.asy_image.alt)).replace(/(?:\r\n|\r|\n)/g,"<br />");$output=$('<div class="latex-modal"></div>').append(t),$output.append('<div class="latex-modal-bottom">							<div class="latex-modal-bottom-title"><u>Asymptote code below</u></div>							<div class="latex-modal-code">'+o+"</div>						</div>"),$output.showModal({frame_class:"latex-modal-wrapper",max_width:"500px",scrollable:!0})},extractValueFromUrl:function(e,t){var o;return _.isNull(t)?0:(o=t.match(new RegExp(e+"(\\d+)")),_.isNull(o)?0:parseInt(o[1]))},hexToRgb:function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},cmty_ajax:{queue:[],has_active_call:!1,time_profiling:!0,ajax_active:!0,fail_level:0,add:function(e){var t=_.extend({never_cancel:!1,source:"master",call_cancel_on_timeout:!1},e);return this.ajax_active?void(this.has_active_call?(t.hasOwnProperty("queue_limit")&&this.queue.length>t.queue_limit&&this.queueLimit(t),e.hasOwnProperty("extra_ajax_runner_options")&&e.extra_ajax_runner_options.hasOwnProperty("queue_at_front")&&e.extra_ajax_runner_options.queue_at_front?this.queue.unshift(t):this.queue.push(t)):this.run(t)):void this.checkWarnCmtyAsleep()},clearCallsOfType:function(e){var t=[];_.each(this.queue,function(o){o.a!==e&&t.push(o)}),this.queue=t},queueLimit:function(e){this.hasHandler(e,"onQueueLimit")&&e.extra_handlers.onQueueLimit()},onAjaxUnknown:function(e){var t,o=this,i=AoPS.Community.Lang;t=AoPS.Community.Constants.base_delay_internet_issue*Math.pow(2,this.fail_level),this.fail_level<4?(this.queue.unshift(this.active_call),AoPS.Ui.Flyout.display(AoPS.Community.Utils.formatString(i["ajax-error-delay"],[t]),{"class":"flyout-atop-modal"}),setTimeout(function(){o.runNext()},1e3*t),console.log("E_AJAX_UNKNOWN: Try again in "+t+" seconds."),this.fail_level++):(this.ajax_active=!1,AoPS.Community.Views.showErrorAtopAModal(i["ajax-error-E_AJAX_UNKNOWN"]))},prepare:function(e){var t,o=this;return t=function(t,i){if(e.main_handler(t,i),o.time_profiling&&AoPS.session.a&&i.hasOwnProperty("response")&&i.response.hasOwnProperty("time_in_script")&&console.log(e.a+" in "+i.response.time_in_script),t)o.hasHandler(e,"onFinish")&&e.extra_handlers.onFinish(i.response),"string"==typeof i.response.cmty_status&&"object"==typeof AoPS.Community&&"object"==typeof AoPS.Community.MasterModel&&AoPS.Community.MasterModel.set("cmty_status",i.response.cmty_status);else{if("E_AJAX_TIMEOUT"===i.error_code&&e.call_cancel_on_timeout&&(i.error_code="E_AJAX_CANCEL"),"E_AJAX_UNKNOWN"===i.error_code||"E_AJAX_BADRETURN"===i.error_code)return o.onAjaxUnknown(),void(o.ajax_active||AoPS.Ui.Modal.applyKillPhrase("ajax-error-kill"));"E_AJAX_FILTERED"===i.error_code?(console.log("call filtered"),o.hasHandler(e,"onAjaxFilter")&&e.extra_handlers.onAjaxFilter()):(o.hasHandler(e,"onError")&&"E_COMMUNITY_DEACTIVATED"!==i.error_code&&e.extra_handlers.onError(i),"E_COMMUNITY_DEACTIVATED"===i.error_code&&o.hasHandler(e,"onDeactivated")&&e.extra_handlers.onDeactivated())}o.fail_level=0,o.runNext()},{a:e.a,params:e.params,handler:t}},run:function(e){var t,o;!this.ajax_active,t=this.prepare(e),o=e.hasOwnProperty("extra_ajax_runner_options")?e.extra_ajax_runner_options:{},this.ajax_active?(this.active_call=e,this.has_active_call=!0,AoPS.Community.Utils.ajax_runner.run(t.a,t.params,t.handler,o),this.current_ajax_runner_id=AoPS.Community.Utils.ajax_runner.getRunningQueueId()):this.checkWarnCmtyAsleep()},checkWarnCmtyAsleep:function(){AoPS.Community.Utils.is_cmty_asleep&&AoPS.Ui.Flyout.display(AoPS.Community.Lang["community-asleep-reminder"],{"class":"flyout-atop-modal"})},runNext:function(){var e;AoPS.Community.is_active&&this.ajax_active?this.queue.length>0?(e=this.queue.shift(),setTimeout(_.bind(function(){this.run(e)},this),400)):(this.current_ajax_runner_id=0,this.active_call=null,this.has_active_call=!1):(_.each(this.queue,function(e){e.handler(!1,{error_code:"E_COMMUNITY_DEACTIVATED"})}),this.queue=[])},hasHandler:function(e,t){return e.hasOwnProperty("extra_handlers")&&"function"==typeof e.extra_handlers[t]},cancelAll:function(e){var t=this;retained_calls=[],_.each(this.queue,function(o){t.checkCancel(e,o)?t.hasHandler(o,"onError")&&o.extra_handlers.onError({error_code:"E_AJAX_CANCEL"}):retained_calls.push(o)}),this.has_active_call&&this.checkCancel(e,this.active_call)&&AoPS.Community.Utils.ajax_runner.cancelQueueId(this.current_ajax_runner_id),this.queue=retained_calls},checkCancel:function(e,t){return t.never_cancel?!1:"all"===e.cancel_type||"feed"===e.cancel_type&&"feed"===t.source||"master"===e.cancel_type&&"master"===t.source}},autotagger:function(){var e={};return e.dictionary=AoPS.Community.hasOwnProperty("term_tag_map")?AoPS.Community.term_tag_map:{},e.min_spellcheck_len=6,e.spellcheck=function(t){var o,i,s,a,n,r,l,c,d="abcdefghijklmnopqrstuvwxyz";for(o=0;o<t.length;o++){if(s=t.slice(0,o),a=t.slice(o+1,t.length),n=t.substr(o,1),r=s+a,e.dictionary.hasOwnProperty(r))return e.dictionary[r];for(i=0;26>i;i++){if(c=d.substr(i,1),c!==n&&(r=s+c+a,e.dictionary.hasOwnProperty(r)))return e.dictionary[r];if(r=s+c+n+a,e.dictionary.hasOwnProperty(r))return e.dictionary[r]}if(o>0&&(l=t.slice(0,o-1),r=l+n+t.substr(o-1,1)+a,e.dictionary.hasOwnProperty(r)))return e.dictionary[r]}for(i=0;26>i;i++)if(r=t+d.substr(i,1),e.dictionary.hasOwnProperty(r))return e.dictionary[r];return[]},e.tag=function(t){return e.dictionary.hasOwnProperty(t)?e.dictionary[t]:t.length>=e.min_spellcheck_len?e.spellcheck(t):[]},e}(),buildUsernameAutocomplete:function(e,t){var o,i,s=function(){},a=function(){};t=_.extend({has_search_icon:!1},t),i=t.has_search_icon?"left-21 top+5":"left top+5",autocomplete_settings=_.extend({match_type:"from_start_then_any",ui_class:"cmty-username-autocomplete",delay:250,is_case_sensitive:!1,onOpen:function(){},source:function(o,i){var n=AoPS.Community.Utils.cmty_ajax;n.clearCallsOfType(t.ajax_call),n.add({a:t.ajax_call,params:_.extend({username_stub:o.term},t.hasOwnProperty("additional_ajax_settings")?t.additional_ajax_settings:{}),main_handler:function(t,n){var r,l=e.val().substr(0,e[0].selectionStart);o.term!==l&&i([]),t?(r=_.map(n.response.usernames,function(e){return _.defaults(e,{label:e.value})}),0===r.length?a():s(),i(r)):i([])}})},_renderItem:function(e,t){var o=$("<li></li>"),i=$("<a>"+t.label+"</a>");return o.append(i),"1"===t.is_admin&&i.addClass("cmty-user-admin"),o.appendTo(e)},num_matches:10,position:{my:i}},t.autocomplete_settings),e.wrap($('<div class="cmty-username-autocomplete-wrapper"></div>')),t.has_search_icon&&(e.before('<span class="aops-font">M</span>'),e.parent().addClass("cmty-search-with-icon")),e.aopsAutocomplete(autocomplete_settings),t.hasOwnProperty("show_no_results_msg")&&t.show_no_results_msg&&(o=t.hasOwnProperty("$no_results")?t.$no_results:$('<div class="cmty-no-results-found">'+AoPS.Community.Lang["search-no-match"]+"</div>"),e.before(o),e.on("blur remove",function(){o.hide()}),s=function(){o.hide()},a=function(){o.show(),o.position({my:"left-1 top+1",at:"left bottom",of:e})})},buildCategoryAutocomplete:function(e,t){var o,i,s=function(){},a=function(){};t=_.extend({include_wrapper:!0,has_search_icon:!1},t),i=t.has_search_icon?"left-21 top+5":"left top+5",autocomplete_settings=_.extend({match_type:"from_start_then_any",delay:250,onOpen:function(){e.autocomplete("widget").width(AoPS.Community.Constants.category_autocomplete_width)},is_case_sensitive:!1,source:function(o,i){var n=AoPS.Community.Utils.cmty_ajax;n.clearCallsOfType(t.ajax_call),n.add({a:t.ajax_call,params:_.extend({category_stub:o.term},t.hasOwnProperty("additional_ajax_settings")?t.additional_ajax_settings:{}),main_handler:function(t,n){var r,l=e.val().substr(0,e[0].selectionStart);o.term!==l&&i([]),t?(r=_.map(n.response.categories,function(e){return _.defaults(e,{label:e.value})}),0===r.length?a():s(),i(r)):i([])}})},_renderItem:function(e,t){var o=$("<li>").addClass("cmty-category-autocomplete-item-"+t.category_type).css({color:t.main_color}),i=$('<a class="cmty-category-autocomplete">').text(t.label).css({color:t.main_color}).data({"main-color":t.main_color,"secondary-color":t.secondary_color});return o.append(i).appendTo(e)},onFocus:_.bind(function(e,t){this.hasOwnProperty("focus_element")&&!_.isNull(this.focus_element)&&this.focus_element.css({color:this.focus_element.data("main-color"),"background-color":""}),this.focus_element=$(e.originalEvent.target).find("a.ui-state-focus"),this.focus_element.css({color:this.focus_element.data("secondary-color"),"background-color":this.focus_element.data("main-color")})},this),num_matches:10,position:{my:i},ui_class:"category-autocomplete"},t.autocomplete_settings),t.include_wrapper&&(e.wrap($('<div class="cmty-category-autocomplete-wrapper"></div>')),t.has_search_icon&&(e.before('<span class="aops-font">M</span>'),e.parent().addClass("cmty-search-with-icon"))),e.aopsAutocomplete(autocomplete_settings),t.hasOwnProperty("show_no_results_msg")&&t.show_no_results_msg&&(o=t.hasOwnProperty("$no_results")?t.$no_results:$('<div class="cmty-no-results-found">'+AoPS.Community.Lang["search-no-match"]+"</div>"),e.before(o),e.on("blur remove",function(){o.hide()}),s=function(){o.hide()},a=function(){o.show(),o.position({my:t.has_search_icon?"left-22 top+4":"left-1 top+1",at:"left bottom",of:e})})},fetchUsernameMatches:function(e){this.cmty_ajax.clearCallsOfType("fetch_username_matches"),this.cmty_ajax.add({a:"fetch_username_matches",params:{username_stub:e.request.term},main_handler:_.bind(function(t,o){var i;return e.hasOwnProperty("checkSquelch")&&e.checkSquelch()?void e.response([]):void(t?(i=_.map(o.response.usernames,function(e){return _.defaults(e,{label:e.value})}),e.response(i)):e.response([]))},this)})},checkValidUsername:function(e){this.cmty_ajax.add({a:"check_valid_username",params:{username:e.username},main_handler:function(e,t){},extra_handlers:e})},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},displayCategoryType:function(e){return AoPS.Community.Lang[AoPS.Community.Utils.simplifyCategoryType(e)]},format_str_regexp:new RegExp("{-?[0-9]+}","g"),formatString:function(e,t){return e.replace(AoPS.Community.Utils.format_str_regexp,function(e){var o,i=parseInt(e.substring(1,e.length-1));return o=i>=0?t[i]:-1===i?"{":-2===i?"}":""})},lastRegexp:/(^Last\s)/,makePrettyTime:function(e){var t,o,i=parseInt(moment().format("X"))-e;return i<AoPS.Community.Constants.time_limits.watched_times_long?(t=moment(String(e),"X").add("milliseconds",-AoPS.Community.Constants.moment_offset-AoPS.Community.Constants.time_hack_nudge),o=t.diff(moment()),o>0&&12e4>o&&(t=moment().subtract(2,"seconds")),t.fromNow()):(t=moment(String(e),"X").add("milliseconds",-AoPS.Community.Constants.moment_offset),i<AoPS.Community.Constants.time_limit_for_calendar_style?t.calendar().replace(AoPS.Community.Utils.lastRegexp,""):t.format("MMM D, YYYY, h:mm a"))},makePrettyTimeOldDateOnly:function(e){var t,o,i=parseInt(moment().format("X"))-e;return i<AoPS.Community.Constants.time_limits.watched_times_long?(t=moment(String(e),"X").add("milliseconds",-AoPS.Community.Constants.moment_offset-AoPS.Community.Constants.time_hack_nudge),o=t.diff(moment()),o>0&&12e4>o&&(t=moment().subtract(2,"seconds")),t.fromNow()):(t=moment(String(e),"X").add("milliseconds",-AoPS.Community.Constants.moment_offset),i<AoPS.Community.Constants.time_limit_for_calendar_style?t.calendar().replace(AoPS.Community.Utils.lastRegexp,""):t.format("MMM D, YYYY"))},makePrettyTimeStatic:function(e){var t=moment(String(e),"X");return t.format("MMM D, YYYY, h:mm a")},makePrettyTimeStaticDateOnly:function(e){var t=moment(String(e),"X");return t.format("MMM D, YYYY")},getLastVisitedText:function(e){return"online"===e.item_subtitle?AoPS.Community.Lang["user-item-online"]:0===e.last_active?"":this.makePrettyTimeStatic(e.last_active)},routerBase:Backbone.Router.extend({errors:{my_aops_not_logged_in:{error_type:"custom",error_msg:"COPY/STYLING NEEDED -- There will be awesome stuff on this My AoPS page when you are logged in!!<br><i>This message brought to you by the errors object near the top of the Community Router object."}},url_parameters:[{letter:"c",property:"category_id"},{letter:"x",property:"priv_id"},{letter:"u",property:"user_id"},{letter:"q",property:"search_id"},{letter:"t",property:"tag_id"},{letter:"f",property:"tag_forum_id"},{letter:"h",property:"topic_id"},{letter:"p",property:"post_id"},{letter:"s",property:"state"}],parsePreloadedData:function(){function e(e){return o.hasOwnProperty(e)?o[e]:0}var t,o=AoPS.bootstrap_data.preload_cmty_data,i=e("category_id"),s=e("topic_id"),a=e("post_id"),n=e("user_id");return o.hasOwnProperty("error")?(this.processError(o.error),!0):(o.hasOwnProperty("topic_data")&&(t=this.models.master.processPotentialNewTopic(o.topic_data),this.preloaded_topic_id=s,t.set("last_posts_update_time",o.topic_data.last_posts_update_time)),o.hasOwnProperty("user")&&this.models.master.get("users").add(new AoPS.Community.Models.User(o.user)),o.hasOwnProperty("rewrite_url")&&o.rewrite_url?(this.rebuildPageFromStart({category_id:i,topic_id:s,post_id:a,priv_id:0,user_id:n,search_id:0,tag_id:0,tag_forum_id:0,state:0}),!0):!1)},throwError:function(e){this.myPage.throwError({error_type:"custom",error_msg:e})},throwNoPermissions:function(){AoPS.session.logged_in?this.throwError(AoPS.Community.Lang["router-err-no-perms-logged-in"]):this.throwError(AoPS.Community.Lang["router-err-no-perms-logged-out"])},processError:function(e){switch(e){case"E_NO_SUCH_POST":this.throwError(AoPS.Community.Lang["router-err-no-post"]);break;case"E_NO_SUCH_TOPIC":this.throwError(AoPS.Community.Lang["router-err-no-topic"]);break;case"E_NOT_PARTICIPANT":this.throwError(AoPS.Community.Lang["router-err-not-participant"]);break;case"E_NO_PERMISSION":AoPS.session.logged_in?this.throwError(AoPS.Community.Lang["router-err-no-perms-logged-in"]):this.throwError(AoPS.Community.Lang["router-err-no-perms-logged-out"]);break;case"E_TOPIC_DELETED":this.throwError(AoPS.Community.Lang["router-err-topic-deleted"]);break;case"E_NO_SUCH_CATEGORIES":this.throwError(AoPS.Community.Lang["router-err-no-such-category"])}},rebuildUrl:function(e){function t(t,o){return 0!=e[o]?t+e[o]:""}var o="";return _.each(this.url_parameters,function(e){o+=t(e.letter,e.property)}),0===o.length?(Backbone.history.navigate(o,{trigger:!0,replace:!1}),!1):(Backbone.history.navigate(o,{trigger:!1,replace:!0}),!0)},rebuildPageFromStart:function(e){this.rebuildUrl(e)&&(this.myPage.showBreadcrumbs(),this.startConstructingPage(e))}}),simplifyCategoryType:function(e){switch(e){case"forum":case"forum_class":return"forum";case"blog":return"blog";default:return"collection"}},time_now:parseInt(moment().format("X")),renderNumberWithCommas:function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}},AoPS.Community.Utils.ajax_runner.addGlobalHandler(function(e,t){t.response.hasOwnProperty("user_session_data")?(t.response.user_session_data.logged_in!==AoPS.session.logged_in||t.response.user_session_data.user_id!==AoPS.session.user_id)&&(AoPS.session.username=t.response.user_session_data.username,AoPS.session.user_id=t.response.user_session_data.user_id,AoPS.session.logged_in=t.response.user_session_data.logged_in,AoPS.session.logged_in?Backbone.trigger("logged_in"):Backbone.trigger("logged_out")):console.log("No user session data found in ajax call"),e||"E_COMMUNITY_DEACTIVATED"===t.error_code&&(AoPS.Community.is_active=!1,AoPS.Community.Views.inCmtyRouter()?window.location.href="/community":Backbone.trigger("community_disabled"))}),AoPS.Community.Models=function(e){var t,o=AoPS.Community.Lang,s=AoPS.Community.Constants,a=AoPS.Community.Utils;return t=a.cmty_ajax,e.Model=Backbone.Model.extend({setDefault:function(e,t){this.has(e)||this.set(e,t)}}),e.Master=Backbone.Model.extend({defaults:{all_past_reported_posts_fetched:!1,loading_post_reports:!1,topic_data_loaded:!1,fullscreen_mode:!1,topics_loading:!1,focus_topic:null,focus_tag:null,topic_lists:{},ajax_data_queue:[],is_fetching_topics:!1,is_stretch_class:!1,watched_users:[],my_aops:null,my_books:null,my_classes:null,my_forums:null,my_bookmarks:null,my_collections:null,my_blogs:null,watched_times_short:[],watched_times_long:[],last_reported_posts_fetch_time:0,in_change_focus_topic:!1,private_items_fetched:!1,in_community:!1,is_parsing_bbcode:!1},initialize:function(){var t,o,i,a,n=this,r={};AoPS.Community.MasterModel=this,AoPS.Community.Constants.moment_offset=moment(AoPS.bootstrap_data.server_time).diff(new Date),this.set("topics",new(Backbone.Collection.extend({model:e.Topic}))),this.set("global_announcements",new(Backbone.Collection.extend({model:e.Topic}))),this.listenTo(this.get("global_announcements"),"change:announce_type",this.onGlobalAnnounceDemote),this.get("topics").comparator=function(e){return e.get("topic_id")},this.set("users",new(Backbone.Collection.extend({model:e.User}))),this.get("users").comparator=function(e){return e.get("user_id")},"string"==typeof AoPS.bootstrap_data.cmty_status?this.set("cmty_status",AoPS.bootstrap_data.cmty_status):this.set("cmty_status","normal"),this.listenTo(this,"change:cmty_status",this.setIntervals),this.setIntervals(),this.constructIntervalAjax({method:function(){n.rebuildWatchedTimes("watched_times_short")},interval_property:"watched_times_short_interval"}),this.constructIntervalAjax({method:function(){n.rebuildWatchedTimes("watched_times_long")},interval_property:"watched_times_long_interval"}),this.set("cached_tag_ids",{}),this.set("topic_lists",new(Backbone.Collection.extend({model:e.TopicList}))),this.set("categories",new(Backbone.Collection.extend({model:e.Category}))),this.set("priv_categories",new(Backbone.Collection.extend({model:e.CategoryPriv}))),this.set("user_search_categories",new(Backbone.Collection.extend({model:e.Category}))),this.set("search_categories",new(Backbone.Collection.extend({model:e.CategorySearch}))),this.set("last_topic_fetch_time",parseInt(AoPS.bootstrap_data.init_time)),this.hasLongNewItemInterval()&&(AoPS.Community.Constants.new_item_check_interval=AoPS.Community.Constants.new_item_check_interval_long),this.constructIntervalAjax({interval_property:"new_item_check_interval",method:function(){n.fetchNewTopics()}}),this.set("last_watcher_fetch_time",parseInt(AoPS.bootstrap_data.init_time)),AoPS.bootstrap_data.hasOwnProperty("watcher_hash")?this.set("watcher_hash",AoPS.bootstrap_data.watcher_hash):this.set("watcher_hash",Math.floor(1e7*Math.random())),this.set("permissions",AoPS.bootstrap_data.hasOwnProperty("user_global_cmty_permissions")?AoPS.bootstrap_data.user_global_cmty_permissions:[]),this.constructIntervalAjax({interval_property:"watchers_updates_check_interval",method:function(){n.fetchWatcherUpdates()}}),this.on("change:focus_topic",this.onChangeFocusTopic),AoPS.bootstrap_data.hasOwnProperty("my_profile")?(AoPS.bootstrap_data.my_profile.master=this,t=new AoPS.Community.Models.User(AoPS.bootstrap_data.my_profile),this.get("users").add(t),this.set("current_user",t),this.set("my_avatar",t.get("avatar")),this.listenTo(t,"change:base_view",function(){n.set("base_view",t.get("base_view"))})):this.set("current_user",new AoPS.Community.Models.User({user_id:1,username:"Anonymous"})),this.set("ebooks_available",AoPS.bootstrap_data.hasOwnProperty("ebooks_available")?AoPS.bootstrap_data.ebooks_available:[]),this.set("base_view",AoPS.bootstrap_data.hasOwnProperty("base_view")?AoPS.bootstrap_data.base_view:"main"),AoPS.session.logged_in&&(n.set("my_aops",n.constructNewCategory({category_name:"My AoPS",no_more_items:!0,category_type:"folder"})),this.constructBookmarkCategories(),this.set("my_privates",this.constructNewCategory(_.extend({category_type:"my_privates",category_name:AoPS.Community.Lang["private-category-name"]},AoPS.bootstrap_data.my_privates_data))),this.set("my_privates_archive",this.constructNewCategory({category_type:"my_privates",is_archive:!0,special_url:"/my-messages-archive/",add_to_master_collection:!1,category_status:"archived",items:this.get("my_privates").get("items"),category_name:AoPS.Community.Lang["private-archived-category-name"],permissions:this.get("my_privates").get("permissions"),can_mark_all_read:!1})),this.set("reported_posts",new(Backbone.Collection.extend({model:e.PostReport}))),this.get("reported_posts").comparator=function(e){return-e.get("inserted_at")}),AoPS.Community.hasOwnProperty("categories")&&(AoPS.bootstrap_data.hasOwnProperty("toplevel_category_permissions")&&_.each(_.keys(AoPS.bootstrap_data.toplevel_category_permissions),function(e){r[e]=AoPS.bootstrap_data.toplevel_category_permissions[e]}),_.each(AoPS.Community.categories,function(e){var t=e.category_id;r.hasOwnProperty(t)&&(e.permissions=r[e.category_id]),n.constructNewCategory(e)}),AoPS.bootstrap_data.hasOwnProperty("cmty_toplevel_data")&&_.each(_.keys(AoPS.bootstrap_data.cmty_toplevel_data),function(e){n.fetchCategory(parseInt(e)).set(AoPS.bootstrap_data.cmty_toplevel_data[e])}),a=this.fetchCategory(s.master_category_id),a.fetchMoreCategoryItems({start_idx:0}),a.set("all_subcategories_loaded",!0),i=this.fetchCategory(s.portal_category_id),_.isUndefined(i)||(i.fetchMoreCategoryItems({start_idx:0}),i.set("all_subcategories_loaded",!0)),o=this.fetchCategory(s.aops_forums_id),_.isUndefined(o)||(AoPS.bootstrap_data.hasOwnProperty("extra_aops_items_front")&&o.addItemsFront(AoPS.bootstrap_data.extra_aops_items_front),AoPS.bootstrap_data.hasOwnProperty("extra_aops_items")&&o.addItems(AoPS.bootstrap_data.extra_aops_items),AoPS.bootstrap_data.hasOwnProperty("aops_subfolders")&&o.addItemsFront(AoPS.bootstrap_data.aops_subfolders))),AoPS.bootstrap_data.hasOwnProperty("global_announcements")&&_.each(AoPS.bootstrap_data.global_announcements,function(e){n.processPotentialNewTopic(e,!0)}),AoPS.bootstrap_data.hasOwnProperty("preload_category_data")&&(Array.isArray(AoPS.bootstrap_data.preload_category_data)||(AoPS.bootstrap_data.preload_category_data=[AoPS.bootstrap_data.preload_category_data]),_.each(AoPS.bootstrap_data.preload_category_data,function(e){n.constructNewCategory(e)})),AoPS.hasOwnProperty("preload_topics")&&this.fetchPreloadTopicData(),AoPS.bootstrap_data.hasOwnProperty("cmty_whois")&&this.set("whois_data",AoPS.bootstrap_data.cmty_whois),this.listenTo(this,"change:fullscreen_mode",this.onChangeFullscreenMode)},setIntervals:function(){var e=this.get("cmty_status");"object"==typeof s.intervals[e]&&_.each(_.keys(s.intervals[e]),function(t){
s.intervals.current[t]=s.intervals[e][t]})},onChangeFullscreenMode:function(){switch(this.get("fullscreen_mode")){case"none":$("body").removeClass("feed-fullscreen fullscreen");break;case"feed":$("body").addClass("feed-fullscreen fullscreen");break;case"master":$("body").addClass("fullscreen")}},fetchPreloadTopicData:function(){var e,t,o,i,a=!1,n=!1,r=!1,l=parseInt(AoPS.bootstrap_data.init_time)-s.time_limit_delete_own,c=this,d=!1;AoPS.bootstrap_data.hasOwnProperty("preload_topics_is_read")&&(a=!0,t=AoPS.bootstrap_data.preload_topics_is_read),AoPS.bootstrap_data.hasOwnProperty("preload_topics_bkmk_data")&&(n=!0,o=AoPS.bootstrap_data.preload_topics_bkmk_data),AoPS.bootstrap_data.hasOwnProperty("preload_watchers")&&(d=!0,i=AoPS.bootstrap_data.preload_watchers),AoPS.bootstrap_data.hasOwnProperty("preload_topics_thanked")&&(r=!0,e=AoPS.bootstrap_data.preload_topics_thanked),_.each(_.keys(AoPS.preload_topics),function(s){var h=c.fetchCategory(s),m=h.get("permissions");h.getPermission("c_can_read")&&_.each(AoPS.preload_topics[s],function(s){var c=s.topic_id;s.permissions=m,a&&t.hasOwnProperty(c)&&(s.is_read=t[c].is_read,s.db_mark_time=t[c].db_mark_time),d&&i.hasOwnProperty(c)&&(s.num_watchers=i[c].num_watchers,s.watchers_usernames=i[c].watchers_usernames,s.watchers_avatars=i[c].watchers_avatars,s.num_named_watchers=i[c].num_named_watchers),n&&o.hasOwnProperty(c)?(s.is_bookmarked=!0,s.is_watched=1===o[c].e,s.in_feed=1===o[c].f):(s.is_bookmarked=!1,s.is_watched=!1,s.in_feed=!1),s.num_posts=s.comment_count+(h.getPermission("c_can_undelete")?s.num_deleted:0),r&&e.hasOwnProperty(s.posts_data[0].post_id)&&(1==e[s.posts_data[0].post_id]?s.posts_data[0].is_thanked=!0:s.posts_data[0].is_nothanked=!0),AoPS.session.logged_in&&(s.posts_data[0].editable=AoPS.session.user_id===s.posts_data[0].poster_id,s.posts_data[0].deletable=AoPS.session.user_id===s.posts_data[0].poster_id&&s.posts_data[0].post_time>l)}),c.processPotentialNewTopics(AoPS.preload_topics[s],!0)})},constructIntervalAjax:function(e){var t,o,i=this;t="number"==typeof AoPS.Community.Constants.intervals.current[e.interval_property]?AoPS.Community.Constants.intervals.current[e.interval_property]:AoPS.Community.Constants[e.interval_property],o=setTimeout(function(){AoPS.Community.is_active&&(e.method(),i.constructIntervalAjax(e))},t),e.hasOwnProperty("interval_id_property")&&e.interval_monitor_model.set(e.interval_id_property,o)},onChangeFocusTopic:function(e){var t=arguments.length>2&&arguments[2].hasOwnProperty("suppress_ajax")&&arguments[2].suppress_ajax,o=this.get("focus_topic"),i=this.previous("focus_topic");_.isNull(i)||i.set("is_master_focus",!1),_.isNull(o)||o.set("is_master_focus",!0),t?_.isNull(o)||(o.startRealtimePostMonitor({hash:this.get("watcher_hash"),source:"master"}),o.set("is_read",!0),o.set("is_master_focus",!0)):this.makeChangeFocusTopicAjaxCall({new_focus:o,previous_focus:i,source:"master",suppress_ajax:t,hash:this.get("watcher_hash"),fetch_all:arguments[2].hasOwnProperty("fetch_all")&&arguments[2].fetch_all,tag_id:arguments[2].hasOwnProperty("tag_id")?arguments[2].tag_id:0,tag_forum_id:arguments[2].hasOwnProperty("tag_forum_id")?arguments[2].tag_forum_id:0})},makeChangeFocusTopicAjaxCall:function(e){var o={topic_fetch:"none"},i=this;this.set("in_change_focus_topic",!0),_.isNull(e.new_focus)?o.new_topic_id=0:(e.new_focus.set("in_onChangeFocus",!0),e.new_focus.startRealtimePostMonitor({hash:e.hash,source:e.source}),e.new_focus.set("is_read",!0),o.new_topic_id=e.new_focus.get("topic_id"),o.new_category_id=e.new_focus.get("category_id"),e.hasOwnProperty("tag_id")&&e.tag_id>0&&(o.focus_tag_id=e.tag_id,o.focus_tag_forum_id=e.tag_forum_id),0===e.new_focus.get("posts").length||1===e.new_focus.get("posts").length&&!e.new_focus.get("all_posts_fetched")||e.new_focus.get("poll_id")>0&&!e.new_focus.has("poll_data")?(o.topic_fetch="initial",o.fetch_first=0===e.new_focus.get("posts").length?1:0,o.fetch_all=e.hasOwnProperty("fetch_all")&&e.fetch_all?1:0):(o.topic_fetch="update",o.last_post_num=e.new_focus.fetchLastLoadedPostNumber(),o.last_update_time=e.new_focus.get("last_posts_update_time")),e.new_focus.set({is_fetching_posts:!0,is_fetching_past_posts:!0})),_.isEmpty(e.previous_focus)?o.old_topic_id=0:(e.previous_focus.stopRealtimePostMonitor({hash:e.hash,source:e.source}),o.old_topic_id=e.previous_focus.get("topic_id")),o.source=e.source,o.hash=e.hash,t.add({a:"change_focus_topic",params:o,source:o.source,main_handler:function(t,s){t?(o.new_topic_id>0?(e.new_focus.set("in_onChangeFocus",!0),s.response.hasOwnProperty("category_mark_time")&&(e.new_focus.has("category")?category=e.new_focus.get("category"):category=e.new_focus.get("master").fetchCategory(e.new_focus.get("category_id")),_.isUndefined(category)||(e.new_focus.set("category",category),category.set("mark_time",s.response.category_mark_time))),e.new_focus.set("mark_time",s.response.topic_mark_time),s.response.hasOwnProperty("new_topic_settings")&&e.new_focus.set(s.response.new_topic_settings),s.response.hasOwnProperty("old_topic_settings")&&(old_topic=e.new_focus.get("master").fetchTopicById(s.response.old_topic_settings.topic_id),_.isNull(old_topic)||old_topic.set(s.response.old_topic_settings)),"initial"===o.topic_fetch?e.new_focus.processInitialPostFetch(s.response):"update"===o.topic_fetch&&e.new_focus.onFinishTopicUpdateAjax(s.response.topic_update_data),e.new_focus.trigger("topic_updated")):o.old_topic_id>0&&s.response.hasOwnProperty("new_topic_settings")&&e.previous_focus.set(s.response.new_topic_settings),i.set("in_change_focus_topic",!1),i.trigger("change_topic_post_finish")):("E_TOPIC_DELETED"===s.error_code||"E_NO_SUCH_TOPIC"===s.error_code||"E_NO_PERMISSION"===s.error_code)&&(e.new_focus.set("deleted",!0,{error_code:s.error_code}),e.new_focus.destroy())},extra_handlers:{onError:function(t){"E_AJAX_CANCEL"===t.error_code&&(_.isNull(e.new_focus)||e.new_focus.set({is_fetching_posts:!1,is_fetching_past_posts:!1}))}}})},fetchNewTopics:function(){var e,o=this,i=!1;e={last_topic_fetch_time:this.get("last_topic_fetch_time"),watched_users:JSON.stringify(this.get("watched_users")),in_community:this.get("in_community")?1:0},"object"==typeof AoPS.Stretch&&"number"==typeof AoPS.Stretch.class_id&&"number"==typeof AoPS.Stretch.forum_id&&"number"==typeof AoPS.Stretch.lesson&&(e.stretch_class_id=AoPS.Stretch.class_id,e.stretch_lesson=AoPS.Stretch.lesson,e.stretch_forum_id=AoPS.Stretch.forum_id,i=!0),this.get("is_fetching_topics")||(this.set("is_fetching_topics",!0),t.add({a:"fetch_new_topics",params:e,queue_limit:1,never_cancel:!0,main_handler:function(e,t){e&&(t.response.hasOwnProperty("topic_fetch_time")&&t.response.topic_fetch_time>parseInt(AoPS.bootstrap_data.init_time)&&o.set("last_topic_fetch_time",t.response.topic_fetch_time),t.response.deleted_topics.length>0&&_.each(t.response.deleted_topics,function(e){var t=o.fetchTopicById(e);_.isNull(t)||(t.set("deleted",!0),t.destroy())}),t.response.moved_topics.length>0&&_.each(t.response.moved_topics,function(e){var t=o.fetchTopicById(e.topic_id),i=o.fetchCategory(e.category_id);_.isNull(t)||t.parsePotentialMove(e),_.isUndefined(i)||i.set({num_topics:e.category_num_topics,num_posts:e.category_num_posts,num_users:e.category_num_users})}),t.response.posts.length>0&&_.each(t.response.posts,function(e){var t=o.fetchTopicById(e.topic_id);_.isNull(t)||t.parseEditedPost(e)}),t.response.topics.length>0&&_.each(t.response.topics,function(e){var t;t=o.fetchCategory(e.category_id),_.isUndefined(t)||t.set({num_topics:e.category_num_topics,num_posts:e.category_num_posts,num_users:e.category_num_users}),o.processPotentialNewTopic(e,!0)}),t.response.category_lock_changes.length>0&&_.each(t.response.category_lock_changes,function(e){var t=parseInt(e.category_id),i=o.fetchCategory(t),s=1==parseInt(e.is_locked);_.isUndefined(i)||i.set("is_locked",s),o.setTopicsForumLockStatus(t,s)}),t.response.hasOwnProperty("whois_data")&&o.set("whois_data",t.response.whois_data),o.set("is_fetching_topics",!1),t.response.hasOwnProperty("deleted_categories")&&_.each(t.response.deleted_categories,function(e){o.deleteCategory(e)}),i&&t.response.hasOwnProperty("stretch_data")&&o.trigger("stretch_data_returned",{data:t.response.stretch_data}))}}))},deleteCategory:function(e){var t="forum"===e.category_type||"forum_class"===e.category_type,i=this.fetchCategory(e.category_id);_.isUndefined(i)||(i.set("deleted",!0),i===this.get("focus_category")&&AoPS.Ui.Modal.showAlert(o["category-deleted"],{width:"400px",onClose:function(){window.location.replace("/community")}}),i.destroy()),t&&this.get("topics").each(function(t){t.get("category_id")===e.category_id&&(t.set("deleted",!0),t.destroy())})},fetchTopicFromDb:function(e){t.add({a:"fetch_topic",params:{topic_id:e.topic_id},main_handler:_.bind(function(t,o){var i;t?(i=this.processPotentialNewTopic(o.response.topic,!1),this.trigger("single_topic_load",{ok:!0,topic:i,topic_id:e.topic_id}),o.response.topic=i,o.response.topic_id=e.topic_id):this.trigger("single_topic_load",{ok:!1,error_code:o.error_code,topic_id:e.topic_id})},this),extra_handlers:e})},fetchTopicFromDbGivenPostId:function(e){t.add({a:"fetch_topic_from_post",params:{post_id:e.post_id},never_cancel:!0,main_hander:_.bind(function(e,t){var o;e&&(o=this.processPotentialNewTopic(t.response.topic,!1),t.response.topic=o)},this),extra_handlers:e})},hasLongNewItemInterval:function(){return!AoPS.hasOwnProperty("router_root")||"community"!==AoPS.router_root&&"class"!==AoPS.router_root},onGlobalAnnounceDemote:function(e){"global"!==e.get("announce_type")&&this.get("global_announcements").remove(e)},processPotentialNewTopic:function(t,o){var i=this.fetchTopicById(t.topic_id);return _.isNull(i)?(t.master=this,t=this.checkLoadedTopicPermissions(t),i=new e.Topic(t),this.get("topics").add(i,{force_to_active:o}),"global"===i.get("announce_type")&&this.get("global_announcements").add(i)):i.processTopicUpdate(t),i},checkLoadedTopicPermissions:function(e){var t;return e.hasOwnProperty("permissions")||(t=this.fetchCategory(e.category_id),_.isUndefined(t)&&(console.log("uh-oh; you are parsing a new topic without permissions, and its category has not been loaded yet."),console.log("Category id is ".topic.category_id)),e.permissions=t.get("permissions")),e},processPotentialNewTopics:function(e,t){var o=this;return topics_models=[],_.each(e,function(e){topics_models.push(o.processPotentialNewTopic(e,t))}),topics_models},fetchCategory:function(e){var t=this.get("categories").find(function(t){return t.get("category_id")===parseInt(e)});return _.isUndefined(t),t},fetchPrivCategory:function(e){var t=this.get("priv_categories").find(function(t){return t.get("user_id")===parseInt(e)});return _.isUndefined(t),t},buildPrivCategory:function(o){var i=this;t.add({a:"fetch_priv_category_data",params:{user_id:o.user_id},main_handler:function(t,o){if(t){o.response.category.visited=!0,o.response.category.master=i;var s=new e.CategoryPriv(o.response.category);i.get("priv_categories").add(s),o.response.category=s}},extra_handlers:o})},buildCategory:function(e){var o=this;t.add({a:"fetch_category_data",params:{category_id:e.category_id},main_handler:function(e,t){if(e){t.response.category.visited=!0;var i=o.constructNewCategory(t.response.category);t.response.category=i}},extra_handlers:e})},buildCategoryAndTag:function(e){var o=this;t.add({a:"fetch_category_and_tag_data",params:{category_id:e.category_id,tag_text:e.tag_text},main_handler:function(e,t){if(e){var i=o.constructNewCategory(t.response.category);t.response.category=i}},extra_handlers:e})},fetchTagId:function(e){var o=this,i=this.get("cached_tag_ids");return i.hasOwnProperty(e.tag_text)?void("function"==typeof e.onFinish&&e.onFinish({tag_id:i[e.tag_text]})):void t.add({a:"fetch_tag_id",params:{tag_text:e.tag_text},main_handler:function(t,i){t&&(o.get("cached_tag_ids")[e.tag_text]=parseInt(i.response.tag_id))},extra_handlers:e})},fetchCategoryColors:function(e){var t;return null===e||_.isUndefined(t=this.fetchCategory(e))?{main_color:"#000",secondary_color:"#aaa"}:{main_color:t.get("main_color"),secondary_color:t.get("secondary_color")}},fetchFilteredTopicList:function(t){var o,i;return t=_.defaults(t,{tag_ids:[]}),i=this.get("topic_lists").find(function(e){var o,i;if(e.get("category")!=t.category)return!1;if(t.tag_ids.length>0){if(o=e.get("tag_ids"),o.length!=t.tag_ids.length)return!1;for(i=0;i<o.length;i++)if(o[i].tag_forum_id!=t.tag_ids[i].tag_forum_id||o[i].tag_id!=t.tag_ids[i].tag_id)return!1;return!0}return 0===e.get("tag_ids").length?!0:!1}),_.isUndefined(i)&&(o=this.constructTopicListFilter({category:t.category,tag_ids:t.hasOwnProperty("tag_ids")&&t.tag_ids.length>0?t.tag_ids:[]}),i=new e.TopicList({master:this,filter:o,tag_ids:t.hasOwnProperty("tag_ids")&&t.tag_ids.length>0?t.tag_ids:[],category_id:t.category_id,category:t.category}),this.get("topic_lists").add(i)),i.get("filtered_topic_list")},fetchUser:function(e){var t=!1;return("number"==typeof e||/^\d+$/.test(e))&&(t=!0),t?this.get("users").find(function(t){return t.get("user_id")===parseInt(e)}):this.get("users").find(function(t){return t.get("username").toLowerCase()===e.toLowerCase()})},buildUser:function(e){var o=this;t.add({a:"fetch_user_profile",params:{user_identifier:e.user_identifier},main_handler:function(t,i){var s;if(t){if(e.user_identifier.indexOf("@")>-1&&(s=o.fetchUser(i.response.user_data.user_id),!_.isUndefined(s)))return void(i.response.user_model=s);i.response.user_data.master=o,i.response.user_model=new AoPS.Community.Models.User(i.response.user_data),o.get("users").add(i.response.user_model)}},extra_handlers:e})},banAsSpammer:function(e){t.add({a:"ban_as_spammer",params:{user_id:parseInt(e.user_id)},main_handler:function(e,t){},extra_handlers:e})},submitFriendRequest:function(e){t.add({a:"send_friend_request",params:{new_friend:e.new_friend},main_handler:function(e,t){},extra_handlers:e})},fetchTopicById:function(e){var t=this.get("topics");return e=parseInt(e),0===t.length?null:this.fetchTopicByIdBinary(e,0,t.length-1,t.models)},fetchTopicByIdBinary:function(e,t,o,i){var s,a;return t>o?null:(s=Math.floor((t+o)/2),a=i[s].get("topic_id"),a>e?this.fetchTopicByIdBinary(e,t,s-1,i):e>a?this.fetchTopicByIdBinary(e,s+1,o,i):i[s])},fetchItemName:function(e,t){var o=this.fetchCategory(e),i=o.fetchItem(t);return _.isUndefined(i)&&(o=self.fetchCategory(t.item_forum_id),i=o.fetchItem(t)),i.item_text},fetchPrivateItems:function(e){var t=this.get("my_privates"),o=this,i=this.get("my_privates_archive");t.fetchMoreItems({onFinish:function(){o.set("private_items_fetched",!0),i.set("items",t.get("items")),e.hasOwnProperty("onFinish")&&e.onFinish()}})},checkValidPrivateRecipient:function(e){t.add({a:"check_valid_private_recipient",params:{username:e.username},main_handler:function(e,t){},extra_handlers:e})},constructNewCategory:function(e){var t,o=!0;return e.hasOwnProperty("add_to_master_collection")&&(e.add_to_master_collection||(o=!1),delete e.add_to_master_collection),t=this.constructTemporaryCategory(e),!_.isNull(t)&&o&&this.get("categories").add(t),t},fetchUserSearchCategory:function(e){var t=this.get("user_search_categories").findWhere({user_id:e});return _.isUndefined(t)&&(t=this.constructTemporaryCategory({category_type:"user_search_posts",user_id:e})),this.get("user_search_categories").add(t),t},validateSearchInput:function(e){t.add({a:"validate_search_input",params:{username:e.username,forum:e.forum},main_handler:function(e,t){},extra_handlers:e})},fetchSearchCategory:function(e){var t;return t=this.get("search_categories").findWhere({search_id:e})},buildSearchCategory:function(e){var t,o={category_type:"search",master:this,search_settings:e};return t=this.constructTemporaryCategory(o),this.get("search_categories").add(t),t},constructTemporaryCategory:function(t){var o,i;if(t.hasOwnProperty("category_type")){switch(t.category_type){case"view_topics":o=e.CategoryViewTopics;break;case"feed_topics":o=e.CategoryFeedTopics;break;case"bookmark_topics":o=e.CategoryBookmarkTopics;break;case"view_tags":o=e.CategoryViewTags;break;case"bookmark_tags":o=e.CategoryBookmarkTags;break;case"view_forums":o=e.CategoryViewForums;break;case"bookmark_forums":o=e.CategoryBookmarkForums;break;case"forum":case"forum_class":o=e.CategoryForum;break;case"my_privates":case"my_privates_archive":o=e.CategoryPrivates;break;case"user_search_topics":o=e.CategoryUsersTopics;break;case"user_search_posts":o=e.CategoryUsersPosts;break;case"search":o=e.CategorySearch;break;case"blog":o=e.CategoryBlog;break;case"my_forums":o=e.CategoryMyForums;break;case"my_blogs":o=e.CategoryMyBlogs;break;case"my_collections":o=e.CategoryMyCollections;break;case"my_bookmarks":o=e.CategoryMyBookmarks;break;case"view_posts":o=e.CategoryViewPosts;break;case"user":o=e.CategoryUser;break;default:o=e.Category}return i=new o(_.defaults(t,{master:this}))}return console.log("You tried to build a new category without a category_type."),console.log('Type "HERE COMES AN ERROR" assumed.  Your wish is my command.'),console.log(t),null},constructTopicListFilter:function(e){return _.partial(function(e,t){var o,i;if(e.hasOwnProperty("tag_ids")&&(i=e.tag_ids.length)>0&&0!=e.tag_ids[0].tag_id)for(o=0;i>o;o++)if(t.get("category_id")!=e.tag_ids[o].tag_forum_id||!t.hasTag(e.tag_ids[o].tag_id))return!1;return e.category.filterTopic(t)?!0:!1},e)},constructBookmarkCategories:function(){var e=this;AoPS.session.logged_in&&AoPS.bootstrap_data.hasOwnProperty("feed_fora")&&_.each(AoPS.bootstrap_data.feed_fora,function(t){var o,i=t.category_type;switch(t.no_more_items=!0,o=e.constructNewCategory(t),i){case"bookmark_topics":e.set("bookmarked_topic_category",o);break;case"bookmark_tags":e.set("bookmarked_tag_category",o);break;case"bookmark_forums":e.set("bookmarked_forum_category",o)}})},processTopicTags:function(e){var t,o,i,s,a;e.get("tags_processed")||(e.set("tags_processed",!0),t=this.fetchCategory(e.get("category_id")),_.isUndefined(t)||(o=t.get("items"),i=t.get("category_id"),_.each(e.get("tags"),function(e){if(a=o.length,!e.hasOwnProperty("is_visible")||e.is_visible){for(s=0;a>s;s++)if(o[s].item_id===e.tag_id)return;o.push({item_id:e.tag_id,item_text:e.tag_text,item_forum_id:i,item_type:"tag",item_main_color:t.get("main_color"),item_secondary_color:t.get("secondary_color")})}})))},parseBBCode:function(e){var o=this;this.get("is_parsing_bbcode")||(this.set("is_parsing_bbcode",!0),t.add({a:"parse_post",params:{text:e.text,post_format:e.post_format},main_handler:_.bind(function(e,t){o.set("is_parsing_bbcode",!1)},this),extra_handlers:e}))},isBookmarked:function(e){var t;switch(e.item_type){case"tag":t="bookmarked_tag_category";break;case"topic":t="bookmarked_topic_category";break;case"forum":case"forum_class":t="bookmarked_forum_category"}return this.has(t)?this.get(t).hasItem(e):!1},fetchBookmarkStatus:function(e){var t,o;if(!AoPS.session.logged_in)return{is_bookmarked:!1,in_feed:!1,is_watched:!1};switch(e.item_type){case"tag":o="bookmarked_tag_category";break;case"topic":o="bookmarked_topic_category";break;case"forum":case"forum_class":o="bookmarked_forum_category"}return this.has(o)?(t=this.get(o).fetchItem(e),_.isUndefined(t)?{is_bookmarked:!1,in_feed:!1,is_watched:!1}:{is_bookmarked:!0,in_feed:1==t.in_feed,is_watched:1==t.is_watched}):!1},addTagBookmark:function(e){this.has("bookmarked_tag_category")&&(this.get("bookmarked_tag_category").addItem(e.item),this.get("bookmarked_tag_category").addItemDb({item:e.item,add_to_client:!1,onError:e.hasOwnProperty("onError")?e.onError:function(){}}))},removeTagBookmark:function(e){this.has("bookmarked_tag_category")&&(this.get("bookmarked_tag_category").removeItem(e),this.get("bookmarked_tag_category").removeItemDb({item:e,remove_from_client:!1}))},submitNewTopic:function(e){function o(t){return e.hasOwnProperty(t)&&e[t]?1:0}var i=o("bookmark_feed"),s=o("notify_email");t.add({a:"submit_new_topic",params:{category_id:e.category_id,title:e.title,tags:JSON.stringify(e.tags),linked_tag:e.linked_tag,target_url:e.target_url,target_text:e.target_text,source:e.source,post_as_halp:e.post_as_halp?1:0,pm_as_sheriff:e.pm_as_sheriff?1:0,allow_latex_errors:e.allow_latex_errors?1:0,hidden_tags:JSON.stringify(e.hidden_tags),restricted_tags:JSON.stringify(e.restricted_tags),removed_autotags:JSON.stringify(e.removed_autotags),post_text:e.post_text,notify_email:s,attachments:JSON.stringify(e.attachments),has_poll:e.has_poll,poll_data:1===e.has_poll?JSON.stringify(e.poll_data):JSON.stringify({}),recipients:JSON.stringify(e.recipients),disable_bbcode:o("disable_bbcode"),is_local_announcement:o("is_local_announcement"),is_global_announcement:o("is_global_announcement"),announce_through:e.hasOwnProperty("announce_through")?e.announce_through:""},main_handler:_.bind(function(e,t){var o,a;e&&(o=this.processPotentialNewTopic(t.response.topic,!0),"blog_post"!==o.get("topic_type")&&(1===s||1===i)&&o.setBookmarkState({is_bookmarked:!0,in_feed:1===i,is_watched:1===s}),a=this.fetchCategory(o.get("category_id")),_.isUndefined(a)||(_.each(o.get("tags"),function(e){e.is_visible&&a.addTag(e)}),a.set({num_topics:t.response.topic.category_num_topics,num_posts:t.response.topic.category_num_posts,num_users:t.response.topic.category_num_users})),t.response.topic_model=o)},this),extra_handlers:e,extra_ajax_runner_options:{timeout:AoPS.Community.Constants.posting_ajax_timeout,queue_at_front:!0}})},submitPost:function(e){function o(t){return e.hasOwnProperty(t)&&e[t]?1:0}var i=o("bookmark_feed"),s=!1,a=o("notify_email");("boolean"==typeof e.bookmark_feed||"boolean"==typeof e.notify_email)&&(i!=(e.topic.get("in_feed")?1:0)||a!=(e.topic.get("is_watched")?1:0))&&(s=!0),t.add({a:"submit_post",params:{attachments:JSON.stringify(e.attachments),post_text:e.post_text,notify_email:a,topic_id:e.topic_id,allow_latex_errors:e.hasOwnProperty("allow_latex_errors")&&e.allow_latex_errors?1:0,last_post_num:e.topic.fetchLastLoadedPostNumber(),last_update_time:e.topic.get("last_update_time"),disable_bbcode:o("disable_bbcode"),is_announcement:o("is_announcement")},main_handler:_.bind(function(t,o){t&&(o.response.hasOwnProperty("new_data")&&o.response.new_data&&(e.topic.processTopicUpdate(o.response),e.topic.trigger("new_post_processed",{post_id:o.response.posts_data[0].post_id})),s&&e.topic.resetBookmarkState({is_bookmarked:!0,in_feed:1===i,is_watched:1===a}))},this),extra_handlers:e,extra_ajax_runner_options:{timeout:AoPS.Community.Constants.posting_ajax_timeout,queue_at_front:!0}})},fetchMyAopsCategory:function(e){var o=this;t.add({a:"fetch_my_aops_category",params:{category:e.category},main_handler:function(t,i){var s,a,n=!1;t&&(s=o.constructNewCategory(i.response.category_data.category),o.set(e.category,s),i.response.category_data.hasOwnProperty("items_categories")&&(a=s.get("items"),_.each(i.response.category_data.items_categories,function(e){var t,i;e.category_id>0?(t=o.fetchCategory(e.category_id),_.isUndefined(t)&&(t=o.constructNewCategory(e),n=!0)):t=o.constructNewCategory(e),i=_.findWhere(a,{item_id:e.category_id}),_.isUndefined(i)||n||(e.hasOwnProperty("topics_data")&&"blog"!==t.get("category_type")&&(t.get("active_topics").add(o.processPotentialNewTopics(e.topics_data,!1)),e.all_topics_loaded&&t.set("all_topics_loaded",e.all_topics_loaded)),i.category=t)})),i.response.constructed_category=s)},extra_handlers:e})},checkAddToWatchTimes:function(e){var t=parseInt(moment().format("X")),o=e.time_data;return t-o.model.get(o.int_time_field)<AoPS.Community.Constants.time_limits.watched_times_long?(e.is_already_watched?this.updateLocationOnWatchedTimes(o):this.addToWatchedTimes(o),!0):!1},addToWatchedTimes:function(e){var t=parseInt(moment().format("X")),o=AoPS.Community.Constants.time_limits.watched_times_short;t-e.model.get(e.int_time_field)<o?this.get("watched_times_short").push(e):this.get("watched_times_long").push(e)},updateLocationOnWatchedTimes:function(e){var t,o,i=parseInt(moment().format("X")),s=AoPS.Community.Constants.time_limits.watched_times_short;i-e.model.get(e.int_time_field)<s?(t="watched_times_short",list_to_remove="watched_times_long"):(t="watched_times_long",list_to_remove="watched_times_long"),_.isUndefined(_.findWhere(this.get(t),e))&&(this.get(t).push(e),o=_.findWhere(this.get(list_to_remove),e),this.set(list_to_remove,_.without(this.get(list_to_remove),e)))},rebuildWatchedTimes:function(e){var t=!1;this.get(e).length>AoPS.Community.Constants.max_times_to_watch[e]&&(t=!0,AoPS.Community.Constants.time_limits[e]=Math.floor(.7*AoPS.Community.Constants.time_limits[e])),_.each(this.get(e),function(e){e.model.set(e.rendered_time_field,AoPS.Community.Utils.makePrettyTime(e.model.get(e.int_time_field)))}),t&&this.filterWatchedTimeCollections(e)},filteredWatchedTimes:function(e){var t=parseInt(moment().format("X"))-AoPS.Community.Constants.time_limits[e];_.each(this.get(e),function(e){e.model.get(e.int_time_field)<=t-5&&removed_watch_times.push(e)}),this.set(e,_.without(this.get(e),removed_watch_times)),"watched_times_short"===e&&this.set("watched_times_long",this.get("watched_times_long").concat(removed_watch_items))},fetchWatcherUpdates:function(){var e=this;t.add({a:"fetch_watcher_changes",params:{last_watcher_fetch_time:this.get("last_watcher_fetch_time")},main_handler:function(t,o){(new Date).getTime();t&&(e.set("last_watcher_fetch_time",o.response.watch_time),_.each(o.response.watcher_data,function(t){var o=e.fetchTopicById(t.topic_id);_.isNull(o)||o.set(t)}))},queue_limit:-1})},setBookmarkState:function(e){var t,o,i,s,a=this.get(e.category_string);return e=_.defaults(e,{item_main_color:"",item_secondary_color:"",item_subtitle:""}),this.has(e.category_string)?(e.state.is_bookmarked?(t=e.state,s=e.state):(t={is_watched:e.bookmarked_item.get("is_watched"),in_feed:e.bookmarked_item.get("in_feed")},s={is_bookmarked:!1,in_feed:!1,is_watched:!1}),e.bookmarked_item.set(s),"topic"===e.item_type&&(i=this.fetchTopicById(e.item_id),_.isUndefined(i)||_.isNull(i)||(i!==e.bookmarked_item&&i.set(s),this.get("topics").remove(i,{removed_by:"topic_update"}),this.get("topics").add(i,{added_by:"topic_update"}))),o={item:{item_id:e.item_id,item_forum_id:0,item_type:e.item_type,item_text:e.item_text,in_feed:t.in_feed?1:0,is_watched:t.is_watched?1:0,item_main_color:e.item_main_color,item_secondary_color:e.item_secondary_color,item_subtitle:e.item_subtitle}},e.hasOwnProperty("onError")&&(o.onError=e.onError),e.hasOwnProperty("onFinish")&&(o.onFinish=e.onFinish),a[e.bookmarked_item.get("is_bookmarked")?"addItemDb":"removeItemDb"](o),!0):!1},setUserBookmarkState:function(e){var i,a,n=this;e.user.set("is_bookmarked",!e.user.get("is_bookmarked")),a=e.user.get("is_bookmarked"),a&&(i={item_id:e.user.get("user_id"),item_forum_id:0,item_type:"user",item_text:e.user.get("username"),in_feed:0,is_watched:0,item_main_color:s.community_main_color,item_secondary_color:s.community_secondary_color,item_subtitle:"",last_active:e.user.get("last_visit"),avatar:e.user.get("avatar")}),t.add({a:"bookmark_user",params:{bookmarked_user_id:e.user.get("user_id"),bookmark_action:e.user.get("is_bookmarked")?1:0},main_handler:function(t,s){var r,l;t?n.get("current_user").has("bookmark_users")&&(l=n.get("current_user").get("bookmark_users"),l>0&&(r=n.fetchCategory(n.get("current_user").get("bookmark_users")),_.isUndefined(r)||(a?r.addItem(i):r.removeItem({item_id:e.user.get("user_id"),item_forum_id:0,item_type:"user"})))):("string"==typeof o["user-bookmark-err-"+s.error_code]?AoPS.Community.Views.showError(o["user-bookmark-err-"+s.error_code]):AoPS.Community.Views.showError(o["unexpected-error-code"]+s.error_code),e.user.set("is_bookmarked",!1))}})},addBookmarkForumViaAdmin:function(e){var t,o=e.item;"forum"!==o.item_type&&console.log("You sent the wrong type of item to addBookmarkForum.  You					deserve the error report this user will give you."),t=this.fetchCategory(parseInt(o.item_id)),_.isUndefined(t)&&(t=this.constructTemporaryCategory({category_type:"forum"})),o.bookmarked_item=t,e.hasOwnProperty("onError")&&(o.onError=e.onError),o.category_string="bookmarked_forum_category",this.setBookmarkState(o)},fetchReportedPosts:function(e){var o=this,i=0;arguments.length>0?i=e.hasOwnProperty("fetch_before")?e.fetch_before:0:e={},this.get("loading_post_reports")||(this.set("loading_post_reports",!0),AoPS.session.logged_in&&t.add({a:"fetch_reported_posts",params:{last_reported_posts_fetch_time:this.get("last_reported_posts_fetch_time"),init_time:parseInt(AoPS.bootstrap_data.init_time),fetch_before:i},main_handler:function(e,t){e&&(_.each(t.response.reported_posts,function(e){var t;found_new_report=!1,e.hasOwnProperty("topic")&&_.isUndefined(o.get("reported_posts").findWhere({id:e.id}))&&(found_new_report=!0,e.topic.master=o,t=new AoPS.Community.Models.Topic(e.topic),e.post_data.topic=t,t.get("posts").add(e.post_data),e.post=t.get("posts").models[0],delete e.topic,o.get("reported_posts").add(e))}),0==i&&o.set("last_reported_posts_fetch_time",t.response.fetch_time),t.response.hasOwnProperty("resolved_reports")&&_.each(t.response.resolved_reports,function(e){var t=o.get("reported_posts").findWhere({id:e.id});_.isUndefined(t)||t.set("status","resolved"),o.resetTopicReports({topic_id:e.topic_id,post_id:e.post_id,topic_num_reports:-1})})),o.trigger("post_reports_fetched"),i>0&&!found_new_report&&o.set("all_past_reported_posts_fetched",!0),o.set("loading_post_reports",!1)},extra_handlers:e}))},resetTopicReports:function(e){var t,o=this.fetchTopicById(e.topic_id);_.isNull(o)||(t=o.get("posts").findWhere({post_id:e.post_id}),_.isUndefined(t)||t.set("reported",!1),-1==e.topic_num_reports?o.set("num_reports",o.get("num_reports")-1):o.set("num_reports",e.topic_num_reports),e.hasOwnProperty("remove_report")&&e.remove_report&&this.get("reported_posts").remove(e.report))},closePostReports:function(e){var t=this.get("reported_posts").where({post_id:e});_.each(t,function(e){e.set("status","resolved")}),this.get("reported_posts").remove(t)},fetchPermission:function(e){var t=this.get("permissions");return t.hasOwnProperty(e)&&t[e]},validateConstructCategory:function(e){function t(t){e.hasOwnProperty("onError")&&e.onError(t)}var o;switch(e.type){case"forum":case"view_tags":case"view_topics":case"view_posts":case"folder":case"blogroll":o="can_create_category";break;case"blog":o="can_create_blog";break;default:return t("E_BAD_TYPE"),!1}return this.fetchPermission(o)?!0:(t("E_NO_PERMISSION"),!1)},getDefaultContainers:function(e){var t=[];switch(e){case"forum":break;case"view_tags":case"folder":break;case"blogroll":}return t},setTopicsForumLockStatus:function(e,t){var o,i=this.get("topics").models,s=i.length;for(o=0;s>o;o++)i[o].get("category_id")===e&&i[o].set("forum_locked",t)},setCategoryLockStatus:function(e,t){var o=this.fetchCategory(e);_.isUndefined(o)||o.setFrontEndLocked(t)},resetCategory:function(e){var t,o=this.fetchCategory(e),i=[];_.isUndefined(o)||(t=o.get("active_topics"),i=t.filter(function(e){return"none"!==e.get("announce_type")}),t.reset(),t.add(i))},fetchLogResults:function(e){var o=this;t.add({a:"fetch_log",params:e.params,main_handler:function(e,t){e&&(t.response.all_fetched&&o.trigger("all_log_entries_fetched"),o.trigger("log_entry_fetch_time",{time:t.response.fetch_time}))},extra_handlers:e})},revertActions:function(e){t.add({a:"revert_actions",params:{log_ids:JSON.stringify(e.log_ids),table_type:e.table_type},main_handler:function(e,t){e&&t.response.all_fetched&&self.trigger("all_log_entries_fetched")},extra_handlers:e})},validateAdmin:function(e){t.add({a:"validate_admin",params:{pwd:e.pwd},main_handler:function(e,t){},extra_handlers:e})},sendPolymathConfirm:function(e){t.add({a:"send_polymath_confirm",params:{category_id:e.category_id,selected_option:e.selected_option,student_type:e.student_type},main_handler:function(e,t){},extra_handlers:e})}}),e.Feed=Backbone.Model.extend({defaults:{initialized:!1,focus_topic_show_from:"show_from_start",feed_setting:AoPS.bootstrap_data.hasOwnProperty("feed_init_setting")?AoPS.bootstrap_data.feed_init_setting:7,focus_topic:null,global_feed_type:"full",on_initial_feed_fetch:!1
},initialize:function(){this.get("master").set("feed",this),this.set("page_subfeed_settings",{}),this.on("change:focus_topic",this.onChangeFocusTopic),this.on("change:feed_setting",this.onChangeFeedSetting),AoPS.bootstrap_data.hasOwnProperty("global_feed_settings")&&(this.set("global_feed_type",AoPS.bootstrap_data.global_feed_settings.global_feed_type),"custom"===this.get("global_feed_type")&&(AoPS.bootstrap_data.global_feed_settings.hasOwnProperty("global_feed_fora")&&AoPS.bootstrap_data.global_feed_settings.global_feed_fora.length>0?this.set("global_feed_fora",AoPS.bootstrap_data.global_feed_settings.global_feed_fora):this.set("global_feed_type","full")))},onChangeFocusTopic:function(e){var o=this.get("focus_topic"),i=this.previous("focus_topic");3===arguments.length&&arguments[2].hasOwnProperty("no_ajax_override")&&arguments[2].no_ajax_override||t.cancelAll({cancel_type:"feed"}),_.isNull(i)||i.set("is_feed_focus",!1),_.isNull(o)||o.set("is_feed_focus",!0),this.get("master").makeChangeFocusTopicAjaxCall({new_focus:o,previous_focus:i,source:"feed",hash:this.get("master").get("watcher_hash")})},onChangeFeedSetting:function(){t.add({a:"change_feed_setting",params:{feed_setting:this.get("feed_setting")},main_handler:function(e,t){}})},fetchInitialSubfeedTopics:function(e){var o,i=_.map(e,function(e){return e.params.a=e.a,e.params}),s=this,a=e.length;this.set("on_initial_feed_fetch",!0),t.add({a:"run_multiple_ajax_calls",params:{type:"initial_feed_fetch",data:JSON.stringify(i)},never_cancel:!0,main_handler:function(t,i){if(t)for(s.set("initialized",!0),o=0;a>o;o++)e[o].main_handler(!0,{response:i.response.results[o]})},extra_handlers:{onFinish:function(t){for(o=0;a>o;o++)e[o].hasOwnProperty("extra_handlers")&&e[o].extra_handlers.hasOwnProperty("onFinish")&&e[o].extra_handlers.onFinish(t.results[o]);s.set("on_initial_feed_fetch",!1)},onError:function(t){for(o=0;a>o;o++)e[o].hasOwnProperty("extra_handlers")&&e[o].extra_handlers.hasOwnProperty("onError")&&e[o].extra_handlers.onError(t)}},source:"feed"})}}),e.UserList=Backbone.Model.extend({defaults:{all_fetched:!1,is_loading:!1,sort_column:"joined_at",sort_direction:"DESC",start_from:0,stub:""},initialize:function(){this.has("users")||this.set("users",[])},fetchMoreUsers:function(e){var o=this;this.get("all_fetched")||this.get("is_loading")||(this.set("is_loading",!0),t.add({a:"fetch_more_users",params:{stub:this.get("stub"),sort_column:this.get("sort_column"),sort_direction:this.get("sort_direction"),start_from:this.get("start_from")},main_handler:function(e,t){var i,s,n,r=[];o.get("users");if(e)if(i=t.response,0==i.num_parsed)o.set("all_fetched",!0);else{if(n=o.get("users").length,0==n)r=i.users;else for(s=0;n>s;s++)if(!o.isUserFetched(i.users[s])){r=i.users.slice(s);break}_.each(r,function(e){e.last_visit>0?e.last_visit=a.makePrettyTime(e.last_visit):e.last_visit="",e.joined_at=a.makePrettyTime(e.joined_at)}),o.get("users").push(r),t.response.new_users=r,o.set("start_from",o.get("start_from")+i.num_parsed)}o.set("is_loading",!1)},extra_handlers:e}))},isUserFetched:function(e){var t=this.get("users"),o=t.length,s=Math.max(0,o-15);for(i=o-1;i>=s;i--)if(t[i].user_id===e.user_id)return!0;return!1}}),e.Category=e.Model.extend({defaults:{all_subcategories_loaded:!1,can_add:!1,can_add_type:"none",can_own_topics:!1,can_mark_all_read:!1,can_post:!1,can_remove_self:!0,can_target:!1,category_id:0,category_name:"",category_type:"",deleted:!1,has_halp:!1,has_source:!1,has_tag_filter:!1,has_topics:!1,hide_desc_on_phone:!1,in_feed:0,is_forum:!1,is_bookmark_category:!1,is_bookmarked:!1,is_locked:!1,is_my_category:!1,is_my_private:!1,is_post_search:!1,is_private:!1,is_public:!0,is_watched:0,last_item_level:0,last_item_score:0,loading_subcategories:!1,main_color:"#000000",no_more_items:!1,reset_on_items_change:!1,secondary_color:"#6c6c6c",short_description:"",special_url:"",subcategories_data_loaded:!1,visited:!1},initialize:function(){this.setDefault("forum_ids",[]),this.setDefault("items",[]),this.setDefault("users",[]),this.setDefault("forums",{})},setFrontEndLocked:function(e){this.set("is_locked",e),this.get("can_own_topics")&&this.get("master").setTopicsForumLockStatus(this.get("category_id"),e)},getPermission:function(e){return this.has("permissions")||console.log("Permission sought before permissions set for category "+this.get("category_name")),_.isUndefined(this.get("permissions")[e])&&console.log("Permissions have not been set for key "+e+" of Category "+this.get("category_name")),this.get("permissions")[e]},fetchItemsByType:function(e){return _.where(this.get("items"),{item_type:e})},fetchItemFromDb:function(e){t.add({a:"fetch_specific_item",params:{category_id:this.get("category_id"),item_id:e.item_id,item_forum_id:e.forum_id,item_type:e.item_type},main_handler:_.bind(function(e,t){e?t.response.success&&this.addItem(t.response.item):this.trigger("item_db_fetch_failed")},this),extra_handlers:e})},fetchMoreItems:function(e){var o=this,i=0===arguments.length?{}:e;this.get("fetching_items")||(this.set("fetching_items",!0),this.get("no_more_items")||(t.add({a:"fetch_more_items",params:{category_id:this.get("category_id"),last_item_score:this.get("last_item_score"),last_item_level:this.get("last_item_level"),last_item_text:this.get("last_item_text"),log_visit:this.get("visited")?0:1,start_num:this.get("items").length,fetch_all:e.hasOwnProperty("fetch_all")&&e.fetch_all?1:0},main_handler:function(e,t){var i=!1;e&&t.response.hasOwnProperty("items")&&(_.each(t.response.items,function(e){i=o.addItem(e)||i}),i?t.response.hasOwnProperty("no_more_items")&&o.set("no_more_items",t.response.no_more_items):o.set("no_more_items",!0),o.set("last_item_score",t.response.last_item_score),o.set("last_item_text",t.response.last_item_text)),o.set("fetching_items",!1)},extra_handlers:i}),this.set("visited",!0)))},fetchItemsForEdit:function(e){var o=this;t.add({a:"fetch_items_for_edit",params:{category_id:this.get("category_id")},main_handler:function(e,t){var i=[];e&&(_.each(t.response.items_for_edit,function(e){e.edit_state="saved"}),o.set("items_for_edit",t.response.items_for_edit),t.response.hasOwnProperty("available_items")&&(_.each(t.response.available_items,function(e){o.hasItem(e)||i.push(e)}),o.set("available_items",i)))},extra_handlers:e})},canAddEditItems:function(){var e=0;return this.has("item_limit")&&0!==this.get("item_limit")?(_.each(this.get("items_for_edit"),function(t){"deleted"!==t.edit_state&&e++}),e<this.get("item_limit")):!0},getSortDescription:function(e){return this.get("category_id")===s.other_forums_id?o["cat-admin-sort-type-system-other_forums"]:"system"===e?"string"==typeof o["cat-admin-sort-type-system-"+this.get("category_type")]?o["cat-admin-sort-type-system-"+this.get("category_type")]:o["cat-admin-sort-type-system-default"]:o["cat-admin-sort-type-"+e]},deleteEditItem:function(e){return"saved"===e.edit_state?(e.edit_state="deleted",!1):(e.edit_state="available",this.set("items_for_edit",_.without(this.get("items_for_edit"),e)),!0)},isActiveEditItem:function(e){var t=_.findWhere(this.get("items_for_edit"),{item_id:e.item_id,item_forum_id:e.item_forum_id,item_type:e.item_type});return!_.isUndefined(t)},fetchTopicEditItem:function(e){t.add({a:"fetch_topic_for_view",params:{category_id:this.get("category_id"),topic_id:e.topic_id},main_handler:function(e,t){},extra_handlers:e})},fetchAvailableItem:function(e){return _.findWhere(this.get("available_items"),{item_id:e.item_id,item_forum_id:e.item_forum_id,item_type:e.item_type})},fetchEditItem:function(e){return _.findWhere(this.get("items_for_edit"),{item_id:e.item_id,item_forum_id:e.item_forum_id,item_type:e.item_type})},addToEditItems:function(e){var t=this.fetchEditItem(e);_.isUndefined(t)&&this.get("items_for_edit").push(e)},removeAvailableItem:function(e){var t=this.fetchAvailableItem(e);_.isUndefined(t)||this.set("available_items",_.without(this.get("available_items"),t))},addToAvailableItems:function(e){var t=this.fetchAvailableItem(e);_.isUndefined(t)&&this.get("available_items").push(e)},saveItemEdits:function(e){var o=[];_.each(this.get("items_for_edit"),function(e){"added"!==e.edit_state?o.push(_.omit(e,"post_data")):o.push(e)}),t.add({a:"save_item_edits",params:{change_sort_type:e.change_sort_type?1:0,sort_type:e.sort_type,edited_items:JSON.stringify(o),category_id:this.get("category_id")},main_handler:function(e,t){},extra_handlers:e})},hasItem:function(e){return!_.isUndefined(this.fetchItem(e))},makeItemOfThis:function(){return{category_id:this.get("category_id"),category_type:this.get("category_type"),is_visible:!0,item_forum_id:0,label:this.get("category_name"),main_color:this.get("main_color"),secondary_color:this.get("category_color"),short_description:this.get("short_description"),value:this.get("category_name")}},fetchMoreCategoryItems:function(e){var o,i,s,a,n,r=e.start_idx,l=this.get("items"),c=[],d=0,h=this,m=this.get("master");if(!this.get("all_subcategories_loaded")&&!this.get("loading_subcategories")){for(i=l.length,o=r;i>o&&d<AoPS.Community.Constants.max_categories_to_load;o++)s=l[o],s.hasOwnProperty("category")||("user"===s.item_type?(c.push(s),d++):(n=m.fetchCategory(s.item_id),_.isUndefined(n)?(c.push(s),d++):s.category=n));if(a={sought_category_ids:JSON.stringify(_.pluck(c,"item_id")),parent_category_id:this.get("category_id"),seek_items:0},d<AoPS.Community.Constants.max_categories_to_load&&!this.get("no_more_items")&&(a.seek_items=1,a.start_num=this.get("items").length),this.get("no_more_items")&&0===d)return this.set("all_subcategories_loaded",!0),void h.trigger("subcategories_loaded");a.log_visit=this.get("visited")?0:1,this.set("visited",!0),this.set("loading_subcategories",!0),t.add({a:"fetch_items_categories",params:a,main_handler:function(e,t){if(e){t.response.hasOwnProperty("categories")&&(_.each(t.response.categories,function(e){var t,o=m.constructNewCategory(e);t=_.findWhere(c,{item_id:"bookmark_users"===h.get("category_type")?e.user_id:e.category_id}),_.isUndefined(t)||(t.category=o)}),t.response.categories.length<c.length&&_.each(c,function(e){var o=_.findWhere(t.response.categories,{category_id:e.item_id});_.isUndefined(o)&&h.removeItem(e)})),t.response.hasOwnProperty("new_items")&&_.each(t.response.new_items,function(e){var t=m.fetchCategory(e.category.category_id);_.isUndefined(t)?(t=m.constructNewCategory(e.category),e.category=t):e.category=t,h.addItem(e)}),t.response.hasOwnProperty("no_more_items")&&h.set("no_more_items",t.response.no_more_items),h.set("loading_subcategories",!1),h.trigger("subcategories_loaded")}}})}},fetchUsersData:function(){var e=[],o={};if(this.has("items")&&0!==this.get("items").length){(new Date).getTime();_.each(this.get("items"),function(t){"forum"===t.item_type&&t.hasOwnProperty("category")&&(e.push(t.item_id),o[t.item_id]=t.category)}),e.length>AoPS.Community.Constants.max_forums_user_update||t.add({a:"fetch_forum_users",params:{forum_ids:e.join(",")},main_handler:function(e,t){e&&_.each(t.response.forum_data,function(e){o.hasOwnProperty(e.forum_id)&&o[e.forum_id].set("num_users",e.num_users)})},queue_limit:-1})}},addItem:function(e){var t;if(!(1!==arguments.length&&arguments[1].hasOwnProperty("no_check_existing")&&arguments[1].no_check_existing||(t=this.fetchItem(e),_.isUndefined(t)||_.isNull(t)))){if(t.item_text===e.item_text)return!1;this.set("items",_.without(this.get("items"),t))}return 2===arguments.length&&arguments[1].hasOwnProperty("add_to_front")&&arguments[1].add_to_front?this.get("items").unshift(e):this.get("items").push(e),e.hasOwnProperty("category")||this.set("all_subcategories_loaded",!1),this.trigger("item_added",e),!0},addItems:function(e){var t=this;_.each(e,function(e){t.addItem(e)})},addItemsFront:function(e){var t,o=this,i=e.length;for(t=i-1;t>=0;t--)o.addItem(e[t],{add_to_front:!0})},fetchItem:function(e){var t=_.find(this.get("items"),function(t){return t.item_id===e.item_id&&t.item_forum_id===e.item_forum_id&&t.item_type===e.item_type});return t},addItemDb:function(e){var i=_.extend({in_feed:!1,is_watched:!1},e.item);e=_.defaults(e,{add_to_client:!0,add_to_client_immediately:!1}),e.add_to_client_immediately&&this.addItem(e.item),i.in_feed=i.in_feed?1:0,i.is_watched=i.is_watched?1:0,t.add({a:"add_item_to_category",params:_.extend({category_id:this.get("category_id")},i),main_handler:_.bind(function(t,i){var s;t?e.add_to_client&&!e.add_to_client_immediately&&this.addItem(e.item):"E_ITEM_NUM_LIMITED"===i.error_code&&(AoPS.Ui.Flyout.display(o["err-bookmark-limit-reached"]),"topic"===e.item.item_type?(s=this.get("master").fetchTopicById(parseInt(e.item.item_id)),_.isNull(s)||s.set({is_bookmarked:!1,in_feed:!1,is_watched:!1})):"forum"===e.item.item_type?(s=this.get("master").fetchCategory(parseInt(e.item.item_id)),_.isUndefined(s)||s.set({is_bookmarked:!1,in_feed:!1,is_watched:!1})):"tag"===e.item.item_type&&(s=this.get("master").fetchCategory(parseInt(e.item.item_forum_id)),_.isUndefined(s)||(this.get("master").get("bookmarked_tag_category").removeItem(e.item),s.trigger("reset_tag_bookmark"))))},this),extra_handlers:e})},removeItem:function(e){var t=this.fetchItem(e);_.isUndefined(t)||_.isNull(t)||(this.set("items",_.without(this.get("items"),t)),this.trigger("item_removed",t))},removeItemDb:function(e){var o=_.extend({remove_from_client:!0,remove_from_client_immediately:!1},e);o.remove_from_client_immediately&&this.removeItem(o.item),o.item.hasOwnProperty("category")&&delete o.item.category,t.add({a:"remove_item_from_category",params:_.extend({category_id:this.get("category_id")},o.item),main_handler:_.bind(function(e,t){e&&o.remove_from_client&&!o.remove_from_client_immediately&&this.removeItem(o.item)},this),extra_handlers:o})},hasItems:function(){return this.has("items")&&this.get("items").length>0},makeItemAutocompleteCall:function(e,o,i){t.clearCallsOfType(e),t.add({a:e,params:o,main_handler:_.bind(function(e,t){var o;if(e){if(i.hasOwnProperty("checkSquelch")&&i.checkSquelch())return void i.response([]);o=_.map(t.response.items,function(e){return _.defaults(e,{label:e.value})}),i.hasOwnProperty("checkInputExists")&&i.checkInputExists()&&(i.response(o),0===o.length&&i.hasOwnProperty("onNoMatch")&&i.onNoMatch(),o.length>0&&i.hasOwnProperty("onMatch")&&i.onMatch())}else i.response([])},this)})},fetchItemAutocompleteMatches:function(e){this.makeItemAutocompleteCall("fetch_item_autocomplete_matches",{tag_stub:e.request.term,category_id:this.get("category_id")},e)},markVisited:function(){this.get("is_forum")&&AoPS.session.logged_in&&(this.get("is_watched")||this.get("is_monitored")&&this.getPermission("c_can_monitor"))&&t.add({a:"mark_category_visited",params:{category_id:this.get("category_id")},main_handler:function(e,t){}})},checkUserRole:function(e){var t=e.toLowerCase(),o=_.find(this.get("users"),function(e){return e.username.toLowerCase()===t});return _.isUndefined(o)?{role:"none"}:o},updateUserRole:function(e,o){this.get("category_id")>0&&t.add({a:"update_category_user",params:{category_id:this.get("category_id"),user_id:e.user_id,role:o},main_handler:function(e,t){}}),this.updateUserRoleInModel(e,o)},updateUserRoleInModel:function(e,t){var o=_.findWhere(this.get("users"),{user_id:parseInt(e.user_id)});_.isUndefined(o)||(o.role=t),this.trigger("users_changed")},checkAddedUsername:function(e){t.add({a:"check_username_added_to_category",params:{username:e.username},main_handler:function(e,t){},extra_handlers:e})},addUser:function(e){this.get("category_id")>0&&t.add({a:"add_category_user",params:{category_id:this.get("category_id"),user_id:e.user_id,role:e.role},main_handler:function(e,t){}}),this.addUserToModel(e)},addUserToModel:function(e){var t,o,i=this.get("users"),s=!1,a=e.username.toLowerCase(),n=i.length,r={user_id:parseInt(e.user_id),username:e.username,role:e.role,is_admin:parseInt(e.is_admin)};for(t=n-1;t>=0;t--){if(o=a.localeCompare(i[t].username.toLowerCase()),0===o)return!1;if(o>0){i.splice(t+1,0,r),s=!0;break}}s||i.splice(0,0,r),this.trigger("users_changed")},removeUser:function(e){var o,i=this.get("users");o=_.findWhere(i,{user_id:parseInt(e.user_id)}),_.isUndefined(o)||(this.get("category_id")>0&&t.add({a:"remove_category_user",params:{category_id:this.get("category_id"),user_id:o.user_id},main_handler:function(e,t){},extra_handlers:e}),this.removeUserFromModel(o))},removeUserFromModel:function(e){this.set("users",_.without(this.get("users"),e)),this.trigger("users_changed")},removeUsersByRole:function(e){this.set("users",_.reject(this.get("users"),function(t){return t.role===e}))},setLockedStatus:function(e){var o=this;this.get("category_id")>0?t.add({a:"set_category_lock_status",params:{category_id:this.get("category_id"),is_locked:e.is_locked?1:0},main_handler:function(t,i){t&&o.setFrontEndLocked(e.is_locked)},extra_handlers:e}):this.set("is_locked",e.is_locked)},toggleIsPublic:function(e){this.get("category_id")>0&&t.add({a:"set_is_public",params:{category_id:this.get("category_id"),is_public:this.get("is_public")?0:1},main_handler:function(e,t){},extra_handlers:e})},setHasSource:function(e){t.add({a:"set_has_source",params:{category_id:this.get("category_id"),has_source:e.has_source?1:0},main_handler:function(e,t){}}),this.set("has_source",e.has_source)},getAdminLangType:function(){switch(this.get("category_type")){case"forum":case"forum_class":return"forum";case"blog":return"blog";default:return"collection"}},setAdminItemSetting:function(e){t.add({a:"set_category_admin_item",params:{category_id:this.get("category_id"),setting:e.setting,value:e.value},main_handler:function(e,t){}})},burnNewCategory:function(e){var o,i,s=this;o={category_type:this.get("category_type"),category_name:this.get("category_name"),short_description:this.get("short_description"),role_inheritance_parent:this.has("role_inheritance_parent")&&!_.isNull(this.get("role_inheritance_parent"))?parseInt(this.get("role_inheritance_parent").item_id):0,users:JSON.stringify(this.get("users")),is_public:this.get("is_public")?1:0,is_locked:this.get("is_locked")?1:0,has_items:0,has_source:this.get("has_source")?1:0},"blog"===this.get("category_type")&&(i={},_.each(["show_profile_info","show_stats","show_shoutbox","show_contributors","show_tags","blog_post_comment_text","blog_comments_text","blog_one_comment_text","blog_no_comments_text"],function(e){var t=s.get(e);"boolean"==typeof t&&(t=t?1:0),i[e]=t}),o.blog_settings=JSON.stringify(i),o.is_primary_blog=s.get("is_primary_blog")?1:0),this.get("items").length>0&&(o.has_items=1,o.items=JSON.stringify(this.get("items"))),t.add({a:"build_new_category",params:o,main_handler:function(e,t){},extra_handlers:e})},saveCoreDataToDb:function(e){t.add({a:"save_core_data",params:{category_id:this.get("category_id"),category_name:this.get("category_name"),short_description:this.get("short_description")},main_handler:function(e,t){},extra_handlers:e})},removeInheritanceParent:function(){t.add({a:"remove_inheritance_parent",params:{category_id:this.get("category_id")},main_handler:function(e,t){}})},setRoleInheritanceParent:function(e){t.add({a:"set_inheritance_parent",params:{category_id:this.get("category_id"),parent_id:e.parent_id},main_handler:function(e,t){},extra_handlers:e})},fetchCategoryAdminData:function(e){var o=this;t.add({a:"fetch_category_admin_data",params:{category_id:this.get("category_id"),get_items:o.get("no_more_items")?0:1,start_item_num:this.get("items").length},main_handler:function(e,t){e&&(o.set("users",t.response.users),t.response.hasOwnProperty("items")&&_.each(t.response.items,function(e){o.addItem(e)}),t.response.hasOwnProperty("containers")&&o.constructContainersModel(t.response.containers),t.response.hasOwnProperty("role_inheritance_parent")&&o.set("role_inheritance_parent",t.response.role_inheritance_parent),t.response.hasOwnProperty("allowed_item_sort_types")&&o.set("allowed_item_sort_types",t.response.allowed_item_sort_types),t.response.hasOwnProperty("item_limit")&&o.set("item_limit",t.response.item_limit),"forum_class"===o.get("category_type")&&t.response.hasOwnProperty("class_id")&&o.set("class_id",t.response.class_id))},extra_handlers:e})},convertToContainer:function(e){return _.extend({category_id:this.get("category_id"),category_name:this.get("category_name"),short_description:this.get("short_description"),can_remove:0,main_color:this.get("main_color"),secondary_color:this.get("secondary_color")},e)},constructContainersModel:function(t){var o,i=_.map(t,function(e){return{item_id:e.category_id,item_forum_id:0,item_type:"folder",item_text:e.category_name,item_subtitle:e.short_description,item_can_remove:e.can_remove,item_main_color:e.main_color,item_secondary_color:e.secondary_color}});o=new e.ContainerHolder({category_id:this.get("category_id"),category_type:this.get("category_type"),category_name:this.get("category_name"),category:this,items:i}),this.set("container_model",o)},canAddItem:function(){return this.get("is_locked")?this.getPermission("c_can_override_lock"):this.getPermission("c_can_add_item")},canRemoveItem:function(){return this.get("is_locked")?this.getPermission("c_can_override_lock"):this.getPermission("c_can_remove_item")},startUsersMonitoring:function(){var e=this;this.get("master").constructIntervalAjax({interval_monitor_model:this,interval_id_property:"forums_users_monitor",interval_property:"fetch_forum_users_interval",method:function(){e.fetchUsersData()}})},stopUsersMonitoring:function(){this.has("forums_users_monitor")&&clearTimeout(this.get("forums_users_monitor"))},updateGlobalFeedSetting:function(e){t.add({a:"change_cat_global_feed",params:{category_id:this.get("category_id"),new_setting:e.new_setting},main_handler:function(e,t){},extra_handlers:e})},"delete":function(e){t.add({a:"delete_category",params:{category_id:this.get("category_id"),delete_type:e.delete_type},main_handler:function(e,t){},extra_handlers:e})}}),e.CategoryMyForums=e.Category.extend({defaults:_.defaults({can_add_type:"forum",is_my_category:!0,category_type:"my_forums"},e.Category.prototype.defaults),initialize:function(){e.Category.prototype.initialize.apply(this),this.get("master").get("current_user").get("is_new_user")&&this.set("long_description",this.get("long_description")+o["new-user-my-forums"])}}),e.CategoryMyBlogs=e.Category.extend({defaults:_.defaults({can_add_type:"blog",is_my_category:!0,category_type:"my_blogs"},e.Category.prototype.defaults),initialize:function(){e.Category.prototype.initialize.apply(this),this.get("master").get("current_user").get("is_new_user")&&this.set("long_description",this.get("long_description")+o["new-user-my-blogs"])}}),e.CategoryMyCollections=e.Category.extend({defaults:_.defaults({can_add_type:"collection",is_my_category:!0,category_type:"my_collections"},e.Category.prototype.defaults),initialize:function(){e.Category.prototype.initialize.apply(this),this.get("master").get("current_user").get("is_new_user")&&this.set("long_description",this.get("long_description")+o["new-user-my-collections"])}}),e.CategoryViewPosts=e.Category.extend({defaults:_.defaults({category_type:"view_posts"},e.Category.prototype.defaults),createViewPostItem:function(e){t.add({a:"create_view_posts_item",params:{category_id:this.get("category_id"),post_type:e.post_type,post_label:e.post_label,post_id:e.post_id,hide_label:e.hide_label,custom_text:e.custom_text},main_handler:function(e,t){},extra_handlers:e})}}),e.CategoryWithTopics=e.Category.extend({defaults:_.defaults({all_topics_loaded:!1,are_announcements_fetched:!0,has_topics:!0,show_announcements:!1},e.Category.prototype.defaults),initialize:function(){var t=this.get("master").get("topics");e.Category.prototype.initialize.apply(this),this.buildTopicsCollections(),this.listenTo(t,"add",this.onAddMasterTopic),this.listenTo(t,"remove",this.onRemoveMasterTopic)},onRemoveMasterTopic:function(e,t,o){this.get("active_topics").remove(e,o)},onAddMasterTopic:function(e,t,o){var i=this.get("active_topics");o.hasOwnProperty("fetching_category")&&o.fetching_category==this.get("category_id")||!this.filterTopic(e)||(o.hasOwnProperty("force_to_active")&&o.force_to_active||this.get("all_topics_loaded")||i.length>0&&-this.topicsComparator(e)>=-this.topicsComparator(this.get("active_topics").last()))&&this.get("active_topics").add(e,o)},constructFetchTopicsArguments:function(t){var o=this.get("master").get("topics"),i=t.hasOwnProperty("tag_ids")&&t.tag_ids.length>0,a=[],n=((new Date).getTime(),this.get("category_type"),this),r={};return r.a="fetch_topics",r.params=_.defaults({category_type:this.get("category_type"),log_visit:this.get("visited")?0:1,required_tag:i?t.tag_ids[0].tag_forum_id+"_"+t.tag_ids[0].tag_id:"",fetch_before:t.fetch_before,user_id:"priv"===this.get("category_type")?this.get("user_id"):0,fetch_by_field:t.fetch_by_field,fetch_archived:this.get("is_private")&&this.get("is_archive")?1:0,fetch_announcements:this.get("are_announcements_fetched")?0:1},this.fetchFetchTopicParameters()),this.set("visited",!0),r.never_cancel="boolean"==typeof t.never_cancel?t.never_cancel:!1,t.hasOwnProperty("source")&&(r.source=t.source),r.main_handler=function(r,l){var c,d,h=s.very_large_time;d=t.hasOwnProperty("calling_list")?t.calling_list:{},r&&(l=l.response,i&&(c=n.get("active_topics").findWhere({announce_type:"none"}),_.isUndefined(c)||(h=c.get("last_post_time"))),n.set("are_announcements_fetched",!0),n.get("is_private")&&!n.get("is_archive")&&n.get("master").get("feed").get("on_initial_feed_fetch")&&l.topics.reverse(),_.each(l.topics,function(t){var s,r,l,c=!0;if(n.get("is_post_search")){if(r=t.focus_post_data.post_id,l=n.get("active_topics").findWhere({focus_post_id:r}),!_.isUndefined(l))return;t.master=n.get("master"),t=n.get("master").checkLoadedTopicPermissions(t),t.search_settings=n.get("search_settings"),t.is_search_result=!0,s=new e.Topic(t),n.get("active_topics").add(s,{calling_list:d}),a.push(s)}else _.isNull(s=n.get("master").fetchTopicById(parseInt(t.topic_id)))?(t.category_id===n.get("category_id")&&(t.category=n),t.master=n.get("master"),t=n.get("master").checkLoadedTopicPermissions(t),s=new e.Topic(t),i?"none"===s.get("announce_type")?(a.push(s),s.get("last_post_time")<h&&(c=!1)):d.filter(s)&&a.push(s):a.push(s),c&&n.get("active_topics").add(s,{calling_list:d}),o.add(s,{fetching_category:n.get("category_id")})):("user_search_topics"===n.get("category_type")&&s.addParticipants(t.participants),"none"!==s.get("announce_type")?n.get("active_topics").add(s):i||n.get("active_topics").add(s,{calling_list:d}),s.get("category_id")!==t.category_id&&s.parsePotentialMove({new_category_id:t.category_id,category_name:t.category_name,category_main_color:t.category_main_color,category_secondary_color:t.category_secondary_color,can_read:!0,extra_data:{calling_list:d}}),"none"===s.get("announce_type")&&a.push(s))}),i||l.no_more_topics&&n.set("all_topics_loaded",!0),l.hasOwnProperty("num_search_results")&&n.set("num_posts_fetched",n.get("num_posts_fetched")+l.num_search_results),l.topics_found=l.hasOwnProperty("topics")&&!_.isNull(l.topics)&&l.topics.length>0,l.new_topics=a)},r.extra_handlers=t,r},fetchTopics:function(e){t.add(this.constructFetchTopicsArguments(e))},buildTopicsCollections:function(){var t,o,i=this;this.set("active_topics",new(Backbone.Collection.extend({model:e.Topic}))),this.get("active_topics").comparator=this.topicsComparator,this.has("topics_data")&&(o=this.get("active_topics"),"blog"===i.get("category_type")?(t=this.get("permissions"),_.each(this.get("topics_data"),function(e){e.master=i.get("master"),e.permissions=t,o.add(e)})):(("forum"===i.get("category_type")||"forum_class"===i.get("category_type"))&&(t=this.get("permissions"),_.each(this.get("topics_data"),function(e){e.permissions=t})),o.add(i.get("master").processPotentialNewTopics(this.get("topics_data"),!1))))},topicsComparator:function(e){return-e.get("last_post_time")},filterTopic:function(e){return!1},fetchFetchTopicParameters:function(){return{}},getCollectionFetchBefore:function(e){var t,o;return 0===e.length?o=0:(t=e.models[e.length-1],o=e.category.get("is_post_search")?t.get("focus_post").get("post_time"):"none"!==t.get("announce_type")&&this.get("show_announcements")?0:t.get("last_post_time")),{value:o}}}),e.CategoryViewForums=e.CategoryWithTopics.extend({initialize:function(){this.buildForumsArray(),this.set({category_type:"view_forums",hide_desc_on_phone:!0,reset_on_items_change:!0}),e.CategoryWithTopics.prototype.initialize.apply(this),this.listenTo(this,"item_added item_removed",this.onItemsChange)},filterTopic:function(e){return _.indexOf(this.get("forums_array"),e.get("category_id"))>-1},fetchFetchTopicParameters:function(){return{forums_string:this.get("forums_array").join(",")}},buildForumsArray:function(){this.set("forums_array",_.map(this.get("items"),function(e){return e.item_id}))},onItemsChange:function(){this.buildForumsArray(),this.set("all_topics_loaded",!1),this.get("active_topics").reset()},loadForums:function(e){var o,i=[],s=this.get("master").get("categories"),a=arguments.length>0?e:{},n=this;_.each(this.get("forums_array"),function(e){o=s.find(function(t){return t.get("category_id")===e}),_.isUndefined(o)&&i.push(e)}),i.length>0?t.add({a:"fetch_categories_data",params:{category_ids:JSON.stringify(i)},main_handler:function(e,t){e&&(_.each(t.categories,function(e){n.get("master").constructNewCategory(e)}),n.trigger("view_forums_loaded"),n.set("forums_loaded",!0))},extra_handlers:a}):(this.trigger("view_forums_loaded"),this.set("forums_loaded",!0),a.hasOwnProperty("onFinish")&&a.onFinish())}}),e.CategoryBookmarkForums=e.CategoryViewForums.extend({initialize:function(){e.CategoryViewForums.prototype.initialize.apply(this),this.set("category_type","bookmark_forums"),this.set("is_bookmark_category",!0)}}),e.CategoryMyBookmarks=e.Category.extend({defaults:_.defaults({no_more_items:!0,category_type:"my_bookmarks",long_description:AoPS.Community.Lang["my-bookmarks-long-desc"]},e.Category.prototype.defaults)}),e.CategoryGlobal=e.CategoryWithTopics.extend({initialize:function(){e.CategoryWithTopics.prototype.initialize.apply(this),this.set({category_type:"global"}),AoPS.Community.MasterModel.has("feed")&&"full"!==AoPS.Community.MasterModel.get("feed").get("global_feed_type")?(this.set("filter_topic_function",this.filterTopicCustomFeed),this.set("global_feed_fora",AoPS.Community.MasterModel.get("feed").get("global_feed_fora"))):this.set("filter_topic_function",this.filterTopicFullFeed)},filterTopic:function(e){return this.get("filter_topic_function").apply(this,[e])},filterTopicFullFeed:function(e){return"forum"===e.get("topic_type")},filterTopicCustomFeed:function(e){return _.indexOf(this.get("global_feed_fora"),e.get("category_id"))>-1}}),e.CategoryUsersTopics=e.CategoryWithTopics.extend({initialize:function(){e.CategoryWithTopics.prototype.initialize.apply(this),this.set({category_type:"user_search_topics"}),this.has("user_id")||console.log("You created a CategoryUsersTopics without specifying a user id.  Bad."),this.get("master").get("watched_users").push(this.get("user_id"))},filterTopic:function(e){return e.has("participants")&&"forum"===e.get("topic_type")&&!_.isUndefined(_.findWhere(e.get("participants"),{user_id:this.get("user_id"),removed:!1}))},fetchFetchTopicParameters:function(){return{fetched_user_id:this.get("user_id")}}}),e.CategorySearch=e.CategoryWithTopics.extend({defaults:_.defaults({category_name:o["Search-Results"],num_posts_fetched:0,is_post_search:!0},e.CategoryWithTopics.prototype.defaults),initialize:function(){var t,i=this.get("master");this.has("search_settings")&&(t=this.get("search_settings"),t.hasOwnProperty("forums")&&1==t.forums.length&&t.forums[0]==s.private_messages_id&&this.set("category_name",o["private-search-results"])),e.CategoryWithTopics.prototype.initialize.apply(this),i.get("search_categories").add(this),this.set("search_id",i.get("search_categories").length),this.listenTo(this.get("active_topics"),"add",this.onAddSearchTopic)},onAddSearchTopic:function(e,t,o){e.set("in_master_topics",!1)},topicsComparator:function(e){return e.get("search_id")},onAddMasterTopic:function(e){},
onRemoveMasterTopic:function(e){},fetchFetchTopicParameters:function(){return{search_settings:JSON.stringify(this.get("search_settings")),start_search_id:this.get("num_posts_fetched")}},filterTopic:function(){return!0}}),e.CategoryUsersPosts=e.CategoryWithTopics.extend({initialize:function(){var t;this.set("is_post_search",!0),e.CategoryWithTopics.prototype.initialize.apply(this),this.has("username")||(t=this.get("master").fetchUser(this.get("user_id")),_.isUndefined(t)||this.set("username",t.get("username"))),this.has("username")?this.set("category_name",a.formatString(o["user-search-posts-category-username"],[this.get("username")])):this.set("category_name",a.formatString(o["user-search-posts-category-user-id"],[this.get("user_id")])),this.listenTo(this.get("active_topics"),"add",this.onAddSearchTopic)},onAddSearchTopic:e.CategorySearch.prototype.onAddSearchTopic,topicsComparator:function(e){return-e.get("focus_post").get("post_time")},filterTopic:function(e){return e.has("focus_post")&&e.get("focus_post").get("poster_id")===this.get("user_id")},fetchFetchTopicParameters:function(){return{fetched_user_id:this.get("user_id")}},onAddMasterTopic:function(e){},onRemoveMasterTopic:function(e){}}),e.CategoryConglomeration=e.CategoryWithTopics.extend({initialize:function(){var t=this;e.CategoryWithTopics.prototype.initialize.apply(this),this.set("category_type","conglomeration"),this.listenTo(this.get("active_topics"),"add",this.onAddTopic),_.each(this.get("categories"),function(e){e.get("reset_on_items_change")&&t.listenTo(e,"item_added item_removed",t.resetTopicsCollection)})},resetTopicsCollection:function(){this.set("all_topics_loaded",!1),this.get("active_topics").reset()},onAddTopic:function(e){_.each(this.get("categories"),function(t){t.filterTopic(e)&&t.get("active_topics").add(e)})},filterTopic:function(e){var t,o=this.get("categories"),i=o.length;for(t=0;i>t;t++)if(o[t].filterTopic(e))return!0;return!1},fetchFetchTopicParameters:function(){var e=[];return _.each(this.get("categories"),function(t){var o=t.fetchFetchTopicParameters();o.category_type=t.get("category_type"),e.push(o)}),{categories_data:JSON.stringify(e)}},hasItems:function(){var e,t=this.get("categories"),o=t.length;for(e=0;o>e;e++)if(t[e].hasItems())return!0;return!1}}),e.CategoryViewTopics=e.CategoryWithTopics.extend({initialize:function(){e.CategoryWithTopics.prototype.initialize.apply(this),this.set("category_type","view_topics")},filterTopic:function(e){return!_.isUndefined(this.get("active_topics").findWhere({topic_id:e.get("topic_id")}))},fetchFetchTopicParameters:function(){return{category_id:this.get("category_id")}},onItemsChange:function(){}}),e.CategoryBookmarkTopics=e.CategoryViewTopics.extend({initialize:function(){e.CategoryViewTopics.prototype.initialize.apply(this),this.set("category_type","bookmark_topics"),this.set("is_bookmark_category",!0)},filterTopic:function(e){return e.get("is_bookmarked")},onItemsChange:function(){}}),e.CategoryFeedTopics=e.CategoryViewTopics.extend({initialize:function(){e.CategoryViewTopics.prototype.initialize.apply(this),this.set("category_type","feed_topics"),this.set("is_bookmark_category",!0)},filterTopic:function(e){return e.get("in_feed")},hasItems:function(){return!0},onItemsChange:function(){},fetchFetchTopicParameters:function(){return{category_id:this.get("bookmark_topic_category_id")}}}),e.CategoryForum=e.CategoryWithTopics.extend({defaults:_.defaults({all_read:!1,allow_autotag:!0,are_announcements_fetched:!1,can_start_topic:!0,can_own_topics:!0,can_mark_all_read:!0,category_type:"forum",has_tag_filter:!0,mark_time:0,last_post_time:0,is_forum:!0,show_announcements:!0},e.CategoryWithTopics.prototype.defaults),initialize:function(){var t,o=this;e.CategoryWithTopics.prototype.initialize.apply(this),this.set(this.get("master").fetchBookmarkStatus({item_id:this.get("category_id"),item_type:this.get("category_type"),item_forum_id:0})),AoPS.session.logged_in&&(this.on("change:mark_time change:last_post_time change:all_topics_loaded",this.parseMarkTime),this.listenTo(this.get("active_topics"),"add",this.onAddTopic),this.listenTo(this.get("active_topics"),"change:is_read",this.onTopicRead),this.parseMarkTime()),this.get("is_monitored")&&this.getPermission("c_can_monitor")&&this.addMonitorTags(),this.get("master").get("bookmarked_tag_category")&&(t=this.get("master").get("bookmarked_tag_category"),_.each(t.get("items"),function(e){e.item_forum_id===o.get("category_id")&&-1==_.indexOf(s.monitoring_tag_id_array,e.item_id)&&(o.removeItem(e),o.addItem(e,{no_check_existing:!0,add_to_front:!0}))})),this.get("show_announcements")&&this.get("active_topics").add(this.get("master").get("global_announcements").models),"forum_class"===this.get("category_type")&&this.set("can_remove_self",!1)},addMonitorTags:function(){var e=this,t=this.get("category_id"),o=this.get("main_color"),i=this.get("secondary_color");_.each(s.monitor_tags,function(s){e.addItem({item_id:s.item_id,item_type:"tag",item_forum_id:t,item_text:s.item_text,item_subtitle:"",item_main_color:o,item_secondary_color:i},{no_check_existing:!0,add_to_front:!0})})},getTermTagDictionary:function(){return AoPS.Community.hasOwnProperty("term_tag_map")?AoPS.Community.term_tag_map:{}},topicsComparator:function(e){return-e.get("last_post_time")-1e9*e.get("announce_factor")},onTopicRead:function(){arguments[2].hasOwnProperty("mark_all")&&arguments[2].mark_all||this.parseMarkTime()},parseMarkTime:function(){this.get("mark_time")>=this.get("last_post_time")?this.set("all_read",!0):this.set("all_read",!1)},onAddTopic:function(e){e.get("last_post_time")>this.get("last_post_time")&&this.set("last_post_time",e.get("last_post_time")),!e.get("is_read")&&e.get("last_post_time")<this.get("mark_time")&&this.set("mark_time",e.get("last_post_time")-1)},filterTopic:function(e){return e.get("category_id")===this.get("category_id")||this.get("show_announcements")&&"global"===e.get("announce_type")},fetchFetchTopicParameters:function(){return{category_id:this.get("category_id")}},addTag:function(e){this.addItem({item_id:e.tag_id,item_forum_id:this.get("category_id"),item_text:e.tag_text,item_type:"tag",item_main_color:this.get("main_color"),item_secondary_color:this.get("secondary_color")})},markAllTopicsRead:function(){AoPS.session.logged_in&&t.add({a:"mark_forum_read",params:{category_id:this.get("category_id")},main_handler:_.bind(function(e,t){e&&(this.set("mark_time",t.response.mark_time),this.get("active_topics").each(function(e){e.set("is_read",!0,{mark_all:!0})}))},this)})},setBookmarkState:function(e){return this.get("master").setBookmarkState({state:e,category_string:"bookmarked_forum_category",bookmarked_item:this,item_id:this.get("category_id"),item_type:this.get("category_type"),item_text:this.get("category_name"),item_main_color:this.get("main_color"),item_secondary_color:this.get("secondary_color"),item_subtitle:this.get("short_description")})}}),e.CategoryPriv=e.CategoryForum.extend({defaults:_.defaults({show_announcements:!1,is_private:!0,category_id:AoPS.Community.Constants.private_messages_id,category_type:"priv",has_tag_filter:!0,are_announcements_fetched:!0,is_archive:!1},e.CategoryForum.prototype.defaults),initialize:function(){this.set("main_color",AoPS.Community.Constants.privates_main_color),this.set("secondary_color",AoPS.Community.Constants.privates_secondary_color),this.set({category_name:this.get("username")+" Private Messages",category_type:"priv"}),e.CategoryForum.prototype.initialize.apply(this)},topicsComparator:function(e){return-e.get("last_post_time")},filterTopic:function(e){var t;return e.get("category_id")!==s.private_messages_id?!1:(t=this.get("user_id"),!_.isUndefined(_.findWhere(e.get("participants"),{user_id:t})))}}),e.CategoryPrivates=e.CategoryForum.extend({defaults:_.defaults({show_announcements:!1,is_private:!0,is_my_private:!0,category_id:AoPS.Community.Constants.private_messages_id,category_status:"active",category_type:"my_privates",has_tag_filter:!0,are_announcements_fetched:!0,is_archive:!1,pm_notification_open:!1},e.CategoryForum.prototype.defaults),initialize:function(){this.set("main_color",AoPS.Community.Constants.privates_main_color),this.set("secondary_color",AoPS.Community.Constants.privates_secondary_color),e.CategoryForum.prototype.initialize.apply(this),this.set("current_user",this.get("master").get("current_user")),this.set("user_id",this.get("current_user").get("user_id")),this.get("is_archive")||(this.setupLiveNotification(),this.listenTo(this.get("current_user"),"change:pm_live_notify",this.setupLiveNotification))},topicsComparator:function(e){return-e.get("last_post_time")},filterTopic:function(e){return e.get("category_id")===this.get("category_id")&&e.get("status")===this.get("category_status")},setupLiveNotification:function(){switch(this.has("new_pm_notification")&&this.stopListening(this.get("active_topics"),"add",this.get("new_pm_notification")),this.get("current_user").get("pm_live_notify")){case"modal":case"flyout":this.set("new_pm_notification",this.listenTo(this.get("active_topics"),"add",this.notifyNewMessage))}},notifyNewMessage:function(){var e=arguments[0],i=this.get("current_user"),s=this;e.get("is_read")||e.get("last_poster_id")===this.get("user_id")||this.get("pm_notification_open")||(!(e.get("last_post_time")<parseInt(AoPS.bootstrap_data.init_time))||this.get("master").get("feed").get("on_initial_feed_fetch")&&i.get("has_new_pm"))&&(this.set("pm_notification_open",!0),i.set("has_new_pm",!1),"modal"===i.get("pm_live_notify")?AoPS.Ui.Modal.showConfirm(a.formatString(o["pm-notify"],[e.get("last_poster_name"),e.get("topic_title")]),function(t){t&&("string"==typeof AoPS.router_root&&"community"===AoPS.router_root?Backbone.history.navigate("/c1h"+e.get("topic_id"),{trigger:!0}):window.location.href="/community/c1h"+e.get("topic_id"))},{title:o["pm-notify-title"],width:"500px",confirm_button_ok:o["pm-notify-btn-OK"],confirm_button_cancel:o["pm-notify-btn-cancel"],onClose:function(){s.set("pm_notification_open",!1)}}):(AoPS.Ui.Flyout.display(a.formatString(o["pm-notify-flyout"],[e.get("last_poster_name"),e.get("topic_title"),e.get("topic_id")])),setTimeout(function(){s.set("pm_notification_open",!1)},5e3)),t.add({a:"set_profile_field",params:{user_id:i.get("user_id"),field:"has_new_pm",value:0},main_handler:function(e,t){}}))},fireNewMessageFlyout:function(){}}),e.CategoryBlog=e.CategoryForum.extend({defaults:_.defaults({all_read:!1,allow_autotag:!1,are_announcements_fetched:!1,can_mark_all_read:!0,can_start_topic:!0,category_type:"blog",creator_location:"",last_post_time:0,mark_time:0,show_announcements:!1,show_contributors:!0,show_custom_block:!0,show_profile_info:!0,show_shoutbox:!0,show_stats:!0,show_tags:!0},e.CategoryForum.prototype.defaults),initialize:function(){var t,o=this,i=[{field:"blog_post_comment_text",default_field:"blog-default-post-comments"},{field:"blog_comments_text",default_field:"blog-default-comments"},{field:"blog_one_comment_text",default_field:"blog-default-one-comment"},{field:"blog_no_comments_text",default_field:"blog-default-no-comments"}];e.CategoryForum.prototype.initialize.apply(this),_.each(i,function(e){o.has(e.field)&&0!==o.get(e.field).length||o.set(e.field,AoPS.Community.Lang[e.default_field])}),this.has("shout_topic_data")&&(t=this.get("shout_topic_data"),t.master=this.get("master"),this.set("shoutbox_topic",new AoPS.Community.Models.Shoutbox(t)),this.get("master").get("topics").add(this.get("shoutbox_topic")))},topicsComparator:function(e){return-e.get("first_post_time")},filterTopic:function(e){return"blog_post"===e.get("topic_type")&&e.get("category_id")===this.get("category_id")},getCollectionFetchBefore:function(e){var t;return t=0===e.length?0:e.models[e.length-1].get("first_post_time"),{value:t}},setBitBlogSetting:function(e){var o=this;this.set(e.setting,e.value),this.get("category_id")>0&&t.add({a:"set_blog_bit_setting",params:{category_id:this.get("category_id"),setting:e.setting,value:e.value?1:0},main_handler:function(t,i){var s;t&&"is_primary_blog"===e.setting&&(s=o.get("master").get("current_user"),s.set("primary_blog_id",e.value?o.get("category_id"):0),s.set("primary_blog_name",e.value?o.get("category_name"):""))},extra_handlers:e})},setStringBlogSetting:function(e){this.set(e.setting,e.value),this.get("category_id")>0&&t.add({a:"set_blog_string_setting",params:{category_id:this.get("category_id"),setting:e.setting,value:e.value},main_handler:function(e,t){},extra_handlers:e})},setNewCss:function(e){t.add({a:"set_blog_css",params:{category_id:this.get("category_id"),new_css:e.new_css},main_handler:function(e,t){},extra_handlers:e})},deleteCss:function(e){t.add({a:"delete_blog_css",params:{category_id:this.get("category_id")},main_handler:function(e,t){},extra_handlers:e})}}),e.CategoryViewTags=e.CategoryWithTopics.extend({initialize:function(){this.buildTagsString(),this.set({category_type:"view_tags",has_tag_filter:!0,hide_desc_on_phone:!0,reset_on_items_change:!0}),e.CategoryWithTopics.prototype.initialize.apply(this),this.listenTo(this,"item_added item_removed",this.onItemsChange)},onItemsChange:function(){this.buildTagsString(),this.set("all_topics_loaded",!1),this.get("active_topics").reset()},onTopicTagChange:function(e){this.filterTopic(e)||(this.get("active_topics").remove(e,{removed_by:"topic_update"}),this.trigger("force_remove_topic",{topic:e}))},buildTagsString:function(){this.set("tags_string",_.map(this.get("items"),function(e){return'"'+e.item_forum_id+"_"+e.item_id+'"'}).toString())},filterTopic:function(e){return e.hasTagInArray(this.get("items"))},fetchFetchTopicParameters:function(){return{tags_string:this.get("tags_string")}}}),e.CategoryBookmarkTags=e.CategoryViewTags.extend({initialize:function(){e.CategoryViewTags.prototype.initialize.apply(this),this.set("category_type","bookmark_tags"),this.set("is_bookmark_category",!0)}}),e.Topic=e.Model.extend({defaults:{all_posts_fetched:!1,announce_factor:0,can_have_source:!1,cat_can_target:!1,deleted:!1,force_add_to_category:null,has_initial_posts_loaded:!1,in_master_topics:!0,is_feed_focus:!1,is_fetching_past_posts:!1,is_fetching_posts:!1,is_last_post_time_watched:!1,is_master_focus:!1,is_search_result:!1,num_named_watchers:0,num_watchers:0,poll_id:0,read_since_loading:!1,source:"",stretch_category:null,tags_processed:!1,watchers_usernames:""},postsComparator:function(e){return parseInt(e.get("post_id"))},initialize:function(){this.setDefault("tags",[]),this.setDefault("participants",[]),_.each(this.get("posts_data"),_.bind(function(e){e.topic=this},this)),this.has("poll_data")||this.set("poll_data",{}),this.has("focus_post_data")&&(this.set("focus_post",new e.Post(this.get("focus_post_data"))),this.unset("focus_post_data"),this.set("focus_post_id",this.get("focus_post").get("post_id"))),this.set("posts",new(Backbone.Collection.extend({model:e.Post,comparator:this.postsComparator}))(this.get("posts_data"))),this.get("master").get("is_stretch_class")&&this.get("posts").each(function(e){e.set("reported",AoPS.Stretch.Utils.isPostReported(e.get("post_id")))}),this.get("posts").length>0&&this.checkAllPostsLoaded(),this.parseLastPostTime(),this.on("change:last_post_time",this.parseLastPostTime),this.get("master").checkAddToWatchTimes({time_data:{model:this,int_time_field:"first_post_time",rendered_time_field:"first_post_rendered_time"},is_already_watched:!1}),this.set("first_post_rendered_time",AoPS.Community.Utils.makePrettyTimeOldDateOnly(this.get("first_post_time")))},isPrivateMessage:function(){return this.get("category_id")===AoPS.Community.Constants.private_messages_id},fetchSearchText:function(e){var t;return this.has("search_settings")?(t=this.get("search_settings"),t.hasOwnProperty("search_text")?t.search_text:t.hasOwnProperty(e)?t[e]:""):""},parseLastPostTime:function(){this.set("is_last_post_time_watched",this.get("master").checkAddToWatchTimes({time_data:{model:this,int_time_field:"last_post_time",rendered_time_field:"last_post_rendered_time"},is_already_watched:this.get("is_last_post_time_watched")})),this.set("last_post_rendered_time",AoPS.Community.Utils.makePrettyTimeOldDateOnly(this.get("last_post_time")))},getPermission:function(e){return this.has("permissions")||console.log("Permission sought before permissions set for category "+this.get("category_name")),_.isUndefined(this.get("permissions")[e])&&console.log("Permissions have not been set for key "+e+" of Category "+this.get("category_name")),this.get("permissions")[e]},addNewTag:function(e,o){this.has("category")||this.set("category",this.get("master").fetchCategory(this.get("category_id"))),t.add({a:"add_tag_to_topic",params:{topic_id:this.get("topic_id"),tag_id:e,tag_text:o},main_handler:_.bind(function(e,t){var o=t.response;e&&(o=t.response,this.get("tags").push(o.tag),this.get("category").addTag(o.tag),this.trigger("tag_added",{topic:this}))},this)})},deleteTagFromTagsArray:function(e,t){var o=this.get("tags");this.set("tags",e>0?_.filter(o,function(t){return t.tag_id!=e}):_.filter(o,function(e){return e.tag_text!=t}))},removeTag:function(e,o){var i=this.get("tags");this.deleteTagFromTagsArray(e,o),t.add({a:"remove_tag_from_topic",params:{topic_id:this.get("topic_id"),tag_id:e,tag_text:o},main_handler:_.bind(function(t,s){t?(this.deleteTagFromTagsArray(e,o),this.trigger("tag_removed",{topic:this})):this.set("tags",i,{removed_by:"topic_update"})},this)})},hasTag:function(e){var t,o=this.get("tags");for(e=parseInt(e),t=o.length-1;t>=0;t-=1)if(o[t].tag_id===e)return!0;return!1},startRealtimePostMonitor:function(e){var t,o=this;t=this.get("last_post_time")<this.get("master").get("last_topic_fetch_time")-86400,this.get("master").constructIntervalAjax({interval_monitor_model:this,interval_id_property:"realtime_monitor"+e.source+e.hash,interval_property:t?"topic_update_interval_long":"topic_update_interval",method:function(){o.checkTopicUpdate(e)}}),t&&this.set("post_monitor_id",this.listenTo(this,"change:last_post_time",function(){o.resetPostMonitor(e)}))},resetPostMonitor:function(e){this.stopRealtimePostMonitor(e),this.startRealtimePostMonitor(e)},stopRealtimePostMonitor:function(e){clearTimeout(this.get("realtime_monitor"+e.source+e.hash)),this.has("post_monitor_id")&&(this.stopListening(this.get("post_monitor_id")),this.unset("post_monitor_id")),this.unset("realtime_monitor"+e.source+e.hash)},fetchLastLoadedPostNumber:function(){return this.get("posts").last().get("post_number")},checkTopicUpdate:function(e){this.get("is_fetching_posts")||(this.set("is_fetching_posts",!0),t.add({a:"fetch_topic_update",params:{topic_id:this.get("topic_id"),last_post_num:this.fetchLastLoadedPostNumber(),last_update_time:this.get("last_posts_update_time"),hash:e.hash,source:e.source},main_handler:_.bind(function(e,t){e?this.onFinishTopicUpdateAjax(t.response):this.set("is_fetching_posts",!1)},this),queue_limit:0}))},onFinishTopicUpdateAjax:function(e){e.new_data?(this.processTopicUpdate(e),this.set("last_posts_update_time",e.last_posts_update_time)):(this.set({num_watchers:e.num_watchers,num_named_watchers:e.num_named_watchers,watchers_usernames:e.watchers_usernames,watchers_avatars:e.watchers_avatars,num_views:e.num_views}),e.hasOwnProperty("poll_data")&&this.set("poll_data",e.poll_data)),this.set("is_fetching_posts",!1),this.set("is_fetching_past_posts",!1)},processTopicUpdate:function(e){var t,o=!1,i=!1,s={},a=this;this.set("last_update_time",e.last_update_time),this.get("master").get("focus_topic")===this&&(this.set("read",!0),i=!0),this.get("master").has("feed")&&this.get("master").get("feed").get("focus_topic")===this&&(this.set("read",!0),i=!0),i||this.set("is_read",e.is_read),(this.get("last_post_time")!=e.last_post_time||this.get("last_poster_name")!=e.last_poster_name)&&(o=!0),"private"==this.get("topic_type")&&this.set("status",e.status),e.hasOwnProperty("announce_type")&&this.get("announce_type")!=e.announce_type&&(this.set({announce_type:e.announce_type,announce_factor:e.announce_factor}),o=!0),_.each(["poll_data","topic_title","source","preview","num_posts","last_poster_name","last_post_id","last_poster_id","last_post_time","last_poster_avatar","num_reports","locked","target_url","target_text","state"],function(t){e.hasOwnProperty(t)&&(s[t]=e[t])}),this.set(s),e.hasOwnProperty("updated_posts")&&e.updated_posts.length>0&&_.each(e.updated_posts,function(e){a.parseEditedPost(e)}),e.hasOwnProperty("posts_data")&&e.posts_data.length>0&&this.parseNewArrayOfPosts(e.posts_data),e.hasOwnProperty("category_num_posts")&&(t=this.get("master").fetchCategory(this.get("category_id")),_.isUndefined(t)||t.set("num_posts",e.category_num_posts)),e.hasOwnProperty("participants")&&this.addParticipants(e.participants),e.hasOwnProperty("permissions")&&this.set("permissions",e.permissions),e.hasOwnProperty("num_watchers")&&this.set({num_watchers:e.num_watchers,num_named_watchers:e.num_named_watchers,watchers_usernames:e.watchers_usernames,watchers_avatars:e.watchers_avatars,num_views:e.num_views}),e.hasOwnProperty("tags")&&this.checkTagsChanged(e.tags),o&&this.get("in_master_topics")&&(this.get("master").get("topics").remove(this,{removed_by:"topic_update"}),this.get("master").get("topics").add(this,{added_by:"topic_update"})),this.get("all_posts_fetched")&&(this.get("num_posts")>this.get("posts").length?this.set("all_posts_fetched",!1):this.get("last_post_id")>this.get("posts").last().get("post_id")&&this.set("all_posts_fetched",!1))},checkTagsChanged:function(e){var t=this.get("tags"),o=!0;o=this.checkArrayForNewTags(e),this.set("tags",e),o&&this.trigger("tag_added",{topic:this}),this.checkArrayForNewTags(t)&&this.trigger("tag_removed",{topic:this})},checkArrayForNewTags:function(e){var t,o=e.length;if(e.length>this.get("tags").length)return!0;for(t=0;o>t;t++)if(e[t].item_forum_id===this.get("category_id")&&!this.hasTag(e[t].item_id))return!0;return!1},hasTagInArray:function(e){var t,o=e.length;for(t=0;o>t;t++)if(e[t].item_forum_id===this.get("category_id")&&this.hasTag(e[t].item_id))return!0;return!1},onReadTopic:function(e){_.extend({set_mark:!0,update_watcher:!0,increment_views:!0},e);this.set("is_read",!0)},setState:function(e){var o=this;e.state!=this.get("state")&&(this.deleteTagFromTagsArray(0,"/"+this.get("state")),this.get("tags").push({tag_id:s.monitored_topic_tag_ids[e.state],tag_text:"/"+e.state,is_visible:!1}),this.trigger("tag_removed",{topic:this}),this.trigger("tag_added",{topic:this}),this.set("state",e.state),this.has("set_state_timeout")&&clearTimeout(this.get("set_state_timeout")),this.set("set_state_timeout",setTimeout(function(){t.add({a:"set_topic_state",params:{topic_id:o.get("topic_id"),state:e.state},main_handler:function(e,t){}})},600)))},setMyStatus:function(e){var o=this.get("master");t.add({a:"set_participant_status",params:{topic_id:this.get("topic_id"),status:e.status},main_handler:function(e,t){},never_cancel:!0,extra_handlers:e}),this.isPrivateMessage()?(o.get("topics").remove(this),"removed"===e.status?this.destroy():(this.set("status",e.status),o.get("topics").add(this))):_.each(this.get("participants"),function(t){t.user_id===AoPS.session.user_id&&(t.removed="removed"===e.status)})},setBookmarkState:function(e){return this.get("master").setBookmarkState({state:e,category_string:"bookmarked_topic_category",bookmarked_item:this,item_id:this.get("topic_id"),item_type:"topic",item_text:""})},resetBookmarkState:function(e){var t=this;this.get("master").setBookmarkState({state:{is_bookmarked:!1,in_feed:!1,is_watched:!1},category_string:"bookmarked_topic_category",bookmarked_item:this,item_id:this.get("topic_id"),item_type:"topic",item_text:"",onFinish:function(){t.setBookmarkState(e)}})},processInitialPostFetch:function(e){var t=this,o=this.get("master").get("is_stretch_class");_.each(e.posts,function(e){e.topic=t,o&&(e.reported=AoPS.Stretch.Utils.isPostReported(e.post_id))}),this.get("posts").add(e.posts),e.hasOwnProperty("participants")&&this.set("participants",e.participants),e.hasOwnProperty("permissions")&&this.set("permissions",e.permissions),this.set("last_posts_update_time",e.initialization_time),this.checkTagsChanged(e.tags),this.set(e.data_to_set_direct_on_topic),this.checkAllPostsLoaded(),this.set("is_fetching_posts",!1),this.set("is_fetching_past_posts",!1),this.trigger("post_load_complete")},fetchMorePosts:function(e){var o=AoPS.Community.Constants.num_posts_to_fetch,i=_.extend({source:"master"},e);this.get("all_posts_fetched")||(this.set("is_fetching_posts",!0),this.set("is_fetching_past_posts",!0),t.add({a:"fetch_posts_for_topic",params:{topic_id:this.get("topic_id"),direction:i.hasOwnProperty("direction")?i.direction:"forwards",start_post_id:i.hasOwnProperty("start_post_id")?i.start_post_id:-1,start_post_num:i.hasOwnProperty("start_post_num")?i.start_post_num:-1,show_from_time:i.hasOwnProperty("show_from_time")?i.show_from_time:-1,num_to_fetch:o},source:i.source,main_handler:_.bind(function(e,t){if(e){var o,s,a=t.response.posts.length,n=(this.get("posts").models,0),r=999999,l=!1,c=!1,d=[];this.trigger("post_load_complete");for(var o=0;a>o;o++)t.response.posts[o][i.show_from_setting]=!0,s=this.parsePotentialNewPost(t.response.posts[o]),d.push(s.post_model),"show_from_middle"===i.show_from_setting&&(!l&&s.post_model.get("show_from_start")&&(l=!0),!c&&s.post_model.get("show_from_end")&&(c=!0),s.post_model.get("post_number")<r&&(r=s.post_model.get("post_number")),s.post_model.get("post_number")>n&&(n=s.post_model.get("post_number")));l&&_.each(d,function(e){e.set("show_from_start",!0)}),c&&_.each(d,function(e){e.set("show_from_end",!0)}),this.checkAllPostsLoaded(),this.set("is_fetching_posts",!1),this.set("is_fetching_past_posts",!1),t.response.low_num=r,t.response.high_num=n,t.response.target_post_number=t.response.hasOwnProperty("target_post_number")?t.response.target_post_number:null,this.trigger("topic_updated")}this.set("is_fetching_posts",!1)},this),extra_handlers:i}))},checkAllPostsLoaded:function(){this.get("num_posts")<=this.get("posts").length?(this.get("posts").each(function(e){e.set("show_from_start",!0),e.set("show_from_end",!0)}),this.set("all_posts_fetched",!0)):this.set("all_posts_fetched",!1)},parseNewArrayOfPosts:function(e){var t,o=this,i=!1;return _.each(e,function(e){t=o.parsePotentialNewPost(e),t.new_post_found&&(i=!0)}),this.checkAllPostsLoaded(),i},parsePotentialNewPost:function(t){var o=this.checkPostLoaded(t.post_id),i=!1;return _.isNull(o)&&(t.topic=this,this.get("master").get("is_stretch_class")&&(t.reported=AoPS.Stretch.Utils.isPostReported(t.post_id)),o=new e.Post(t),this.get("posts").add(o),i=!0),{new_post_found:i,post_model:o}},checkRemoveLastPost:function(e){"none"!==e.delete_status&&(this.get("last_post_time")<=this.get("db_mark_time")&&this.set("is_read",!0),e.post_time>=this.get("last_post_time")&&this.get("in_master_topics")&&(this.get("master").get("topics").remove(this,{removed_by:"topic_update"}),this.get("master").get("topics").add(this,{added_by:"topic_update"})))},parseEditedPost:function(t){var o,i=this.getPermission("c_can_read_deleted");i&&(t.topic_data.num_posts+=t.topic_data.num_deleted),delete t.topic_data.num_deleted,this.set(t.topic_data),this.checkRemoveLastPost(t),0!==this.get("posts").length&&(o=this.checkPostLoaded(t.post_id),_.isNull(o)?"none"==t.delete_status&&this.get("all_posts_fetched")&&(t.show_from_start=!0,t.show_from_end=!0,t.topic=this,this.get("master").get("is_stretch_class")&&(t.reported=AoPS.Stretch.Utils.isPostReported(t.post_id)),o=new e.Post(t),this.get("posts").add(o)):"hard"==t.delete_status?(o.trigger("hard_delete"),this.get("posts").remove(o)):"soft"==t.delete_status?i?o.set("deleted",!0):(o.trigger("hard_delete"),this.get("posts").remove(o)):o.parseEdits(t))},checkPostLoaded:function(e){var t=this.get("posts");return 0===t.length?null:this.checkPostLoadedBinarySearch(e,0,t.length-1,t.models)},checkPostLoadedBinarySearch:function(e,t,o,i){var s,a;return t>o?null:(s=Math.floor((t+o)/2),a=i[s].get("post_id"),a>e?this.checkPostLoadedBinarySearch(e,t,s-1,i):e>a?this.checkPostLoadedBinarySearch(e,s+1,o,i):i[s])},submitNewParticipant:function(e){e.user.hasOwnProperty("user_id")||(e.user.user_id=0),t.add({a:"add_topic_participant",params:_.extend({topic_id:this.get("topic_id")},e.user),main_handler:_.bind(function(t,o){t?o.response.hasOwnProperty("participants")&&this.set("participants",o.response.participants):o.response.username=e.user.username},this),extra_handlers:e})},addParticipants:function(e){var t,o,i=e.length;if(0!==i||!this.has("participants"))if(this.has("participants")&&this.get("participants").length===i){for(t=0;i>t;t++)if(o=e[t],current_participant_entry=_.findWhere(this.get("participants"),{user_id:o.user_id}),_.isUndefined(current_participant_entry)||current_participant_entry.removed!==o.removed)return void this.set("participants",e)}else this.set("participants",e)},"delete":function(e){t.add({a:"delete_topic",params:{topic_id:this.get("topic_id"),delete_type:e.delete_type},main_handler:_.bind(function(e,t){e&&(Backbone.trigger("destroy_topic_view",{category_id:this.get("category_id"),topic_id:this.get("topic_id")}),this.set("deleted",!0,{deleted_by_me:!0}),this.destroy())},this),extra_handlers:e})},move:function(e){var o=this.get("category_id");t.add({a:"move_topic",params:{topic_id:this.get("topic_id"),new_category_id:e.new_category_id,old_category_id:this.get("category_id")},main_handler:_.bind(function(t,i){t&&(this.set(i.response.new_topic_data),Backbone.trigger("destroy_topic_view",{category_id:o,topic_id:this.get("topic_id")}),this.get("master").get("topics").remove(this),this.get("master").get("topics").add(this),this.get("master").trigger("move_to_topic",{category_id:e.new_category_id,topic_id:this.get("topic_id"),replace:!0}))},this),extra_handlers:e})},lock:function(){this.setLockStatus(!0)},unlock:function(){this.setLockStatus(!1)},setLockStatus:function(e){this.set("locked",e),t.add({a:"set_lock_status",params:{topic_id:this.get("topic_id"),lock_status:e?1:0},main_handler:function(e,t){}})},setAnnounceType:function(e){var o=this;t.add({a:"set_announce_type",params:{topic_id:this.get("topic_id"),announce_type:e.type,announce_through:e.announce_through},main_handler:function(t,i){var s;t&&(o.set({announce_type:e.type,announce_factor:"none"===e.type?0:"local"===e.type?1:2}),o.get("master").get("topics").remove(o),o.get("master").get("topics").add(o),s=o.get("master").fetchCategory(o.get("category_id")),_.isUndefined(s)||0==s.get("active_topics").length&&s.get("active_topics").add(o))},extra_handlers:e})},parsePotentialMove:function(e){var t;if(this.get("category_id")!=e.new_category_id){if(!e.can_read)return this.set("deleted",!0),void this.destroy();this.set({category_id:e.new_category_id,category_name:e.category_name,category_main_color:e.category_main_color,category_secondary_color:e.category_secondary_color}),t=this.get("master").fetchCategory(e.new_category_id),_.isUndefined(t)||this.set("permissions",t.get("permissions")),this.get("master").get("topics").remove(this,_.extend({removed_by:"topic_move"},"object"==typeof e.extra_data?e.extra_data:{})),this.get("master").get("topics").add(this,_.extend({removed_by:"topic_move"},"object"==typeof e.extra_data?e.extra_data:{}))}},computeDerivedPollData:function(){var e,t,o,i=0,s=!1,a=0;if(this.has("poll_data")){for(e=this.get("poll_data"),o=Object.keys(e.options).length,t=0;o>t;t++)i+=e.options[t].total;if(e.num_votes=i,0==i)for(t=0;o>t;t++)e.options[t].pct=0,e.options[t].bar_scale=0;else{for(t=0;o>t;t++)e.options[t].pct=Math.round(100*e.options[t].total/i),a=Math.max(a,e.options[t].pct),e.options[t].selected&&(s=!0);for(t=0;o>t;t++)e.options[t].bar_scale=Math.round(100*e.options[t].pct/a)}e.has_voted=s,e.can_vote=AoPS.session.logged_in&&!e.poll_closed&&(!s||e.allow_revote)}},castVote:function(e){var o=this;t.add({a:"cast_vote",params:{topic_id:this.get("topic_id"),votes:e.votes.join()},main_handler:function(e,t){e&&o.set("poll_data",t.response.poll_data)},extra_handlers:e})},removeTarget:function(e){var o=this;t.add({a:"remove_target_url",
params:{topic_id:this.get("topic_id")},main_handler:function(e,t){e&&(o.deleteTagFromTagsArray(0,o.get("target_url")),o.set("target_url",""))},extra_handlers:e})},changeTargetUrl:function(e){var o,i=this;o=_.last(e.new_target.split(".com")),new_target_text=e.new_target_text,t.add({a:"change_target_url",params:{topic_id:this.get("topic_id"),new_target:o,new_target_text:new_target_text,is_restricted:e.is_restricted?1:0},main_handler:function(e,t){e&&(i.deleteTagFromTagsArray(0,i.get("target_url")),i.get("tags").push({tag_id:t.response.new_tag.tag_id,tag_text:t.response.new_tag.tag_text,is_visible:t.response.new_tag.is_visible,is_public:t.response.new_tag.is_public}),i.set({target_url:t.response.new_tag.tag_text,target_text:t.response.new_tag.new_target_text}))},extra_handlers:e})},addHiddenTag:function(e){var o,i=this;o=_.last(e.new_text.split(".com")),t.add({a:"add_hidden_tag",params:{topic_id:this.get("topic_id"),new_text:o,is_restricted:e.is_restricted?1:0},main_handler:function(e,t){e&&(i.hasTag(t.response.new_tag.tag_id)||i.get("tags").push({tag_id:t.response.new_tag.tag_id,tag_text:t.response.new_tag.tag_text,is_visible:t.response.new_tag.is_visible,is_public:t.response.new_tag.is_public}))},extra_handlers:e})},checkShowTargetLink:function(){var e,t;return 0===this.get("target_url").length?!1:(e=this.get("target_url").split("/"),e.length>3&&"class"===e[0]&&"ebook"===e[2]?(t=this.get("master").get("ebooks_available"),AoPS.session.logged_in&&_.indexOf(t,parseInt(e[3]))>-1):!0)}}),e.Shoutbox=e.Topic.extend({postsComparator:function(e){return-parseInt(e.get("post_id"))},fetchLastLoadedPostNumber:function(){return this.get("posts").first().get("post_number")},checkPostLoadedBinarySearch:function(e,t,o,i){var s,a;return t>o?null:(s=Math.floor((t+o)/2),a=i[s].get("post_id"),e>a?this.checkPostLoadedBinarySearch(e,t,s-1,i):a>e?this.checkPostLoadedBinarySearch(e,s+1,o,i):i[s])}}),e.FilteredTopicList=Backbone.Collection.extend({model:e.Topic,initialize:function(e,t){return this.topics_loading=!1,t.hasOwnProperty("master")?(t.hasOwnProperty("filter")||console.log("You created a filtered topic list without setting filter.  You really deserve what happens next."),$.extend(this,t),this.category=t.category,this.all_topics_fetched=this.category.get("all_topics_loaded"),this.listenTo(this.category.get("active_topics"),"add",this.checkNewTopic),this.listenTo(this.category.get("active_topics"),"reset",this.emptyList),this.fetch_settings=_.pick(t,"category_id","tag_ids"),this.hasOwnProperty("tag_ids")&&this.tag_ids.length>0&&(this.listenTo(this.category.get("active_topics"),"tag_added",this.refilterActiveTopic),this.listenTo(this,"tag_removed",this.refilterActiveTopic)),this.listenTo(this.master.get("topics"),"remove",this.removeTopic),void this.listenTo(this.category,"force_remove_topic",this.forceRemoveTopic)):void console.log("You created a filtered topic list without setting master.  You deserve what happens next.")},forceRemoveTopic:function(e){this.remove(e.topic,{removed_by:"topic_update"})},emptyList:function(){this.all_topics_fetched=!1,this.reset()},refilterActiveTopic:function(e){this.checkNewTopic(e.topic,null,{added_by:"topic_update"})||this.remove(e.topic,{removed_by:"topic_update"})},removeTopic:function(e,t,o){this.remove(e,o)},checkNewTopic:function(e,t,o){return o.hasOwnProperty("calling_list")&&o.calling_list===this?!1:this.filter(e)?(this.add(e,o),!0):!1},constructFetchMoreTopicsParams:function(e){var t,o,i=this,s=this.length;return this.category.get("all_topics_loaded")&&(this.all_topics_fetched=!0,e.hasOwnProperty("onFinish")&&e.onFinish()),o=this.category.getCollectionFetchBefore(this),this.topics_loading=!0,t=_.extend({fetch_before:o.value,calling_list:this,never_cancel:"boolean"==typeof e.never_cancel?e.never_cancel:!1,onFinish:_.bind(function(t){this.add(t.new_topics,{add_in_bulk:!0,force_add:e.hasOwnProperty("force_add")?e.force_add:!1}),this.topics_loading=!1,(t.no_more_topics||!t.topics_found||0===o.value&&0===t.new_topics.length&&s===this.length)&&(this.all_topics_fetched=!0),this.trigger("bulk_topics_added"),!_.isUndefined(e)&&e.hasOwnProperty("onFinish")&&e.onFinish()},this),onError:function(t){i.topics_loading=!1,!_.isUndefined(e)&&e.hasOwnProperty("onError")&&e.onError(t)}},this.fetch_settings),arguments.length>0&&e.hasOwnProperty("source")&&(t.source=e.source),t},constructAjaxCall:function(e){return this.category.constructFetchTopicsArguments(this.constructFetchMoreTopicsParams(e))},fetchMoreTopics:function(e){0===arguments.length&&(e={}),this.category.fetchTopics(this.constructFetchMoreTopicsParams(e))},fetchTopicById:function(e){return e=parseInt(e),this.find(function(t){return t.get("topic_id")===e})}}),e.TopicList=e.Model.extend({defaults:{category_id:0},initialize:function(t){var o;this.setDefault("tag_ids",[]),t.hasOwnProperty("master")||console.log("You created a filtered topic list without setting master.  You deserve what happens next."),t.hasOwnProperty("filter")||console.log("You created a filtered topic list without setting filter.  You really deserve what happens next."),o=new e.FilteredTopicList([],{category_id:this.get("category_id"),category:this.get("category"),tag_ids:this.get("tag_ids"),master:t.master,filter:t.filter}),o.comparator=this.get("category").topicsComparator,o.add(this.get("category").get("active_topics").filter(t.filter),{sort:!1}),o.sort(),this.set("filtered_topic_list",o)}}),e.Post=Backbone.Model.extend({defaults:{can_target:!1,deletable:!1,editable:!1,is_edit_time_watched:!1,is_forum_admin:!1,is_forum_mod:!1,last_edit_time_rendered:"",has_target:!1,real_poster_id:0,real_poster_username:""},initialize:function(){parseInt(moment().format("X"));this.has("topic")&&(this.get("topic").get("master").checkAddToWatchTimes({time_data:{model:this,int_time_field:"post_time",rendered_time_field:"date_rendered"},is_already_watched:!1}),1===this.get("post_number")&&this.get("topic").get("cat_can_target")&&(this.set("can_target",!0),this.listenTo(this.get("topic"),"change:target_url",this.onChangeTopicTarget),this.get("topic").get("target_url").length>0&&this.set("has_target",!0))),this.set("date_rendered",AoPS.Community.Utils.makePrettyTime(this.get("post_time"))),this.set("last_edit_time_rendered",AoPS.Community.Utils.makePrettyTime(this.get("last_edit_time"))),this.parseEditData(),this.on("change:last_edit_time_rendered",this.parseEditData),this.get("attachment")||this.set("attachments",[]),this.set("original_attachments",this.get("attachments"))},onChangeTopicTarget:function(){this.set("has_target",this.get("topic").get("target_url").length>0)},parseEditData:function(){parseInt(moment().format("X"));this.has("topic")&&this.get("num_edits")>0&&this.set("is_edit_time_watched",this.get("topic").get("master").checkAddToWatchTimes({time_data:{model:this,int_time_field:"last_edit_time",rendered_time_field:"last_edit_time_rendered"},is_already_watched:this.get("is_edit_time_watched")}))},report:function(e,o){t.add({a:"report_post",params:{reason_short:e,details:o,post_id:this.get("post_id")},main_handler:_.bind(function(e,t){e&&this.set("reported",!0)},this)})},isDeletableByUser:function(){var e=this.get("topic");return _.isUndefined(e)?!1:this.get("deletable")&&this.get("post_id")===e.get("last_post_id")&&e.getPermission("c_can_edit_own_posts")?this.get("poster_id")===s.halp_user_id?this.has("real_poster_id")&&this.get("real_poster_id")===AoPS.session.user_id&&e.getPermission("c_can_edit_own_posts")?!0:!1:this.get("poster_id")===AoPS.session.user_id:!1},"delete":function(e){t.add({a:"delete_post",params:{hard_delete:e.hard_delete?1:0,topic_id:this.get("topic_id"),post_id:this.get("post_id")},never_cancel:!0,main_handler:_.bind(function(t,o){t?o.response.hasOwnProperty("topic_deleted")&&o.response.topic_deleted?(this.get("topic").set("deleted",!0,{deleted_by_me:!0}),this.get("topic").destroy()):(this.get("topic").get("master").closePostReports(this.get("post_id")),this.set("deleted",!0),this.set("reported",!1),o.response.topic_updated&&this.get("topic").processTopicUpdate(o.response.topic_data),e.hard_delete&&this.trigger("hard_delete")):"E_HARD_DELETE"===o.error_code&&this.trigger("hard_delete")},this),extra_handlers:e})},undelete:function(e){t.add({a:"undelete_post",params:{topic_id:this.get("topic_id"),post_id:this.get("post_id")},never_cancel:!0,main_handler:_.bind(function(e,t){e?(this.set("deleted",!1),t.response.topic_updated&&this.get("topic").processTopicUpdate(t.response.topic_data)):"E_HARD_DELETE"===t.error_code&&this.trigger("hard_delete")},this),extra_handlers:e})},setThankStatus:function(e){this.set("is_thanked",1==e.new_status),this.set("is_nothanked",-1==e.new_status),t.add({a:"set_thank_status",params:{post_id:this.get("post_id"),thank_status:e.new_status},main_handler:_.bind(function(e,t){e&&(t.response.hasOwnProperty("post_thank_count")&&this.set("thanks_received",t.response.post_thank_count),t.response.hasOwnProperty("post_nothank_count")&&this.set("nothanks_received",t.response.post_nothank_count),"string"==typeof t.response.thankers&&this.set("thankers",t.response.thankers))},this)})},edit:function(e){var o=e.hasOwnProperty("disable_bbcode")&&e.disable_bbcode?"none":"bbcode",i=1===this.get("post_number"),s=this.get("attachment")?this.get("original_attachments"):[],a=!1;return s.length===e.attachments.length?_.each(e.attachments,function(e){0===e.existing&&(a=!0)}):a=!0,a||$.trim(e.edited_text)!=this.get("post_canonical")||o!==this.get("format")||i&&this.has("topic")&&(this.get("topic").get("topic_title")!==$.trim(e.topic_title)||this.get("topic").get("source")!==$.trim(e.source))?void t.add({a:"edit_post",params:{post_id:this.get("post_id"),edited_text:e.edited_text,source:e.source,attachments:JSON.stringify(e.attachments),topic_title:e.topic_title,edit_reason:e.edit_reason,format:o,allow_latex_errors:e.allow_latex_errors?1:0},never_cancel:!0,main_handler:_.bind(function(t,o){t&&o.response.post_id===this.get("post_id")&&(o.response.show_from_start=this.get("show_from_start"),o.response.show_from_end=this.get("show_from_end"),this.parseEdits(o.response),this.has("topic")&&i&&this.get("topic").set({topic_title:e.topic_title,source:e.source}))},this),extra_handlers:e}):void(e.hasOwnProperty("onError")&&e.onError({error_code:"E_NO_EDIT_MADE"}))},parseEdits:function(e){e.last_edit_time>0&&(e.last_edit_time_rendered=AoPS.Community.Utils.makePrettyTime(e.last_edit_time)),!e.attachment&&this.get("attachment")&&(this.set("original_attachments",[]),e.attachments=[]),e.deletable=this.get("deletable"),e.editable=this.get("editable"),this.set(e)},checkShowTargetLink:function(){return this.get("has_target")?this.get("topic").checkShowTargetLink():!1},fetchIP:function(e){t.add({a:"fetch_ip",params:{post_id:this.get("post_id")},main_handler:function(e,t){},extra_handlers:e})}}),e.PostReport=Backbone.Model.extend({initialize:function(){},settle:function(e){var o=this;t.add({a:"settle_post_report",params:{id:this.get("id"),topic_id:this.get("topic_id"),post_id:this.get("post_id"),notes:e.hasOwnProperty("notes")?e.notes:""},never_cancel:!0,main_handler:function(e,t){e&&(o.get("post").get("topic").get("master").resetTopicReports({topic_id:o.get("topic_id"),post_id:o.get("post_id"),topic_num_reports:t.response.topic_num_reports}),o.get("post").set("reported",!1),o.get("post").get("topic").get("master").closePostReports(o.get("post_id")))},extra_handlers:e})},decrementNumReports:function(){var e=this.get("topic_id"),t=this.get("post").get("topic").get("master").fetchTopicById(e);!_.isUndefined(t)&&!_.isNull(t)&&t.get("num_reports")>0&&t.set("num_reports",t.get("num_reports")-1)}}),e.ItemsHolder=Backbone.Model.extend({initialize:function(){},fetchMoreItems:function(){}}),e.ContainerHolder=e.ItemsHolder.extend({addItem:function(e){var o=this.fetchItem(e.item);_.isUndefined(o)?(this.get("items").push(e.item),this.trigger("item_added",e.item),this.get("category").get("category_id")>0&&t.add({a:"add_item_to_category",params:{category_id:e.item.item_id,item_id:this.get("category").get("category_id"),item_forum_id:0,item_type:this.get("category").get("category_type")},main_handler:function(e,t){}})):e.hasOwnProperty("onError")&&e.onError({error_code:"E_ALREADY_ADDED"})},fetchItem:function(e){return _.find(this.get("items"),function(t){return t.item_id===e.item_id&&t.item_forum_id===e.item_forum_id&&t.item_type===e.item_type})},removeItem:function(e){var o=this.fetchItem(e);_.isUndefined(o)||(this.set("items",_.without(this.get("items"),o)),this.trigger("item_removed"),this.get("category").get("category_id")>0&&t.add({a:"remove_item_from_category",params:{category_id:o.item_id,item_id:this.get("category").get("category_id"),item_forum_id:0,item_type:this.get("category").get("category_type")},main_handler:function(e,t){}}))}}),e.User=Backbone.Model.extend({defaults:{all_friends_loaded:!1,all_requests_loaded:!1,avatar:"",can_pm:!1,email:"",friends_initialized:!1,goals:"",has_classes:!1,has_ebooks:!1,hide_avatars:!1,hide_tags_on_topic:!1,interests:"",is_activated:!0,is_banned:!1,is_bookmarked:!1,is_coppa_blocked:!1,is_limited:!1,is_new_user:!1,is_online:!1,joined_at:0,loading_friends:!1,location:"",num_posts:0,occupation:"",posting_subscribe_reply:!1,school:"",show_last_visit:!0,show_tags_on_feed:!1,status:"",warn_on_snipes:!1,website:""},initialize:function(){this.set("joined_at",moment(this.get("joined_at"),"X").format("MMMM D, YYYY")),this.has("last_visit")&&this.get("last_visit")>0?this.get("is_online")?this.set("last_visit_pretty",AoPS.Community.Lang["user-item-online"]):this.set("last_visit_pretty",AoPS.Community.Utils.makePrettyTimeStatic(this.get("last_visit"))):this.set("last_visit_pretty",this.get("joined_at")),this.has("friends")?this.set("friends_initialized",!0):this.set("friends",[]),this.has("friend_requests")||this.set("friend_requests",[]),this.set("new_friends",[])},emptyFriends:function(){this.set("friends",[]),this.set("friend_requests",[]),this.set("all_friends_loaded",!1),this.set("friends_initialized",!1)},deleteAvatar:function(e){t.add({a:"delete_avatar",params:{user_id:this.get("user_id")},main_handler:function(e,t){},extra_handlers:e})},fetchFriends:function(e){var o,i=this;o="initial"===e.fetch_type?"":_.last(this.get(e.fetch_type)).username,this.set("loading_friends",!0),t.add({a:"fetch_friends",params:{user_id:this.get("user_id"),last_friend:o,fetch_type:e.fetch_type},main_handler:function(e,t){e&&(t.response.hasOwnProperty("all_friends_loaded")&&i.set("all_friends_loaded",t.response.all_friends_loaded),t.response.hasOwnProperty("friends")&&(t.response.loaded_friends=[],i.has("new_friends")&&0===i.get("new_friends").length?t.response.loaded_friends=t.response.friends:_.each(t.response.friends,function(e){i.wasFriendAddedDuringThisPageLoad(e.user_id)||t.response.loaded_friends.push(e)}),i.set("friends",i.get("friends").concat(t.response.loaded_friends))),t.response.hasOwnProperty("friend_requests")&&i.set("friend_requests",i.get("friend_requests").concat(t.response.friend_requests)),t.response.hasOwnProperty("all_requests_loaded")&&i.set("all_requests_loaded",t.response.all_requests_loaded)),i.set("loading_friends",!1)},extra_handlers:e})},fetchTopFora:function(e){var o=this;t.add({a:"fetch_top_fora",params:{user_id:this.get("user_id")},main_handler:function(e,t){e&&o.set("top_fora",t.response.top_fora)},extra_handlers:e})},wasFriendAddedDuringThisPageLoad:function(e){return!_.isUndefined(_.findWhere(this.get("new_friends"),{user_id:e}))},unFriend:function(e){var o,i=this;o=_.findWhere(i.get("friends"),{user_id:e.user_id}),_.isUndefined(o)||i.set("friends",_.without(i.get("friends"),o)),t.add({a:"unfriend",params:{user_id:e.user_id},main_handler:function(e,t){}})},setUserSetting:function(e){var o,i=this;o="boolean"==typeof this.get(e.field),t.add({a:"set_profile_field",params:{field:e.field,value:e.value,user_id:this.get("user_id")},main_handler:function(t,s){t&&(o&&(e.value=1===parseInt(e.value)),"friends_exclude"===e.field&&e.value&&i.emptyFriends(),"email"!==e.field&&i.set(e.field,e.value),"status"===e.field&&i.trigger("status_changed",{set_from:e.hasOwnProperty("set_from")?e.set_from:""}))},extra_handlers:e})},submitNewPassword:function(e){$.ajax({url:AoPS.protected_url+"m/community/ajax.php",timeout:1e4,type:"post",data:{a:"reset_password",new_password:e.new_password,old_password:e.old_password},crossDomain:!0,xhrFields:{withCredentials:!0},error:function(e){},success:function(t){t.hasOwnProperty("error_code")?e.hasOwnProperty("onError")&&e.onError(t):e.hasOwnProperty("onFinish")&&e.onFinish(t.response)}})},closeFriendRequest:function(e){var o=this;t.add({a:"close_friend_request",params:{user_id:e.user_id,action:e.action},main_handler:function(t,i){var s;t&&(s=i.response.new_friend_data,"accepted"===e.action&&(o.get("new_friends").push(s),o.get("friends").unshift(s)))},extra_handlers:e}),this.set("friend_requests",_.reject(this.get("friend_requests"),function(t){return t.user_id===e.user_id}))},archiveAllPrivates:function(){var e,o,i=this.get("master"),s=i.get("my_privates").get("active_topics"),a=s.length;if(i.get("current_user")===this){for(e=a-1;e>=0;e--)o=s.models[e],o.set("status","archived"),i.get("topics").remove(o),i.get("topics").add(o);i.get("my_privates_archive").set("all_topics_loaded",!1),t.add({a:"archive_all_privates",params:{},main_handler:function(e,t){}})}},removeFromAllPrivates:function(){var e,o,i=this.get("master"),s=i.get("my_privates").get("active_topics"),a=i.get("my_privates_archive").get("active_topics"),n=s.length,r=a.length;if(i.get("current_user")===this){for(e=n-1;e>=0;e--)o=s.models[e],i.get("topics").remove(o),o.destroy();for(e=r-1;e>=0;e--)o=a.models[e],i.get("topics").remove(o),o.destroy();t.add({a:"remove_from_all_privates",params:{},main_handler:function(e,t){}})}},clearBookmarks:function(e){t.add({a:"clear_bookmarks",params:{user_id:this.get("user_id"),bookmark_section:e.bookmark_section,clear_type:e.clear_type},main_handler:function(e,t){},extra_handlers:e})},addNote:function(e){t.add({a:"add_user_note",params:{user_id:this.get("user_id"),note_text:e.note_text},main_handler:function(e,t){},extra_handlers:e})},makeItemOfThis:function(){return{is_admin:this.get("is_admin"),is_visible:!0,label:this.get("username"),user_id:this.get("user_id"),value:this.get("username")}},setBlogSubscriptionStatus:function(e){t.add({a:"set_blog_subscription",params:{blog_id:e.blog_id,status:e.status?1:0},main_handler:function(e,t){}})}}),e.CategoryUser=e.User.extend({getPermission:function(e){return"c_can_read"===e?!0:!1}}),e.TagTermManager=e.Model.extend({defaults:{focus_tag:null,focus_term:null},initialize:function(){this.set("tags",new(Backbone.Collection.extend({model:e.Tag}))),this.get("tags").comparator=function(e){return e.get("tag_text").toLowerCase()},this.set("terms",new(Backbone.Collection.extend({model:e.Term}))),this.get("terms").comparator=function(e){return e.get("term_text").toLowerCase()}},fetch_map:function(e){var o=this;t.add({a:"fetch_tag_term_map",params:{},main_handler:function(e,t){e&&(o.get("terms").add(t.response.terms),o.get("tags").add(t.response.tags),_.each(t.response.maps,function(e){var t,i;t=o.findTagById(e.tag_id),i=o.findTermById(e.term_id),_.isUndefined(t)||_.isUndefined(i)||(t.get("mapped_terms").add(i),i.get("mapped_tags").add(t))}))},extra_handlers:e})},findTagById:function(e){return this.get("tags").findWhere({tag_id:e})},findTermById:function(e){return this.get("terms").findWhere({term_id:e})},deleteMap:function(e){e.term.get("mapped_tags").remove(e.tag),e.tag.get("mapped_terms").remove(e.term),t.add({a:"remove_tag_term_map",params:{tag_id:e.tag.get("tag_id"),term_id:e.term.get("term_id")},main_handler:function(e,t){}})},deleteTerm:function(e){e.term.get("mapped_tags").each(function(t){t.get("mapped_terms").remove(e.term)}),this.get("terms").remove(e.term),t.add({a:"delete_term",params:{term_id:e.term.get("term_id")},main_handler:function(t,o){t&&e.term.destroy()}})},addTagToFocusTerm:function(e){var t=this.get("tags").findWhere({tag_id:e.item_id});_.isUndefined(t)&&(t=new AoPS.Community.Models.Tag({tag_id:e.item_id,tag_text:e.label})),this.get("tags").add(t),this.mapTagTerm(t,this.get("focus_term")),this.saveTagTermMap({tag_id:e.item_id,term_id:this.get("focus_term").get("term_id")})},addTermToFocusTag:function(e){this.mapTagTerm(this.get("focus_tag"),e),this.saveTagTermMap({tag_id:this.get("focus_tag").get("tag_id"),term_id:e.get("term_id")})},addTermTextToFocusTag:function(o){var i=this,s=this.get("terms").findWhere({text_lc:o.term_text.toLowerCase()});_.isUndefined(s)?t.add({a:"add_new_term_text_to_tag",params:{term_text:o.term_text,tag_id:this.get("focus_tag").get("tag_id")},main_handler:function(t,s){var a;t&&(a=new e.Term({term_id:s.response.term_id,term_text:o.term_text}),i.get("terms").add(a),i.mapTagTerm(i.get("focus_tag"),a))},extra_handlers:o}):this.addTermToFocusTag(s)},saveTagTermMap:function(e){t.add({a:"add_tag_term_map",params:{tag_id:e.tag_id,term_id:e.term_id},main_handler:function(e,t){}})},mapTagTerm:function(e,t){e.get("mapped_terms").add(t),t.get("mapped_tags").add(e)},constructTermAutocompleteSource:function(){return this.get("terms").map(function(e){return{value:e.get("term_text"),label:e.get("term_text"),term:e}})},buildNewTerm:function(o){var i,s=o.term_text.toLowerCase(),a=this;i=this.get("terms").findWhere({text_lc:s}),_.isUndefined(i)||o.hasOwnProperty("onFinish")&&o.onFinish({term:i}),t.add({a:"construct_new_term",params:{term_text:o.term_text},main_handler:function(t,i){var s;t&&(s=new e.Term({term_text:o.term_text,term_id:i.response.term_id}),a.get("terms").add(s),i.response.term=s)},extra_handlers:o})},loadTagById:function(e){var o=this.get("tags").findWhere({tag_id:e.tag_id}),i=this;return _.isUndefined(o)?void t.add({a:"load_tag_by_id",params:{tag_id:e.tag_id},main_handler:function(e,t){e&&i.get("tags").add({tag_id:t.response.tag_id,tag_text:t.response.tag_text})},extra_handlers:e}):void("function"==typeof e.onFinish&&e.onFinish({tag_id:e.tag_id}))},deleteFocusTerm:function(){this.deleteTerm({term:this.get("focus_term")}),this.set("focus_term",null)},addNewTagTextToFocusTerm:function(o){var i=this;t.add({a:"add_new_tag_text_to_term",params:{term_id:this.get("focus_term").get("term_id"),tag_text:o.tag_text},main_handler:function(t,s){var a;t&&(a=i.get("tags").findWhere({tag_id:s.response.tag_id}),_.isUndefined(a)&&(a=new e.Tag({tag_id:s.response.tag_id,tag_text:o.tag_text})),i.get("tags").add(a),i.mapTagTerm(a,i.get("focus_term")))},extra_handlers:o})},fetchItemAutocompleteMatches:function(e){this.makeItemAutocompleteCall("fetch_tag_term_autocomplete",{text_stub:e.request.term,fetch_type:e.additional_params.type},e)},fetchTagIdByText:function(e){var o=this;t.add({a:"fetch_tag_by_text",params:{tag_text:e.tag_text,create_new:e.hasOwnProperty("create_new")&&e.create_new?1:0,suppress_clean:e.hasOwnProperty("suppress_clean")&&e.suppress_clean?1:0},main_handler:function(t,i){var s;t&&(s=o.findTagById(i.response.tag_id),_.isUndefined(s)&&(s=new AoPS.Community.Models.Tag({tag_id:i.response.tag_id,tag_text:e.tag_text}),o.get("tags").add(s)),i.response.tag=s)},extra_handlers:e})},makeItemAutocompleteCall:e.Category.prototype.makeItemAutocompleteCall}),e.Tag=e.Model.extend({initialize:function(){this.set("text_lc",this.get("tag_text").toLowerCase()),this.set("mapped_terms",new(Backbone.Collection.extend({model:e.Term}))),this.get("mapped_terms").comparator=function(e){return e.get("text_lc")}},fetchForumData:function(e){var o=this;t.add({a:"fetch_tag_forum_data",params:{tag_id:this.get("tag_id")},main_handler:function(e,t){e&&o.set("forum_data",t.response.forum_data)},extra_handlers:e})},recapitalize:function(e){t.add({a:"recapitalize_tag",params:{tag_id:this.get("tag_id"),new_text:e.new_text},main_handler:function(e,t){},extra_handlers:e})},mergeToTag:function(e){var o=e.hasOwnProperty("affected_categories")?e.affected_categories:[];t.add({a:"merge_tags",params:{merge_from:this.get("tag_id"),merge_to:e.new_tag_id,affected_categories:JSON.stringify(o)},main_handler:function(e,t){},extra_ajax_runner_options:{timeout:24e4},extra_handlers:e})},deleteTag:function(e){var o=e.hasOwnProperty("affected_categories")?e.affected_categories:[];t.add({a:"delete_tag_admin",params:{tag_id:this.get("tag_id"),delete_type:e.delete_type,affected_categories:JSON.stringify(o)},main_handler:function(e,t){},extra_ajax_runner_options:{timeout:24e4},extra_handlers:e})}}),e.Term=e.Model.extend({initialize:function(){this.set("text_lc",this.get("term_text").toLowerCase()),this.set("mapped_tags",new(Backbone.Collection.extend({model:e.Tag}))),this.get("mapped_tags").comparator=function(e){return e.get("text_lc")}}}),e}(AoPS.Community.Models||{}),AoPS.Community.Views=function(ComViews){var Lang=AoPS.Community.Lang,Constants=AoPS.Community.Constants,Utils=AoPS.Community.Utils,Modal=AoPS.Ui.Modal,Flyout=AoPS.Ui.Flyout;return ComViews.clicking=!1,$(document).on("mousedown.watcher",function(){ComViews.clicking=!0}).on("mouseup.watcher",function(){ComViews.clicking=!1}),ComViews.isIOS=navigator.userAgent.match(/iPhone|iPad|iPod/i),ComViews.isIOS&&(Constants.max_num_shown_topics=170,Constants.num_topics_to_hide=80,Constants.num_topics_to_reveal=40),jQuery.fn.extendedHighlightText=function(e,t){var o,i=$(this);t=t.replace(/[^a-zA-Z0-9\' _-]/g," ").replace(/ +(?= )/g,""),o=t.split(" "),_.each(o,function(t){i.highlightText(e,t)})},jQuery.fn.cmtyLoadFromFile=function(e){var t=$(this);Utils.cmty_ajax.add({a:"load_file",params:{filename:e.filename},main_handler:function(e,o){e&&t.html(o.response.file_contents)},extra_handlers:e})},jQuery.fn.highlightText=function(e,t){function o(t,s){var a,n,r,l,c,d,h=0;if(3===t.nodeType)a=t.data.toUpperCase().match(i),_.isNull(a)||(n=document.createElement("span"),n.className=e,r=t.splitText(a.index),l=r.splitText(s.length),c=r.cloneNode(!0),n.appendChild(c),r.parentNode.replaceChild(n,r),h=1);else if(1===t.nodeType&&t.childNodes&&!/(script|style)/i.test(t.tagName))for(d=0;d<t.childNodes.length;++d)d+=o(t.childNodes[d],s);return h}var i=new RegExp(t.toUpperCase().replace(/\*/,".*"));return this.length&&t&&t.length?this.each(function(){o(this,t.toUpperCase())}):this},jQuery.fn.stripSpansByClass=function(span_class){return this.find("span."+span_class).each(function(){with(this.parentNode.firstChild.nodeName,this.parentNode)replaceChild(this.firstChild,this),normalize()}).end()},ComViews.buildCommunityScrollbar=function(e){var t={fade_start_class:"aops-scroll-fade-top",fade_end_class:"aops-scroll-fade-bottom",slider_end_tolerance:2,autosize:!0,autosize_nudge:8,stop_scroll_propagation:!0},o=1===arguments.length?t:_.extend(t,arguments[1]),i=e.wrapWithScroll(o);return i.addClass("cmty-scroll-outer"),i},ComViews.inCmtyRouter=function(){return AoPS.hasOwnProperty("pushState_attr")&&"data-cmty"===AoPS.pushState_attr},ComViews.throwAjaxError=function(e){var t;switch(e.error_code){case"E_NO_PERMISSION":t=Lang["err-no-permission"];break;default:t=Utils.formatString(Lang["err-unknown"],[e.error_code])}Modal.showAlert(t,{onClose:function(){Modal.closeAllModals()}})},ComViews.onPMPage=function(){return"my-message"===Backbone.history.fragment.substring(0,10)},ComViews.setTabTarget=function(e,t){e.on("keydown",function(o){var i=o.which||o.keyCode;e.data("suppress_tab")!==!0&&(9!==i||o.shiftKey||(t.focus(),o.stopPropagation(),o.preventDefault()))}),t.on("keydown",function(o){var i=o.which||o.keyCode;t.data("suppress_tab")!==!0&&9===i&&o.shiftKey&&(e.focus(),o.stopPropagation(),o.preventDefault())})},ComViews.setRouteInfo=function(e,t){e.url_cmty_path="string"==typeof t.url_cmty_path?t.url_cmty_path:"string"==typeof e.url_cmty_path?e.url_cmty_path:"",e.url_router_base="string"!=typeof t.url_router_base||_.isUndefined(t.url_router_base)?"string"==typeof e.url_router_base?e.url_router_base:"/community":t.url_router_base,e.push_state_attribute="string"==typeof t.push_state_attribute?t.push_state_attribute:"string"==typeof e.push_state_attribute?e.push_state_attribute:"data-cmty"},ComViews.launchNewPrivateMessage=function(e){"boolean"==typeof e.is_admin&&(e.is_admin=e.is_admin?1:0);var t=new ComViews.NewPrivateConversation({category_name:"",category_id:Constants.private_messages_id,model:AoPS.Community.MasterModel.get("my_privates"),preset_recipients:[{label:e.username,user_id:e.user_id,is_visible:!0,is_admin:e.is_admin}],master:AoPS.Community.MasterModel});return t},ComViews.buildSelectRow=function(e){var t=$('<div class="cmty-select-row"></div>'),o=$("<select></select>"),i=e.hasOwnProperty("bold")&&e.bold,s=e.hasOwnProperty("selected")?e.selected:"";return _.each(e.options,function(e){o.append('<option value="'+e.value+'" '+(e.value===s?"selected":"")+">"+e.label+"</option>")}),o.change(function(){e.action(o.val())}),t.append($('<div class="cmty-select-row-select"></div>').append(o)),t.append($('<div class="cmty-select-row-text">'+(i?"<b>":"")+e.text+(i?"</b>":"")+"</div>")),t},ComViews.buildLinkLabelRow=function(e){var t=$('<div class="cmty-link-label-row"></div>'),o=$("<a>"+e.link_text+"</a>"),i=e.hasOwnProperty("bold")&&e.bold;return o.on("click",function(){e.action()}),t.append($('<div class="cmty-link-label-row-link"></div>').append(o)),t.append($('<div class="cmty-link-label-row-label">'+(i?"<b>":"")+e.link_label+(i?"</b>":"")+"</div>")),t},ComViews.buildEditableRow=function(e){var t,o,i,s,a=e.hasOwnProperty("submit_on_enter")?e.submit_on_enter:!0,n=AoPS.View.compileTemplate("#cmty-editable-row-tpl"),r=$('<span class="cmty-editable-pencil aops-font">L</span>'),l=e.hasOwnProperty("length_limit")?e.length_limit:0,c=e.hasOwnProperty("content")?e.content:"";return t={is_active:!1,allow_ctrl_biu:e.hasOwnProperty("allow_ctrl_biu")?e.allow_ctrl_biu:!1,label:e.label,placeholder:e.hasOwnProperty("placeholder")?e.placeholder:"",contents:c,reset:function(){t.$input.text(t.contents),t.$input.append(r)},activate:function(){o.show(),t.$element.addClass("cmty-editable-active-row"),t.is_active=!0},deactivate:function(){o.hide(),t.$element.removeClass("cmty-editable-active-row"),t.is_active=!1},renderUneditable:function(){t.$input.attr("contenteditable",!1),r.detach()},onButtonClick:function(){t.$input.blur(),t.contents.length>0&&t.$input.append(r),t.deactivate()},save:function(){t.burnNewContent()&&e.hasOwnProperty("action")&&e.action(t.contents,t),t.onButtonClick()},burnNewContent:function(){var e=t.fetchInputLines(),o=e.join("\n");return t.$input.text(e.join("<br>")),o!==t.contents?(t.contents=e.join("\n"),!0):!1},fetchInputLines:function(){var e=[],o=!1,i=!1;return t.$input.contents().each(function(){return"BR"===this.nodeName?(i=!1,o?void(a||e.push("")):void(o=!0)):(o=!1,void(3===this.nodeType?(i?e[e.length-1]=e[e.length-1]+this.textContent:e.push(this.textContent),i=!0):(i=!1,"<br>"!==this.innerHTML?e.push(this.innerHTML):e.push(""))))}),e}},t.$element=$(n({label:e.label,placeholder:t.placeholder,content:c})),t.$input=t.$element.find('[contenteditable="true"]'),o=t.$element.find(".cmty-editable-buttons"),s=o.find(".cmty-editable-cancel"),i=o.find(".cmty-editable-save"),(t.contents.length>0||0===t.placeholder.length)&&t.$input.append(r),s.on("click",function(){t.$input.text(t.contents),t.onButtonClick()}),i.on("click",function(){t.save()}),t.$input.on("focus",function(){setTimeout(function(){r.detach()},1)}),t.$input.on("paste",function(e){var o,i=(e.originalEvent||e).clipboardData.getData("text/plain");e.preventDefault(),a&&(i=i.replace(/\r?\n|\r/g,"")),document.execCommand("insertText",!1,i),l>0&&(o=t.$input.text(),o.length>l&&(t.$input.text(o.substr(0,l)),AoPS.Ui.Flyout.display(Lang["editable-length-limit-exceeded-on-paste"])))}),t.$input.on("blur",function(){!t.is_active&&t.contents.length>0&&t.$input.append(r)}),a&&t.$input.on("keydown",function(e){var o=e.which||e.keyCode;13===o&&(t.save(),e.preventDefault(),e.stopPropagation())}),l>0&&t.$input.on("keydown",function(e){var o=e.which||e.keyCode,i=t.$input.text();8!==o&&i.length>l&&e.preventDefault()}),t.allow_ctrl_biu||t.$input.on("keydown",function(e){
var t=e.which||e.keyCode,o=[66,73,85];(e.metaKey||e.ctrlKey)&&_.indexOf(o,t)>-1&&(e.stopPropagation(),e.preventDefault())}),t.$input.on("keyup",function(){t.$input.text()!==t.contents?t.activate():t.deactivate()}),t},ComViews.setFullReplyStyle=function(){$("body").addClass("full-reply")},ComViews.removeFullReplyStyle=function(){$("body").removeClass("full-reply")},ComViews.buildTagAutocomplete=function(e){var t;e.$input_box.wrap($('<div class="cmty-tag-search"></div>')),e=_.defaults(e,{show_no_results_msg:!1,no_results_msg_hash:"cat-cell-no-tag-match",has_search_icon:!1}),e.category=e.model,e.processPostConstruction=ComViews.EditableTagBox.prototype.processTagBoxDropdownArrowing,e.show_no_results_msg&&(t=$('<div class="cmty-no-results-found">'+Lang[e.no_results_msg_hash]+"</div>"),e.$input_box.before(t),e.$input_box.on("blur",function(){t.hide()}),e.$input_box.on("remove",function(){t.remove()}),e.onMatch=function(){t.hide()},e.onNoMatch=function(){t.show()}),e.hasOwnProperty("has_search_icon")&&e.has_search_icon&&(e.$input_box.before('<span class="aops-font">M</span>'),e.$input_box.parent().addClass("cmty-search-with-icon")),e.constructAutocompleteArgs=ComViews.EditableTagBox.prototype.constructAutocompleteArgs,e.getAutocompleteSource=ComViews.EditableTagBox.prototype.getAutocompleteSource,e.constructAutocomplete=ComViews.EditableTagBox.prototype.constructItemAutocomplete,e.constructAutocomplete()},ComViews.buildTagTermTagAutocomplete=function(e){function t(t){0!=t.length&&(tag=e.tag_term_model.get("tags").findWhere({text_lc:t.toLowerCase()}),_.isUndefined(tag)?(ComViews.throwBlockingMessage(Lang["please-wait"]),e.tag_term_model.fetchTagIdByText({tag_text:t,create_new:e.hasOwnProperty("create_new")?e.create_new:!1,suppress_clean:e.hasOwnProperty("suppress_clean")?e.suppress_clean:!1,onFinish:function(t){e.onFoundTag(t.tag)},onError:function(e){switch(e.error_code){case"E_NO_SUCH_TAG":error_msg=Lang["cmty-tag-info-no-tag"];break;default:error_msg=Utils.formatString(Lang["err-unknown"],[e.error_code])}Modal.showAlert(error_msg,{onClose:function(){Modal.closeAllModals()}})}})):e.onFoundTag(tag),ComViews.buildTagTermTagAutocomplete(e))}e.view.hasOwnProperty("$tag_input")&&e.view.$tag_input.parent().remove(),e.view.$tag_input=$('<input name="tag" placeholder="Enter tag" maxlength="60">'),e.view.$tag_input.on("keydown",function(e){ComViews.validateTagCharacter(e)||(e.stopPropagation(),e.preventDefault())}),e.view.$tag_input.on("paste",function(e){ComViews.onTagPaste(e)}),e.$input_box_target.append(e.view.$tag_input),ComViews.buildTagAutocomplete({model:e.tag_term_model,$input_box:e.view.$tag_input,show_no_results_msg:!0,no_results_msg_hash:"cmty-tag-info-no-match",additional_autocomplete_params:{type:"tag"},submitNewItem:function(o){var i;return 0==o.item_id?void t(o.label):(i=e.tag_term_model.findTagById(parseInt(o.item_id)),_.isUndefined(i)&&(i=new AoPS.Community.Models.Tag({tag_id:parseInt(o.item_id),tag_text:o.value}),e.tag_term_model.get("tags").add(i)),e.onFoundTag(i),void ComViews.buildTagTermTagAutocomplete(e))}}),e.view.$tag_input.on("keyup",function(o){var i,s=o.which||o.keyCode;13==s&&(i=$.trim(e.view.$tag_input.val()),t(i))})},ComViews.validateTagCharacter=function(e){var t=e.which||e.keyCode;return t>=65&&90>=t?!0:t>=48&&57>=t?!e.shiftKey:37==t||39==t?!0:190==t?!0:189==t?!0:222==t?!0:8==t||9==t||46==t?!0:32==t?!0:!1},ComViews.onTagPaste=function(e){var t=(e.originalEvent||e).clipboardData.getData("text/plain");t=t.replace(/[^a-zA-Z0-9 \._-]/g,""),e.preventDefault(),document.execCommand("insertText",!1,t)},ComViews.constructUsernameAutocompleteExtraArgs=function(){return{ui_class:"cmty-username-autocomplete",_renderItem:function(e,t){var o=$("<li></li>"),i=$("<a>"+t.label+"</a>");return o.append(i),"1"===t.is_admin&&i.addClass("cmty-user-admin"),o.appendTo(e)}}},ComViews.showError=function(e){AoPS.Ui.Modal.showAlertQuick(e,{width:"400px",onClose:function(){Modal.closeAllModals()}})},ComViews.showErrorAtopAModal=function(e){AoPS.Ui.Modal.showAlertQuick(e,{width:"400px"})},ComViews.constructUrlFromFocus=function(e,t){var o,i,s=e.get("focus_category").get("category_id"),a=2===arguments.length?t:{},n=!a.hasOwnProperty("strip_topic")||!a.strip_topic,r=e.get("focus_topic");return o=s!==Constants.private_messages_id||!e.get("focus_category").get("is_archive")||n&&!_.isNull(r)?"/c"+s:Constants.private_archive_url,i=e.get("focus_tag"),_.isNull(i)||(o+="t"+i.tag_id+"f"+i.tag_forum_id),n&&(_.isNull(r)||(o+="h"+r.get("topic_id"))),o},ComViews.leaveRouterOnClick=function(e,t){e.metaKey||e.ctrlKey?window.open("/community"+t,"_blank"):window.location.href="/community"+t,e.stopPropagation(),e.preventDefault()},ComViews.followUrlOnClick=function(e,t){var o,i;arguments.length>2?(o=arguments[2],i=arguments[3]):(o="/community",i=""),e.metaKey||e.ctrlKey?window.open(o+i+t,"_blank"):Backbone.history.navigate(i+t,{trigger:!0}),e.stopPropagation(),e.preventDefault()},ComViews.isStateTag=function(e){return e=e.toLowerCase(),"/open"===e||"/closed"===e||"/not_monitored"===e},ComViews.makeBookmark=function(e){return String.fromCharCode(67+(e.is_bookmarked?(e.in_feed?2:0)+(e.is_watched?1:0):-1))},ComViews.convertToUrlFragment=function(e){return e.replace(/ /g,"_").replace(/\W/g,"").toLowerCase()},ComViews.makeLinkUrl=function(e){var t=2==arguments.length?arguments[1]:"/community";return t+e},ComViews.makeBackboneClick=function(e,t){e.on("click.backbone",function(e){ComViews.followUrlOnClick(e,t)})},ComViews.throwBlockingMessage=function(e){AoPS.Ui.Modal.showMessageQuick(e,{closeX:!1,force_response:!0,kill_phrase:"ajax-error-kill",width:"400px"})},ComViews.delayModalClearing=function(e){var t={};arguments.length>0&&(t=e),setTimeout(function(){Modal.closeAllModals(),t.hasOwnProperty("onClose")&&t.onClose()},Constants.message_readability_delay)},ComViews.replaceWithLoaderBlockingMessage=function(e){var t='<div class="cmty-quick-message">'+e+"</div>"+AoPS.Page.loader_html;AoPS.Ui.Modal.replaceTopModal({type:"message",body:t,closeX:!1,force_response:!0,kill_phrase:"ajax-error-kill",width:"450px",frame_class:"aops-modal-quick"})},ComViews.throwLoaderBlockingMessage=function(e){var t='<div class="cmty-quick-message">'+e+"</div>"+AoPS.Page.loader_html;AoPS.Ui.Modal.showMessageQuick(t,{closeX:!1,force_response:!0,kill_phrase:"ajax-error-kill",width:"350px"})},ComViews.applyItemColor=function(e,t){e.css({"background-color":t.main_color}).on("mouseenter",function(o){e.css({"background-color":t.secondary_color,color:t.main_color})}).on("mouseleave",function(o){e.css({"background-color":t.main_color,color:""})})},ComViews.$bookmarkModals={},ComViews.constructBookmarkModal=function(e,t){var o=$(AoPS.View.prototype.getTemplate("#cmty-bookmark-modal-tpl",{username:AoPS.session.username,description:t,info_text:Lang["bookmark-modal-info-text"],feed_text:Lang["bookmark-modal-feed"],email_text:Lang["bookmark-modal-email-"+e]}));return o.find(".cmty-cancel-button").on("click",function(){}),o},ComViews.fireBookmarkModal=function(e,t,o){var i,s;i=ComViews.constructBookmarkModal(e,t),s=i.find(".cmty-submit-button"),i.showModal({type:"confirm",title:Lang["bookmark-modal-title-"+e],force_response:!0,closeX:!1,confirm_button_cancel:Lang["bookmark-modal-cancel"],confirm_button_ok:Lang["bookmark-modal-ok"],width:"450px",onButtonClick:function(e){e&&o({is_bookmarked:!0,is_watched:i.find('input[name="bkmk-watch-me"]').is(":checked"),in_feed:i.find('input[name="bkmk-add-feed"]').is(":checked")}),AoPS.Ui.Modal.closeAllModals()}})},ComViews.fetchTopicsListConstructor=function(e){switch(e){case"my_privates":return ComViews.TopicsListPrivates;case"user_search_posts":case"search":return ComViews.TopicsListSearchPosts;default:return ComViews.TopicsList}},ComViews.fetchCategoryCellConstructor=function(e){switch(e){case"forum":case"forum_class":return ComViews.CategoryCell;case"my_privates":return ComViews.CategoryCellMyPrivates;case"folder":case"folder_forums":case"folder_collections":case"folder":case"my_forums":case"my_blogs":case"blogroll":case"my_collections":return ComViews.CategoryCellFolder;case"my_books":return ComViews.CategoryCellMyBooks;case"blog":return ComViews.CategoryCellBlog;case"my_classes":return ComViews.CategoryCellMyClasses;case"my_bookmarks":return ComViews.CategoryCellMyBookmarks;case"view_topics":return ComViews.CategoryCellTopicView;case"bookmark_topics":case"feed_topics":return ComViews.CategoryCellTopicBookmarks;case"bookmark_users":return ComViews.CategoryCellBookmarkUsers;case"view_forums":return ComViews.CategoryCellForumView;case"bookmark_forums":return ComViews.CategoryCellForumBookmarks;case"view_tags":return ComViews.CategoryCellTagView;case"view_posts":return ComViews.CategoryCellPostView;case"bookmark_tags":return ComViews.CategoryCellTagBookmarks;case"user":return ComViews.CategoryUserCell}return ComViews.CategoryCell},ComViews.fetchCategoryCellCategoryTopConstructor=function(e){switch(e){case"my_privates":return ComViews.CategoryCellCategoryTopMyPrivates;case"bookmark_forums":case"view_forums":return ComViews.CategoryCellCategoryTopViewForums;case"bookmark_topics":case"feed_topics":case"view_topics":return ComViews.CategoryCellCategoryTopViewTopics;case"bookmark_tags":case"view_tags":return ComViews.CategoryCellCategoryTopViewTags;case"user_search_posts":return ComViews.CategoryCellCategoryTopUserSearchPosts;case"search":return ComViews.CategoryCellCategoryTopSearch;default:return ComViews.CategoryCellCategoryTop}},ComViews.Post=AoPS.View.extend({template_id:"#cmty-post-tpl",className:"cmty-post",show_link_in_post_number_modal:!1,initialize:function(e){this.topic=e.topic,this.is_read=!0,this.watching_edit_time=!1,this.has_poll=this.topic.model.get("poll_id")>0&&1==this.model.get("post_number"),this.render(),this.listenTo(this.model,"change:show_from_start change:show_from_end",_.bind(function(){this.topic.setPostVisibility(this)},this)),this.listenTo(this.model,"change:deleted",this.onChangeDeleted),this.listenTo(this.model,"change:thanks_received change:nothanks_received",this.renderThankCount),this.listenTo(this.model,"hard_delete",this.removePostFromTopic),this.listenTo(this.model,"change:attachment change:attachments",this.parseAttachments),this.listenTo(this.model,"change:post_rendered",this.render),this.listenTo(this.model,"change:date_rendered",_.bind(function(){this.$el.find(".cmty-post-date").html(this.model.get("date_rendered"))},this)),this.listenTo(this.model,"change:last_edit_time_rendered",this.parseEditData)},render:function(){var e,t,o,i=this.constructReportTemplateData(),s=this.model.get("admin"),a=this.topic.model.getPermission("c_can_edit"),n=this,r=this.topic.model.get("has_thanks")&&this.topic.model.getPermission("c_can_thank")&&AoPS.session.user_id!=this.model.get("poster_id"),l=this.topic.model.get("has_nothanks")&&this.topic.model.getPermission("c_can_nothank")&&AoPS.session.user_id!=this.model.get("poster_id"),c=this.topic.model.getPermission("c_can_delete")&&this.model.get("post_number")>1,d=this.model.isDeletableByUser();d&&!c&&this.listenTo(this.topic.model,"change:last_post_id",function(){n.$(".cmty-post-delete").toggle(n.topic.model.get("last_post_id")==n.model.get("post_id"))}),t=s?Lang["post-user-tooltip-admin"]:this.model.get("is_forum_admin")?Lang["post-user-tooltip-forum-admin"]:this.model.get("is_forum_mod")?Lang["post-user-tooltip-mod"]:Lang["post-user-tooltip-regular"],o={user_id:this.model.get("poster_id"),has_poll:this.has_poll,username:this.model.get("username"),date_rendered:this.model.get("date_rendered"),post_number:this.model.get("post_number"),post_number_title:Lang["post-number-title"],has_real:this.model.get("real_poster_id")>0&&this.model.get("real_poster_id")!=this.model.get("poster_id"),real_poster_id:this.model.get("real_poster_id"),real_username:this.model.get("real_poster_username"),is_reported:i.is_reported,highlight_report_button:i.highlight_report_button,post_rendered:this.model.get("post_rendered"),avatar:this.model.get("avatar"),user_tooltip_text:t,one_post:1==this.model.get("num_posts"),can_pm:AoPS.session.logged_in,is_admin:s,is_forum_admin:!s&&this.model.get("is_forum_admin"),is_forum_mod:!s&&this.model.get("is_forum_mod"),num_posts:this.model.get("num_posts"),rating:this.model.get("rating"),report_title:i.title,lang_post_unread:Lang["post-unread-tootip"],post_rendered:this.model.get("post_rendered"),can_quote:!this.topic.model.get("locked")&&!this.topic.model.get("forum_locked"),can_report:i.can_report,thankers:this.model.get("thankers"),lang_thankers:Lang["post-thanked-by"],can_edit:this.topic.model.getPermission("c_can_lock_category")&&a||!this.topic.model.get("locked")&&!this.topic.model.get("forum_locked")&&(a||this.model.get("editable")&&this.topic.model.getPermission("c_can_edit_own_posts")),can_delete:c||d,can_undelete:this.topic.model.getPermission("c_can_undelete"),thanking_active:r,nothanking_active:l},this.$el.html(this.getTemplate(this.template_id,o)),r&&(this.$thanks=this.$(".cmty-post-thank"),this.setThanks(),this.listenTo(this.model,"change:is_thanked",this.setThanks)),l&&(this.$nothanks=this.$(".cmty-post-nothank"),this.setNothanks(),this.listenTo(this.model,"change:is_nothanked",this.setNothanks)),this.$post_html=this.$(".cmty-post-html"),this.setTargetBox(),this.model.get("can_target")&&this.listenTo(this.topic.model,"change:target_url change:target_text",this.setTargetBox),this.$attachments=this.$(".cmty-post-attachments"),this.parseAttachments(),this.parseEditData(),this.renderThankCount(),this.listenTo(this.model,"change:thankers",this.setThankersBox),this.setVisibility(),this.has_poll&&this.initializePoll(),i.can_settle_report&&this.listenTo(this.model,"change:reported",this.onReportedChange),this.topic.model.get("is_search_result")&&(e=this.topic.model.fetchSearchText("post_text"),e.length>0&&(this.$post_html.extendedHighlightText("cmty-highlight",e),this.model.get("post_id")===this.topic.model.get("focus_post").get("post_id")&&this.$("a.cmty-hide-heading").trigger("click")))},setThankersBox:function(){this.$(".cmty-post-thankers").html('<span class="cmty-thank-title">'+Lang["post-thanked-by"]+'</span> <span class="cmty-thankers">'+this.model.get("thankers")+"</span>"),this.model.get("thanks_received")<=0&&this.$el.removeClass("cmty-post-show-thanks")},setThanks:function(){var e,t;this.model.get("is_thanked")?(e=Lang["post-unthank-this"],t="{"):(e=Lang["post-thank-this"],t="Y"),this.$thanks[0].title=e,this.$thanks.text(t)},setNothanks:function(){var e,t;this.model.get("is_nothanked")?(e=Lang["post-unnothank-this"],t="}"):(e=Lang["post-nothank-this"],t="_"),this.$nothanks[0].title=e,this.$nothanks.text(t)},setTargetBox:function(){var e,t,o;this.$(".cmty-post-target-note").remove(),this.model.checkShowTargetLink()&&(e=new RegExp(document.domain+"/"+AoPS.router_root),o=document.domain+this.topic.model.get("target_url"),t=Utils.formatString(Lang["topic-full-post-with-target-url"],[this.topic.model.get("target_url"),this.topic.model.get("topic_id"),e.test(o)?AoPS.pushState_attr:"",this.topic.model.get("target_text").length>0?this.topic.model.get("target_text"):Lang["topic-full-target-text-default"]]),(AoPS.session.user_id===this.model.get("poster_id")||AoPS.session.user_id===this.model.get("real_poster_id"))&&(t+='<div class="cmty-remove-target"><a class="faux-link">'+Lang["topic-full-remove-target"]+"</a></div>"),this.$el.find(".cmty-post-body").prepend(this.getTemplate("#cmty-post-to-target-link-tpl",{target_note:t})))},initializePoll:function(){this.$poll=this.$(".cmty-post-poll"),this.listenTo(this.topic.model,"change:poll_data",this.constructPoll),this.$poll_loader=$('<div class="cmty-poll-display-top cmty-poll-display">'+Lang["poll-loading"]+"</div>"),this.topic.model.has("poll_data")&&!_.isEmpty(this.topic.model.get("poll_data"))?this.constructPoll():this.$poll.append(this.$poll_loader)},constructPoll:function(){var e,t,o,i,s=this;this.$poll_loader.detach(),this.topic.model.computeDerivedPollData(),e=this.topic.model.get("poll_data"),t=Utils.formatString(Lang[1==e.num_selections?"poll-select-one":"poll-select-many"],[e.num_selections]),i=e.num_votes+Lang[1===e.num_votes?"poll-Vote":"poll-Votes"],o=e.has_voted&&e.can_vote,this.$poll.html(this.getTemplate("#cmty-poll-display-tpl",{lang_heading:Lang["poll-display-heading"],question:e.question,options:e.options,lang_select_options:t,lang_votes:i,input_type:1==e.num_selections?"radio":"checkbox",can_vote:e.can_vote,has_toggle:!e.poll_closed&&!e.has_voted,lang_poll_vote:e.has_voted?Lang["poll-revote-btn"]:Lang["poll-vote-btn"],lang_hide_results:Lang["poll-hide-results"],lang_show_results:Lang["poll-show-results"],has_helper_text:!AoPS.session.logged_in||o,lang_helper:AoPS.session.logged_in?Lang["poll-revote-directions"]:Lang["poll-not-logged-in"]})),this.$poll.toggleClass("cmty-poll-show-results",e.poll_closed||e.has_voted),this.poll_selections=[],e.can_vote&&_.each(e.options,function(e){e.selected&&s.poll_selections.push(e.id)})},parseAttachments:function(){var e,t=[],o=[],i=this,s="";this.$el.toggleClass("post-has-attachment",this.model.get("attachment")),this.$attachments.html(""),this.model.get("attachment")&&(_.each(this.model.get("attachments"),function(e){i.isAttachmentImage(e.mimetype)?t.push(e):o.push(e)}),this.$attachments.append('<div class="cmty-post-attached-title">'+Lang["post-attachments"]+"</div>"),t.length>0&&(e='<div class="cmty-post-attached-images"><div class="cmty-post-attached-image-content">',_.each(t,function(t){e+='<a target="_blank" href="'+t.href+'"><img title="'+t.name+'" src="'+Constants.attachment_path+t.url+'"></a>'}),e+="</div></div>",this.$attachments.append(e)),o.length>0&&(_.each(o,function(e){s+='<div class="cmty-post-attached-file"><a target="_blank" href="'+e.href+'">'+e.name+" ("+e.size+"kb)</a></div>"}),this.$attachments.append(s)))},isAttachmentImage:function(e){return"image"===e.substr(0,5)},markUnread:function(){this.$el.addClass("cmty-post-unread"),this.is_read=!1},markRead:function(){this.$el.removeClass("cmty-post-unread"),this.is_read=!0},constructReportTemplateData:function(){var e={can_report:this.topic.model.getPermission("c_can_report"),can_settle_report:this.topic.model.getPermission("c_can_settle_report"),is_reported:this.model.get("reported"),title:""};return e.can_report&&(e.is_reported?e.can_settle_report?e.title=Lang["topic-full-settle-report-title"]:e.title=Lang["topic-full-already-reported-title"]:e.title=Lang["topic-full-report-post-title"]),e.highlight_report_button=e.can_settle_report&&e.is_reported,e},onReportedChange:function(){this.topic.model.getPermission("c_can_settle_report")&&this.$el.find(".cmty-post-report").toggleClass("cmty-post-settle-report",this.model.get("reported"))},parseEditData:function(){var e,t=this.model.get("num_edits");this.$el.toggleClass("cmty-post-edited",t>0),t>0&&(this.model.get("edit_time_on_timer")&&!this.watching_edit_time&&(this.watching_edit_time=!0),e=Lang["topic-full-edited-1"]+t+(t>1?Lang["topic-full-edited-3"]:Lang["topic-full-edited-2"])+Lang["topic-full-edited-4"]+this.model.get("last_editor_username")+", "+this.model.get("last_edit_time_rendered"),this.model.get("last_edit_reason").length>0&&(e+="<br>"+Lang.Reason+": "+this.model.get("last_edit_reason")),this.$el.find(".cmty-post-edit-info").html(e))},events:{"click .cmty-post-report":"onClickReport","click .cmty-post-settle-report":"onClickSettleReport","click .cmty-post-quote":"onClickQuote","click .cmty-post-delete":"onClickDelete","click .cmty-post-deleted-info":"onClickDeletedInfo","click .cmty-undelete-post":"onClickUndelete","click .cmty-post-thank":"onClickThanks","click .cmty-post-nothank":"onClickNothanks","click .cmty-post-edit":"onClickEdit","click .cmty-post-number":"onClickDirectLink","click .cmty-poll-results-toggle span":"onClickTogglePollResults","click .cmty-poll-vote-row .btn":"onClickPollVote","mousedown .cmty-post-middle":"onClickPostBody","click .cmty-remove-target":"onClickRemoveTarget","click .cmty-post-thank-count":"onClickThankCount","click .cmty-pm-from-post":"onClickMessage"},onClickMessage:function(e){var t,o,i,s,a=this.constructPostUrl();return this.model.get("real_poster_id")>0?(o=this.model.get("real_poster_id"),i=this.model.get("real_poster_username")):(o=this.model.get("poster_id"),i=this.model.get("username")),t=ComViews.launchNewPrivateMessage({user_id:o,username:i,is_admin:this.model.get("admin")}),s=this.topic.model.isPrivateMessage()?"":Utils.formatString(Lang["private-from-post"],[a.url]),s+='[quote="'+this.model.get("username")+'"]'+this.model.get("post_canonical")+"[/quote]",t.addContent(s),_.isUndefined(e)?void 0:(e.stopPropagation(),e.preventDefault(),!1)},onClickThankCount:function(){this.$el.toggleClass("cmty-post-show-thanks")},onClickRemoveTarget:function(){var e,t=this,o=this.model.get("topic");e=o.get("target_text").length>0?Utils.formatString(Lang["mod-topic-remove-target-with-text"],[o.get("target_text")]):Lang["mod-topic-remove-target-confirm"],Modal.showConfirm(e,function(e){e?(ComViews.replaceWithLoaderBlockingMessage(Lang["mod-topic-remove-target-blocker"]),t.model.get("topic").removeTarget({onFinish:function(){setTimeout(function(){Modal.closeAllModals()},500)},onError:ComViews.throwAjaxError})):Modal.closeAllModals()},{width:"450px",close_on_button_click:!1})},onClickTogglePollResults:function(){this.$poll.toggleClass("cmty-poll-show-results")},onClickPostBody:function(e){e.stopPropagation()},onClickPollVote:function(){var e,t=this.topic.model.get("poll_data").num_selections,o=this;if(1===t){if(e=this.$poll.find('input:radio[name="poll-options"]:checked').val(),_.isUndefined(e))return void AoPS.Ui.Modal.showAlertQuick(Lang["poll-nothing-selected"]);e=[e]}else{if(e=[],_.each(this.$poll.find('input:checkbox[name="poll-options"]:checked'),function(t){e.push(t.value)}),0==e.length)return void AoPS.Ui.Modal.showAlertQuick(Lang["poll-nothing-selected"]);if(e.length>t)return void AoPS.Ui.Modal.showAlertQuick(Utils.formatString(Lang["poll-too-many-selected"],[t]))}e.join()!==this.poll_selections.join()&&(AoPS.Community.Views.throwBlockingMessage(Lang["poll-vote-processing"]),this.topic.model.castVote({votes:e,onFinish:function(){setTimeout(function(){AoPS.Ui.Modal.closeAllModals()},Constants.message_readability_delay_short)},onError:function(e){var t,i=e.error_code;"E_NOT_LOGGED_IN"===i?t=Lang["poll-err-not-logged-in"]:"E_POLL_CLOSED"===i?(o.topic.model.get("poll_data").poll_closed=!0,o.topic.model.trigger("change:poll_data"),t=Lang["poll-err-closed"]):t=Lang["unexpected-error-code"]+i,AoPS.Community.Views.showError(t)}}))},constructPostUrl:function(){var e="/community/c"+this.topic.model.get("category_id")+"h"+this.model.get("topic_id")+"p"+this.model.get("post_id"),t=Constants.base_url+e;return{url_path:e,url:t}},onClickDirectLink:function(e){var t,o,i,s,a=this.constructPostUrl(),n=this;t=$('<div class="cmty-post-direct-modal">'+Utils.formatString(Lang["post-direct-link"],[a.url_path])+'<br><br>					<input value="'+a.url+'" /></div>'),AoPS.session.a&&(o=$('<button class="btn btn-primary">'+Lang["post-direct-click-ip"]+"</button>"),i=$("<div>"+Lang["post-direct-loading-ip"]+"</div>"),t.append("<br><br>").append(o),o.on("click",function(){o.hide(),t.append(i),n.model.fetchIP({onFinish:function(e){i.text(e.ip)},onError:function(e){i.text(e.error_code)}})})),t.showModal({width:"400px"}),s=t.find("input"),s[0].setSelectionRange(0,s.val().length),e.stopPropagation(),e.preventDefault()},onClickEdit:function(e){var t,o=1===this.model.get("post_number")?"EditFirstPost":"EditPost";return e.stopPropagation(),e.preventDefault(),this.topic.model.get("forum_locked")&&!this.topic.model.getPermission("c_can_lock_category")?void Modal.showMessage(Lang["topic-edit-forum-locked"]):!this.topic.model.getPermission("c_can_edit")&&this.topic.model.get("locked")?void Modal.showMessage(Lang["topic-edit-locked"]):(t=new AoPS.Community.Views[o]({post_model:this.model,topic_id:this.model.get("topic_id"),category_id:this.topic.model.get("category_id"),topic:this.topic.model,master:this.topic.model.get("master"),input_text:this.model.get("post_canonical")}),t.$el.showModal({frame_class:"cmty-posting-modal",mask_fade_in_speed:200,scrollable:!1,max_width:"1000px",onClickMask:function(e){return t.onClickCancel(),!1},onClickX:function(){return t.onClickCancel(),!1}}),void t.setHeight())},onClickThanks:function(e){var t=this.model.get("is_thanked")?0:1;this.model.setThankStatus({new_status:t})},onClickNothanks:function(e){var t=this.model.get("is_nothanked")?0:-1;this.model.setThankStatus({new_status:t})},onClickQuote:function(){AoPS.session.logged_in?AoPS.isUserLimited()?Modal.showMessage(Lang["new-reply-no-permission-limited"],{width:"450px"}):this.topic.model.get("locked")?Modal.showMessage(Lang["topic-full-reply-to-locked"]):this.topic.model.get("forum_locked")?Modal.showMessage(Lang["topic-full-reply-to-forum-locked"]):this.topic.appendToReply("[quote="+this.model.get("username")+"]"+$.trim(this.model.get("post_canonical"))+"[/quote]\n\n"):AoPS.Ui.buildLoginConfirm(Lang["topic-full-unregistered-reply"])},onClickReport:function(e){var t;return e.stopPropagation(),e.preventDefault(),this.model.get("reported")?this.topic.model.getPermission("c_can_settle_report")?void 0:void AoPS.Ui.Modal.showMessage(Lang["topic-full-already-reported"]):(t=new ComViews.ReportPost({model:this.model}),void t.$el.showPlainModal())},onClickSettleReport:function(e){ComViews.inCmtyRouter()?ComViews.followUrlOnClick(e,"/reported-posts/p"+this.model.get("post_id")):window.location.href="/community/reported-posts/p"+this.model.get("post_id"),e.stopPropagation(),e.preventDefault()},onClickDelete:function(e){var t;t=new ComViews.DeletePost({model:this.model,topic:this.model.get("topic")}),t.$el.showPlainModal(),e.stopPropagation(),e.preventDefault()},onClickDeletedInfo:function(){this.$el.toggleClass("cmty-post-deleted-open")},onClickUndelete:function(e){return AoPS.Ui.Modal.showMessage(Lang["topic-full-undelete-message"],{type:"confirm",title:Lang["topic-full-undelete-title"],confirm_button_ok:Lang.yes,confirm_button_cancel:Lang.no,onButtonClick:_.bind(function(e){e&&this.model.undelete({onError:function(e){"E_HARD_DELETE"===e.error_code&&Flyout.display(Lang["topic-full-undelete-hard"])}}),AoPS.Ui.Modal.closeAllModals()},this)}),e.stopPropagation(),e.preventDefault(),!1},onChangeDeleted:function(){this.model.get("deleted")&&!this.topic.model.getPermission("c_can_read_deleted")?this.removePostFromTopic():this.setVisibility()},removePostFromTopic:function(){"function"==typeof this.topic.removePost&&this.topic.removePost(this)},renderThankCount:function(){this.model.get("thanks_received")>0&&this.topic.model.get("has_thanks")?this.$el.find(".cmty-post-thank-count").html($.parseHTML(" &bull; "+this.model.get("thanks_received")+' <span class="aops-font">Y</span>')):this.$el.find(".cmty-post-thank-count").html(""),this.model.get("nothanks_received")>0&&this.topic.model.get("has_nothanks")?this.$el.find(".cmty-post-nothank-count").html($.parseHTML(" &bull; "+this.model.get("nothanks_received")+' <span class="aops-font">_</span>')):this.$el.find(".cmty-post-nothank-count").html("")},setVisibility:function(){this.$el.toggleClass("cmty-post-is-deleted",this.model.get("deleted"))}}),ComViews.ModerateTopic=AoPS.View.extend({template_id:"#cmty-moderate-topic-tpl",initialize:function(e){var t,o=this.model.get("locked"),i=this,s=[],a="private"===this.model.get("topic_type"),n=this.model.get("announce_type");ComViews.setRouteInfo(this,e),this.topic_category_at_initialization=e.topic_category_at_initialization,this.$el.html($(this.getTemplate(this.template_id,{title:this.model.get("topic_title"),username:this.model.get("first_poster_name")}))),this.$buttons_cell=this.$el.find(".cmty-moderate-topic-buttons"),a||(this.buildButton({permission:"c_can_move_topic_out",symbol:"N",text:Lang["mod-topic-move"],onClick:"onClickMoveTopic"}),this.buildButton({permission:"c_can_lock_topic",symbol:o?"l":"k",text:o?Lang["mod-topic-unlock"]:Lang["mod-topic-lock"],onClick:"onLockTopic"})),this.model.get("category_id")!=Constants.recycle_bin_id&&this.buildButton({permission:"c_can_delete",symbol:"J",text:Lang["mod-topic-delete"],onClick:"onSoftDeleteTopic"}),this.buildButton({permission:"c_can_hard_delete",symbol:"J",text:Lang["mod-topic-hard-delete"],onClick:"onHardDeleteTopic"}),a||("none"===n?(this.buildButton({permission:"c_can_announce",symbol:"i",text:Lang["mod-topic-announce"],onClick:"onMakeLocalAnnouncement"}),this.buildButton({permission:"c_can_global_announce",symbol:"a",text:Lang["mod-topic-global"],onClick:"onMakeGlobal"})):"local"===n?(this.buildButton({permission:"c_can_announce",symbol:"i",text:Lang["mod-topic-normal"],onClick:"onMakeNormal"}),this.buildButton({permission:"c_can_global_announce",symbol:"a",text:Lang["mod-topic-global"],onClick:"onMakeGlobal"})):"global"===n&&this.buildButton({permission:"c_can_global_announce",symbol:"a",text:Lang["mod-topic-normal"],onClick:"onMakeNormal"})),this.model.get("cat_can_target")&&(t=this.model.get("target_url").length>0,this.buildButton({permission:"c_can_add_target",symbol:"j",text:t?Lang["mod-topic-replace-target"]:Lang["mod-topic-add-target"],onClick:"onAddTarget"}),t&&this.buildButton({permission:"c_can_remove_target",symbol:"Jj",text:Lang["mod-topic-remove-target"],onClick:"onRemoveTarget"}),this.buildButton({permission:"c_can_add_target",symbol:"+",text:Lang["mod-topic-add-hidden"],onClick:"onAddHiddenTag"}),this.model.getPermission("c_can_remove_target")&&this.model.get("tags").length>0&&(s=this.findRemovableHiddenTags(),s.length>0&&(this.$el.append('<div class="cmty-mod-topic-hidden-title"><u>'+Lang["mod-topic-hidden-tags"]+"</u></div>"),_.each(s,function(e){var t=$('<div class="cmty-mod-topic-hidden-tag"><span class="aops-font">J</span>'+e.tag_text+"</div>");i.$el.append(t),t.find(".aops-font").on("click",function(){i.model.removeTag(e.tag_id,e.tag_text),t.remove(),0==i.findRemovableHiddenTags().length&&i.$(".cmty-mod-topic-hidden-title").remove()})})))),this.model.get("master").fetchPermission("can_access_log")&&this.buildButton({symbol:"h",text:Lang["mod-topic-log"],onClick:"onVisitLog"}),this.$el.showModal({title:Lang["mod-topic-title"],onClose:function(){i.destroy()}})},onVisitLog:function(e){ComViews.leaveRouterOnClick(e,"/log/topic/"+this.model.get("topic_id"))},onAddTarget:function(){var e,t,o=this.model.get("target_url"),i=this,s=!1;o.length>0&&(t=_.findWhere(this.model.get("tags"),{tag_text:o}),s=!_.isUndefined(t)&&!t.is_public),e=$(this.getTemplate("#cmty-mod-topic-add-target-tpl",{current_target:o,is_restricted:s,lang_edit_instructions:Lang["mod-topic-edit-target-instructions"],lang_tag_text:Lang["mod-topic-edit-target-url"],lang_target_text:Lang["mod-topic-edit-target-text"],current_target_text:this.model.get("target_text"),lang_restricted:Lang["mod-topic-edit-target-is-restricted"]})),e.find('input[type="text"]').focus(),Modal.showConfirm(e,function(t){var a,n,r;if(t){if(a=$.trim(e.find("input.cmty-mod-topic-target").val()),n=$.trim(e.find("input.cmty-mod-topic-target-text").val()),0==a.length)return void i.destroy();if(ComViews.isStateTag(a))return void ComViews.showErrorAtopAModal(Lang["mod-topic-no-state-tags"]);if(r=e.find('input[type="checkbox"]').is(":checked"),a.toLowerCase()===o.toLowerCase()&&r==s&&n===i.model.get("target_text"))return void i.destroy();ComViews.replaceWithLoaderBlockingMessage(Lang["mod-topic-remove-target-blocker"]),i.model.changeTargetUrl({new_target:a,new_target_text:n,is_restricted:r,onFinish:function(){setTimeout(function(){i.destroy()},500)},onError:ComViews.throwAjaxError})}else i.destroy()},{width:"450px",close_on_button_click:!1})},onAddHiddenTag:function(){var e,t=this;e=$(this.getTemplate("#cmty-mod-topic-add-target-tpl",{lang_edit_instructions:Lang["mod-topic-hidden-tag-instructions"],lang_tag_text:Lang["mod-topic-hidden-tag-text"],lang_restricted:Lang["mod-topic-hidden-tag-is-restricted"],current_target:"",is_restricted:!1})),e.find('input[type="text"]').focus(),
Modal.showConfirm(e,function(o){var i,s;if(o){if(i=$.trim(e.find('input[type="text"]').val()),0==i.length)return void t.destroy();if(ComViews.isStateTag(i))return void ComViews.showErrorAtopAModal(Lang["mod-topic-no-state-tags"]);s=e.find('input[type="checkbox"]').is(":checked"),ComViews.replaceWithLoaderBlockingMessage(Lang["mod-topic-hidden-tag-blocker"]),t.model.addHiddenTag({new_text:i,is_restricted:s,onFinish:function(){setTimeout(function(){t.destroy()},500)},onError:ComViews.throwAjaxError})}else t.destroy()},{width:"450px",close_on_button_click:!1})},findRemovableHiddenTags:function(){var e=[],t=this;return _.each(this.model.get("tags"),function(o){o.is_visible||o.tag_text===t.model.get("target_url")||ComViews.isStateTag(o.tag_text)||e.push(o)}),e},onLockTopic:function(){this.model[this.model.get("locked")?"unlock":"lock"](),this.destroy()},onRemoveTarget:function(){var e=this;Modal.showConfirm(Lang["mod-topic-remove-target-confirm"]+Lang["mod-topic-remove-target-extra"],function(t){t?(ComViews.replaceWithLoaderBlockingMessage(Lang["mod-topic-remove-target-blocker"]),e.model.removeTarget({onFinish:function(){setTimeout(function(){e.destroy()},500)},onError:ComViews.throwAjaxError})):e.destroy()},{width:"450px",close_on_button_click:!1})},hasTopicMoved:function(){return this.topic_category_at_initialization!=this.model.get("category_id")?(AoPS.Ui.Modal.showMessage(Lang["mod-topic-move-err-E_ALREADY_MOVED"]),!0):!1},onClickMoveTopic:function(){var e=this;this.checkTopicLength({onOK:function(){e.onMoveTopic()}})},onMoveTopic:function(){function e(){return function(e){var t,o=e.error_code;t=Lang.hasOwnProperty("mod-topic-move-err-"+o)?Lang["mod-topic-move-err-"+o]:Lang["unexpected-error-code"]+o,AoPS.Ui.Modal.showAlert(t,{onClose:function(){c.destroy()},width:"450px"})}}function t(e,t){return function(){var o="/c"+e+"h"+t;"/community"===c.url_router_base?(Backbone.trigger("close_feed_topic"),Backbone.history.navigate(o,{trigger:!0}),c.close()):window.location.href="/community"+o}}if(!this.hasTopicMoved()){var o,i,s=Constants.move_topic_quick_links,a=AoPS.session.logged_in&&s.hasOwnProperty(this.model.get("category_id").toString()),n=this.model.get("master").fetchCategory(this.model.get("category_id")),r=(this.model.get("category_id"),$(this.getTemplate("#cmty-mod-topic-move-tpl",{has_current_category:!_.isUndefined(n),topic_title:this.model.get("topic_title"),quick_link_title:Lang["mod-topic-move-quick"],first_poster_name:this.model.get("first_poster_name"),input_heading:Lang["mod-topic-move-input-heading"],has_quick_links:a}))),l=this.model.get("topic_id"),c=this;_.isUndefined(n)||(o=r.find(".cmty-item-forum").first(),o.html(n.get("category_name")).css({color:n.get("main_color")})),a&&(i=r.find(".cmty-mod-topic-move-quick"),_.each(s[this.model.get("category_id").toString()],function(o){var s,a=c.model.get("master").fetchCategory(o);_.isUndefined(a)||(s=$("<div/>",{"class":"cmty-item-forum",html:a.get("category_name")}).on("click",function(){var o=a.get("category_id");AoPS.Community.Views.throwBlockingMessage(Lang["mod-topic-move-in-progress"]),c.model.move({new_category_id:o,onFinish:t(o,l),onError:e()})}),s.css({color:a.get("main_color")}).on("mouseenter",function(e){s.css({color:a.get("secondary_color"),"background-color":a.get("main_color")})}).on("mouseleave click",function(e){s.css({color:a.get("main_color"),"background-color":"#fff"})}),i.append(s))})),Utils.buildCategoryAutocomplete(r.find("input").first(),{ajax_call:"fetch_forum_autocomplete",autocomplete_settings:{onSelect:function(o,i){var s=parseInt(i.item.category_id);AoPS.Community.Views.throwBlockingMessage(Lang["mod-topic-move-in-progress"]),c.model.move({new_category_id:s,onFinish:t(s,l),onError:e()})},onOpen:function(){}}}),r.showModal({title:Lang["mod-topic-move-title"],frame_class:"cmty-move-topic-modal aops-modal-standard",scrollable:!1,max_width:"400px",onClose:function(){r.remove()}})}},onSoftDeleteTopic:function(){var e=this;this.checkTopicLength({onOK:function(){e.onDeleteTopic("soft")}})},onHardDeleteTopic:function(){var e=this;this.checkTopicLength({onOK:function(){e.onDeleteTopic("hard")}})},checkTopicLength:function(e){this.model.get("num_posts")>Constants.topic_move_length_limit?AoPS.session.a?(AoPS.Ui.Modal.showConfirm(Lang["mod-long-topic-admin-warning"],function(t){AoPS.Ui.Modal.closeTopModal(),t&&e.onOK()},{confirm_button_ok:Lang["mod-long-topic-admin-OK"],confirm_button_cancel:Lang["mod-long-topic-admin-no"],width:"450px",close_on_button_click:!1}),$(":focus").blur()):AoPS.Ui.Modal.showAlert(Lang["mod-topic-delete-err-E_TOPIC_TOO_LONG"],{onClose:function(){self.destroy()},width:"400px"}):e.onOK()},setAnnouncementType:function(e,t){var o=this;this.model.setAnnounceType({type:e,announce_through:t,onFinish:function(){var e;e=o.url_cmty_path+"/c"+o.model.get("category_id")+"h"+o.model.get("topic_id"),Backbone.history.fragment=null,Backbone.history.navigate(e,{trigger:!0}),o.destroy()},onError:function(e){var t=e.error_code;Lang.hasOwnProperty("mod-topic-announce-err-"+t)?msg=Lang["mod-topic-announce-err-"+t]:msg=Lang["unexpected-error-code"]+t,AoPS.Ui.Modal.showAlert(msg,{onClose:function(){o.destroy()}})}})},onMakeNormal:function(){this.setAnnouncementType("none","")},onMakeLocalAnnouncement:function(){this.fetchAnnouncementDate("local")},onMakeGlobal:function(){this.fetchAnnouncementDate("global")},fetchAnnouncementDate:function(e){var t=$("<div>"+Lang["mod-topic-set-announce-through"]+'<br><input type="text" class="cmty-posting-announce-through" placeholder="yyyy-mm-dd"></div>'),o=t.find("input"),i=this;ComViews.makeAnnounceDateInput(o),Modal.showConfirm(t,function(t){t&&(ComViews.replaceWithLoaderBlockingMessage(Lang["mod-topic-announce-blocker"]),setTimeout(function(){i.setAnnouncementType(e,o.val())},500))},{close_on_button_click:!1})},onDeleteTopic:function(e){var t=this;this.model.get("topic_type");AoPS.Ui.Modal.showConfirm(Lang["mod-topic-"+e+"-delete-warning"],function(o){o?(AoPS.Community.Views.throwBlockingMessage(Lang["mod-topic-delete-pending"]),t.model["delete"]({delete_type:e,onFinish:function(){Backbone.trigger("close_feed_topic"),t.destroy()},onError:function(e){var o,i;i=e.error_code,o=Lang.hasOwnProperty("mod-topic-delete-err-"+i)?Lang["mod-topic-delete-err-"+i]:Lang["unexpected-error-code"]+i,AoPS.Ui.Modal.showAlert(o,{onClose:function(){t.destroy()},width:"400px"})}})):AoPS.Ui.Modal.closeTopModal()},{title:Lang["mod-topic-"+e+"-delete-title"],close_on_button_click:!1})},destroy:function(){AoPS.Ui.Modal.closeAllModals(),this.close()},buildButton:function(e){var t=this;(!e.hasOwnProperty("permission")||this.model.getPermission(e.permission))&&this.$buttons_cell.append($("<button/>",{"class":"btn btn-primary",html:'<span class="aops-font">'+e.symbol+"</span> "+e.text}).on("click",function(o){t[e.onClick](o)})).append("<br>")}}),ComViews.makeAnnounceDateInput=function(e){e.on("blur",function(t){var o,i=e.val();0!==i.length&&(o=moment(i,"YYYY-MM-DD"),o.isValid()?moment().diff(moment(i,"YYYY-MM-DD"),"days")>0?(ComViews.showErrorAtopAModal(Lang["post-environ-announce-date-too-early"]),e.val("")):moment().diff(moment(i,"YYYY-MM-DD"),"years")<=-2&&(ComViews.showErrorAtopAModal(Lang["post-environ-announce-date-too-late"]),e.val("")):(ComViews.showErrorAtopAModal(Lang["post-environ-invalid-announce-date"]),e.val("")))})},ComViews.Itembox=AoPS.View.extend({className:"cmty-itembox",push_state_attribute:"data-cmty",check_can_remove:!1,can_remove_all:!1,scrollbarCreator:ComViews.buildCommunityScrollbar,initialize:function(e){var t=this;this.url_cmty_path="",this.url_router_base="/community",_.defaults(this,e),this.hasOwnProperty("scrollbar_arguments")||(this.scrollbar_arguments={}),e.hasOwnProperty("check_can_remove")&&(this.check_can_remove=e.check_can_remove),e.hasOwnProperty("can_remove_all")&&(this.can_remove_all=e.can_remove_all),ComViews.setRouteInfo(this,e),this.render_tooltips_on_items="forum"!=this.model.get("category_type")&&!this.model.get("is_private"),this.render(),this.$loader=$('<div class="cmty-itembox-loader">'+Lang["cmty-itembox-loader"]+"</div>"),this.listenTo(this.model,"item_removed",this.render),this.listenTo(this.model,"item_added",this.addItem),this.$el.find(".aops-scroll-bar").on("slider_at_end",function(){t.model.get("no_more_items")||($(document).trigger("mouseup"),t.$itembox.append(t.$loader),t.$scrollable.scrollTop(t.$scrollable[0].scrollHeight),t.model.fetchMoreItems({onFinish:function(e){var o;t.$loader.detach(),t.model.get("no_more_items")||(o=t.$itembox.parent(),t.$itembox.height-(o.scrollTop()+o.height())<10&&t.$el.find(".aops-scroll-bar").trigger("slider_at_end"))},onError:function(){t.$loader.detach()}}))})},render:function(){var e,t,o,i=this.model.get("items").length;if(this.$itembox=$("<div/>",{"class":"cmty-itembox-inner-box"}),this.category_id=this.hasOwnProperty("category_id")?this.category_id:this.model.get("category_id"),this.category_type=this.model.get("category_type"),this.item_cells=[],i>0){for(e=0;i>e;e++)t=this.model.get("items")[e],o=this.constructItem(t),this.item_cells.push(o);this.$itembox.append(this.item_cells)}else this.hasOwnProperty("placeholder_text")&&(this.$placeholder=$("<div/>",{"class":"cmty-itembox-placeholder"}).append(this.placeholder_text),this.$itembox.append(this.$placeholder));this.$el.html(this.scrollbarCreator(this.$itembox,this.scrollbar_arguments)),this.$scrollable=this.$el.find(".aops-scroll-inner")},constructItem:function(e){var t,o,i,s,a,n,r,l,c,d,_=this,h=!0;switch(a={main_color:e.item_main_color,secondary_color:e.item_secondary_color},"tag"===e.item_type?(n=this.model.get("special_url").length>0?this.model.get("special_url"):this.url_cmty_path+"/c"+this.category_id,t=n+"t"+e.item_id+"f"+e.item_forum_id+"_"+ComViews.convertToUrlFragment(e.item_text)):"blog"===e.item_type||"blogroll"===e.item_type||"folder_collections"===e.item_type||"folder_forums"===e.item_type||"folder"===e.item_type||"forum_class"===e.item_type||"forum"===e.item_type||"view"===e.item_type.substr(0,4)||"bookmark"===e.item_type.substr(0,8)?t=this.url_cmty_path+"/c"+e.item_id+"_"+ComViews.convertToUrlFragment(e.item_text):"user"===e.item_type&&(t=this.url_cmty_path+"/user/"+e.item_id),"blog"===e.item_type&&(h=!1),r="<a "+(h?this.push_state_attribute:"")+' href="'+ComViews.makeLinkUrl(t,this.url_router_base)+'">',c=this.check_can_remove&&(this.can_remove_all||e.hasOwnProperty("item_can_remove")&&e.item_can_remove),remove_text=c?'<span class="cmty-delete-item aops-font">J</span>':"",e.item_type){case"forum":case"forum_class":case"folder":case"folder_forums":case"folder_collections":case"blogroll":case"blog":case"view_tags":case"view_topics":case"view_posts":r+='<div class="cmty-item-'+e.item_type+'" style="color:'+a.main_color+'"><div class="cmty-item-text">'+e.item_text+'<br><span class="cmty-item-subtitle">'+e.item_subtitle+"</span></div>"+remove_text+"</div>";break;case"user":l=Utils.getLastVisitedText(e),r+='<div class="cmty-item-'+e.item_type+'"><img src="'+e.avatar+'"><div class="cmty-item-text">'+e.item_text+'<br><span class="cmty-item-subtitle">'+l+"</span></div>"+remove_text+"</div>";break;case"bookmark_tags":case"bookmark_topics":case"feed_topics":case"bookmark_forums":r+='<div class="cmty-item-'+e.item_type+'" style="color:'+a.main_color+'"><div class="cmty-item-text-w-extra">'+e.item_text+"</div>"+remove_text+"</div>";break;default:d="<div",this.render_tooltips_on_items&&e.hasOwnProperty("item_category_name")&&(d+=' title="'+Lang["tag-tooltip-forum"]+" "+e.item_category_name+'"'),d+=' style="background-color:'+a.main_color+'" ',d+=' class="cmty-item-'+e.item_type+'">'+e.item_text+remove_text+"</div>",r+=d}return r+="</a>",o=$(r),c&&o.find(".cmty-delete-item").on("click",function(t){_.onClickDelete(e,o),t.stopPropagation(),t.preventDefault()}),i=o.find(".cmty-item-"+e.item_type),"tag"===e.item_type?i.on("mouseenter",function(e){i.css({"background-color":a.secondary_color,color:a.main_color})}).on("mouseleave",function(e){i.css({"background-color":a.main_color,color:""})}).on("click",function(e){i.css({"background-color":a.main_color,color:""})}):(s=i.find(".cmty-item-subtitle"),i.on("mouseenter",function(e){i.css({color:a.secondary_color,"background-color":a.main_color}),s.addClass("cmty-item-subtitle-on-hover")}).on("mouseleave",function(e){i.css({color:a.main_color,"background-color":""}),s.removeClass("cmty-item-subtitle-on-hover")}).on("click",function(e){i.css({color:a.main_color,"background-color":""}),s.removeClass("cmty-item-subtitle-on-hover")})),o},onClickDelete:function(e,t){this.hasOwnProperty("onDeleteItem")&&this.onDeleteItem(e)},addItem:function(e){var t;this.hasOwnProperty("$placeholder")&&this.$placeholder.detach(),t=this.constructItem(e),this.item_cells.push(t),this.$itembox.append(t)},events:{},onClose:function(){}}),ComViews.ItemboxPosts=ComViews.Itembox.extend({post_views:[],constructItem:function(e){var t;return this.hasOwnProperty("has_label_column")||(this.has_label_column=ComViews.ViewPosts.prototype.hasLabel.apply(this)),t=new ComViews.ViewPostsItem({model:this.model,item:e,has_label_column:this.has_label_column}),this.post_views.push(t),t.$el},onClose:function(){ComViews.Itembox.prototype.onClose.apply(this),_.each(this.post_views,function(e){e.close()})}}),ComViews.TopicCell=AoPS.View.extend({template_id:"#cmty-topic-cell-tpl",className:"cmty-topic-cell",marked_for_deletion:!1,is_hidden_until_page_add:!1,full_topics_popup:!1,has_subtitle:!0,is_focus:!1,watch_focus:!0,show_focus_post:!1,show_forum:!1,in_feed:!1,initialize:function(e){this.master=e.master,this.route_category_id=e.route_category_id,this.topic_list=e.topic_list,ComViews.setRouteInfo(this,e),this.focus_tag=e.hasOwnProperty("focus_tag")?e.focus_tag:null,this.buildRoutes(),"/community"===this.url_router_base&&"blog_post"===this.model.get("topic_type")&&this.model.get("category_id")!==Constants.blog_recycle_bin_id&&(this.push_state_attribute=""),this.setAnnouncementStatus(),this.buildTopic(),this.setColor(),this.setReadStatus(),this.skip_onClickTopic=!1,this.listenTo(this.model,"change:is_read",this.setReadStatus),this.listenTo(this.model,"change:num_posts",this.onChangeNumPosts),this.listenTo(this.model,"change:last_post_id",this.onChangeLastPost),this.watch_focus&&this.setFocusWatchBehavior(),this.listenTo(this.model,"change:watchers_usernames change:num_watchers change:num_views",this.constructWatchersLine),this.listenTo(this.model,"change:last_post_rendered_time",this.onChangeLastPostTime),this.listenTo(this.model,"change:first_post_rendered_time",this.onChangeFirstPostTime),this.listenTo(this.model,"change:locked change:forum_locked",this.setTitleLine),this.listenTo(this.model,"change:deleted",this.onDelete),this.listenTo(this.model,"change:preview",this.onChangePreview),this.listenTo(this.model,"change:topic_title",this.setTitleLine),this.model.getPermission("c_can_monitor")&&this.listenTo(this.model,"change:state",this.setColor)},onChangePreview:function(){this.$post_preview.html(this.model.get("preview"))},events:{"click a.cmty-topics-list-jump-bottom-link":"onClickJumpToBottom","click .cmty-topic-cell-close-topic":"onClickClose","click .cmty-post-settle-report":"onClickSettleReport","click .cmty-topic-cell-forum-view-last-poster":"onClickJumpToBottom","click a.cmty-topics-list-goto-unread-link":"onClickGotoUnread"},setFocusWatchBehavior:function(){this.listenTo(this.model,"change:is_master_focus",this.checkFocusTopic),this.checkFocusTopic()},onClickJumpToBottom:function(e){},onClickGotoUnread:function(e){},setColor:function(){var e,t,o=this,i=this.model.getPermission("c_can_monitor"),s=this.model.get("category_main_color"),a="",n=this.model.get("category_secondary_color");e=this.is_focus?n:s,this.$el.find(".cmty-color-main").css({color:e}),this.$el.find(".cmty-topic-cell-top").css({"background-color":s}),i&&this.colorMonitoredTopic(n,s),t=Utils.hexToRgb(n),_.isNull(t)||(a="rgba("+parseInt((255+t.r)/2)+","+parseInt((255+t.g)/2)+","+parseInt((255+t.b)/2)+", 1.0)"),this.$el.on("mouseenter",function(e){o.is_focus||o.$el.add(o.$topic_watchers).css({"background-color":a})}).on("mouseleave click",function(e){i?o.colorMonitoredTopic(n,s):o.$el.add(o.$topic_watchers).css({"background-color":""})})},colorMonitoredTopic:function(e,t){var o="open"===this.model.get("state"),i=o&&!this.is_focus?e:"";this.$el.css({"background-color":i,"border-left":o?"3px "+t+" solid":"auto"}),this.$topic_watchers.css({"background-color":i})},setAnnouncementStatus:function(){this.topic_list.collection.category.get("show_announcements")?this.announce_type=this.model.get("announce_type"):this.announce_type="none"},buildTopic:function(){var e,t=this.model.get("posts"),o=(t.at(t.length-1),this.url_router_base+this.url_cmty_path);t.at(0);this.$el.html(this.getTemplate(this.template_id,{route:AoPS.Community.Views.makeLinkUrl(this.route,o),route_bottom:AoPS.Community.Views.makeLinkUrl(this.route_bottom,o),route_back:AoPS.Community.Views.makeLinkUrl(this.route_back,o),route_unread:AoPS.Community.Views.makeLinkUrl(this.route_unread,o),push_state_attribute:this.push_state_attribute,category_id:this.model.get("category_id"),topic_id:this.model.get("topic_id"),lang_visit_in_forum:Lang["topic-cell-visit-in-forum"],full_topics_popup:this.full_topics_popup,first_poster_username:this.model.get("first_poster_name"),has_subtitle:this.has_subtitle,has_replies:this.model.get("num_posts")>1,last_poster_username:this.model.get("last_poster_name"),last_post_time:this.model.get("last_post_rendered_time"),topic_title:this.model.get("topic_title"),post_text:this.show_focus_post?this.model.get("focus_post").get("post_rendered"):this.model.get("preview"),first_poster_avatar:this.model.get("first_poster_avatar"),first_post_time:this.model.get("first_post_rendered_time"),is_logged_in:AoPS.session.logged_in,title_jump_end:Lang["topic-cell-title-jump-end"],title_settle:Lang["topic-cell-title-settle"],title_close:Lang["topic-cell-title-close"],title_unread:Lang["topic-cell-title-unread"],can_have_source:this.model.get("can_have_source"),has_source:this.model.get("source").length>0,source:this.model.get("source"),lang_source_title:Lang["topic-cell-source"],show_forum:this.show_forum,lang_Posted_at:this.show_focus_post?Utils.formatString(Lang["topic-cell-Posted-at"],[this.model.get("focus_post").get("username"),this.model.get("focus_post").get("poster_id"),Lang["topic-cell-view-user-profile"]]):"",show_focus_post_date:this.show_focus_post,focus_post_number:this.show_focus_post?this.model.get("focus_post").get("post_number"):0,focus_post_date:this.show_focus_post?Utils.makePrettyTimeStatic(this.model.get("focus_post").get("post_time")):0,category_name:this.model.get("category_name")})),this.has_subtitle&&(this.$subtitle=this.$el.find(".cmty-topic-cell-subtitle")),this.$watchers_line=this.$el.find(".cmty-topic-cell-watchers"),this.$watchers_line_forum_view=this.$el.find(".cmty-topic-cell-data-watchers"),this.$subject_line=this.$el.find(".cmty-topic-cell-subject"),this.$topic_cell_time=this.$el.find(".cmty-topic-cell-time"),this.$topic_watchers=this.$(".cmty-topic-watchers"),this.$post_preview=this.$el.find(".cmty-topic-cell-post"),this.$forum_view_last_poster=this.$el.find(".cmty-topic-cell-forum-view-last-poster"),this.$replies_line=this.$el.find(".cmty-topic-cell-replies"),this.$data_posts=this.$el.find(".cmty-topic-cell-data-posts"),this.setTitleLine(),this.onChangeNumPosts(),this.onChangeLastPost(),this.constructWatchersLine(),"local"===this.announce_type?this.$el.addClass("cmty-topics-list-local-announcement"):"global"===this.announce_type&&this.$el.addClass("cmty-topics-list-global-announcement"),this.model.getPermission("c_can_settle_report")&&(this.onChangeNumReports(),this.listenTo(this.model,"change:num_reports",this.onChangeNumReports)),this.model.get("can_have_source")&&this.listenTo(this.model,"change:source",this.onChangeSource),this.model.get("is_search_result")&&(this.model.get("focus_post").get("deleted")&&this.$el.addClass("cmty-search-target-deleted"),e=this.model.fetchSearchText("post_text"),e.length>0&&this.$post_preview.extendedHighlightText("cmty-highlight",e),e=this.model.fetchSearchText("title"),e.length>0&&this.$subject_line.extendedHighlightText("cmty-highlight",e),this.model.get("source").length>0&&(e=this.model.fetchSearchText("source"),e.length>0&&this.$(".cmty-topic-cell-source").extendedHighlightText("cmty-highlight",e)))},constructSubtitle:function(){this.has_subtitle&&this.$subtitle.html(this.getTemplate("#cmty-topic-cell-subtitle-tpl",{has_replies:this.model.get("num_posts")>1,last_poster_username:this.model.get("last_poster_name"),last_post_time:this.model.get("last_post_rendered_time")}))},constructWatchersLine:function(){var e,t,o=this.model.get("num_watchers"),i=!1,s=0,a="",n=this.model.get("num_views"),r=_.unescape(this.model.get("topic_title"));return this.in_feed&&"private"!==this.model.get("topic_type")&&(r+="\n"+_.unescape(this.model.get("category_name"))),0===o?this.$topic_watchers.hide():(e=this.model.get("num_named_watchers"),r+="\n",r+=0===e?Utils.formatString(Lang["topic-cell-"+(1===o?"":"not-")+"1-reader"],[o]):Lang["topic-cell-reading-now"]+this.model.get("watchers_usernames")+(o>e?" +"+(o-e):""),t=this.model.get("watchers_avatars"),!this.model.get("master").get("current_user").get("hide_avatars")&&!_.isUndefined(t)&&t.length>0&&(t=t.split(" "),i=!0,t.length>0&&(t.length>6&&(t=_.first(t,6)),_.each(t,function(e){e=$.trim(e),!_.isUndefined(e)&&e.length>0&&(a+='<img class="cmty-avatar" src="'+e+'" width="15" height="15">',s+=1)}))),i?t.length<o&&(a+=" <span>+"+(o-s)+'</span> <span class="aops-font">w</span>'):a=o+" "+Lang.viewing,this.$topic_watchers.html(a),this.$topic_watchers.show()),r+="\n"+this.model.get("num_views")+" "+(1===n?Lang.view:Lang.views),"none"!==this.model.get("announce_type")&&this.model.get("announce_through").length>0&&(r+="\nAnnouncement ends "+moment(this.model.get("announce_through"),"YYYY-MM-DD").format("MMM Do, YYYY")+"."),this.el.title=r,r},setTitleLine:function(){var e="";e+=this.model.get("locked")||this.model.get("forum_locked")?'<span class="aops-font">k</span>&nbsp;':"",e+="local"===this.model.get("announce_type")?'<span class="aops-font">i</span>&nbsp;':"",e+=this.model.get("poll_id")>0?'<span class="aops-font">9</span>&nbsp;':"",e+="global"===this.model.get("announce_type")?'<span class="aops-font">a</span>&nbsp;':"",e+=this.model.get("topic_title"),this.$subject_line.html(e)},onChangeNumReports:function(){var e;this.model.getPermission("c_can_settle_report")&&(e=this.$el.find(".cmty-topic-cell-topic-reported"),0===e.length&&this.model.get("num_reports")>0?(e=this.getTemplate("#cmty-topic-cell-reported-topic-tpl",{topic_id:this.model.get("topic_id")}),this.$el.find(".cmty-topic-cell-left").append(e)):e.toggle(this.model.get("num_reports")>0))},onChangeNumPosts:function(){this.$replies_line.html(this.model.get("num_posts")-1),this.$data_posts.html(this.model.get("num_posts")-1+' <span class="cmty-no-tablet">'+(2==this.model.get("num_posts")?Lang["topic-cell-reply"]:Lang["topic-cell-replies"])+"</span>"),this.constructSubtitle()},buildForumViewLastPoster:function(){var e=this.url_router_base+this.url_cmty_path;this.$forum_view_last_poster.html(this.getTemplate("#cmty-topic-cell-forum-view-last-poster-tpl",{has_replies:this.model.get("num_posts")>1,last_poster_username:this.model.get("last_poster_name"),route_bottom:AoPS.Community.Views.makeLinkUrl(this.route_bottom,e),last_poster_avatar:this.model.get("last_poster_avatar"),last_post_time:this.model.get("last_post_rendered_time"),no_replies_message:Lang["topic-cell-no-replies"],push_state_attribute:this.push_state_attribute}))},onChangeLastPost:function(){this.constructSubtitle(),this.buildForumViewLastPoster()},onChangeLastPostTime:function(){this.$el.find(".cmty-reply-time").html(this.model.get("last_post_rendered_time")),this.buildForumViewLastPoster()},onChangeFirstPostTime:function(){this.$topic_cell_time.html(this.model.get("first_post_rendered_time"))},onChangeSource:function(){var e;this.model.get("can_have_source")&&(e=this.model.get("source"),e.length>0?this.$(".cmty-topic-cell-source").html('<span class="cmty-source-title">'+Lang["topic-cell-source"]+"</span>: "+e):this.$(".cmty-topic-cell-source").html(""))},onDelete:function(){this.close()},markMoved:function(){this.route_category_id=this.model.get("category_id"),this.$post_preview.html(this.route_category_id===Constants.recycle_bin_id?Lang["topic-cell-recycled-topic"]:Lang["topic-cell-moved-topic"]),this.buildRoutes(),this.$el.find("a.cmty-full-cell-link").attr("href","/community"+this.route).removeAttr(this.push_state_attribute).attr("data-cmty",!0),this.$el.find("a.cmty-topics-list-jump-bottom-link").attr("href","/community"+this.route_bottom).removeAttr(this.push_state_attribute).attr("data-cmty",!0),this.$el.find("a.cmty-topics-list-goto-unread-link").attr("href","/community"+this.route_unread).removeAttr(this.push_state_attribute).attr("data-cmty",!0)},buildRoutes:function(){var e,t,o=ComViews.convertToUrlFragment(this.model.get("topic_title"));e="priv"===this.topic_list.collection.category.get("category_type")?"/x"+this.topic_list.collection.category.get("user_id"):"/c"+this.route_category_id,_.isNull(this.focus_tag)||(e+="t"+this.focus_tag.item_id+"f"+this.focus_tag.item_forum_id),t=e+"h"+this.model.get("topic_id"),this.route=t+"_"+o,this.route_bottom=t+"s1_"+o,this.route_back=e,this.route_unread=t+"s2_"+o,"private"===this.model.get("topic_type")&&"archived"===this.model.get("status")&&(this.route_back="/my-messages-archive",null!=this.focus_tag&&(this.route_back+="/t"+this.focus_tag.item_id+"f"+this.focus_tag.item_forum_id))},checkFocusTopic:function(){this.is_focus=this.model.get("is_master_focus"),this.processFocusTopicStatusChange()},processFocusTopicStatusChange:function(){this.$el.toggleClass("focus-topic",this.is_focus),this.setColor()},setReadStatus:function(){this.$el.toggleClass("topic-unread",!this.model.get("is_read"))}}),ComViews.TopicCellPopout=ComViews.TopicCell.extend({parent:ComViews.TopicCell,buildTopic:function(){this.parent.prototype.buildTopic.apply(this),this.createStuntDouble()},createStuntDouble:function(){var e=this.url_router_base+this.url_cmty_path;return this.$stunt_double=$(this.getTemplate("#cmty-topic-cell-stunt-double-tpl",{wrapper_class:"cmty-topic-cell-double focus-topic "+this.className,push_state_attribute:this.push_state_attribute,full_topics_popup:this.full_topics_popup,route:AoPS.Community.Views.makeLinkUrl(this.route,e),route_bottom:AoPS.Community.Views.makeLinkUrl(this.route_bottom,e),route_back:AoPS.Community.Views.makeLinkUrl(this.route_back,e),title_settle:Lang["topic-cell-title-settle"],has_settleable_reports:this.model.get("num_reports")>0&&this.model.getPermission("c_can_settle_report")})),("global"===this.model.get("announce_type")||"local"===this.model.get("announce_type"))&&this.$stunt_double.addClass("cmty-stunt-double-announcement"),this.constructWatchersLine(),this.$stunt_double},constructWatchersLine:function(){var e=this.parent.prototype.constructWatchersLine.apply(this);this.hasOwnProperty("$stunt_double")&&(this.$stunt_double[0].title=e)},onClose:function(){this.$stunt_double.remove()}}),ComViews.search_post_topic_cell_arguments={className:ComViews.TopicCell.prototype.className+" cmty-topic-cell-search-post",show_focus_post:!0,show_forum:!0,buildRoutes:function(){var e,t,o,i,s=this.model.get("focus_post"),a=s.get("post_id"),n=this.topic_list.collection.category;"user_search_posts"===n.get("category_type")?(e="u",t=n.get("user_id")):"search"===n.get("category_type")?(e="q",t=n.get("search_id")):console.log("Uh-oh, building a Search Posts type topic cell without 					user_search_posts or search type category"),o="/"+e+t,i=o+"h"+this.model.get("topic_id")+"p"+a,this.route=i,this.route_bottom=i+"s1",this.route_back=o+(n.has("encoded_search_text")?"_"+n.get("encoded_search_text"):""),this.route_unread=i+"s2"}},ComViews.TopicCellSearchPost=ComViews.TopicCell.extend(ComViews.search_post_topic_cell_arguments),ComViews.TopicCellSearchPopout=ComViews.TopicCellPopout.extend(ComViews.search_post_topic_cell_arguments),ComViews.CategoryCellTopicCell=ComViews.TopicCell.extend({has_subtitle:!1,watch_focus:!0}),ComViews.TopicsList=AoPS.View.extend({template_id:"#cmty-category-cell-topics-tpl",list_location:"master",no_more_items_message:Lang["topics-list-no-more-items"],no_items_at_all_message:Lang["topics-list-no-items-at-all"],className:"cmty-topics-list",focus_tag:null,popout_focus_cell:null,focus_topic_cell:null,fetch_topics_on_build:!0,on_page:!1,use_topic_category:!1,topicView:ComViews.TopicCell,popoutView:ComViews.TopicCellPopout,initialize:function(e){var t=this;this.view_start_id=0,this.view_end_id=-1,this.suppress_scroll=!1,ComViews.setRouteInfo(this,e),this.$loader=AoPS.Page.buildLoader(),this.$no_more_topics=$('<div class="cmty-no-more-topics">'+this.no_more_items_message+"</div>"),this.listenTo(this.collection,"bulk_topics_added",this.addBulkLoadedTopics),this.suppress_initial_fetch=e.hasOwnProperty("suppress_initial_fetch")?e.suppress_initial_fetch:!1,this.can_toggle_scroll_style="boolean"==typeof e.can_toggle_scroll_style&&e.can_toggle_scroll_style,this.on_initial_topic_fetch=!1,this.scroll_inner_listener_set=!1,e.hasOwnProperty("use_topic_category")&&(this.use_topic_category=e.use_topic_category),0!==this.collection.length||this.suppress_initial_fetch?this.constructTopicsList(e):this.onEmptyCollection(e),0===this.collection.length&&this.suppress_initial_fetch&&this.appendNoMoreTopicsMessage(),this.topics_hidden_until_next_add=[],this.updated_topics=[],this.topics_marked_for_deletion=!1,this.listenTo(this.collection,"reset",this.onCollectionReset),this.listenTo(this.collection.category,"check_for_more_topics",function(){t.collection.length<10&&(t.suppress_scroll=!0,t.fetchMoreTopics())})},isFixedHeight:function(){return"feed"===this.list_location?!0:(!this.can_toggle_scroll_style||$(window).width()>Constants.phone_mode_max_width)&&this.$scrollbar.is(":visible")},onCollectionReset:function(){_.each(this.topic_boxes,function(e){e.close()}),this.topic_boxes=[],this.view_start_id=0,this.view_end_id=-1,this.topics_hidden_until_next_add=[],this.topics_marked_for_deletion=!1,this.updated_topics=[],this.$no_more_topics.detach(),this.on_page&&this.onSliderAtBottom()},onEmptyCollection:function(e){this.constructTopicsList(e)},onAddToPage:function(){var e=this;this.$scroll_area.scrollTop(this.scroll_loc),!_.isNull(this.getFocusTopic())&&this.$el.is(":visible")&&this.shiftToTopic(this.getFocusTopic()),this.on_page=!0,this.checkQueuedUpTopicBoxes(),this.parseFocusTopic(),this.setFocusListener(),$("#cmty-topic-view-top .cmty-cat-cell-jump-top").on("click.cat-jump-to-top-"+this.cid,function(){e.onClickJumpToTop()}),$(window).on("scroll.topics_list-"+this.cid+" touchmove.topics_list-"+this.cid,_.bind(function(){var e=$(document).scrollTop();_.isUndefined(this.$scrollbar)||this.$el.is(":visible")&&!this.$scrollbar.is(":visible")&&(document.documentElement.clientHeight+e>=document.body.offsetHeight-50&&this.onSliderAtBottom(),e<$("#header-wrapper").outerHeight()+parseInt($("#main-content").css("padding-top"))+$("#cmty-topic-view-top").height()&&this.onSliderAtTop())},this)),this.checkIfEnoughCells()},onClose:function(){var e,t=this.topic_boxes.length;for(e=0;t>e;e++)this.topic_boxes[e].hasOwnProperty("is_placeholder")&&this.topic_boxes[e].is_placeholder||this.topic_boxes[e].close();this.hasOwnProperty("popout_focus_cell")&&!_.isNull(this.popout_focus_cell)&&this.popout_focus_cell.close()},parseFocusTopicList:function(){this.master.get("focus_topic_list")!=this.collection&&(this.processUpdatedTopicVisibility(),this.stopListening(this.master,"change:focus_topic_list"))},processUpdatedTopicVisibility:function(){var e,t,o=this,i=[],s=null;if(this.hasOwnProperty("topic_boxes")){if(this.topics_marked_for_deletion){for(t=this.topic_boxes.length,e=t-1;e>=0;e--)this.topic_boxes[e].marked_for_deletion?(this.updateViewLimitIdOnDelete(e),
this.topic_boxes[e].close()):i.unshift(this.topic_boxes[e]);this.topic_boxes=i,this.updated_topics=[],this.topics_marked_for_deletion=!1}_.each(this.topics_hidden_until_next_add,function(e){o.addTopic(e,{})}),this.topics_hidden_until_next_add=[]}for(t=this.topic_boxes.length,e=0;t>e;e++)"none"!==this.topic_boxes[e].announce_type?(this.topic_boxes[e].$el.removeClass("cmty-last-announcement"),s=this.topic_boxes[e]):e=t;_.isNull(s)||s.$el.addClass("cmty-last-announcement")},onRemoveFromPage:function(){this.on_page=!1,this.stopListening(this.master,"change:focus_topic"),this.stopListening(this.master,"change:fullscreen_mode"),$("#cmty-topic-view-top .cmty-cat-cell-jump-top").off("click.cat-jump-to-top-"+this.cid),$(window).off("scroll.topics_list-"+this.cid+" touchmove.topics_list-"+this.cid)},shiftToTopic:function(e){var t,o,i,s=_.find(this.topic_boxes,function(t){return t.model===e&&!t.is_hidden_until_page_add}),a=this.$topics_window.height(),n=this.$topics_box.height();a>n||s&&(this.isFixedHeight()?(i=s.$el.position().top,t=i-this.$scroll_area.scrollTop(),(0>t||t+s.$el.height()>a)&&this.$scroll_area.scrollTop(-Math.max(-i,a-n))):(i=s.$el.offset().top,o=$(window).scrollTop(),(o>i||o+$(window).height()>i+s.$el.height())&&window.scrollTo(0,i)))},checkIfEnoughCells:function(){var e,t;if(this.$topics_box.is(":visible")&&this.$topics_window.is(":visible")){if(e=this.$topics_box.height(),$(window).width()<=Constants.phone_mode_max_width&&e>$(window).height())return;t=this.$topics_window.height(),e>0&&t>0&&t>=e&&this.fetchMoreTopics()}},constructFetchMoreTopicsOptions:function(){var e=this,t=1===arguments.length&&"boolean"==typeof arguments[0].never_cancel?arguments[0].never_cancel:!1;return{source:this.list_location,never_cancel:t,onFinish:function(){e.parseFocusTopic(),e.$loader.detach(),e.collection.all_topics_fetched&&e.appendNoMoreTopicsMessage(),e.on_initial_topic_fetch=!1,e.suppress_scroll=!1,e.checkIfEnoughCells(),ComViews.isIOS&&e.$scroll_area.css({"-webkit-overflow-scrolling":"touch"})},onError:function(t){var o;e.$loader.detach(),"E_AJAX_CANCEL"!==t.error_code&&(o="string"==typeof Lang["topic-fetch-err-"+t.error_code]?Lang["topic-fetch-err-"+t.error_code]:Lang["unexpected-error-code"]+t.error_code,"E_AJAX_TIMEOUT"!=t.error_code&&(e.collection.all_topics_fetched=!0),ComViews.showError(o),ComViews.isIOS&&e.$scroll_area.css({"-webkit-overflow-scrolling":"touch"}))}}},fetchMoreTopics:function(){var e=1===arguments.length?arguments[0]:{};this.collection.topics_loading||(0===this.collection.length&&(this.on_initial_topic_fetch=!0,this.suppress_scroll=!0),this.collection.all_topics_fetched?(this.suppress_scroll=!1,this.appendNoMoreTopicsMessage()):(this.$topics_box.append(this.$loader),ComViews.isIOS&&(this.$scroll_area.css({"-webkit-overflow-scrolling":"auto"}),this.$scroll_area.scrollTop(this.$scroll_area[0].scrollHeight)),this.collection.fetchMoreTopics(this.constructFetchMoreTopicsOptions(e))))},constructTopicsList:function(e){var t,o,i=this.collection.length,s=[];if(_.extend(this,_.pick(e,"master","focus_tag","main_color","secondary_color")),this.category_id=e.category_id,this.$topics_box=$("<div/>",{"class":"cmty-topics-list-inner-box"}),this.$title_bar=$(this.getTemplate("#cmty-topic-list-heading-tpl",{topic:"Topic",first:"First Poster",last:"Last Poster"})),this.$topics_box.append(this.$title_bar),this.topic_boxes=[],i>0){for(t=Math.min(Constants.max_num_shown_topics,i)-1,o=0;t>=o;o++)this.addTopic(this.collection.models[o],{add_in_bulk:!0});for(o=0;t>=o;o++)s.push(this.topic_boxes[o].$el);if(i-1>t)for(o=t;i>o;o++)this.topic_boxes.push({model:this.collection.models[o],is_placeholder:!0});this.$title_bar.after(s),this.view_end_id=t}this.min_add_bulk_idx=Constants.BIG,this.$scrollwrapped_list=AoPS.Community.Views.buildCommunityScrollbar(this.$topics_box,{onScroll:_.bind(function(){this.onScroll()},this)}),this.$el.append(this.$scrollwrapped_list),this.$topics_window=this.$topics_box.parent(),this.$scroll_inner_window=this.$el.find(".aops-scroll-inner"),this.$scrollbar=this.$el.find(".aops-scroll-bar"),this.$scrollbar.before('<div title="'+Lang["topic-list-jump-top"]+'" class="cmty-topic-list-jump-top clickable">G</div>'),this.$scroll_slider=this.$scrollbar.find(".aops-scroll-slider"),this.$scrollbar.on("slider_at_end",_.bind(function(){this.onSliderAtBottom()},this)),this.$scrollbar.on("slider_at_start",_.bind(function(){this.onSliderAtTop()},this)),this.listenTo(this.collection,"add",this.addTopicAfterLoad),this.listenTo(this.collection,"remove",this.removeTopic),this.scroll_loc=0,this.$scroll_area=this.$topics_box.parent(),this.$scroll_area.on("scroll",_.bind(function(){this.scroll_loc=this.$scroll_area.scrollTop()},this)),this.collection.all_topics_fetched?this.appendNoMoreTopicsMessage():this.fetch_topics_on_build&&!this.suppress_initial_fetch&&this.checkMoreTopicsNeeded(),this.$scroll_area.scrollTop(0),"condensed"===this.master.get("current_user").get("forum_view")&&this.$el.addClass("cmty-condensed-topic-list")},events:{"click .cmty-topic-list-jump-top":"onClickJumpToTop"},setFocusListener:function(){this.listenTo(this.master,"change:focus_topic",this.onChangeFocusTopic),this.listenTo(this.master,"change:focus_topic_list",this.parseFocusTopicList),this.listenTo(this.master,"change:fullscreen_mode",this.onChangeFullscreen)},onChangeFullscreen:function(){var e=this;setTimeout(function(){e.setPopoutVisibility()},10)},getFocusTopic:function(){return this.master.get("focus_topic")},onScroll:function(){_.isNull(this.getFocusTopic())||this.setPopoutVisibility()},revealFocusCell:function(e){var t="top"===e,o=this.getFocusTopic(),i=this;this.hasOwnProperty("popout_focus_cell")&&!_.isNull(this.popout_focus_cell)&&(this.popout_focus_cell.$el.show(),this.$stunt_double.show(),this.focus_cell_location=e,this.scroll_inner_listener_set||(this.$scroll_inner_window.on("scroll.stunt",function(){i.locateStuntDouble(e)}),this.scroll_inner_listener_set=!0),this.$el.toggleClass("top-focus-popup",t),this.$el.toggleClass("bottom-focus-popup",!t),this.$el.toggleClass("announcement-popup",!("none"===o.get("announce_type"))),this.stunt_double_height=this.$stunt_double.outerHeight(),i.locateStuntDouble(e))},locateStuntDouble:function(e){var t=this.$scroll_inner_window.scrollTop();"top"===e?this.$stunt_double.css("top",t+"px"):this.$stunt_double.css("top",t+this.$scroll_inner_window.height()-this.stunt_double_height+"px")},setPopoutVisibility:function(){var e=this.getFocusTopic(),t=-1,o=this.topic_boxes.length,i=null;if(this.on_page){for(var s=0;o>s;s++)if(this.topic_boxes[s].model===e){t=s,i=this.topic_boxes[s];break}if(_.isNull(i))return _.isNull(e)?void 0:void(this.collection.filter(e)?this.revealFocusCell("bottom"):this.destroyPopoutCell());if(t<this.view_start_id)return void this.revealFocusCell("top");if(t>this.view_end_id)return void this.revealFocusCell("bottom");focus_top=-this.$scroll_inner_window.scrollTop()+i.$el.position().top,focus_top<.5?this.revealFocusCell("top"):focus_top>this.$el.height()-i.$el.outerHeight()?this.revealFocusCell("bottom"):(this.$el.removeClass("top-focus-popup bottom-focus-popup"),this.hasOwnProperty("popout_focus_cell")&&!_.isNull(this.popout_focus_cell)&&this.popout_focus_cell.$el.hide(),this.$stunt_double.hide(),this.$scroll_inner_window.off("scroll.stunt"))}},destroyPopoutCell:function(){_.isNull(this.popout_focus_cell)||(this.stopListening(this.popout_focus_cell.model,"change:announce_type"),this.popout_focus_cell.close(),this.$stunt_double.remove(),this.$scroll_inner_window.off("scroll.stunt"),this.scroll_inner_listener_set=!1,this.popout_focus_cell=null,this.$el.removeClass("top-focus-popup bottom-focus-popup"))},onChangeFocusTopic:function(){var e=this;$(window).width()<=Constants.phone_mode_max_width&&(_.isNull(this.master.get("focus_topic"))?_.isUndefined(this.stored_window_top)||setTimeout(function(){window.scrollTo(0,e.stored_window_top)},10):this.stored_window_top=$(window).scrollTop()),this.parseFocusTopic()},parseFocusTopic:function(){var e;return this.on_page?(e=this.getFocusTopic(),_.isNull(e)?void this.destroyPopoutCell():_.isNull(this.popout_focus_cell)||this.popout_focus_cell.model!==e?(_.isNull(this.popout_focus_cell)||this.popout_focus_cell.close(),this.popout_focus_cell=new this.popoutView({model:e,topic_list:this,master:this.master,focus_tag:this.focus_tag,push_state_attribute:this.push_state_attribute,url_cmty_path:this.url_cmty_path,url_router_base:this.url_router_base,route_category_id:this.category_id}),this.listenTo(e,"change:announce_type",this.destroyPopoutCell),this.popout_focus_cell.$el.addClass("cmty-topic-list-popout"),this.$stunt_double=this.popout_focus_cell.$stunt_double,this.$scroll_inner_window.append(this.$stunt_double),_.isNull(this.popout_focus_cell)||this.$el.find(".aops-scroll-outer").append(this.popout_focus_cell.$el),void this.setPopoutVisibility()):void this.setPopoutVisibility()):void this.destroyPopoutCell()},checkMoreTopicsNeeded:function(){this.collection.all_topics_fetched?(this.topic_boxes.length<=Constants.num_topics_to_reveal&&(this.view_start_id=0,this.view_end_id=this.topic_boxes.length-1),this.appendNoMoreTopicsMessage()):this.topic_boxes.length<10&&(this.suppress_scroll=!0,this.onSliderAtBottom({never_cancel:!0}))},buildTopicCell:function(e){return new this.topicView({model:e,url_cmty_path:this.url_cmty_path,url_router_base:this.url_router_base,push_state_attribute:this.push_state_attribute,topic_list:this,master:this.master,focus_tag:this.focus_tag,route_category_id:this.use_topic_category?e.get("category_id"):this.category_id})},includeTopicWhenLocatingNew:function(e){return e.marked_for_deletion?this.collection.category.get("is_forum")?"none"!==e.model.get("announce_type"):!1:!0},addTopic:function(e,t){var o,i,s,a=this.buildTopicCell(e),n=-this.collection.comparator(e),r=t.hasOwnProperty("add_in_bulk")&&t.add_in_bulk&&"none"===e.get("announce_type"),l=!1,c=this.topic_boxes.length;for(a.is_hidden_until_page_add=!1,o=c-1;o>=0;o--)s=this.topic_boxes[o],this.includeTopicWhenLocatingNew(s)&&-this.collection.comparator(s.model)>n&&(r?this.min_add_bulk_idx>o+1&&(this.min_add_bulk_idx=o+1):s.$el.after(a.$el),this.topic_boxes.splice(o+1,0,a),i=o+1,o=-1,l=!0);if(l||(r?this.min_add_bulk_idx=0:this.$title_bar.after(a.$el),this.topic_boxes.splice(0,0,a),i=0),this.updateViewLimitIdOnAdd(i)||a.$el.detach(),"none"!==a.announce_type&&(i===c||"none"===this.topic_boxes[i+1].model.get("announce_type"))){for(o=0;i>o;o++)this.topic_boxes[o].$el.removeClass("cmty-last-announcement");a.$el.addClass("cmty-last-announcement")}return this.$no_more_topics.text(this.no_more_items_message),a},addTopicAfterLoad:function(e,t,o){var i,s,a=!1,n=!1;this.on_page&&"topic_update"===o.added_by&&(a=this.topics_marked_for_deletion&&_.indexOf(this.updated_topics,e)>-1),this.on_page&&(a||"topic_move"===o.added_by)&&this.collection.category!==e.get("force_add_to_category")?(-1===_.indexOf(this.topics_hidden_until_next_add,e)&&this.topics_hidden_until_next_add.push(e),n=!0):i=this.addTopic(e,o),o.add_in_bulk||(this.$loader.detach(),this.on_initial_topic_fetch||n||(this.isFixedHeight()?(s=this.$scroll_area.scrollTop(),i.$el.position().top<=s&&(this.$scroll_area.scrollTop(s+i.$el.outerHeight()),this.setPopoutVisibility())):this.on_page&&(s=$(window).scrollTop(),i.$el.position().top<=s&&window.scrollTo(0,s+i.$el.outerHeight()))))},removeTopic:function(e,t,o){var i,s,a=null,n=this,r=[],l=this.topic_boxes.length;for(_.each(this.topics_hidden_until_next_add,function(t){t!==e&&r.push(t)}),this.topics_hidden_until_next_add=r,i=0;l>i;i++)if(this.topic_boxes[i].model===e){s=i,a=this.topic_boxes[i];break}_.isNull(a)||_.isUndefined(a)||(this.on_page&&o.hasOwnProperty("removed_by")?("topic_update"===o.removed_by?(a.marked_for_deletion=!0,this.updated_topics.push(e),this.topics_marked_for_deletion=!0):"topic_move"===o.removed_by&&(a.marked_for_deletion=!0,this.topics_marked_for_deletion=!0,this.collection.filter(e)?(this.removeTopicBox(a,s,e),this.on_page&&this.getFocusTopic()===e&&setTimeout(function(){n.parseFocusTopic()},10)):a.markMoved()),Backbone.trigger("topic_cell_marked_for_deletion",{topics_list:this})):this.removeTopicBox(a,s,e)),!_.isNull(this.master.get("focus_topic"))&&this.on_page&&this.shiftToTopic(this.master.get("focus_topic")),0===this.collection.length&&this.$no_more_topics.text(this.no_items_at_all_message)},removeTopicBox:function(e,t,o){_.isNull(this.popout_focus_cell)||this.popout_focus_cell.model!==o||(this.popout_focus_cell.close(),this.popout_focus_cell=null,this.$el.removeClass("top-focus-popup bottom-focus-popup")),e.close(),this.topic_boxes=_.without(this.topic_boxes,e),this.updateViewLimitIdOnDelete(t)},addBulkLoadedTopics:function(){var e,t,o,i=[],s=this;if(this.min_add_bulk_idx<Constants.BIG&&(this.view_end_id===this.topic_boxes.length-1||this.view_end_id<=0)){for(o=this.topic_boxes.length-1,e=this.min_add_bulk_idx;o>=e;e++)i.push(this.topic_boxes[e].$el);this.$topics_box.append(i),this.checkRevealedTopics(),t=i.length>0?this.$loader.height():0,this.on_initial_topic_fetch||!this.on_page||this.suppress_scroll||(this.isFixedHeight()?0!=s.$scroll_area.scrollTop()&&s.$scroll_area.scrollTop(s.topic_boxes[s.min_add_bulk_idx].$el.position().top-s.$topics_window.height()):window.scrollTo(0,this.topic_boxes[this.min_add_bulk_idx].$el.offset().top-$(window).height()+20))}this.min_add_bulk_idx=Constants.BIG,this.$scrollwrapped_list.hasOwnProperty("aopsScroll")&&this.$scrollwrapped_list.aopsScroll.adjustSlider()},updateViewLimitIdOnAdd:function(e){return e<this.view_start_id?(this.view_start_id++,this.view_end_id++,!1):e>=this.view_start_id&&e<=this.view_end_id?(this.view_end_id++,!0):e==this.view_end_id+1&&1==this.on_page?(this.view_end_id++,!0):e>=this.view_end_id+1?!1:void 0},updateViewLimitIdOnDelete:function(e){e<this.view_start_id&&this.view_start_id--,e<=this.view_end_id&&this.view_end_id>=0&&this.view_end_id--},onClickJumpToTop:function(){var e,t,o=this.topic_boxes.length,i=[];for(this.view_end_id=Math.min(this.view_end_id,Constants.max_num_shown_topics-1),t=Math.min(this.view_start_id-1,this.view_end_id),this.view_start_id=0,e=this.view_start_id;t>=e;e++)i.push(this.topic_boxes[e].$el);for(e=this.view_end_id+1;o>e;e++)this.topic_boxes[e].$el.detach();this.$title_bar.after(i),this.isFixedHeight()?this.$scroll_area.scrollTop(0):window.scrollTo(0,0),this.markIfAtTop()},checkRevealedTopics:function(){var e,t,o,i,s,a;if(this.view_end_id-this.view_start_id<=Constants.max_num_shown_topics)return void this.markIfAtTop();if(this.on_page){for(e=this.$scroll_slider.position().top,a=this.$scrollbar.height(),s=this.topic_boxes.length,.2>e/a?(o=this.view_end_id-Constants.num_topics_to_hide+1,i=this.view_end_id,this.view_end_id=o-1):e/a>.7&&(i=this.view_start_id+Constants.num_topics_to_hide-1,o=this.view_start_id,this.view_start_id=i+1),t=o;i>=t;t++)this.topic_boxes[t].$el.detach();this.markIfAtTop()}},markIfAtTop:function(){var e=0==this.view_start_id;this.$el.toggleClass("cmty-not-at-top",!e),$("body").toggleClass("cmty-hide-header",!e)},checkQueuedUpTopicBoxes:function(){var e,t=[];if(-1===this.view_end_id){e=Math.min(this.topic_boxes.length,Constants.max_num_shown_topics);for(var o=0;e>o;o++)t.push(this.topic_boxes[o].$el);this.$title_bar.after(t),this.view_end_id=e-1,this.view_start_id=0}else this.view_end_id!==this.topic_boxes.length-1&&this.addQueuedTopics({fetch_more_if_at_end:!1})},addQueuedTopics:function(e){var t,o,s=[];for(o=Math.min(this.topic_boxes.length-1,this.view_end_id+Constants.num_topics_to_reveal),ComViews.isIOS&&this.$scroll_area.css({"-webkit-overflow-scrolling":"auto"}),i=this.view_end_id+1;i<=o;i++)this.topic_boxes[i].hasOwnProperty("is_placeholder")&&this.topic_boxes[i].is_placeholder&&(this.topic_boxes[i]=this.buildTopicCell(this.topic_boxes[i].model)),s.push(this.topic_boxes[i].$el);this.topic_boxes[this.view_end_id].$el.after(s),t=this.view_end_id,this.view_end_id=o,this.checkRevealedTopics(),this.suppress_scroll||(this.isFixedHeight()?this.$scroll_area.scrollTop(this.topic_boxes[t+1].$el.position().top-this.$topics_window.height()):window.scrollTo(0,this.topic_boxes[t+1].$el.offset().top-$(window).height()+50)),t===o?t--:this.$scrollbar.trigger("reset_end_watchers"),ComViews.isIOS&&this.$scroll_area.css({"-webkit-overflow-scrolling":"touch"}),e.fetch_more_if_at_end&&o==this.topic_boxes.length-1?this.fetchMoreTopics():this.suppress_scroll=!1},onSliderAtBottom:function(){var e=1===arguments.length?arguments[0]:{};this.topic_boxes.length-1;$(document).trigger("mouseup"),this.view_end_id===this.topic_boxes.length-1?this.fetchMoreTopics(e):this.addQueuedTopics({fetch_more_if_at_end:!0})},onSliderAtTop:function(){var e,t,o,s=[];if(0!==this.view_start_id){for(this.$scrollbar.trigger("reset_end_watchers"),ComViews.isIOS&&this.$scroll_area.css({"-webkit-overflow-scrolling":"auto"}),e=Math.max(0,this.view_start_id-Constants.num_topics_to_reveal),i=e;i<this.view_start_id;i++)s.push(this.topic_boxes[i].$el);this.topic_boxes[this.view_start_id].$el.before(s),o=this.view_start_id,this.view_start_id=e,this.checkRevealedTopics(),this.suppress_scroll||(this.isFixedHeight()?(t=this.topic_boxes[o].$el.position().top,this.$scroll_area.scrollTop(t)):(t=this.topic_boxes[o].$el.offset().top,window.scrollTo(0,t-40))),ComViews.isIOS&&this.$scroll_area.css({"-webkit-overflow-scrolling":"touch"})}},appendNoMoreTopicsMessage:function(){this.$loader.detach(),0==this.collection.length&&this.$no_more_topics.text(this.no_items_at_all_message),this.$topics_box.append(this.$no_more_topics)}}),ComViews.CategoryCellTopics=ComViews.TopicsList.extend({template_id:"#cmty-category-cell-topics-tpl",className:"cmty-itembox",topicView:ComViews.CategoryCellTopicCell}),ComViews.CategoryCellPrivatesTopics=ComViews.CategoryCellTopics.extend({no_more_items_message:Lang["topics-list-no-more-privates"],no_items_at_all_message:Lang["topics-list-no-privates"]}),ComViews.TopicsListPrivates=ComViews.TopicsList.extend({no_more_items_message:Lang["topics-list-no-more-privates"],no_items_at_all_message:Lang["topics-list-no-privates"]}),ComViews.TopicsListSearchPosts=ComViews.TopicsList.extend({topicView:ComViews.TopicCellSearchPost,popoutView:ComViews.TopicCellSearchPopout}),ComViews.TopicTagbox=ComViews.Itembox.extend({always_show_edit:!0,initialize:function(e){var t,o,i=e.hasOwnProperty("render_titles")&&e.render_titles,s=this;ComViews.setRouteInfo(this,e),this.category_id=this.model.get("category_id"),this.secondary_color=this.model.get("category_secondary_color"),this.main_color=this.model.get("category_main_color"),_.each(this.model.get("tags"),function(e){var t,a;(!e.hasOwnProperty("is_visible")||e.is_visible)&&(s.category_id===Constants.private_messages_id&&"archived"===s.model.get("status")?(o="/my-messages-archive/",category_name=s.model.get("master").get("my_privates_archive").get("category_name")):(o="/c"+s.category_id,category_name=s.model.get("category_name")),t=o+"t"+e.tag_id+"f"+s.category_id+"_"+ComViews.convertToUrlFragment(e.tag_text),a=$($.parseHTML("<a "+s.push_state_attribute+' href="'+ComViews.makeLinkUrl(t,s.url_router_base+s.url_cmty_path)+'"><div '+(i?'title="'+Lang["tag-tooltip-forum"]+_.unescape(category_name)+'"':"")+' class="cmty-item-tag">'+e.tag_text+"</div></a>")),s.$el.append(a))}),(this.always_show_edit||this.model.getPermission("c_can_edit_tags"))&&(t=$($.parseHTML('<div title="'+Lang["tag-edit-title"]+'" class="cmty-item-tag cmty-edit-tag aops-font">L</div>')),this.$el.append(t)),this.$el.find(".cmty-item-tag").css({"background-color":this.main_color})},events:{"mouseenter .cmty-item-tag":"onHoverTag","mouseleave .cmty-item-tag":"onLeaveTag","click .cmty-item-tag":"onClickTag"},onClickTag:function(e){var t;return $(e.target).hasClass("cmty-edit-tag")?AoPS.session.logged_in?this.model.getPermission("c_can_edit_tags")?void 0:(t=this.model.get("master").get("current_user").get("is_new_user")?"tagbox-new-user":"tagbox-no-permission",AoPS.Ui.Modal.showMessage(Lang[t],{width:"450px"}),e.stopPropagation(),e.preventDefault(),!1):(AoPS.Ui.buildLoginConfirm(Lang["tagbox-not-logged-in"]),e.stopPropagation(),e.preventDefault(),!1):(this.onLeaveTag(e),!0)},onHoverTag:function(e){e.target.style.backgroundColor=this.secondary_color,e.target.style.color=this.main_color},onLeaveTag:function(e){e.target.style.color="#fff",e.target.style.backgroundColor=this.main_color}}),ComViews.ModalToAddParticipant=AoPS.View.extend({template_id:"#cmty-private-add-participant-tpl",initialize:function(){this.$el.html(this.getTemplate("#cmty-private-add-participant-tpl",{instructions_start:Lang["add-participant-instructions-start"],instructions_end:Lang["add-participant-instructions-end"],add_user:Lang["add-participant-add-user"],placeholder:Lang["add-participant-placeholder"],max_number:Constants.max_conversation_participants})),this.$input=this.$el.find("input"),Utils.buildUsernameAutocomplete(this.$input,{ajax_call:"fetch_username_matches",autocomplete_settings:{onSelect:_.bind(function(e,t){var o,i=_.findWhere(this.model.get("participants"),{user_id:parseInt(t.item.user_id)});return _.isUndefined(i)?this.chooseUser(t.item):(o=i.removed?"private-already-added-self-removed":"private-already-added-active",AoPS.Ui.Modal.showMessage(Utils.formatString(Lang[o],[t.item.label]),{width:"450px"}),this.$input.val("")),e.stopPropagation(),e.preventDefault(),!1},this)}}),this.$new_participant=this.$el.find(".cmty-chosen-new-participant"),this.$el.showModal({type:"buttons",buttons:[{text:Lang["private-add-user-confirm-OK"],value:1},{text:Lang.Cancel,value:0}],close_on_button_click:!1,max_width:"450px",onButtonClick:_.bind(function(e){if(1==e){if(!this.hasOwnProperty("user")&&0==this.$input.val().length)return void AoPS.Ui.Modal.showMessage(Lang["private-no-username"]);this.addUserToParticipants()}else this.close()},this)}),this.$el.find("input").focus()},addUserToParticipants:function(){var e={onFinish:_.bind(function(e){this.onFinishAdding(e)},this),onError:_.bind(function(e){var t,o=e.error_code;"E_NO_USER"===o?(AoPS.Ui.Modal.closeTopModal(),AoPS.Ui.Modal.showAlert(Utils.formatString(Lang["invalid-user"],[e.response.username]),{onClose:_.bind(function(){this.$input.focus()},this)}),this.$new_participant.html(""),this.$input.show(),this.$input.val("")):(t="E_NOT_LOGGED_IN"===o?Lang["add-participant-logged-out"]:"E_NO_PERMISSION"===o?Lang["add-participant-no-permission"]:"E_PAST_TIME_LIMIT"===o?Lang["add-participant-too-late"]:"E_NO_MORE_PARTICIPANTS"===o?Lang["add-participant-no-more"]:"E_USER_EXCLUDED_FROM_PM"===o?Utils.formatString(Lang["add-participant-recipient-exclude-system"],[e.response.username]):"E_USER_DOESNT_RECEIVE_PM"===o?Utils.formatString(Lang["add-participant-recipient-exclude-self"],[e.response.username]):"E_NO_ADDING_SELF"===o?Lang["add-participant-no-self"]:Lang["unexpected-error-code"]+o,AoPS.Community.Views.showError(t))},this)};AoPS.Ui.Modal.showMessage(Lang["private-adding-user-blocker"],{force_response:!0}),e=_.extend(e,{user:this.hasOwnProperty("user")?this.user:{username:this.$input.val()}}),this.model.submitNewParticipant(e)},onFinishAdding:function(e){var t=this;AoPS.Community.Views.delayModalClearing({onClose:function(){t.close()}})},chooseUser:function(e){this.user={username:e.value,user_id:parseInt(e.user_id)},this.$new_participant.html(e.value),1==parseInt(e.is_admin)&&this.$new_participant.addClass("cmty-user-admin"),this.$input.hide()},onClose:function(){AoPS.Ui.Modal.closeAllModals()}}),ComViews.EditableItemList=AoPS.View.extend({item_class:"aops-editable-item-list-item",item_limit:100,item_name:"item",has_close:!1,className:"cmty-items-input-box",num_matches:0,submitted_item:"",submit_on_special_keys:!0,item_selected:!1,initialize:function(e){var t=this;$.extend(this,e),this.has_close&&(this.$close_me=$($.parseHTML('<div class="cmty-editable-item-close">q</div>')),this.$el.append(this.$close_me)),this.counter=1,this.sending_to_rebuild=!1,this.constructInput(),this.suppress_autofocus=!1,this.$items=[],_.each(this.items,function(e){t.putItemInBox(e)})},events:{"click .cmty-delete-item":"onClickDeleteItem","click .cmty-editable-item-close":"onClickClose"},prepareAutocomplete:function(){this.constructItemAutocomplete()},getAutocompleteSource:function(){},getAutocompleteOnOpen:function(){return _.bind(function(e){},this)},constructAutocompleteArgs:function(){return{}},constructItemAutocomplete:function(){var e=_.extend({match_type:"from_start_then_any",delay:250,is_case_sensitive:!1,source:this.getAutocompleteSource(),num_matches:this.num_matches,blockResponse:_.bind(function(){return this.item_submitted},this),position:{my:"left top+5"},onSelect:_.bind(function(e,t){13===e.keyCode&&this.$input_box.val().toLowerCase()!==t.item.value.toLowerCase()&&(this.submitNewItem({label:this.$input_box.val(),item_id:0}),this.item_submitted=!0,this.item_selected=!0),this.item_submitted||(this.item_selected=!0,this.item_submitted=!0,this.submitNewItem(t.item),this.submitted_item=t.item.value),e.stopPropagation(),e.preventDefault()},this)},this.constructAutocompleteArgs());this.$input_box.aopsAutocomplete(e),"function"==typeof this.onClose&&this.$input_box.blur(this.onClose),this.processPostConstruction()},onPaste:function(e){},processPostConstruction:function(){var e=this;this.$input_box.on("paste",function(t){e.onPaste(t)}),this.$input_box.on("keydown",_.bind(function(e){var t,o=e.which||e.keyCode,i=this.$input_box.val();this.item_submitted=!1,(13===o||188===o||9===o)&&((188===o||9===o&&i.length>0)&&(e.preventDefault(),e.stopPropagation()),i.length>1&&this.submitted_item.toLowerCase()!==i.toLowerCase()&&!this.item_selected&&this.submit_on_special_keys&&this.submitNewItem({label:i,item_id:0})),0===i.length&&(8===o?this.$input_box.prev().hasClass(this.item_class)?this.tryToRemoveItem(this.$input_box.prev()):(t=this.$input_box.prevUntil("."+this.item_class).last().prev(),t.length>0&&this.tryToRemoveItem(t)):46===o?this.tryToRemoveItem(this.$input_box.next()):this.$input_box.width(Constants.itembox_input_width),this.$input_box.focus()),this.item_selected=!1,this.validateCharacter(e)||(e.stopPropagation(),e.preventDefault())},this)),this.$input_box.parent().on("click",function(t){e.$input_box.focus(),t.stopPropagation()})},validateCharacter:function(e){return!0},removeItem:function(e){var t,o;if(e instanceof jQuery)t=e,o=e.data("item");else if(o=e,t=_.find(this.$items,function(e){return e.data("item")===o}),_.isUndefined(t))return;this.processRemovedItem(o),this.items=_.without(this.items,o),this.$items=_.without(this.$items,t),t.remove(),this.hasOwnProperty("onRemoveItem")&&this.onRemoveItem(o)},onClickDeleteItem:function(e){this.tryToRemoveItem($(e.target).parent())},tryToRemoveItem:function(e){this.removeItem(e)},processRemovedItem:function(e){},showError:function(e){AoPS.Ui.Modal.showAlert(e,{onClose:_.bind(this.resetInput,this)})},performCustomValidation:function(e){return!0},submitNewItem:function(e){return e.label=e.label.trim(),this.item_submitted=!0,this.countItems()>=this.item_limit?(this.showError(Lang["new-item-too-many-1"]+this.item_limit+" "+this.item_name+Lang["new-item-too-many-2"]),!1):e.label.length<2?(this.showError(Lang["new-item-too-short"]),!1):this.checkItemExists(e)?(this.showError(Lang["new-item-already-added"]+"<b>"+e.label+"</b>."),!1):void(this.performCustomValidation(e)&&this.buildNewItem(e))},countItems:function(){return this.items.length},checkItemExists:function(e){return!_.isUndefined(_.find(this.items,function(t){return t.label.toLowerCase()===e.label.toLowerCase()}))},buildNewItem:function(e){var t;e.hasOwnProperty("is_visible")||(e.is_visible=!0),this.items.push(e),this.processNewItem(e),t=this.putItemInBox(e),this.hasOwnProperty("onAddItem")&&this.onAddItem(e,t),this.resetInput()},applyCssToNewItem:function(e,t){},submitItemSilent:function(e){this.countItems()>=this.item_limit||this.checkItemExists(e)||(this.suppress_autofocus=!0,this.buildNewItem(e),this.suppress_autofocus=!1)},putItemInBox:function(e){var t;if(!e.hasOwnProperty("is_visible")||e.is_visible)return"string"!=typeof e.label&&"string"==typeof e.value&&(e.label=e.value),"string"!=typeof e.value&&"string"==typeof e.label&&(e.value=e.label),t=$($.parseHTML('<div class="'+this.item_class+'">'+e.label+' <span class="cmty-delete-item aops-font">J</span></div>')),"boolean"==typeof e.is_special&&e.is_special&&t.addClass("cmty-special-item"),this.applyCssToNewItem(t,e),t.data("item",e),t.data("item_label",e.label),this.$items.push(t),this.$input_box.before(t),t},processNewItem:function(e){},resetInput:function(){var e=this;this.$input_box.val(""),this.counter+=1,this.$input_box.data("suppress_tab",!0),setTimeout(_.partial(function(t){e.rebuildInput(t)},this.suppress_autofocus),10)},constructInput:function(){var e=this;this.$input_box=$($.parseHTML('<input type="text" class="cmty-items-input" maxlength="30"></input>')),this.$el.append(this.$input_box),"function"==typeof this.onInputBoxBlur&&this.$input_box.on("blur",function(){e.onInputBoxBlur()}),this.prepareAutocomplete()},rebuildInput:function(e){this.$input_box.remove(),this.hasOwnProperty("$no_results")&&this.$no_results.hide(),this.constructInput(),0!=arguments.length&&e||this.$input_box.focus()},onClickClose:function(){this.$input_box.val().length>1&&this.submitNewItem({label:this.$input_box.val()}),this.close()}}),ComViews.EditableTagBox=ComViews.EditableItemList.extend({item_class:"cmty-item-tag",item_limit:Constants.max_tags_per_topic,has_search_icon:!1,item_name:"tag",num_matches:15,initialize:function(e){this.category=e.hasOwnProperty("category")?e.category:this.model.get("master").fetchCategory(this.model.get("category_id")),this.setTagColors(),ComViews.EditableItemList.prototype.initialize.apply(this,[e]),this.$no_results=$('<div class="cmty-no-results-found">'+Lang["autocomplete-new-tag"]+"</div>"),this.$input_box.before(this.$no_results),this.input_on_blur=e.hasOwnProperty("input_on_blur")&&e.input_on_blur},onInputBoxBlur:function(){ComViews.clicking&&this.$input_box.val().length>0&&this.input_on_blur&&(this.suppress_autofocus=!0,this.submitNewItem({label:this.$input_box.val(),item_id:0}),this.suppress_autofocus=!1),this.$no_results.hide()},onMatch:function(e){this.$no_results.hide()},onNoMatch:function(e){e===this.counter&&(this.$no_results.show(),this.$no_results.position({my:"left-1 top+1",at:"left bottom",of:this.$input_box}))},countItems:function(){return _.where(this.items,{is_visible:!0}).length},setTagColors:function(){this.tag_colors={main_color:this.category.get("main_color"),secondary_color:this.category.get("secondary_color")}},getAutocompleteSource:function(){var e=this,t=this.counter,o=this.$input_box;return _.bind(function(i,s){this.category.fetchItemAutocompleteMatches({request:i,response:s,checkSquelch:function(){return i.term!==o.val().substr(0,o[0].selectionStart)&&i.term!==o.val()},checkInputExists:function(){return e.counter===t},onMatch:function(){"function"==typeof e.onMatch&&e.onMatch(e.counter)},onNoMatch:function(){"function"==typeof e.onNoMatch&&e.onNoMatch(e.counter)},additional_params:e.hasOwnProperty("additional_autocomplete_params")?e.additional_autocomplete_params:{}})},this)},getAutocompleteOnOpen:function(){return _.bind(function(e){var t=$(e).data("ui-autocomplete").menu;t.element.find("a").css({"background-color":this.tag_colors.main_color}).addClass(this.item_class)},this)},applyCssToNewItem:function(e,t){e.css({"background-color":this.tag_colors.main_color})},constructAutocompleteArgs:function(){var e;return e=this.has_search_icon?"left-21 top+5":"left-1 top+5",{onFocus:_.bind(function(e,t){this.hasOwnProperty("focus_element")&&!_.isNull(this.focus_element)&&this.focus_element.css({color:"white","background-color":this.focus_element.data("main-color")}),this.focus_element=$(e.originalEvent.target).find("a.ui-state-focus"),this.focus_element.css({color:this.focus_element.data("main-color"),"background-color":this.focus_element.data("secondary-color")})},this),onOpen:_.bind(function(){
this.$input_box.autocomplete("widget").width(Constants.tag_autocomplete_width)},this),_renderItem:function(e,t){var o=$("<a>").text(t.label).css({"background-color":t.main_color}).data({"main-color":t.main_color,"secondary-color":t.secondary_color});return $("<li>").append(o).appendTo(e)},position:{my:e,at:"left bottom",of:this.$input_box}}},processPostConstruction:function(){ComViews.EditableItemList.prototype.processPostConstruction.apply(this),this.processTagBoxDropdownArrowing()},onPaste:ComViews.onTagPaste,validateCharacter:ComViews.validateTagCharacter,processTagBoxDropdownArrowing:function(){this.$input_box.on("keydown.post_construction",_.bind(function(e){var t=e.keyCode||e.which;(38===t||40===t)&&0===this.$input_box.data("ui-autocomplete").menu.element.find(".ui-state-focus").length&&_.each(this.$input_box.data("ui-autocomplete").menu.element.find("a"),function(e){$(e).css({"background-color":$(e).data("main-color"),color:"#fff"})})},this))}}),ComViews.EditableUserList=ComViews.EditableItemList.extend({item_class:"cmty-itemlist-username",item_limit:1e3,item_name:"user",initialize:function(e){this.is_checking_username=!1,ComViews.EditableItemList.prototype.initialize.apply(this,[e])},getAutocompleteSource:function(){var e=this.$input_box;return _.bind(function(t,o){Utils.fetchUsernameMatches({request:t,response:o,checkSquelch:function(){return t.term!==e.val().substr(0,e[0].selectionStart)&&t.term!==e.val()}})},this)},constructAutocompleteArgs:function(){return{ui_class:"cmty-username-autocomplete",_renderItem:function(e,t){var o=$("<li></li>"),i=$("<a>"+t.label+"</a>");return o.append(i),"1"===t.is_admin&&i.addClass("cmty-user-admin"),o.appendTo(e)}}},applyCssToNewItem:function(e,t){("1"===t.is_admin||1===t.is_admin)&&e.addClass("cmty-user-admin")},processUsernameCheckDelay:function(e,t,o){var i=(new Date).getTime()-o,s=this;i>=Constants.message_readability_delay?this.processUsernameCheck(e,t):setTimeout(function(){s.processUsernameCheck(e,t)},Constants.message_readability_delay-i)},processUsernameCheck:function(e,t){this.is_checking_username=!1,this.isUsernameOK(e,t)?(e.user_id=t.user_id,e.is_admin=t.is_admin,this.buildNewItem(e),AoPS.Ui.Modal.closeTopModal()):AoPS.Ui.Modal.replaceTopModal({type:"alert",body:Utils.formatString(Lang["invalid-user"],[e.label]),frame_class:"aops-modal-quick",onClose:_.bind(this.resetInput,this)})},isUsernameOK:function(e,t){return t.user_id>0}}),ComViews.EditableUserListCategoryAdmin=ComViews.EditableUserList.extend({has_close:!0,initialize:function(e){this.role=e.role,ComViews.EditableUserList.prototype.initialize.apply(this,[e])},processNewItem:function(e){e.hasOwnProperty("suppress_add_to_model")?delete e.suppress_add_to_model:this.model.addUser({role:this.role,username:e.value,user_id:parseInt(e.user_id),is_admin:parseInt(e.is_admin)})},processRemovedItem:function(e){this.model.removeUser({user_id:parseInt(e.user_id)})},getAutocompleteSource:function(){var e=this.$input_box;return _.bind(function(t,o){Utils.fetchUsernameMatches({request:t,response:o,checkSquelch:function(){return t.term!==e.val().substr(0,e[0].selectionStart)&&t.term!==e.val()}})},this)},performCustomValidation:function(e){var t,o,i,s=this;return this.isNewUserAdmin(e)?!1:(t=this.model.checkUserRole(e.label),"none"!==t.role?(this.is_checking_username=!0,o=Utils.formatString(Lang["cat-admin-perms-existing-user"],[e.label,Lang["cat-admin-user-types-"+this.model.getAdminLangType()+"-"+t.role]]),this.model.getPermission("c_can_edit_"+t.role)?AoPS.Ui.Modal.showConfirm(o+Lang["cat-admin-perms-existing-user-3"]+" <b>"+Lang["cat-admin-user-types-"+this.model.getAdminLangType()+"-"+this.role]+"</b>.",function(o){o&&(e.user_id=parseInt(t.user_id),e.suppress_add_to_model=!0,s.model.updateUserRole(e,s.role),s.buildNewItem(e)),s.reset()},{width:"450px"}):AoPS.Ui.Modal.showAlert(o,{width:"450px",onClose:function(){s.reset()}}),!1):e.hasOwnProperty("user_id")?(e.item_id=parseInt(e.user_id),!0):(ComViews.throwBlockingMessage(Lang["user-list-validation-blocker"]),i=(new Date).getTime(),this.is_checking_username=!0,this.model.checkAddedUsername({username:e.label,onFinish:function(t){s.processUsernameCheckDelay(e,t,i)}}),!1))},processUsernameCheck:function(e,t){var o=this;return 0===parseInt(t.user_id)?(AoPS.Ui.Modal.replaceTopModal({type:"alert",body:Utils.formatString(Lang["invalid-user"],[e.label]),frame_class:"aops-modal-quick",onClose:function(){o.resetInput(),o.is_checking_username=!1}}),!1):(e.user_id=t.user_id,e.label=t.username,e.value=t.username,e.is_admin=t.is_admin,this.performCustomValidation(e)?(this.buildNewItem(e),AoPS.Ui.Modal.closeAllModals(),this.is_checking_username=!1,!0):!1)},isNewUserAdmin:function(e){var t=this;return 1!==parseInt(e.is_admin)||"owner"===this.role&&AoPS.session.user_id==e.user_id?!1:(this.is_checking_username=!0,AoPS.Ui.Modal.showAlert(Lang["cat-admin-no-add-admin-start"]+e.label+Lang["cat-admin-no-add-admin-end"],{width:"450px",onClose:function(){t.reset()}}),!0)},reset:function(){AoPS.Ui.Modal.closeAllModals(),this.$input_box.focus(),this.is_checking_username=!1},onClickClose:function(){var e,t,o,i=this;this.$input_box.val().length>1?(this.is_checking_username=!0,t=this.$input_box.val(),e={label:t,value:t},ComViews.throwBlockingMessage(Lang["user-list-validation-blocker"]),this.is_checking_username=!0,this.model.checkAddedUsername({username:e.label,onFinish:function(t){setTimeout(function(){i.processUsernameCheck(e,t,o)&&i.close()},500)}})):this.close()}}),ComViews.StaticUserList=AoPS.View.extend({className:"cmty-static-user-list",no_users_message:"",initialize:function(e){var t,o=this,i="function"==typeof e.onMatchLoggedInUser;e.hasOwnProperty("no_users_message")&&(this.no_users_message=e.no_users_message),e.user_list.length>0?_.each(e.user_list,function(t){var s,a,n;a="cmty-itemlist-username"+(1===parseInt(t.is_admin)?" cmty-user-admin":""),s="/user/"+t.user_id,n=$('<a data-cmty href="'+ComViews.makeLinkUrl(s)+'"><span class="'+a+'">'+t.username+"</span></a>"),i&&t.user_id==AoPS.session.user_id&&e.onMatchLoggedInUser(n,t),o.$el.append(n),o.$el.append(" ")}):this.$el.append(this.no_users_message),e.is_editable&&(t=$('<div title="'+Lang["userlist-edit"]+'" class="cmty-edit-user-list aops-font">L</div>'),this.$el.append(t))}}),ComViews.ToggleableUserList=AoPS.View.extend({editableUserlistView:ComViews.EditableUserList,staticUserlistView:ComViews.StaticUserList,no_users_message:Lang.None,initialize:function(e){this.user_list=e.user_list,this.constructStaticUserlist()},events:{"click .cmty-edit-user-list":"toggleUserlist"},toggleUserlist:function(){this.is_static?(this.static_userlist.close(),this.constructEditableUserlist()):(this.editable_userlist.close(),this.constructStaticUserlist())},constructStaticUserlist:function(){this.static_userlist=new AoPS.Community.Views.StaticUserList({user_list:this.getUserList(),is_editable:!0,no_users_message:this.no_users_message}),this.is_static=!0,this.$el.html(this.static_userlist.$el)},constructEditableUserlist:function(){var e=this;this.editable_userlist=new this.editableUserlistView(_.extend({items:this.getEditableUserList(),model:this.model,onClose:function(){setTimeout(function(){e.editable_userlist.$el.find("input")[0]!==document.activeElement&&(e.is_static||e.editable_userlist.is_checking_username||e.toggleUserlist())},200)}},this.getAdditionalEditableOptions())),this.is_static=!1,this.$el.html(this.editable_userlist.$el),this.editable_userlist.$input_box.focus()},onClose:function(){this.is_static?this.static_userlist.close():this.editable_userlist.close()},getAdditionalEditableOptions:function(){return{}},getUserList:function(){return this.user_list},getEditableUserList:function(){return this.user_list}}),ComViews.ToggleableUserListCategoryAdmin=ComViews.ToggleableUserList.extend({editableUserlistView:ComViews.EditableUserListCategoryAdmin,initialize:function(e){this.user_list=_.filter(this.model.get("users"),function(t){return t.role===e.role}),this.role=e.role,"owner"===e.role&&(this.no_users_message=Lang["cat-admin-site-admins-are-admins"]),this.constructStaticUserlist(),this.listenTo(this.model,"users_changed",this.onUsersChange)},onUsersChange:function(){this.is_static&&(this.static_userlist.close(),this.constructStaticUserlist())},getAdditionalEditableOptions:function(){return{role:this.role}},getUserList:function(){var e=this;return this.user_list=_.filter(this.model.get("users"),function(t){return t.role===e.role}),this.user_list},getEditableUserList:function(){var e=this.getUserList();return _.map(e,function(e){return{user_id:e.user_id,label:e.username,is_admin:e.is_admin}})}}),ComViews.EditableRecipientBox=ComViews.EditableUserList.extend({performCustomValidation:function(e){var t,o=this;return this.is_checking_username=!0,e.label.toLowerCase()===AoPS.session.username.toLowerCase()?(this.showError(Lang["private-no-add-self"]),this.is_checking_username=!1,!1):this.items.length>=AoPS.Community.Constants.max_conversation_participants-1?(this.showError(Lang["private-cant-add-more"]),!1):e.hasOwnProperty("user_id")?!0:(ComViews.throwBlockingMessage(Lang["private-validation-blocker"]),t=(new Date).getTime(),this.model.checkValidPrivateRecipient({username:e.label,onFinish:function(i){o.processUsernameCheckDelay(e,i,t)}}),!1)},isUsernameOK:function(e,t){return t.is_valid_recipient}}),ComViews.EditableValidatedUserList=ComViews.EditableUserList.extend({performCustomValidation:function(e){var t=this;return e.hasOwnProperty("user_id")?!0:(ComViews.throwBlockingMessage(Lang["user-list-validation-blocker"]),now=(new Date).getTime(),Utils.checkValidUsername({username:e.label,onFinish:function(o){t.processUsernameCheckDelay(e,o,now)}}),!1)},isUsernameOK:function(e,t){return t.is_valid}}),ComViews.EditableTagBoxExistingTopic=ComViews.EditableTagBox.extend({has_close:!0,setTagColors:function(){this.tag_colors={main_color:this.model.get("category_main_color"),secondary_color:this.model.get("category_secondary_color")}},processNewItem:function(e){this.topic.addNewTag(e.tag_id,e.label)},processRemovedItem:function(e){this.topic.removeTag(e.tag_id,e.label)}}),ComViews.EditableForumList=ComViews.EditableItemList.extend({item_class:"cmty-item-forum",submit_on_special_keys:!1,initialize:function(e){this.ajax_call=e.hasOwnProperty("ajax_call")?e.ajax_call:"fetch_forum_autocomplete",this.$no_results=$('<div class="cmty-no-results-found">'+Lang["search-no-match"]+"</div>"),ComViews.EditableItemList.prototype.initialize.apply(this,[e]),this.$input_box.before(this.$no_results)},onInputBoxBlur:function(){this.$no_results.hide()},prepareAutocomplete:function(){var e=this;Utils.buildCategoryAutocomplete(this.$input_box,{ajax_call:this.ajax_call,autocomplete_settings:{blockResponse:_.bind(function(){return this.item_submitted},this),onSelect:function(t,o){e.item_submitted||(e.item_selected=!0,e.item_submitted=!0,e.submitNewItem(o.item),e.submitted_item=o.item.value),t.stopPropagation(),t.preventDefault()}},$no_results:this.$no_results,include_wrapper:!1,show_no_results_msg:!0}),this.processPostConstruction()},applyCssToNewItem:function(e,t){e.css({color:t.main_color})}}),ComViews.TopicFull=AoPS.View.extend({template_id:"#cmty-topic-full-tpl",viewing_source:"master",className:"cmty-topic-full",reply_open:!1,postView:ComViews.Post,has_source:!1,staticTagboxView:ComViews.TopicTagbox,editableTagboxView:ComViews.EditableTagBoxExistingTopic,scrollbar_settings:{autosize_exclusions:[{min:841,max:1e5}]},initialize:function(e){var t=this;ComViews.setRouteInfo(this,e),this.reply_box=null,this.$loader=AoPS.Page.buildLoader(),this.spoofing_scrollbar=!1,this.reveal_type=e.reveal_type,this.topic_category_at_initialization=this.model.get("category_id"),this.topic_id=this.model.get("topic_id"),this.loaded_from_post_id=0,this.fullscreen_triggered_by_reply=!1,this.from_middle={init:!1},this.unread_posts=[],this.posts=[],this.mark_time_at_add=this.model.get("db_mark_time"),this.start_post_id=-1,this.is_initialized=!1,this.is_on_page=!1,this.is_full_reply=!1,0===this.model.get("posts").length||"show_from_start"!=this.reveal_type&&1===this.model.get("posts").length&&!this.model.get("all_posts_fetched")?(this.$el.append(this.$loader),this.fetchTopicInitialPosts(function(){t.completeInitialization(e)})):this.completeInitialization(e),this.snipe_warning_open=!1,this.snipe_warning_type=this.model.get("master").get("current_user").get("warn_on_snipes"),this.listenTo(this.model.get("master").get("current_user"),"change:warn_on_snipes",function(){t.snipe_warning_type=t.model.get("master").get("warn_on_snipes")}),this.listenTo(this.model,"change:deleted",this.onDelete),this.listenTo(this.model,"change:state",this.renderState),this.listenTo(this.model,"change:target_url",this.onChangeTargetUrl)},canModerate:function(){return this.model.getPermission("c_can_move_topic_out")||this.model.getPermission("c_can_delete")||this.model.getPermission("c_can_lock_topic")||this.model.getPermission("c_can_announce")||this.model.getPermission("c_can_hard_delete")},onChangeTargetUrl:function(){0==this.model.get("target_url").length&&this.$(".cmty-target-url").parent().remove()},checkIsPrivate:function(){return"private"!==this.model.get("topic_type")?!1:"feed"===this.viewing_source?!0:!_.isNull(this.master.get("focus_category"))&&!_.isUndefined(this.master.get("focus_category"))&&"priv"!==this.master.get("focus_category").get("category_type")},completeInitialization:function(e){var t,o,i,s,a,n,r=this,l="",c=this.model.checkShowTargetLink(),d=this.canModerate();t=this.model.getPermission("c_can_monitor")&&"none"!==this.model.get("state"),this.master=this.model.get("master"),this.is_private=this.checkIsPrivate(),this.route_category_id=e.hasOwnProperty("route_category_id")?e.route_category_id:this.model.get("category_id"),this.model.get("target_url").length>0&&(o=new RegExp(document.domain+"/"+AoPS.router_root),i=document.domain+this.model.get("target_url"),l=o.test(i)?AoPS.pushState_attr:""),this.$el.html(this.getTemplate(this.template_id,{topic_title:this.model.get("topic_title"),category_name:this.model.get("category_name"),category_id:this.model.get("category_id"),topic_id:this.model.get("topic_id"),can_reply:!0,has_target_url:c,target_attr:l,target_url:this.model.get("target_url"),tooltip_target:Lang["topic-full-target-tooltip"],viewed_in_own_forum:this.route_category_id===this.model.get("category_id"),lang_topic_tooltip:Lang["topic-full-title-tooltip"],lang_tag_tooltip:Lang["tag-tooltip-forum"],can_moderate:!this.is_private&&d,has_participants:this.is_private,can_unlock:this.model.getPermission("c_can_lock_topic"),can_unlock_forum:this.model.getPermission("c_can_lock_category"),tooltip_expand:Lang["topic-full-expand-tooltip"],tooltip_close:Lang["topic-full-close-tooltip"],tooltip_moderate:Lang["topic-full-moderate-tooltip"],tooltip_locked:this.model.getPermission("c_can_lock_topic")?Lang["topic-full-locked-tooltip-mod"]:Lang["topic-full-locked-tooltip"],tooltip_forum_locked:this.model.getPermission("c_can_lock_category")?Lang["topic-full-locked-forum-tooltip-mod"]:Lang["topic-full-locked-forum-tooltip"],tooltip_reply:Lang["topic-full-reply-tooltip"],locked:Lang["topic-full-locked"],forum_locked:Lang["topic-full-locked"],reply:Lang["topic-full-reply"],lang_Mod:Lang.Mod,has_topic_state:t,tooltip_state:Lang["topic-full-state-tooltip"]+this.model.get("state"),topic_state:this.fetchStateSymbol(),tooltip_feed_topic_title:Lang["feed-topic-title-tooltip"],tooltip_feed_forum_title:Lang["feed-forum-title-tooltip"],lang_click_for_tags:Lang["topic-full-click-for-tags"]})),this.$top_panel=this.$el.find(".cmty-topic-full-top"),this.$top_panel_placeholder=this.$el.find(".cmty-topic-full-top-placeholder"),this.$bottom_panel=this.$el.find(".cmty-topic-full-bottom"),this.is_private&&(this.$participants=this.$el.find(".cmty-topic-participants"),this.addParticipants(),this.listenTo(this.model,"change:participants",this.addParticipants)),(c||t)&&this.$top_panel.addClass("too-many-icons"),this.$posts_box=$("<div/>",{"class":"cmty-postbox-inner-box"}),this.model.get("can_have_source")&&(this.has_source=!0,this.$source=$('<div class="cmty-topic-source-display"></div>'),this.renderSource(),this.$posts_box.append(this.$source),this.listenTo(this.model,"change:source",this.renderSource)),this.$quick_reply=$($.parseHTML('<div class="cmty-topic-posts-bottom"><div class="cmty-topic-mini-reply"><span class="aops-font">N</span> '+Lang["topic-full-post-reply"]+"</div></div>")),this.parseLockedVisibility(),this.$posts_outer_wrapper=this.$el.find(".cmty-topic-posts-outer-wrapper"),this.$reply_window=this.$el.find(".cmty-reply-window"),this.$reply_divider=this.$(".cmty-reply-divider"),this.$drag_wrapper=this.$(".cmty-topic-full-drag-wrapper"),this.$reply_divider.draggable({axis:"y",containment:this.$drag_wrapper,start:function(e,t){a=r.$posts_outer_wrapper.height(),n=t.offset.top,textarea_start_height=r.$reply_window.find("textarea").height()},helper:"clone",drag:function(e,t){var o=t.offset.top-n;r.$(".ui-draggable-dragging").css({left:"0px"}),r.$reply_window.find("textarea").height(textarea_start_height-o),r.$posts_outer_wrapper.height(a+o)}}),this.$bookmark=this.$el.find(".cmty-topic-bookmark"),"private"===this.model.get("topic_type")?this.setArchiveStatus():this.setBookmarkStatus(),this.$posts_outer_wrapper.prepend(AoPS.Community.Views.buildCommunityScrollbar(this.$posts_box,this.scrollbar_settings)),this.$scrollbar=this.$posts_outer_wrapper.find(".aops-scroll-bar"),this.$posts_inner_wrapper=this.$posts_box.parent(),this.$posts_inner_wrapper.parent().append(this.$el.find(".cmty-topic-jump")),this.setPostFilter(),this.model.get("posts").each(function(e){r.addPost(e)}),this.initializeTagbox(),this.doExtraInitialization(),this.listenTo(this.model,"goto_last_post",this.goToLastPost),this.listenTo(this.model.get("posts"),"add",this.addPostAfterPageConstruction),this.listenTo(this.model,"change:is_bookmarked change:in_feed change:is_watched",this.setBookmarkStatus),this.listenTo(this.model,"post_load_complete",this.removeLoader),this.listenTo(this.model,"tag_removed tag_added",this.setHeight),this.listenTo(this.model,"change:locked change:forum_locked",this.parseLockedVisibility),this.listenTo(this.model,"change:topic_title",this.onChangeTopicTitle),0===this.posts.length||this.$posts_box.append(this.$quick_reply),this.setHeight(),1!==this.model.get("posts").length||this.model.get("all_posts_fetched")?this.onEndInitialization():(this.$posts_box.append(this.$loader),this.fetchTopicInitialPosts(function(){r.onEndInitialization()})),this.model.get("is_search_result")&&(s=this.model.fetchSearchText("title"),s.length>0&&this.$(".cmty-topic-subject").extendedHighlightText("cmty-highlight",s)),this.model.get("num_posts")>3&&1===this.model.get("posts").length&&(this.$posts_inner_wrapper.parent().addClass("aops-spoof-scrollbar-visible"),this.spoofing_scrollbar=!0)},isFixedHeight:function(){return"feed"===this.viewing_source||$(window).width()>Constants.phone_mode_max_width},fetchStateSymbol:function(){switch(this.model.get("state")){case"open":return"O";case"closed":return"C";case"not_monitored":return"N";default:return""}},renderState:function(){var e=this.$(".cmty-topic-state");e.length>0&&(e.html(this.fetchStateSymbol()),e[0].title=Lang["topic-full-state-tooltip"]+this.model.get("state"))},onClickState:function(){var e;switch(this.model.get("state")){case"open":e="closed";break;case"closed":e="not_monitored";break;case"not_monitored":e="open";break;default:e=this.model.get("state")}this.model.setState({state:e})},renderSource:function(){var e=this.model.get("source");e.length>0?(this.$source.html('<span class="cmty-source-title">'+Lang["topic-full-source"]+"</span>: "+this.model.get("source")),this.$source.css({display:"block"})):this.$source.css({display:"none"}),this.model.get("is_search_result")&&(search_text=this.model.fetchSearchText("source"),search_text.length>0&&this.$source.extendedHighlightText("cmty-highlight",search_text))},onChangeTopicTitle:function(){this.$(".cmty-topic-subject").html(this.model.get("topic_title"))},fetchTopicInitialPosts:function(e){this.listenToOnce(this.model,"post_load_complete",function(){e()})},onEndInitialization:function(){this.is_initialized=!0,this.is_on_page&&this.finishOnAddToPage(this.add_to_page_settings)},addParticipants:function(){this.$participants.html(this.getTemplate("#cmty-private-participants-tpl",{participants:this.is_private?this.buildParticipants():[],lang_removed:Lang["private-user-removed"],lang_remove_me:Lang["private-remove-me"],lang_add_participant:Lang["private-add-participant"],can_add_more:this.is_private&&this.model.get("category_id")==Constants.private_messages_id&&this.model.getPermission("p_can_add_participant")?this.model.get("participants").length<Constants.max_conversation_participants:!1})),this.setHeight()},buildParticipants:function(){return _.map(this.model.get("participants"),function(e){return _.defaults({is_me:AoPS.session.user_id===e.user_id},e)})},setInitialPostBoxLocation:function(){"show_from_end"===this.reveal_type?this.goToLastPost():"show_from_start"===this.reveal_type&&this.goToFirstPost()},doExtraInitialization:function(){},initializeTagbox:function(){var e;this.is_private||(e=this.model.get("master").get("current_user"),e.get("hide_tags_on_topic")&&this.$el.addClass("cmty-hide-topic-tags"),this.listenTo(e,"change:hide_tags_on_topic",function(){this.$el.toggleClass("cmty-hide-topic-tags",e.get("hide_tags_on_topic"))})),this.constructStaticTagbox(),this.listenTo(this.model,"change:tags tag_added",this.onTagsChanged)},setBookmarkStatus:function(){var e=this.$bookmark.find(".bkmk-icon"),t=this.$bookmark.find(".bkmk-text");this.$bookmark.prop("title",this.model.get("is_bookmarked")?Lang["topic-full-remove-bookmark-tooltip"]:Lang["topic-full-bookmark-tooltip"]),t.html(this.model.get("is_bookmarked")?Lang["bookmark-remove"]:Lang["bookmark-follow"]),e.html(ComViews.makeBookmark({is_bookmarked:this.model.get("is_bookmarked"),in_feed:this.model.get("in_feed"),is_watched:this.model.get("is_watched")}))},setArchiveStatus:function(){this.hasOwnProperty(this.$archive_status)||(this.$archive_status=$('<span class="cmty-topic-archive cmty-icon-w-text clickable"></span>'),this.$(".cmty-topic-bookmark").replaceWith(this.$archive_status)),"active"===this.model.get("status")?(this.$archive_status.append('<span class="aops-icon">(</span>'+Lang["private-Archive-btn"]),this.$archive_status[0].title=Lang["private-archive-topic"]):(this.$archive_status.append('<span class="aops-icon">)</span>'+Lang["private-Unarchive-btn"]),this.$archive_status[0].title=Lang["private-unarchive-topic"])},events:{"click .cmty-topic-mini-reply":"onClickReply","click .cmty-itembox .cmty-edit-tag":"toggleTagbox","click .cmty-topic-bookmark":"onClickBookmark","click .cmty-topic-jump-bottom":"goToLastPost","click .cmty-topic-jump-top":"goToFirstPost","click .cmty-topic-close":"onClickClose","click .cmty-add-participant":"onClickAddParticipant","click .cmty-full-screen":"onClickFullScreen","click .cmty-topic-moderate":"onClickModerate","click .cmty-topic-can-unlock, .cmty-topic-reply":"onClickFullReply","click .cmty-remove-me":"onClickRemoveMe","click .cmty-topic-archive":"onClickArchiveToggle","click .cmty-click-for-tags":"onClickForTags","click .cmty-topic-state":"onClickState"},onClickForTags:function(e){this.$el.removeClass("cmty-hide-topic-tags"),e.stopPropagation(),e.preventDefault()},onClickArchiveToggle:function(){var e=this.model.get("master");"active"===this.model.get("status")?(this.model.setMyStatus({status:"archived"}),"feed"!==this.viewing_source?e.get("my_privates").trigger("check_for_more_topics"):"feed"===this.model.get("master").get("fullscreen_mode")&&this.performFullScreenEvents(!1),this.completeParticipantStatusChange("/c"+Constants.private_messages_id),AoPS.Ui.Flyout.display(Lang["private-message-archived"])):(this.model.setMyStatus({status:"active"}),this.completeParticipantStatusChange("/h"+this.model.get("topic_id")),AoPS.Ui.Flyout.display(Lang["private-message-unarchived"]))},onClickFullScreen:function(e){this.performFullScreenEvents(!1)},onChangeFullscreenMode:function(){"feed"===this.model.get("master").get("fullscreen_mode")&&"master"===this.viewing_source&&(this.is_full_reply=!1)},performFullScreenEvents:function(e){var t=!1,o="none"===this.model.get("master").get("fullscreen_mode")?"master":"none";this.$posts_box.height()-this.$posts_inner_wrapper.scrollTop()-this.$posts_inner_wrapper.height()<Constants.reply_jump_to_bottom_window&&(t=!0),this.model.get("master").set("fullscreen_mode",o),$(window).trigger("resize"),t&&this.goToLastPost()},onClickRemoveMe:function(){var e,t,o=this;"archived"===this.model.get("status")?(e=Lang["private-remove-from-archived"],t="my_privates_archive"):(e=Lang["private-remove-from-active"],t="my_privates"),AoPS.Ui.Modal.showConfirm(e,function(e){var i,s=o.model,a=s.get("master");e&&(i="feed"===o.viewing_source?"":ComViews.constructUrlFromFocus(s.get("master"),{strip_topic:!0}),o.completeParticipantStatusChange(i),s.setMyStatus({status:"removed"}),a.get(t).trigger("check_for_more_topics"))},{confirm_button_ok:Lang["private-remove-me-ok"],width:"450px"})},completeParticipantStatusChange:function(e){Backbone.history.navigate(e,{trigger:!0})},onClickModerate:function(){new AoPS.Community.Views.ModerateTopic({model:this.model,topic_category_at_initialization:this.topic_category_at_initialization,url_cmty_path:this.url_cmty_path,url_router_base:this.url_router_base,push_state_attribute:this.push_state_attribute})},onClickAddParticipant:function(){new AoPS.Community.Views.ModalToAddParticipant({model:this.model})},onTagsChanged:function(){"static"===this.tagbox_state&&(this.tagbox.close(),this.constructStaticTagbox())},onClickClose:function(e){var t,o=this.model.get("master").get("focus_tag"),i=this.master.get("focus_category"),s=i.get("category_type");this.model.get("master").set("fullscreen_mode","none"),$(window).trigger("resize"),"user_search_posts"===s?t="/u"+i.get("user_id"):"search"===s?t="/q"+i.get("search_id")+(i.has("encoded_search_text")?"_"+i.get("encoded_search_text"):""):"my_privates"===s&&"archived"===i.get("category_status")?(t="/my-messages-archive",_.isNull(o)||(t+="/t"+o.item_id+"f"+o.item_forum_id)):t="priv"===s?"/x"+i.get("user_id"):"/c"+this.route_category_id+(_.isNull(o)?"":"t"+o.item_id+"f"+o.item_forum_id),ComViews.followUrlOnClick(e,t,this.url_router_base,this.url_cmty_path),this.fullscreen_triggered_by_reply=!1},onClickBookmark:function(){AoPS.session.logged_in?AoPS.isUserLimited()?Modal.showMessage(Lang["bookmark-limited-user"],{width:"450px"}):this.model.get("is_bookmarked")?this.model.setBookmarkState({is_bookmarked:!1,in_feed:!1,is_watched:!1}):ComViews.fireBookmarkModal("topic",Utils.formatString(Lang["bookmark-modal-topic"],[this.model.get("topic_title"),this.model.get("category_name")]),_.bind(this.model.setBookmarkState,this.model)):AoPS.Ui.buildLoginConfirm(Lang["bookmark-not-logged-in"])},onAddToPage:function(e){function t(){o.finishOnAddToPage(e),o.is_on_page=!0}var o=this;if(this.is_full_reply&&this.setFullReplyStyle(),this.listenTo(this.model.get("master"),"change:fullscreen_mode",this.onChangeFullscreenMode),"master"===this.viewing_source&&Backbone.trigger("squelch_scroll_to_top"),this.is_on_page=!0,this.setFocusListener(),this.is_initialized){if(this.model.get("all_posts_fetched"))return void t();this.model.get("master").get("in_change_focus_topic")?("show_from_start"===e.reveal_type?this.goToFirstPost():"show_from_middle"===e.reveal_type?this.goToPostId(e.post_id):this.goToLastPost(),this.setHeight(),this.$posts_box.append(this.$loader),this.$quick_reply.hide(),this.listenToOnce(this.model.get("master"),"change_topic_post_finish",function(){o.$loader.detach(),t()})):t()}else this.hasOwnProperty("$posts_outer_wrapper")&&this.setHeight(),this.add_to_page_settings=e},finishOnAddToPage:function(e){var t=this,o=!1;if(this.mark_time_at_add=this.model.get("db_mark_time"),this.reveal_type=e.reveal_type,e.hasOwnProperty("post_id")&&(this.start_post_id=e.post_id),"show_unread"===this.reveal_type&&(o=!0),this.setHeight(),this.setInitialPostBoxLocation(),this.model.get("all_posts_fetched"))if("show_from_start"!==this.reveal_type&&"show_from_end"!==this.reveal_type&&(this.reveal_type="show_from_start",this.setPostFilter(),this.applyPostFilter()),this.start_post_id>0)this.goToPostId(this.start_post_id);else if(o)if(target_post=this.locateFirstUnreadPostBox(),_.isUndefined(target_post))this.goToLastPost();else{var i=Math.min(this.$posts_box.height()-this.$posts_inner_wrapper.height(),target_post.$el.position().top);this.$posts_inner_wrapper.scrollTop(i)}if("show_from_middle"===this.reveal_type||"show_unread"===this.reveal_type)if(this.reveal_type="show_from_middle",this.from_middle={init:!1},_.isUndefined(e.post_id)&&(e.post_id=0),this.model.get("read_since_loading")&&o){var s=this.locateFirstUnreadPostBox();this.reveal_type="show_from_end",this.setQuickReplyVisibility(),this.reveal_type="show_from_middle";var i=Math.min(this.$posts_box.height()-this.$posts_inner_wrapper.height(),s.$el.position().top);this.$posts_inner_wrapper.scrollTop(i)}else(0===e.post_id||0===this.loaded_from_post_id)&&(this.maskLoading(),this.fetchMorePosts("both"));this.model.set("is_read",!0),$(window).bind("resize.cmty-topic-"+this.cid,function(){t.setHeight()}),this.setUpOnPageListeners(),this.model.get("read_since_loading")&&o||this.setQuickReplyVisibility(),this.model.set("read_since_loading",!0),this.loaded_from_post_id=e.post_id},setUpOnPageListeners:function(){this.listenTo(this.model,"topic_updated",this.setQuickReplyVisibility)},setFocusListener:function(){this.listenTo(this.model,"change:is_master_focus",this.onChangeFocusTopic)},maskLoading:function(){this.model.get("all_posts_fetched")||this.model.get("is_fetching_posts")||(this.setQuickReplyVisibility(),_.each(this.posts,function(e){e.$el.hide()}))},onChangeFocusTopic:function(){this.fetchFocusTopic()!==this.model&&(this.$el.detach(),this.onRemoveFromPage())},fetchFocusTopic:function(){return this.model.get("master").get("focus_topic")},onDelete:function(){var e=(this.model.get("master"),this),t="topic-full-message-deleted",o=arguments.length>1&&arguments[2].hasOwnProperty("deleted_by_me")&&arguments[2].deleted_by_me,i=arguments.length>1&&arguments[2].hasOwnProperty("error_code")&&"E_NO_PERMISSION"===arguments[2].error_code;if(i&&(t=AoPS.session.logged_in?"topic-full-deleted-loss-permission":"topic-full-deleted-not-logged-in"),this.model.get("deleted")&&this.model.get("master").get("focus_topic")==this.model){if(!o){var s=$(".cmty-new-topic-popup"),a="";if(s.length>0){var n=s.first().find(".cmty-post-textarea").val();n.length>0&&(a+=Lang["topic-full-deleted-extra"]+"<textarea>"+n+"</textarea>")}AoPS.Ui.Modal.showAlert(Lang[t]+a,{onClose:function(){e.navigateAfterDelete()},frame_class:a.length>0?"aops-modal-standard cmty-deleted-topic-w-extra":"aops-modal-standard"})}this.close(),o&&this.navigateAfterDelete()}},navigateAfterDelete:function(){var e,t,o=this.model.get("master");Modal.closeAllModals(),e=o.get("focus_category"),e.get("is_post_search")?"user_search_posts"===e.get("category_type")?Backbone.history.navigate("/u"+e.get("user_id"),{trigger:!0}):Backbone.history.navigate("/q"+e.get("search_id"),{trigger:!0}):"priv"===e.get("category_type")?Backbone.history.navigate("/x"+e.get("user_id"),{trigger:!0}):(t=e.get("category_id"),Backbone.history.navigate(this.url_cmty_path+"/c"+t,{trigger:!0}))},parseLockedVisibility:function(){this.model.get("locked")||this.model.get("forum_locked")?(this.reply_open&&(this.$el.is(":visible")&&AoPS.Ui.Modal.showMessage(Lang["topic-full-just-locked"]),this.closeNewReply()),this.$quick_reply.hide(),this.$(".cmty-topic-reply").addClass("force-hidden"),this.$(this.model.get("forum_locked")?".cmty-topic-forum-locked":".cmty-topic-locked").removeClass("force-hidden"),this.$(this.model.get("forum_locked")?".cmty-topic-locked":".cmty-topic-forum-locked").addClass("force-hidden")):(this.setQuickReplyVisibility(),
this.$(".cmty-topic-locked").addClass("force-hidden"),this.$(".cmty-topic-forum-locked").addClass("force-hidden"),this.$(".cmty-topic-reply").removeClass("force-hidden"))},setHeight:function(){var e,t,o,i,s,a,n,r,l=0;if(this.hasOwnProperty("$top_panel")&&(r=$(window).width(),this.hasOwnProperty("$posts_outer_wrapper"))){if(this.is_full_reply&&this.reply_open&&this.reply_box.is_previewing&&(this.removeFullReplyStyle(),this.setFullReplyStyle()),e=this.$top_panel.outerHeight(),this.$top_panel_placeholder.outerHeight(e),this.reply_open&&(a=this.$(".cmty-topic-full-drag-wrapper"),n=e+Constants.min_posts_window_height,a.css({top:n}),this.isFixedHeight()?this.is_full_reply?a.height(this.$el.height()-n-100):a.css({height:""}):a.height(this.$posts_inner_wrapper.height())),this.isFixedHeight()){if(0===e)return;return t=this.$posts_outer_wrapper.parent().height()-e,this.$el.toggleClass("cmty-no-preview",t<Constants.min_preview_height),this.$el.toggleClass("cmty-tiny-viewport",this.reply_open&&t<Constants.min_draggable_reply_height),this.reply_open&&(preview_heights=0,this.reply_box.is_previewing&&!this.is_full_reply&&(i=this.$reply_window.find(".cmty-post-preview"),i.is(":visible")&&(preview_heights=this.$reply_window.find(".cmty-posting-preview-bar").outerHeight()+i.outerHeight())),s=this.$reply_window.find(".cmty-reply-divider"),o=t-Constants.min_posts_window_height-(s.is(":visible")?this.$reply_window.find(".cmty-reply-divider").outerHeight():0)-this.$reply_window.find(".cmty-posting-button-row").outerHeight()-preview_heights,this.$reply_window.find("textarea").outerHeight()>o&&this.$reply_window.find("textarea").outerHeight(Math.max(o,Constants.min_stupid_view_reply_textarea)),l=this.$bottom_panel.outerHeight()),void this.$posts_outer_wrapper.outerHeight(Math.max(t-l,Constants.min_posts_window_height))}this.$posts_outer_wrapper.height("")}},removeFocusListener:function(){this.stopListening(this.model.get("master"),"change:focus_topic")},onRemoveFromPage:function(){var e;this.removeListeners(),this.$el.removeClass("cmty-not-at-top"),this.is_full_reply&&this.removeFullReplyStyle(),$("body").removeClass("cmty-hide-header"),$(window).unbind("resize.cmty-topic-"+this.cid),this.stored_window_top=0,$("#community-all").removeClass("reply-focused"),$(window).unbind("scroll.topic_full_from_start-"+this.cid),$(window).unbind("scroll.topic_full_from_end-"+this.cid),$(window).unbind("touchmove.topic_full_from_start-"+this.cid),$(window).unbind("touchmove.topic_full_from_end-"+this.cid),this.snipe_warning_type=this.model.get("master").get("current_user").get("warn_on_snipes"),AoPS.session.logged_in&&(_.each(this.unread_posts,function(e){e.markRead()}),this.unread_posts.length>0&&(e=this.unread_posts[this.unread_posts.length-1].model,this.model.set("db_mark_time",e.get("post_time"))),this.unread_posts=[]),this.is_on_page=!1,this.start_post_id=-1,this.endReplyTriggeredFullscreen()},removeListeners:function(){this.stopListening(this.model,"topic_updated"),this.removeFocusListener(),this.stopListening(this.model.get("master"),"change:fullscreen_mode")},constructStaticTagbox:function(){var e,t="feed"===this.viewing_source,o=this.hasOwnProperty("route_category_id")&&this.route_category_id!==this.model.get("route_category_id");this.tagbox=new this.staticTagboxView({render_titles:o,model:this.model,url_cmty_path:t?"":this.url_cmty_path,url_router_base:t?"/community":this.url_router_base,push_state_attribute:t?"data-cmty":this.push_state_attribute}),this.$el.find(".cmty-tags-itembox-wrapper").append(this.tagbox.$el),this.tagbox_state="static",this.model.get("is_search_result")&&(e=this.model.fetchSearchText("tags"),e.length>0&&this.tagbox.$el.extendedHighlightText("cmty-highlight",e))},constructEditableTagbox:function(){this.closing=!1,this.editable_tagbox=new this.editableTagboxView({topic:this.model,model:this.model,items:_.map(this.model.get("tags"),function(e){return{label:e.tag_text,item_id:e.tag_id,is_visible:e.is_visible}}),onClose:_.bind(function(e){setTimeout(_.bind(function(){this.editable_tagbox.$el.find("input")[0]!==document.activeElement&&"static"!==this.tagbox_state&&this.toggleTagbox()},this),200)},this)}),this.$el.find(".cmty-tags-itembox-wrapper").append(this.editable_tagbox.$el),this.tagbox_state="editing",this.editable_tagbox.$input_box.focus()},toggleTagbox:function(){"static"===this.tagbox_state?(this.tagbox.close(),this.constructEditableTagbox()):(this.editable_tagbox.close(),this.constructStaticTagbox()),this.setHeight()},goToLastPost:function(){var e,t,o;this.reveal_type="show_from_end",this.setPostFilter(),this.applyPostFilter(),0!==this.posts.length&&(this.setHeight(),e=this.$posts_outer_wrapper.outerHeight(),t=this.$posts_box.height(),o=this.posts[this.posts.length-1].$el.position().top,e>t||(this.isFixedHeight()?this.$posts_inner_wrapper.scrollTop(Math.min(o,-e+t)):window.scrollTo(0,document.body.scrollHeight),this.setPageHeaderVisibility()))},goToFirstPost:function(){this.reveal_type="show_from_start",this.setPostFilter(),this.applyPostFilter(),this.$posts_inner_wrapper.scrollTop(0),this.isFixedHeight()||window.scrollTo(0,0),this.setPageHeaderVisibility()},goToPostId:function(e){var t;t=_.find(this.posts,function(t){return t.model.get("post_id")===e}),_.isUndefined(t)?this.onNoPostFound():this.setPostsBox(t.$el,0,0)},goToPostNumber:function(e){var t;t=_.find(this.posts,function(t){return t.model.get("post_number")===e}),_.isUndefined(t)?this.onNoPostFound():this.setPostsBox(t.$el,0,0)},onNoPostFound:function(){ComViews.showError(Lang["topic-full-no-post-found"]),this.goToFirstPost()},setPostFilter:function(){var e=this;"show_from_start"===this.reveal_type||"show_from_end"===this.reveal_type?this.filterPost=_.bind(function(e){return e.get(this.reveal_type)},this):this.filterPost=_.bind(function(e){var t=e.get("post_number");return t>=this.from_middle.first_shown_post_num&&t<=this.from_middle.last_shown_post_num},this),this.$scrollbar.off("slider_at_start.topic_full"),this.$scrollbar.off("slider_at_end.topic_full"),("show_from_start"===this.reveal_type||"show_from_middle"===this.reveal_type)&&(this.$scrollbar.on("slider_at_end.topic_full",_.bind(function(){this.fetchMorePosts("forwards")},this)),"master"===this.viewing_source&&($(window).on("scroll.topic_full_from_start-"+this.cid+" touchmove.topic_full_from_start-"+this.cid,function(){e.$el.is(":visible")&&!e.$scrollbar.is(":visible")&&document.documentElement.clientHeight+$(document).scrollTop()+20>=document.body.offsetHeight&&e.fetchMorePosts("forwards")}),$(window).unbind("scroll.topic_full_from_end-"+this.cid),$(window).unbind("touchmove.topic_full_from_end-"+this.cid))),("show_from_end"===this.reveal_type||"show_from_middle"===this.reveal_type)&&(this.$scrollbar.on("slider_at_start.topic_full",_.bind(function(){this.fetchMorePosts("backwards")},this)),"master"===this.viewing_source&&($(window).on("scroll.topic_full_from_end-"+this.cid+" touchmove.topic_full_from_end-"+this.cid,function(){e.$el.is(":visible")&&!e.$scrollbar.is(":visible")&&$(document).scrollTop()<$("#header-wrapper").outerHeight()+parseInt($("#main-content").css("padding-top"))+$("#cmty-topic-view-top").height()&&e.fetchMorePosts("backwards")}),$(window).unbind("scroll.topic_full_from_start-"+this.cid),$(window).unbind("touchmove.topic_full_from_start-"+this.cid)))},setQuickReplyVisibility:function(){this.reply_open||this.model.get("locked")||this.model.get("forum_locked")||"show_from_end"!==this.reveal_type&&!this.model.get("all_posts_fetched")?this.$quick_reply.css({display:"none"}):this.$quick_reply.css({display:"block"})},applyPostFilter:function(){var e=this;this.setQuickReplyVisibility(),_.each(this.posts,function(t){e.setPostVisibility(t)})},setPostVisibility:function(e){e.$el.toggle(this.filterPost(e.model))},setPostsBox:function(e,t,o){_.isUndefined(e)||_.isNull(e)||(this.isFixedHeight()?this.$posts_inner_wrapper.scrollTop(-(t-e.position().top+this.$posts_box.position().top-o)):window.scrollTo(0,e.position().top),this.setPageHeaderVisibility())},setPageHeaderVisibility:function(){!this.is_on_page||this.isFixedHeight()||1!==this.posts[0].model.get("post_number")||this.posts[0].$el.is(":visible")?$("body").removeClass("cmty-hide-header"):$("body").addClass("cmty-hide-header"),$(window).trigger("resize")},fetchMorePosts:function(e){var t,o,i,s,a,n,r,l="append",c=this.posts.length,d=this;if(!this.model.get("all_posts_fetched")&&!this.model.get("is_fetching_posts")&&($(document).trigger("mouseup"),this.is_initialized)){switch(this.reveal_type){case"show_from_start":r={onFinish:_.bind(function(){this.applyPostFilter()},this),start_post_num:_.last(_.filter(this.posts,_.bind(function(e){return this.filterPost(e.model)},this))).model.get("post_number")};break;case"show_from_end":r={start_post_num:_.find(this.posts,_.bind(function(e){return this.filterPost(e.model)},this)).model.get("post_number"),onFinish:_.bind(function(){this.setPostsBox(s,a,n),this.applyPostFilter()},this)};break;case"show_from_middle":r=this.from_middle.init?{start_post_num:"forwards"===e?this.from_middle.last_shown_post_num:this.from_middle.first_shown_post_num}:{start_post_id:this.start_post_id,show_from_time:this.mark_time_at_add},r.onFinish=_.bind(function(t){var o=-1;(!this.from_middle.init||t.low_num<this.from_middle.first_shown_post_num)&&(this.from_middle.first_shown_post_num=t.low_num),(!this.from_middle.init||t.high_num>this.from_middle.last_shown_post_num)&&(this.from_middle.last_shown_post_num=t.high_num),this.from_middle.init||(o=t.hasOwnProperty("target_post_number")&&!_.isNull(t.target_post_number)?t.target_post_number:-1),this.from_middle.init=!0,this.model.get("posts").findWhere({post_number:t.low_num}).get("show_from_start")&&(this.model.get("posts").each(function(e){e.get("post_number")<=d.from_middle.last_shown_post_num&&e.set("show_from_start",!0)}),this.reveal_type="show_from_start"),this.model.get("posts").findWhere({post_number:t.high_num}).get("show_from_end")&&(this.model.get("posts").each(function(e){e.get("post_number")>=d.from_middle.first_shown_post_num&&e.set("show_from_end",!0)}),this.reveal_type="show_from_end"),this.setPostFilter(),this.applyPostFilter(),"backwards"===e&&this.setPostsBox(s,a,n),o>-1&&this.goToPostNumber(o)},this);break;default:console.log("Uhoh.  fetchMorePosts called without reveal_type set properly")}if(r.direction=e,r.show_from_setting=this.reveal_type,"backwards"===e&&(l="prepend"),this.$posts_box[l](this.$loader),"backwards"===e){n=-this.$posts_inner_wrapper.scrollTop();for(var t=0;c>t;t++)o=this.posts[t].$el,o.is(":visible")&&(i=o.position().top,n+i+o.height()>0&&(s=o,a=i+n,t=c))}"forwards"===e&&this.$posts_inner_wrapper.scrollTop(this.$posts_box.height()-this.$posts_inner_wrapper.height()),"backwards"===e&&this.$posts_inner_wrapper.scrollTop(0),r.onError=function(e){"E_AJAX_CANCEL"===e.error_code&&d.$loader.detach()},r.source=this.viewing_source,this.model.fetchMorePosts(r)}},removeLoader:function(){this.$loader.detach()},addPost:function(e){var t,o,i=new this.postView({model:e,topic:this}),s=e.get("post_number"),a=this,n=this.posts.length;for(post_placed=!1,this.spoofing_scrollbar&&(this.spoofing_scrollbar=!1,setTimeout(function(){a.$posts_inner_wrapper.parent().removeClass("aops-spoof-scrollbar-visible")},330)),i.$el.css({display:"none"}),t=n-1;t>=0;t--)o=this.posts[t],o.model.get("post_number")<s&&(o.$el.after(i.$el),this.posts.splice(t+1,0,i),this.filterPost(e)&&i.$el.css({display:"block"}),post_placed=!0,t=0);post_placed||(this.posts.splice(0,0,i),this.has_source?this.$source.after(i.$el):this.$posts_box.prepend(i.$el),this.filterPost(e)&&i.$el.css({display:"block"})),AoPS.session.logged_in&&i.model.get("post_time")>this.mark_time_at_add&&i.model.get("poster_id")!==AoPS.session.user_id&&(i.markUnread(),this.unread_posts.push(i))},removePost:function(e){this.posts=_.without(this.posts,e),e.close()},locateFirstUnreadPostBox:function(){var e=this.posts.length;if(this.posts[e-1].is_read)return this.posts[e-1];for(var t=e-2;t>0;t--)if(this.posts[t].is_read)return this.posts[t+1];return this.posts[0]},addPostAfterPageConstruction:function(e){this.addPost(e),!this.reply_open||_.isNull(this.reply_box)||this.reply_box.sending_to_database||"none"===this.snipe_warning_type||this.model.get("is_fetching_past_posts")||!this.$el.is(":visible")||this.max_post_num_at_reply_start<e.get("post_number")&&e.get("poster_id")!==AoPS.session.user_id&&e.get("poster_id")!==Constants.halp_user_id&&this.warnAboutSniping()},warnAboutSniping:function(){var e,t=this;this.snipe_warning_open||(this.snipe_warning_open=!0,e=[{text:Lang["snipe-option-never"],value:"none"},{text:Lang["snipe-option-not-this-time"],value:"now"},{text:Lang["snipe-option-flyout"],value:"flyout"},{text:Lang["snipe-option-close"],value:"close"}],"modal"===this.snipe_warning_type?(AoPS.Ui.Modal.showMessage(Lang["snipe-warning-body"],{type:"buttons",title:Lang["snipe-title"],buttons:e,width:"450px",close_on_button_click:!1,onButtonClick:_.bind(function(e){return"now"===e&&(this.snipe_warning_type="none"),("none"===e||"flyout"===e)&&(this.model.get("master").get("current_user").setUserSetting({field:"warn_on_snipes",value:e}),this.snipe_warning_type=e),AoPS.Ui.Modal.closeAllModals(),!1},this),onClose:_.bind(function(){this.snipe_warning_open=!1},this)}),$("textarea.cmty-post-textarea").last().focus()):(Flyout.display(Lang["snipe-warning-flyout"]),setTimeout(function(){t.snipe_warning_open=!1},2e3)))},setFullReplyStyle:function(){ComViews.setFullReplyStyle()},removeFullReplyStyle:function(){ComViews.removeFullReplyStyle()},onClickFullReply:function(){this.completeReplyClick("feed"===this.viewing_source?"quick":"full")},checkReplyAvailable:function(){return AoPS.session.logged_in?this.model.getPermission("c_can_reply")||this.model.getPermission("c_undo_global_ban")?!0:(AoPS.isUserLimited()?message=Lang["new-reply-no-permission-limited"]:message=Lang["new-reply-no-permission"],AoPS.Ui.Modal.showMessage(message,{width:"450px"}),!1):(AoPS.Ui.buildLoginConfirm(Lang["topic-full-not-logged-in-reply"]),!1)},onClickReply:function(){var e="quick";this.model.get("master").get("current_user").get("posting_fullscreen_reply")&&"feed"!=this.viewing_source&&(e="full"),this.completeReplyClick(e)},completeReplyClick:function(e){var t,o=!1;this.checkReplyAvailable()&&(t="full"===e,t&&(this.setFullReplyStyle(),this.is_full_reply=!0,this.reply_open&&this.reply_box.is_previewing&&(o=!0,this.reply_box.onClickClosePreview())),this.reply_open?(_.isNull(this.reply_box)||this.reply_box.$post_box.focus(),this.isFixedHeight()||this.goToLastPost()):this.openNewReply(),t&&($(window).trigger("resize"),o&&this.reply_box.previewPost()))},openNewReply:function(){var e,t=!1,o=this;this.max_post_num_at_reply_start=this.model.get("posts").last().get("post_number"),e={notify_email:this.model.get("is_watched")||this.model.get("master").get("current_user").get("posting_subscribe_reply"),bookmark_feed:this.model.get("in_feed")||this.model.get("master").get("current_user").get("posting_subscribe_reply")},this.reply_box=new ComViews.NewReply({topic_id:this.model.get("topic_id"),category_id:this.model.get("category_id"),topic:this.model,master:this.master,onPreview:function(){o.$el.addClass("cmty-open-preview"),o.setHeight()},onRevealPreview:function(){o.is_full_reply&&window.scrollTo(0,o.$(".cmty-posting-preview-bar").offset().top-20)},onClosePreview:_.bind(function(){this.$el.removeClass("cmty-open-preview"),this.setHeight()},this),onSubmit:_.bind(function(){this.listenToOnce(this.model,"new_post_processed",this.onSubmittedPostProcessed)},this),onCancel:_.bind(function(){this.closeNewReply()},this),preset_extra_options:e}),this.reply_box.$post_box.on("focus",function(){$("#community-all").addClass("reply-focused")}).on("blur",function(){setTimeout(function(){$("#community-all").removeClass("reply-focused")},10)}),this.$posts_box.height()-this.$posts_inner_wrapper.scrollTop()-this.$posts_inner_wrapper.height()<Constants.reply_jump_to_bottom_window&&(t=!0),this.$quick_reply.hide(),this.$reply_window.show(),this.$reply_window.append(this.reply_box.$el),this.reply_open=!0,this.setHeight(),this.reply_box.$el.find("textarea").focus(),t&&this.goToLastPost()},appendToReply:function(e){this.reply_open?this.reply_box.addContent(e):(this.openNewReply(),this.reply_box.addContent(e))},onSubmittedPostProcessed:function(){this.closeNewReply(),this.goToLastPost(),setTimeout(function(){AoPS.Ui.Modal.closeAllModals()},Constants.new_reply_modal_delay)},closeNewReply:function(){this.reply_open=!1,this.setQuickReplyVisibility(),_.isNull(this.reply_box)||this.reply_box.close(),this.reply_box=null,this.$reply_window.hide(),this.setHeight(),this.is_full_reply&&(this.is_full_reply=!1,this.removeFullReplyStyle())},endReplyTriggeredFullscreen:function(){this.fullscreen_triggered_by_reply&&(this.fullscreen_triggered_by_reply=!1,this.model.get("master").set("fullscreen_mode","none"),$(window).trigger("resize"))},onClose:function(){this.hasOwnProperty("reply_box")&&!_.isNull(this.reply_box)&&"function"==typeof this.reply_box.close&&this.reply_box.close(),_.each(this.posts,function(e){e.close()}),Backbone.trigger("destroy_topic_view",{category_id:this.topic_category_at_initialization,topic_id:this.topic_id})}}),ComViews.CategoryCell=AoPS.View.extend({template_id:"#cmty-category-cell-tpl",className:"cmty-category-cell",can_bookmark:!1,has_own_url:!1,has_search:!1,has_small_header:!1,forums_not_tags:!1,default_to_tags:!0,force_to_tags:!1,has_topics:!0,fetch_topics_immediately:!1,has_numbers:!0,has_items:!0,has_help:!1,has_search_link:!1,has_bottom:!0,has_jump_to_top:!1,placeholder_text:Lang["cat-cell-no-tags-yet"],use_own_color:!0,topics_box_constructor:ComViews.CategoryCellTopics,items_box_constructor:ComViews.Itembox,topic_box_constructed:!1,tags_topics_in_topbar:!1,topics_title:Lang["cat-cell-forum-topics"],items_title:Lang["cat-cell-tags-title"],show_description:!1,initialize:function(e){var t,o=Utils.displayCategoryType(this.model.get("category_type")),i=this.model.get("category_id")>1,s="none"!==this.model.get("can_add_type")&&this.model.get("master").fetchPermission("can_create_category"),a=this.model.getPermission("c_can_lock_category"),n=s?Lang.Create+" new "+this.model.get("can_add_type"):"";e.hasOwnProperty("default_to_topics")&&e.default_to_topics?this.default_to_tags=!1:!this.force_to_tags&&this.model.has("active_topics")&&(this.model.get("all_topics_loaded")||this.model.get("active_topics").length>3)&&(this.default_to_tags=!1),ComViews.setRouteInfo(this,e),this.constructUrls(i),t={has_small_header:this.has_small_header,category_name:this.model.get("category_name"),short_description:this.model.get("short_description"),long_description:this.model.get("short_description"),url:AoPS.Community.Views.makeLinkUrl(this.url,this.url_router_base+this.url_cmty_path),push_state_stay:this.push_state_attribute,can_post:this.model.get("can_start_topic")&&!this.model.get("is_locked"),is_locked:this.model.get("can_own_topics")&&this.model.get("is_locked"),lang_category_locked_title:a?Lang["cat-cell-forum-locked-title-mod"]:Lang["cat-cell-forum-locked-title"],Locked:Lang["cat-cell-Locked"],can_unlock:a,can_add:s,can_add_title:n,hide_desc_phone:this.model.get("hide_desc_on_phone"),has_numbers:this.has_numbers,has_items:this.has_items,has_jump_to_top:this.has_jump_to_top,show_description:!(this.has_numbers||this.has_topics)||this.show_description,has_bottom:this.has_bottom,can_bookmark:this.can_bookmark,mark_read:Lang["cat-cell-mark-read"],new_post:this.model.get("is_private")?Lang["cat-cell-new-message"]:Lang["cat-cell-new-topic"],category_id:this.model.get("category_id"),can_mark_all_read:AoPS.session.logged_in&&this.model.get("can_mark_all_read"),has_info:i,has_search_link:this.has_search_link&&-1==_.indexOf(Constants.unsearchable_fora,this.model.get("category_id")),lang_search:this.model.get("is_private")?Lang["cat-cell-search-pm"]:Lang["cat-cell-search-forum"],lang_information:Utils.capitalizeFirstLetter(o)+" "+Lang.information,lang_mark_read_title:Lang["cat-cell-mark-read-title"],lang_bookmark_title:Lang["cat-cell-bookmark-title"]+o,lang_new_topic_title:this.model.get("is_private")?Lang["cat-cell-new-pm-title"]:Lang["cat-cell-new-topic-title"],lang_additional_options:Lang["cat-cell-more-options-title"],has_help:this.has_help,has_search:this.has_search,lang_help_title:Lang["cat-cell-help-title"]},this.$el.html(this.getTemplate(this.template_id,t)),this.forums_not_tags&&this.$el.addClass("cmty-forums-not-tags"),this.model.get("can_own_topics")&&this.listenTo(this.model,"change:is_locked",this.parseLockStatus),this.$category_heading=this.$el.find(".cmty-category-cell-heading"),this.$new_topic=this.$category_heading.find(".cmty-new-topic-button"),this.$locked=this.$category_heading.find(".cmty-category-locked-button"),this.$category_description=this.$el.find(".cmty-category-description"),this.$menu=this.$el.find(".cmty-cat-cell-menu"),(this.has_items||this.has_topics)&&(this.$itembox_container=this.$el.find(".cmty-category-itembox-wrapper")),this.has_items&&(this.$itembox_bar=this.$el.find(".cmty-category-cell-poptags"),this.$active_triangle=this.$el.find(".cmty-category-cell-sublink-triangle"),this.$itembox_bar.length>0&&(this.$itembox_bar[0].title=this.items_title),this.default_to_tags&&this.onClickPopularTags()),this.has_numbers&&(this.$num_topics=this.$el.find(".cmty-category-cell-num-topics"),this.$num_users=this.$el.find(".cmty-category-cell-num-users"),this.setNumTopics(),this.setNumUsers(),this.listenTo(this.model,"change:num_topics",this.onChangeNumTopics),this.listenTo(this.model,"change:num_posts",this.setNumPosts),this.listenTo(this.model,"change:num_users",this.onChangeNumUsers)),this.has_search&&this.buildCategorySearch(),this.applyColor(),this.has_topics&&(this.$topic_bar=this.$el.find(".cmty-category-cell-topics"),this.default_to_tags||this.onClickTopics(),this.$topic_bar.length>0&&(this.$topic_bar[0].title=this.topics_title)),this.model.get("can_mark_all_read")&&AoPS.session.logged_in&&(this.parseAllRead(),this.listenTo(this.model,"change:all_read",this.parseAllRead)),this.tags_topics_in_topbar&&(this.$(".cmty-category-cell-right").append(this.$topic_bar),this.$(".cmty-category-cell-right").append(this.$itembox_bar)),this.listenTo(this.model,"change:deleted",this.onDeleteCategory)},parseLockStatus:function(){this.model.get("can_own_topics")&&(this.$new_topic.toggleClass("force-hidden",this.model.get("is_locked")),this.$locked.toggleClass("force-hidden",!this.model.get("is_locked")))},constructUrls:function(e){this.url=this.has_own_url?this.own_url:"/c"+this.model.get("category_id")+"_"+ComViews.convertToUrlFragment(this.model.get("category_name")),this.url_info=e?"/category-admin/"+this.model.get("category_id"):""},events:{"mouseenter .cmty-full-cell-link":"onHoverHeading","mouseleave .cmty-full-cell-link":"onUnhoverHeading","click .cmty-mark-all-read":"markAllRead","click .cmty-category-cell-poptags":"onClickPopularTags","click .cmty-category-cell-topics":"onClickTopics","click .cmty-new-topic-button":"launchNewTopic","click .cmty-category-cell-heading":"onClickHeading","click .cmty-mark-all-read":"onClickMarkAllRead","click .cmty-cat-cell-cat-info":"onClickInfo","click .cmty-add-new-category":"onClickAddNew","click .cmty-cat-admin-help-wrap":"onClickHelp","click .cmty-category-locked-button":"onClickLocked","click .cmty-cat-cell-search":"onClickSearch"},onDeleteCategory:function(){this.model.get("deleted")&&this.close()},onClickLocked:function(e){return this.model.getPermission("c_can_lock_category")?void this.launchNewTopic(e):(ComViews.showError(Lang["cat-cell-locked-modal"]),e.stopPropagation(),void e.preventDefault())},onClickAddNew:function(e){"forum"===this.model.get("can_add_type")&&ComViews.followUrlOnClick(e,"/category-admin/forum"),"collection"===this.model.get("can_add_type")&&AoPS.Ui.Modal.showAlert(this.getTemplate("#cmty-create-collection-modal-body-tpl",{}),{title:Lang["cat-cell-create-collection"],alert_button_ok:Lang.Cancel,width:"600px"}),"blog"===this.model.get("can_add_type")&&ComViews.followUrlOnClick(e,"/category-admin/blog"),e.preventDefault(),e.stopPropagation()},onClickSearch:function(e){var t=1==this.model.get("category_id")?"/search-private":"/search-forum/"+this.model.get("category_id");"/community"===this.url_router_base?ComViews.followUrlOnClick(e,t):ComViews.leaveRouterOnClick(e,t)},onClickInfo:function(e){"/community"===this.url_router_base?ComViews.followUrlOnClick(e,this.url_info):ComViews.leaveRouterOnClick(e,this.url_info)},onClickMarkAllRead:function(e){return this.model.markAllTopicsRead(),e.preventDefault(),e.stopPropagation(),!1},onClickHelp:function(e){var t=this.getTemplate(this.help_template,{is_logged_in:AoPS.session.logged_in});0===this.help_template.length&&console.log("oh no; there is a help box on a category with no help_template set."),AoPS.Ui.Modal.showAlert(t,{title:Lang[this.help_template_title_setting],width:"450px",scrollable:!0}),e.preventDefault(),e.stopPropagation()},onAddToPage:function(){this.hasOwnProperty("topic_box")&&(this.topic_box.on_page=!0,this.checkNeedLoadTopics())},onRemoveFromPage:function(){this.hasOwnProperty("topic_box")&&(this.topic_box.on_page=!1)},onHoverHeading:function(e){this.use_own_color&&this.$category_heading.find(".cmty-category-cell-left").css({color:"#fff"})},onUnhoverHeading:function(e){this.use_own_color&&this.$category_heading.find(".cmty-category-cell-left").css({color:this.model.get("secondary_color")})},onClickPopularTags:function(e){this.hasOwnProperty("itembox")||this.constructItembox(),this.itembox.$el.show(),this.topic_box_constructed&&this.topic_box.$el.hide(),this.topic_box_revealed=!1,this.setBars(this.$itembox_bar,this.$topic_bar),arguments.length>0&&e.stopPropagation()},onClickTopics:function(e){this.topic_box_constructed||this.constructTopicBox(),this.hasOwnProperty("itembox")&&this.itembox.$el.hide(),this.topic_box.$el.show(),this.topic_box.on_page=!0,this.topic_box_revealed=!0,this.checkNeedLoadTopics(),this.setBars(this.$topic_bar,this.$itembox_bar),arguments.length>0&&e.stopPropagation()},checkNeedLoadTopics:function(){this.topic_box_revealed&&0===this.topic_box.collection.length&&this.topic_box.checkMoreTopicsNeeded()},parseAllRead:function(){this.$el.toggleClass("cmty-all-read",this.model.get("all_read"))},buildCategorySearch:function(){var e=$('<input type="search" class="cmty-tag-search-input" placeholder="'+Lang["cat-search-placeholder-"+this.model.get("category_id")]+'"></input>');Utils.buildCategoryAutocomplete(e,{ajax_call:this.category_search_autocomplete,has_search_icon:!0,autocomplete_settings:{onSelect:function(t,o){e.val(""),e.autocomplete("close"),Backbone.history.navigate("/c"+o.item.category_id+"_"+ComViews.convertToUrlFragment(o.item.label),{trigger:!0}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0}),e.parent().on("click touchstart",function(t){e.focus(),t.stopPropagation(),t.preventDefault()}),this.$el.find(".cmty-category-cell-right").append(e.parent())},onChangeNumTopics:function(){var e=this,t=this.$num_topics.find(".cmty-category-cell-number");t.fadeOut(300,function(){e.setNumTopics(),t.show()})},setNumTopics:function(){var e=this.model.has("num_topics")?Utils.renderNumberWithCommas(this.model.get("num_topics")):"1,729",t=1===e?Lang["cat-cell-topic"]:Lang["cat-cell-topics"];this.$num_topics.html(this.getTemplate("#cmty-category-cell-num-topics-tpl",{num_topics:e+" "+t,url:AoPS.Community.Views.makeLinkUrl(this.url)}));var o=this.$num_topics.find("a");o.length&&(o[0].style.color=this.model.get("main_color"))},setNumPosts:function(){var e=this.model.has("num_posts")?this.model.get("num_posts"):1030401,t=1===e?Lang["cat-cell-post"]:Lang["cat-cell-posts"];this.$num_topics[0].title=e+" "+t},onChangeNumUsers:function(){var e=this,t=this.$num_users.find(".cmty-category-cell-number");t.fadeOut(300,function(){e.setNumUsers(),t.show()})},setNumUsers:function(){var e=this.model.has("num_users")?this.model.get("num_users"):31,t=1===e?Lang["cat-cell-user"]:Lang["cat-cell-users"];this.$num_users.html(this.getTemplate("#cmty-category-cell-num-users-tpl",{num_users:e+" "+t})),this.$num_users[0].title=Lang["cat-cell-num-user-title"]},setBars:function(e,t){e.addClass("active-sublink").append(this.$active_triangle),_.isUndefined(t)||t.removeClass("active-sublink")},constructItembox:function(){this.itembox=new this.items_box_constructor({model:this.model,placeholder_text:this.placeholder_text,url_router_base:this.url_router_base,url_cmty_path:this.url_cmty_path,scrollbar_arguments:{autosize_exclusions:[{min:841,max:1e5}]},push_state_attribute:this.push_state_attribute}),this.$itembox_container.append(this.itembox.$el)},constructTopicBox:function(){var e=this.model.get("master").fetchFilteredTopicList({category:this.model,category_id:this.model.get("category_id"),tag_ids:[]});this.topic_box=new this.topics_box_constructor({collection:e,main_color:this.model.get("main_color"),secondary_color:this.model.get("secondary_color"),master:this.model.get("master"),category_id:this.model.get("category_id"),suppress_initial_fetch:!(this.default_to_tags||this.fetch_topics_immediately),use_topic_category:this.forums_not_tags}),this.$itembox_container.append(this.topic_box.$el),this.topic_box_constructed=!0,this.model.get("is_forum")&&this.model.has("num_topics")&&this.model.get("num_topics")<6&&this.$el.addClass("cmty-short-forum")},markAllRead:function(){this.model.markAllTopicsRead()},applyColor:function(){var e=this.model.get("main_color"),t=this.model.get("secondary_color");this.use_own_color&&(this.$category_heading.css({"background-color":e,color:t}),this.$el.find(".cmty-category-cell-numbers").css({color:e}))},onClose:function(){this.hasOwnProperty("itembox")&&this.itembox.close(),this.hasOwnProperty("topic_box")&&this.topic_box.close(),this.hasOwnProperty("tag_filter")&&this.tag_filter.close()},launchNewTopic:function(e){var t;return AoPS.session.logged_in?this.model.getPermission("c_can_start_topic")||this.model.getPermission("c_undo_global_ban")?(t={model:this.model,master:this.model.get("master"),url_cmty_path:this.url_cmty_path},arguments.length>1&&(t.tags=arguments[1].tags),_.isNull(this.model.get("master").get("focus_tag"))||(t.tags=[this.model.get("master").get("focus_tag").item_text]),new ComViews.NewTopic(t)):AoPS.Ui.Modal.showMessage(Lang[AoPS.isUserLimited()?"cat-cell-no-perm-limited-user":"cat-cell-no-perm-start-topic"],{width:"450px"}):AoPS.Ui.buildLoginConfirm(Lang["new-topic-not-logged-in"]),e.preventDefault(),e.stopPropagation(),!1}}),ComViews.CategoryCellBlog=ComViews.CategoryCell.extend({className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-blog cmty-category-cell-folder ",template_id:"#cmty-category-cell-blog-tpl",has_items:!1,default_to_tags:!1,has_numbers:!1,use_own_color:!1,initialize:function(e){var t=this.model.get("num_topics"),o=t+" ";ComViews.CategoryCell.prototype.initialize.apply(this,[e]),this.$(".cmty-blog-cell-avatar").append('<img src="'+this.model.get("creator_avatar")+'" width="52" height="52">'),o+=1===t?Lang["blog-Entry"]:Lang["blog-Entries"],this.$(".cmty-blog-cell-entry-count").html(o)}}),ComViews.CategoryCellMyBooks=ComViews.CategoryCell.extend({has_topics:!1,has_numbers:!1,placeholder_text:"BOOKS WILL BE HERE",can_bookmark:!1,has_own_url:!0,own_url:"MYBOOKSURL",onClickHeading:function(){}}),ComViews.CategoryCellMyClasses=ComViews.CategoryCell.extend({has_topics:!1,can_bookmark:!1,has_numbers:!1,placeholder_text:"CLASSES WILL BE HERE",has_own_url:!0,own_url:"MYCLASSESURL",onClickHeading:function(){}}),ComViews.CategoryCellFolder=ComViews.CategoryCell.extend({className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-folder  cmty-category-cell-no-numrow",has_topics:!1,placeholder_text:Lang["cat-cell-no-items-yet"],can_bookmark:!1,has_numbers:!1,use_own_color:!1,applyColor:function(){var e=this.model.get("main_color");this.$category_heading.css({"border-top":"5px solid "+e
}),this.$el.find(".cmty-category-cell-title").css({color:e})}}),ComViews.CategoryCellBookmarkUsers=ComViews.CategoryCellFolder.extend({placeholder_text:Lang["cat-cell-no-users-bookmarked"]}),ComViews.CategoryCellMyBookmarks=ComViews.CategoryCellFolder.extend({has_own_url:!0,has_numbers:!1,own_url:"/my-bookmarks",onClickHeading:function(e){ComViews.followUrlOnClick(e,"/my-bookmarks")}}),ComViews.CategoryCellForumView=ComViews.CategoryCell.extend({className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-folder",can_bookmark:!1,has_numbers:!1,show_description:!1,use_own_color:!1,tags_topics_in_topbar:!0,topics_title:Lang["cat-cell-forum-view-topics"],items_title:Lang["cat-cell-items-title-forum-view"],forums_not_tags:!0}),ComViews.CategoryCellForumBookmarks=ComViews.CategoryCellForumView.extend({placeholder_text:Lang["bookmark-no-forums-bookmarked"],items_title:Lang["cat-cell-items-title-forum-bookmark"]}),ComViews.CategoryCellTagView=ComViews.CategoryCell.extend({className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-view-tags cmty-category-cell-folder",can_bookmark:!1,has_numbers:!1,show_description:!1,use_own_color:!1,topics_title:Lang["cat-cell-tag-view-topics"],items_title:Lang["cat-cell-items-title-tag-view"],tags_topics_in_topbar:!0,applyColor:ComViews.CategoryCellFolder.prototype.applyColor}),ComViews.CategoryCellPostView=ComViews.CategoryCell.extend({className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-folder",can_bookmark:!1,placeholder_text:Lang["cat-cell-no-posts-yet"],has_numbers:!1,use_own_color:!1,has_topics:!1,items_box_constructor:ComViews.ItemboxPosts,applyColor:function(){var e=this.model.get("main_color");this.model.get("secondary_color");this.$category_heading.css({"border-top":"5px solid "+e}),this.$el.find(".cmty-category-cell-title").css({color:e})}}),ComViews.CategoryCellTagBookmarks=ComViews.CategoryCellTagView.extend({placeholder_text:Lang["bookmark-no-tags-bookmarked"],items_title:Lang["cat-cell-items-title-tag-bookmark"]}),ComViews.CategoryCellTopicView=ComViews.CategoryCell.extend({can_bookmark:!1,className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-folder",has_items:!1,use_own_color:!1,has_numbers:!1,default_to_tags:!1,fetch_topics_immediately:!1}),ComViews.CategoryCellTopicBookmarks=ComViews.CategoryCellTopicView.extend({placeholder_text:Lang["bookmark-no-topics-bookmarked"]}),ComViews.CategoryCellMyPrivates=ComViews.CategoryCell.extend({can_bookmark:!1,default_to_tags:!1,has_numbers:!1,topics_box_constructor:ComViews.CategoryCellPrivatesTopics,launchNewTopic:function(e){var t;return this.model.getPermission("c_can_start_topic")||this.model.getPermission("c_undo_global_ban")?t=new ComViews.NewPrivateConversation({category_name:"",category_id:Constants.private_messages_id,model:this.model,master:this.model.get("master")}):AoPS.Ui.Modal.showMessage(Lang[AoPS.isUserLimited()?"new-pm-no-permission-limited":"new-pm-no-permission"],{width:"450px"}),_.isUndefined(e)?void 0:(e.stopPropagation(),e.preventDefault(),!1)}}),ComViews.CategoryCellOtherForums=ComViews.CategoryCellFolder.extend({category_search_autocomplete:"fetch_forum_autocomplete",has_search:!0,className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-no-numrow cmty-category-cell-folder",help_template:"#cmty-other-forums-help-modal-tpl"}),ComViews.CategoryCellSpecialCollections=ComViews.CategoryCellFolder.extend({category_search_autocomplete:"fetch_folder_collections_contents_autocomplete",has_search:!0,className:ComViews.CategoryCell.prototype.className+" cmty-category-cell-no-numrow cmty-category-cell-folder",help_template:"#cmty-special-collections-help-modal-tpl"}),ComViews.category_cell_category_top_new_properties={num_matches:15,default_to_tags:!0,has_small_header:!0,force_to_tags:!0,has_jump_to_top:!0,initialize:function(e){this.model.get("is_forum")&&(this.model.get("is_private")||(this.can_bookmark=!0),this.has_search_link=!0),this.model.get("special_url").length>0&&(this.url=this.model.get("special_url"),this.constructUrls=function(){}),ComViews.CategoryCell.prototype.initialize.apply(this,[e]),("forum"===this.model.get("category_type")||"my_privates"===this.model.get("category_type"))&&this.$category_heading.find(".cmty-category-cell-left").css({color:"#fff"}),this.model.get("has_tag_filter")&&(this.tag_filter=new ComViews.CategoryTagFilter(e),this.$itembox_container.before(this.tag_filter.$el)),this.can_bookmark&&(this.$bookmark=this.$el.find(".cmty-category-cell-bookmark"),this.setForumBookmarkStatus(),this.listenTo(this.model,"change:is_bookmarked change:is_watched change:in_feed",this.setForumBookmarkStatus)),this.model.get("is_private")&&!this.model.get("is_archive")&&this.setArchivedButton(),this.listenTo(this.model,"reset_tag_bookmark",this.setTagBookmarkStatus)},setArchivedButton:function(){var e=this.$category_heading.find(".cmty-category-cell-right");e.prepend('<span title="'+Lang["private-archive-title"]+'"				 class="cmty-category-cell-archive cmty-icon-w-text clickable"><span class="cmty-cat-cell-aops-font-icon">(</span>				 <span class="cmty-cat-cell-symbol-tag">'+Lang["private-View-Archive-btn"]+"</span></span>&nbsp;")},events:_.extend({"click .cmty-category-cell-bookmark":"onClickForumBookmark","click .cmty-category-cell-archive":"onClickArchive"},ComViews.CategoryCell.prototype.events),onAddToPage:function(){this.model.get("has_tag_filter")&&this.tag_filter.onAddToPage(),this.has_topics&&this.model.has("master")&&this.insertFocusTag()},onRemoveFromPage:function(){this.has_topics&&this.model.has("master")&&this.removeFocusTag()},insertFocusTag:function(){var e,t,o,i,s;if(!_.isNull(this.model.get("master").get("focus_tag"))){s=_.clone(this.model.get("master").get("focus_tag")),s.item_can_remove=!0,e=this.itembox.constructItem(s);var a=e.find(".cmty-item-tag");a.css({"background-color":s.item_secondary_color,color:s.item_main_color,border:"1px solid "+s.item_main_color}).on("mouseleave",function(e){a.css({"background-color":s.item_secondary_color,color:s.item_main_color})}),e.addClass("cmty-cat-cell-focus-shadow cmty-tablet-inline"),this.itembox.$itembox.prepend(e),t=e.attr("href"),o=t.match(/t\d+f\d+/),_.isNull(o)||(i=t.split(o)[0],e.attr("href",i)),this.$focus_tag=e}},removeFocusTag:function(){this.hasOwnProperty("$focus_tag")&&this.$focus_tag.remove()},onClickArchive:function(e){ComViews.followUrlOnClick(e,"/my-messages-archive")},onClickForumBookmark:function(e){e.preventDefault(),e.stopPropagation(),AoPS.session.logged_in?AoPS.isUserLimited()?Modal.showMessage(Lang["bookmark-limited-user"],{width:"450px"}):this.model.get("is_bookmarked")?this.model.setBookmarkState({is_bookmarked:!1}):ComViews.fireBookmarkModal("forum",Utils.formatString(Lang["bookmark-modal-forum"],[this.model.get("category_name")]),_.bind(this.model.setBookmarkState,this.model)):AoPS.Ui.buildLoginConfirm(Lang["bookmark-not-logged-in"])},setForumBookmarkStatus:ComViews.TopicFull.prototype.setBookmarkStatus,submitNewItem:function(e){var t=this;this.model.addItem({item_id:parseInt(e.item_id),item_type:"tag",item_forum_id:this.model.get("category_id"),item_text:e.value,item_main_color:e.main_color,item_secondary_color:e.secondary_color}),setTimeout(function(){t.$input_box.autocomplete("disable"),t.$input_box.autocomplete("enable"),Backbone.history.navigate(t.url_cmty_path+"/c"+t.model.get("category_id")+"t"+e.item_id+"f"+e.item_forum_id,{trigger:!0})},100),this.$input_box.val("")},onUnhoverHeading:function(e){this.use_own_color&&this.$category_heading.find(".cmty-category-cell-left").css({color:"#fff"})},onHoverHeading:function(e){this.use_own_color&&this.$category_heading.find(".cmty-category-cell-left").css({color:this.model.get("secondary_color")})}},ComViews.CategoryTagFilter=AoPS.View.extend({template_id:"#cmty-category-cell-focus-tpl",has_own_url:!1,className:"cmty-tag-filter",initialize:function(e){this.focus_tag=e.focus_tag,this.model.get("special_url").length>0?this.url=this.model.get("special_url"):this.url="/c"+this.model.get("category_id")+"_"+ComViews.convertToUrlFragment(this.model.get("category_name")),ComViews.setRouteInfo(this,e),this.render(),this.$focus_tag_line=this.$el.find(".cmty-focus-tag-line"),this.$focus_tag_box=this.$focus_tag_line.parent(),this.listenTo(this.model.get("master"),"change:focus_tag",this.onChangeFocusTag),this.listenTo(this.model,"tag_bookmarked",this.setTagBookmarkStatus)},render:function(){this.$el.html(this.getTemplate(this.template_id,{filter_placeholder:Lang["cat-cell-filter-placeholder"]}))},events:{"click .cmty-focus-tag-line .bkmk-icon":"onClickTagBookmark"},constructUrls:ComViews.CategoryCell.prototype.constructUrls,onAddToPage:function(){this.buildInputAutocomplete(),this.setTagBookmarkStatus()},onChangeFocusTag:function(){this.model.get("master").get("focus_category")===this.model&&(this.focus_tag=this.model.get("master").get("focus_tag"),this.setFocusTag())},buildInputAutocomplete:function(){var e=$('<input type="search" class="cmty-tag-search-input" placeholder="'+Lang["cat-cell-filter-placeholder"]+'"></input>'),t=this;this.hasOwnProperty("$input_box")?this.$input_box.parent().replaceWith(e):this.$focus_tag_box.append(e),this.$input_box=e,AoPS.Community.Views.buildTagAutocomplete({$input_box:this.$input_box,model:this.model,show_no_results_msg:!0,submitNewItem:function(e){t.submitNewItem(e)},has_search_icon:!0}),this.setFocusTag()},setTagBookmarkStatus:function(){var e;_.isNull(this.focus_tag)||this.model.get("is_private")||(this.tag_bookmark_state=this.model.get("master").fetchBookmarkStatus(this.focus_tag),e=this.$focus_tag_line.find(".bkmk-icon"),e.html(ComViews.makeBookmark(this.tag_bookmark_state)),e[0].title=this.tag_bookmark_state.is_bookmarked?Lang["remove-bookmarked-tag-tooltip"]:Lang["bookmark-tag-tooltip"])},onClickTagBookmark:function(){AoPS.session.logged_in?AoPS.isUserLimited()?Modal.showMessage(Lang["bookmark-limited-user"],{width:"450px"}):this.tag_bookmark_state.is_bookmarked?(this.model.get("master").removeTagBookmark(_.defaults(this.tag_bookmark_state,this.focus_tag)),this.model.trigger("tag_bookmarked"),this.setTagBookmarkStatus()):ComViews.fireBookmarkModal("tag",Utils.formatString(Lang["bookmark-modal-tag"],[this.focus_tag.item_text,this.model.get("category_name")]),_.bind(function(e){"forum"===this.model.get("category_type")&&(this.focus_tag.item_category_name=this.model.get("category_name")),this.model.get("master").addTagBookmark({item:_.defaults(e,this.focus_tag)}),this.model.trigger("tag_bookmarked")},this)):AoPS.Ui.buildLoginConfirm(Lang["bookmark-not-logged-in"])},setFocusTag:function(){var e;this.$el.find(".cmty-focus-tag-line").empty(),null!=this.focus_tag?(this.tag_colors={main_color:this.focus_tag.item_main_color,secondary_color:this.focus_tag.item_secondary_color},e="<a "+this.push_state_attribute+' href="'+ComViews.makeLinkUrl(this.url,this.url_router_base+this.url_cmty_path)+'"><div class="cmty-item-tag focused">'+this.focus_tag.item_text+' </div></a><div class="bkmk-icon clickable"></div>'):e="",this.$focus_tag_line.append($($.parseHTML(e))),this.setTagBookmarkStatus(),null!=this.focus_tag&&(this.$focus_tag_line.find(".cmty-item-tag").css({border:"1px solid "+this.tag_colors.main_color,"background-color":this.tag_colors.secondary_color,color:this.tag_colors.main_color}),this.$focus_tag_line.find(".bkmk-icon").css({color:this.tag_colors.main_color}))},submitNewItem:function(e){var t=this;this.model.addItem({item_id:parseInt(e.item_id),item_type:"tag",item_forum_id:this.model.get("category_id"),item_text:e.value,item_main_color:e.main_color,item_secondary_color:e.secondary_color}),setTimeout(function(){t.$input_box.autocomplete("disable"),t.$input_box.autocomplete("enable"),Backbone.history.navigate(t.url_cmty_path+"/c"+t.model.get("category_id")+"t"+e.item_id+"f"+e.item_forum_id,{trigger:!0})},100),this.$input_box.val("")}}),ComViews.category_cell_category_top_new_properties_view_forums=_.defaults({className:ComViews.CategoryCellForumView.prototype.className+" cmty-view-folder-top cmty-category-cell-view-forums",use_own_color:!1,can_bookmark:!1},ComViews.category_cell_category_top_new_properties),ComViews.category_cell_category_top_new_properties_view_topics=_.defaults({has_bottom:!1,className:ComViews.CategoryCell.prototype.className+"  cmty-folder-top cmty-flat-top ",use_own_color:!1,has_help:!0,help_template:"#cmty-view_topics-help-tpl",help_template_title_setting:"cat-cell-view_topics-help-title",can_bookmark:!1,onAddToPage:function(){$("#community-all").addClass("cmty-view-topics-page")},onRemoveFromPage:function(){$("#community-all").removeClass("cmty-view-topics-page")}},ComViews.category_cell_category_top_new_properties),ComViews.category_cell_category_top_new_properties_view_tags=_.defaults({className:ComViews.CategoryCell.prototype.className+" cmty-folder-top cmty-flat-top",help_template:"#cmty-view_tags-help-tpl",help_template_title_setting:"cat-cell-view_tags-help-title",has_help:!0,use_own_color:!1},ComViews.category_cell_category_top_new_properties),ComViews.CategoryCellCategoryTop=ComViews.CategoryCell.extend(ComViews.category_cell_category_top_new_properties),ComViews.CategoryCellCategoryTopViewTags=ComViews.CategoryCell.extend(ComViews.category_cell_category_top_new_properties_view_tags),ComViews.CategoryCellCategoryTopMyPrivates=ComViews.CategoryCellMyPrivates.extend(ComViews.category_cell_category_top_new_properties),ComViews.CategoryCellCategoryTopViewForums=ComViews.CategoryCell.extend(ComViews.category_cell_category_top_new_properties_view_forums),ComViews.CategoryCellCategoryTopViewTopics=ComViews.CategoryCellTopicView.extend(ComViews.category_cell_category_top_new_properties_view_topics),ComViews.CategoryCellCategoryTopUserSearchPosts=AoPS.View.extend({template_id:"#cmty-user-search-posts-top-tpl",className:"cmty-folder-top",initialize:function(){this.$el.html(this.getTemplate(this.template_id,{category_name:this.model.get("category_name"),url:"/community/u"+this.model.get("user_id")}))}}),ComViews.CategoryCellCategoryTopSearch=AoPS.View.extend({template_id:"#cmty-search-results-top-tpl",className:"cmty-folder-top cmty-search-results",initialize:function(){var e=this.model.get("search_settings").hasOwnProperty("search_text"),t=e?this.model.get("search_settings").search_text:"",o=e?encodeURIComponent(t):"",i=this.model.has("search_page_id"),s=i?"/community/edit-search/"+this.model.get("search_id"):"";this.$el.html(this.getTemplate(this.template_id,{category_name:this.model.get("category_name"),search_text:Utils.formatString(Lang["search-results-title-with-text"],[t]),has_search_text:e,url:"/community/q"+this.model.get("search_id"),encoded_search_text:o,can_edit:i,edit_url:s,lang_edit_search:Lang["search-results-edit"],lang_search_placeholder:Lang["main-crumb-search-placeholder"]}))},events:{"keydown input":"onKeyDownSearch","click .cmty-search-bar-icon":"onClickSearchIcon"},onClickSearchIcon:function(e){var t=$.trim(this.$("input").val());Backbone.history.navigate("/search/"+encodeURIComponent(t),{trigger:!0}),this.$("input").val("")},onKeyDownSearch:function(e){var t,o=e.which||e.keyCode;13===o&&(t=e.currentTarget.value,t.length>0&&(Backbone.history.navigate("/search/"+encodeURIComponent(e.currentTarget.value),{trigger:!0}),e.currentTarget.value=""))}}),ComViews.Folder=AoPS.View.extend({template_id:"#cmty-folder-top-tpl",className:"cmty-folder-top",has_header:!0,has_subheader:!1,own_url:"",has_own_url:!1,has_info:!0,initialize:function(){var e=this.model.get("category_id")>0,t="none"!==this.model.get("can_add_type")&&this.model.get("master").fetchPermission("can_create_category");this.model.get("category_type");this.url=this.has_own_url?this.own_url:"/c"+this.model.get("category_id")+"_"+ComViews.convertToUrlFragment(this.model.get("category_name")),this.url_info=e?"/category-admin/"+this.model.get("category_id"):"",this.$nothing_here=$('<div class="cmty-folder-empty">'+Lang["folder-empty-"+this.model.get("category_type")]+"</div>"),this.$el.html(this.getTemplate(this.template_id,{can_add:t,can_add_title:t?Lang.Create+" new "+this.model.get("can_add_type"):"",has_header:this.has_header,has_pdf:!1,lang_pdf:Lang["view-pdf-tooltip"],category_id:this.model.get("category_id"),has_subheader:this.has_subheader,url:ComViews.makeLinkUrl(this.url),category_name:this.model.get("category_name"),short_description:this.model.get("short_description"),subheader:this.model.get("long_description"),long_description:this.model.get("long_description"),has_info:this.has_info,has_jump_to_top:!0,lang_information:Utils.capitalizeFirstLetter(Lang.information)})),this.$category_heading=this.$el.find(".cmty-category-cell-heading"),this.has_header&&this.applyColor(),this.cat_box_holder=this.$el.find(".cmty-folder-grid-container"),this.cat_boxes=[],this.start_item_index=0,this.$loader=AoPS.Page.buildLoader(),this.constructItems(),this.onFinishConstructingItems(),this.start_item_index<8&&!this.model.get("all_subcategories_loaded")&&this.fetchMoreCategories(),this.setScrollListener(),0===this.model.get("items").length&&this.$el.append(this.$nothing_here),this.listenTo(this.model,"item_removed",this.onRemoveItem),"bookmark_forums"===this.model.get("category_type")&&this.listenTo(this.model,"item_added",this.onAddItem)},events:{"click .cmty-cat-cell-cat-info":"onClickInfo","click .cmty-add-new-category":"onClickAddNew","click .cmty-cat-cell-jump-top":"onClickJumpTop","click .cmty-small-category-heading":"onClickHeading"},onClickJumpTop:function(e){window.scrollTo(0,0),e.stopPropagation(),e.preventDefault()},onClickHeading:function(e){$(window).width()<=Constants.phone_mode_max_width&&this.onClickJumpTop(e)},onClickAddNew:ComViews.CategoryCell.prototype.onClickAddNew,setScrollListener:function(){var e=this;this.model.get("all_subcategories_loaded")||$(window).on("scroll."+this.model.cid+" touchmove."+this.model.cid,function(t){window.innerHeight+window.pageYOffset+10>=document.body.offsetHeight&&(e.model.get("loading_subcategories")||e.model.get("all_subcategories_loaded")||e.fetchMoreCategories())})},stopScrollListener:function(){$(window).off("scroll."+this.model.cid+" touchmove."+this.model.cid)},onRemoveItem:function(e){var t,o=null,i=this.cat_boxes.length;if(e.hasOwnProperty("category")){for(t=0;i>t;t++)if(this.cat_boxes[t].model===e.category){o=this.cat_boxes[t];break}_.isNull(o)||(this.cat_boxes=_.without(this.cat_boxes,o),o.close(),this.start_item_index--),0===this.cat_boxes.length&&this.$el.append(this.$nothing_here)}},onAddItem:function(e){var t;t=this.model.get("master").fetchCategory(e.item_id),_.isUndefined(t)||this.addCategoryBox(t)},constructItems:function(){var e,t,o,i=this.model.get("items"),s=i.length;for(s>0&&this.$nothing_here.detach(),e=this.start_item_index;s>e&&(t=i[e],t.hasOwnProperty("category"));e++)o=t.category,this.addCategoryBox(o)},onFinishConstructingItems:function(){},addCategoryBox:function(e){var t;this.start_item_index++,e.getPermission("c_can_read")&&(t=new(ComViews.fetchCategoryCellConstructor(e.get("category_type")))({model:e}),this.cat_boxes.push(t),this.cat_box_holder.append(t.$el))},fetchMoreCategories:function(){var e=this;this.cat_box_holder.append(this.$loader),this.listenToOnce(this.model,"subcategories_loaded",function(){var t=$(window).scrollTop();e.$loader.detach(),e.constructItems(),window.scrollTo(0,t)}),this.model.fetchMoreCategoryItems({start_idx:this.start_item_index})},onClose:function(){_.each(this.cat_boxes,function(e){e.close()})},onAddToPage:function(){_.each(this.cat_boxes,function(e){"function"==typeof e.onAddToPage&&e.onAddToPage()}),this.cat_boxes.length<Constants.max_forums_user_update&&!_.isUndefined(_.findWhere(this.model.get("items"),{item_type:"forum"}))&&this.model.startUsersMonitoring(),this.setScrollListener()},onClickInfo:function(e){ComViews.followUrlOnClick(e,this.url_info)},onRemoveFromPage:function(){this.model.stopUsersMonitoring(),this.stopScrollListener(),_.each(this.cat_boxes,function(e){"function"==typeof e.onRemoveFromPage&&e.onRemoveFromPage()})},applyColor:function(){var e=this.model.get("main_color");this.$el.find(".cmty-category-cell-heading").css({color:e}),this.$el.find(".cmty-category-cell-title").css({color:e})}}),ComViews.HeadlessFolder=ComViews.Folder.extend({has_header:!1}),ComViews.FolderMyBookmarks=ComViews.Folder.extend({has_own_url:!0,has_subheader:!0,own_url:"/my-bookmarks",has_info:!1}),ComViews.FolderMyForums=ComViews.Folder.extend({has_own_url:!0,has_subheader:!0,own_url:"/my-forums",onClickInfo:function(e){return 0===this.model.get("category_id")?void AoPS.Ui.Modal.showAlert(Lang["user-profile-no-my-forums"],{width:"450px"}):void ComViews.Folder.prototype.onClickInfo.apply(this,[e])}}),ComViews.FolderMyCollections=ComViews.Folder.extend({has_own_url:!0,has_subheader:!0,own_url:"/my-collections",onClickInfo:function(e){return 0===this.model.get("category_id")?void AoPS.Ui.Modal.showAlert(Lang["user-profile-no-my-collections"],{width:"450px"}):void ComViews.Folder.prototype.onClickInfo.apply(this,[e])}}),ComViews.FolderMyBlogs=ComViews.Folder.extend({has_own_url:!0,has_subheader:!0,own_url:"/my-blogs",onClickInfo:function(e){return 0===this.model.get("category_id")?void AoPS.Ui.Modal.showAlert(Lang["user-profile-no-my-blogs"],{width:"450px"}):void ComViews.Folder.prototype.onClickInfo.apply(this,[e])}}),ComViews.MyAoPSTop=AoPS.View.extend({template_id:"#cmty-my-aops-top-tpl",id:"cmty-my-aops-top",initialize:function(){var e=this,t=[{class_stub:"profile",url:"/my-aops"},{class_stub:"bookmarks",url:"/my-bookmarks"},{class_stub:"messages",url:"/my-messages"},{class_stub:"my-forums",url:"/my-forums"},{class_stub:"my-collections",url:"/my-collections"},{class_stub:"my-blogs",url:"/my-blogs"}];this.render(),_.each(t,function(t){e.$(".cmty-my-aops-"+t.class_stub+"-btn").on("click",function(e){ComViews.followUrlOnClick(e,t.url)})}),this.listenTo(this.model.get("current_user"),"change:location",this.onChangeLocation)},events:{},render:function(){var e,t=this.model.get("current_user");this.$el.html(this.getTemplate(this.template_id,{has_books:t.get("has_ebooks"),has_classes:t.get("has_classes"),location:t.get("location"),avatar:this.model.get("my_avatar"),username:AoPS.session.username,email:t.get("email"),lang_Edit_Settings:Lang["my-aops-Community-Settings"],lang_Edit_Profile:Lang["my-aops-Edit-Profile"],lang_Profile:Lang.Profile,lang_My_AoPS:Lang.MyAoPS,lang_Bookmarks:Lang.Bookmarks,lang_Messages:Lang.Messages,lang_My_Forums:Lang["my-aops-MyForums"],lang_My_Collections:Lang["my-aops-MyCollections"],lang_My_Blogs:Lang["my-aops-MyBlogs"],lang_My_Books:Lang["my-aops-MyBooks"],lang_My_Classes:Lang["my-aops-MyClasses"],lang_phone_PM:Lang["my-aops-phone-PM"],lang_phone_Bkmk:Lang["my-aops-phone-Bkmk"],lang_phone_Fora:Lang["my-aops-phone-Fora"],lang_phone_Coll:Lang["my-aops-phone-Coll"],lang_phone_Blogs:Lang["my-aops-phone-Blogs"]})),this.$messages_btn=this.$(".cmty-my-aops-messages-btn"),e=this.model.fetchCategory(1),this.private_messages_topics=e.get("active_topics"),this.listenTo(this.private_messages_topics,"change:is_read add remove",this.markMessagesReadStatus),this.markMessagesReadStatus()},onChangeLocation:function(){this.$(".cmty-my-aops-top-data-left > .cmty-my-aops-data-middle").text(this.model.get("current_user").get("location"))},markMessagesReadStatus:function(){this.$messages_btn.toggleClass("cmty-messages-btn-unread",!_.isUndefined(this.private_messages_topics.findWhere({is_read:!1})))}}),ComViews.AoPSCollectionTop=AoPS.View.extend({template_id:"#cmty-header-box-logged-in-tpl",className:"header-box community-background-color",initialize:function(){this.$el.append(this.getTemplate(this.template_id,{username:AoPS.session.username,is_logged_in:AoPS.session.logged_in,avatar:this.model.get("my_avatar"),user_id:AoPS.session.user_id,lang_Community:Lang.Community,lang_Welcome:Lang.Welcome,lang_MyAoPS:Lang.MyAoPS,lang_Bookmarks:Lang.Bookmarks,lang_Conversations:Lang.Messages,lang_search_placeholder:Lang["main-crumb-search-placeholder"],lang_advanced_search:Lang["main-crumb-advanced-search"]}))},events:{"keydown input":"onKeyDownSearch","click .cmty-search-bar-icon":"onClickSearchIcon"},onClickSearchIcon:ComViews.CategoryCellCategoryTopSearch.prototype.onClickSearchIcon,onKeyDownSearch:ComViews.CategoryCellCategoryTopSearch.prototype.onKeyDownSearch}),ComViews.LimitedUserMessage=AoPS.View.extend({initialize:function(){this.$el.html(this.getTemplate("#cmty-limited-user-msg-tpl",{username:AoPS.session.username}))}}),ComViews.Announcement=AoPS.View.extend({className:"cmty-home-announce",initialize:function(e){this.$el.html(this.getTemplate("#cmty-announcement-tpl",{content:e.content}))}}),ComViews.AoPSMasterCollection=ComViews.HeadlessFolder.extend({has_extra_box:!0,on_page:!1,events:_.extend({"click .cmty-whois-user-toggle":"onClickUserEllipsis"},ComViews.Folder.prototype.events),onAddToPage:function(){ComViews.Folder.prototype.onAddToPage.apply(this),this.reset_whois&&this.fillWhoIsOnline(),this.on_page=!0},onRemoveFromPage:function(){ComViews.Folder.prototype.onRemoveFromPage.apply(this),this.on_page=!1},constructItems:function(){var e,t,o,i,s=this.model.get("items"),a=AoPS.hasOwnProperty("preload_topics"),n=s.length,r=this;for(this.$extra_box=$('<div class="cmty-master-collection-extra-fora"></div>'),this.$extra_box.append('<div class="cmty-master-heading">'+Lang["master-other-forums"]+'<div class="cmty-help cmty-no-phone">?</div></div>'),this.$el.find(".cmty-folder-grid").append(this.$extra_box),t=this.start_item_index;n>t;t++){o=s[t];(new Date).getTime();o.hasOwnProperty("category")&&(this.start_item_index++,i=o.category,i.getPermission("c_can_read")&&(9===i.get("category_id")?(e=new ComViews.CategoryCellOtherForums({model:i}),r.$extra_box.append(e.$el)):12===i.get("category_id")?(e=new ComViews.CategoryCellSpecialCollections({model:i}),r.$extra_box.append(e.$el)):(e=new(ComViews.fetchCategoryCellConstructor(i.get("category_type")))({model:i,default_to_topics:a&&11!==i.get("category_id")&&13!==i.get("category_id")}),11===i.get("category_id")||13===i.get("category_id")?r.$extra_box.append(e.$el):r.cat_box_holder.append(e.$el)),r.cat_boxes.push(e)))}this.$extra_box.find(".cmty-help").on("click",function(){r.onClickExtraHelp()}),this.extra_help=this.getTemplate("#cmty-toplevel-extras-help-modal-tpl",{can_create_forums:this.model.get("master").fetchPermission("can_create_category")})},onFinishConstructingItems:function(){this.model.get("master").has("whois_data")&&(this.buildWhoIs(),AoPS.session.user_id>1&&this.listenTo(this.model.get("master").get("current_user"),"change:hidden",this.onChangeWhoisData))},buildWhoIs:function(){this.$whois_online=$('<div class="cmty-whois"></div>'),this.fillWhoIsOnline(),this.$el.find(".cmty-folder-grid").append(this.$whois_online),this.listenTo(this.model.get("master"),"change:whois_data",this.onChangeWhoisData),this.constructExtraNote()},constructExtraNote:function(){},onChangeWhoisData:function(){this.on_page?this.fillWhoIsOnline():this.reset_whois=!0},buildUser:function(e){var t="";return e.c%2===1&&(t="cmty-user-admin"),e.c>1&&(t+=" cmty-hidden-user"),t.length>0?'<a data-cmty class="'+t+'" href="/community/user/'+e.b+'">'+e.a+"</a>":'<a data-cmty href="/community/user/'+e.b+'">'+e.a+"</a>"},fillWhoIsOnline:function(){var e,t,o,i,s=this.model.get("master").get("whois_data"),a=this,n=s.user_data.shown_users.length,r=(Constants.num_users_whois_online,s.user_data.num_registered,!1),l=[],c=[];for(!AoPS.session.logged_in||this.model.get("master").get("current_user").get("hidden")&&!AoPS.session.a||l.push(a.buildUser({a:AoPS.session.username,b:AoPS.session.user_id,c:(AoPS.session.a?1:0)+(this.model.get("master").get("current_user").get("hidden")?2:0)})),t=0;n>t;t++)o=s.user_data.shown_users[t],AoPS.session.user_id!==o.b?(i=this.buildUser(o),l.push(i)):AoPS.session.logged_in&&(r=!0);AoPS.session.logged_in&&!r&&(s.user_data.num_total=parseInt(s.user_data.num_total)+1,s.user_data.num_registered=parseInt(s.user_data.num_registered)+1),this.$whois_online.html(this.getTemplate("#cmty-whois-content-tpl",{whois_heading:Lang["master-whois-title"],whois_users:Lang["master-registered-online"],memberlist_link:Lang["master-whois-memberlist-link"],FAQ_link:Lang["master-whois-FAQ-link"],whois_top_data:Utils.formatString(Lang["master-whois-dataline"],[Utils.renderNumberWithCommas(s.user_data.num_total),Utils.renderNumberWithCommas(s.user_data.num_registered),Utils.renderNumberWithCommas(s.user_data.num_hidden)]),stats_heading:Lang["master-statistics-title"],stats_data:Utils.formatString(Lang["master-statistics-data"],[Utils.renderNumberWithCommas(s.num_posts),Utils.renderNumberWithCommas(s.num_topics),Utils.renderNumberWithCommas(s.num_users)])})),e=this.$whois_online.find(".cmty-whois-users"),this.$hidden_users=e.find(".cmty-whois-hidden-users"),e.append(l.join(", ")),this.$hidden_users.append(c.join(", ")),e.append(this.$hidden_users),this.reset_whois=!1},onClickUserEllipsis:function(e){this.$whois_online.find("a.cmty-whois-user-toggle").hide(),this.$hidden_users.show()},onClickExtraHelp:function(e){Modal.showMessage(this.extra_help,{title:Lang["master-collections-modal-title"],width:"450px"})},attachCategories:function(){var e,t=this;this.$extra_box=$('<div class="cmty-master-collection-extra-fora"></div>'),this.$extra_box.append("<br>"),this.$el.find(".cmty-folder-grid").append(this.$extra_box),_.each(this.model.get("items"),function(o){var i;o.hasOwnProperty("category")&&(i=o.category,i.getPermission("c_can_read")&&(e=new(ComViews.fetchCategoryCellConstructor(i.get("category_type")))({model:i}),i.get("category_id")<=8?t.cat_box_holder.append(e.$el):t.$extra_box.append(e.$el),t.cat_boxes.push(e)))})}}),ComViews.AoPSPortal=ComViews.AoPSMasterCollection.extend({has_header:!0,has_info:!1,constructItems:function(){var e,t,o,i,s=this.model.get("items"),a=AoPS.hasOwnProperty("preload_topics"),n=s.length,r=this;for(this.$featured_content=$('<div class="cmty-master-collection-extra-fora cmty-portal-featured"></div>'),this.$featured_content.append('<div class="cmty-master-heading">'+Lang["master-featured-content"]+'<div class="cmty-help">?</div></div>'),this.$el.find(".cmty-folder-grid").append(this.$featured_content),this.$extra_box=$('<div class="cmty-master-collection-extra-fora"></div>'),this.$extra_box.append('<div class="cmty-master-heading">'+Lang["portal-extra-content"]+'<div class="cmty-help">?</div></div>'),this.$el.find(".cmty-folder-grid").append(this.$extra_box),t=this.start_item_index;n>t;t++)o=s[t],o.hasOwnProperty("category")&&(this.start_item_index++,i=o.category,i.getPermission("c_can_read")&&(9===i.get("category_id")?(e=new ComViews.CategoryCellOtherForums({model:i}),r.$extra_box.append(e.$el)):12===i.get("category_id")?(e=new ComViews.CategoryCellSpecialCollections({model:i}),r.$extra_box.append(e.$el)):e=new(ComViews.fetchCategoryCellConstructor(i.get("category_type")))({model:i,default_to_topics:a&&(6===i.get("category_id")||7===i.get("category_id"))}),90===i.get("category_id")||91===i.get("category_id")?this.$featured_content.append(e.$el):6===i.get("category_id")||7===i.get("category_id")?r.cat_box_holder.append(e.$el):this.$extra_box.append(e.$el),r.cat_boxes.push(e)));this.$featured_content.find(".cmty-help").on("click",function(){r.onClickFeaturedHelp()}),this.featured_content_help=this.getTemplate("#cmty-featured-content-help-tpl"),this.$extra_box.find(".cmty-help").on("click",function(){r.onClickExtraHelp()}),this.extra_help=this.getTemplate("#cmty-portal-special-views-help-tpl")},onClickFeaturedHelp:function(){Modal.showMessage(this.featured_content_help,{title:Lang["portal-featured-help-title"],width:"450px"})},onClickExtraHelp:function(){Modal.showMessage(this.extra_help,{title:Lang["portal-extra-help-title"],width:"450px"})},constructExtraNote:function(){this.$el.append('<div class="cmty-portal-extra">'+Lang["portal-extra-note"]+(AoPS.session.logged_in?Lang["portal-extra-logged-in"]:"")+"</div>")}}),ComViews.ViewPosts=AoPS.View.extend({
template_id:"#cmty-folder-top-tpl",className:"cmty-folder-top",initialize:function(){var e=this,t=this.model.get("short_description").length>0;this.url=this.has_own_url?this.own_url:"/c"+this.model.get("category_id")+"_"+ComViews.convertToUrlFragment(this.model.get("category_name")),this.has_label_column=this.hasLabel(),this.url_info="/category-admin/"+this.model.get("category_id"),this.$el.html(this.getTemplate(this.template_id,{has_header:!0,category_name:this.model.get("category_name"),can_add:!1,category_id:this.model.get("category_id"),has_info:!0,has_pdf:!0,lang_pdf:Lang["view-pdf-tooltip"],has_subheader:t,subheader:this.model.get("short_description"),url:ComViews.makeLinkUrl(this.url),lang_information:Utils.capitalizeFirstLetter(Lang.information)})),this.item_views=[],this.$posts_box=this.$(".cmty-folder-grid-container"),_.each(this.model.get("items"),function(t){e.addItem(t)}),0===this.model.get("items").length&&this.$el.append('<div class="cmty-folder-empty">'+Lang["folder-empty-view_posts"]+"</div>"),this.applyColor()},events:{"click .cmty-cat-cell-cat-info":"onClickInfo"},applyColor:function(){var e=this.model.get("main_color");this.$el.find(".cmty-category-cell-heading").css({color:e}),this.$el.find(".cmty-category-cell-title").css({color:e})},onClickInfo:ComViews.Folder.prototype.onClickInfo,addItem:function(e){var t=new AoPS.Community.Views.ViewPostsItem({item:e,model:this.model,has_label_column:this.has_label_column});this.item_views.push(t),this.$posts_box.append(t.$el)},hasLabel:function(){var e=_.find(this.model.get("items"),function(e){return"post"===e.item_type&&e.item_text.length>0});return!_.isUndefined(e)},onClose:function(){_.each(this.item_views,function(e){e.close()})}}),ComViews.ViewPostsItem=AoPS.View.extend({template_id:"#cmty-view-posts-item-tpl",hidden_template_id:"#cmty-view-posts-item-hidden-tpl",className:"cmty-view-posts-item",initialize:function(e){var t=e.item,o="post_hidden"===t.item_type,i=o?this.hidden_template_id:this.template_id,s="view_posts_text"!==t.post_data.post_type,a=o&&e.has_label_column||t.item_text.length>0;o&&0===t.item_text.length&&(t.item_text=Lang["view-posts-click-hidden"]),s?this.url="/c"+t.post_data.category_id+"h"+t.post_data.topic_id+"p"+t.item_id:this.url="",this.$el.html(this.getTemplate(i,{has_label:a,label:t.item_text,has_poster:s,poster_avatar:t.post_data.poster_avatar,poster_username:t.post_data.username,post:t.post_data.post_rendered,view_topic_text:Lang["view-posts-view-topic"],url:this.url})),a&&!o&&this.$el.addClass("cmty-view-post-item-w-label"),o&&(this.$hidden_content=this.$(".cmty-post-item-hidden-content"),this.$("a.cmty-hide-heading").remove(),this.$(".cmty-hide-content").css({display:"inline-block"}).removeClass("cmty-hide-content")),a?s?this.$el.addClass("cmty-vp-both"):this.$el.addClass("cmty-vp-left"):s&&this.$el.addClass("cmty-vp-right")},events:{"click .cmty-post-item-hidden-bar":"onClickHiddenBar","click .cmty-view-post-poster":"onClickPost"},onClickHiddenBar:function(){this.$el.toggleClass("cmty-view-posts-item-reveal")},onClickPost:function(e){this.url.length>0&&ComViews.followUrlOnClick(e,this.url)}}),ComViews.BasicCategoryTitleBar=AoPS.View.extend({template_id:"#cmty-category-basic-title-tpl",className:"cmty-category-cell",initialize:function(){var e=this.model.get("main_color");this.model.get("secondary_color");this.url=this.has_own_url?this.own_url:"/c"+this.model.get("category_id")+"_"+ComViews.convertToUrlFragment(this.model.get("category_name")),this.$el.html(this.getTemplate(this.template_id,{category_name:this.model.get("category_name"),short_description:this.model.get("short_description"),url:AoPS.Community.Views.makeLinkUrl(this.url)})),this.$category_heading=this.$el.find(".cmty-category-cell-heading"),this.$category_heading.css({"background-color":e,color:"#fff"})},events:{"mouseenter .cmty-full-cell-link":"onHoverHeading","mouseleave .cmty-full-cell-link":"onUnhoverHeading","click .cmty-category-cell-heading":"onClickHeading"},onClickHeading:ComViews.Folder.prototype.onClickHeading,onHoverHeading:ComViews.category_cell_category_top_new_properties.onHoverHeading,onUnhoverHeading:ComViews.category_cell_category_top_new_properties.onUnhoverHeading}),ComViews.PostingEnviron=AoPS.View.extend({template_id:"#cmty-posting-frame-tpl",className:"cmty-posting-environ",has_bbcode_buttons:!0,is_new_pm:!1,has_email_subscribe:!0,has_add_to_feed:!0,sending_blocker:Lang["new-topic-send-blocker"],initialize:function(e){var t=this;this.settings=e,this.is_bbcode_enabled=!0,this.settings.hasOwnProperty("has_add_to_feed")&&(this.has_add_to_feed=this.settings.has_add_to_feed),this.settings.hasOwnProperty("has_email_subscribe")&&(this.has_email_subscribe=this.settings.has_email_subscribe),_.extend(this,{submenus:{},is_building_subwindow:!1,is_previewing:!1,is_preview_processing:!1,extra_options:{}}),this.has_poll=!1,this.attachments=[],this.render(),this.allow_latex_errors=!1,this.$posting_buttons=this.$el.find(".cmty-bbcode-buttons"),this.$post_box=this.$el.find(".cmty-post-textarea"),this.$title_box=this.$el.find(".cmty-subject-input"),this.$preview_box=this.$el.find(".cmty-post-preview"),this.$preview_text=this.$el.find(".cmty-post-preview-text"),this.$preview_button=this.$el.find(".cmty-preview-button"),this.$submit_button=this.$el.find(".cmty-submit-button"),this.$el.find(".cmty-post-preview").append(AoPS.Community.Views.buildCommunityScrollbar(this.$preview_text)),this.$loader=AoPS.Page.buildLoader(),this.has_bbcode_buttons&&(this.constructBbCodeButtons(),this.styleAttachmentsButton()),this.$active_submenu_button=null,this.$el.on("keydown",function(e){var o=e.which||e.keyCode;13===o&&(e.ctrlKey||e.metaKey)&&t.submitPost()}),this.settings.hasOwnProperty("preset_extra_options")&&_.each(_.keys(this.settings.preset_extra_options),function(e){(t.has_email_subscribe||"notify_email"!==e)&&(t.has_add_to_feed||"bookmark_feed"!==e)&&(t.extra_options[e]=t.settings.preset_extra_options[e])}),this.setPreviewButton(),"string"==typeof e.content&&e.content.length>0&&this.addContent(e.content)},isLatexError:function(e){return"E_LATEX_ERROR"===e||"E_ASY_ERROR"===e},throwLatexErrorMessage:function(e){var t=this;Modal.showConfirm(Utils.formatString(Lang["error-latex-posting-confirm"],["E_LATEX_ERROR"===e?"LaTeX":"Asymptote"]),function(e){e?(t.allow_latex_errors=!0,Modal.closeTopModal(),t.submitPost()):(Modal.closeTopModal(),Modal.closeTopModal(),t.$post_box.focus())},{confirm_button_cancel:Lang["error-latex-i-will-fix"],confirm_button_ok:Lang["error-latex-post-anyway"],width:"450px",closeX:!1,force_response:!0,close_on_button_click:!1})},constructBbCodeButtons:function(){var e=this,t=[{button_class:"cmty-bbcode-other",onClick:function(t){e.showSubMenu(t,"extra_options")},is_bbcode:!1},{button_class:"cmty-bbcode-bold",title:Lang["bbcode-title-bold"],stub:"b"},{button_class:"cmty-bbcode-underline",stub:"u",title:Lang["bbcode-title-underline"]},{button_class:"cmty-bbcode-italic",stub:"i",title:Lang["bbcode-title-italic"]},{button_class:"cmty-bbcode-text-size",stub:"size",title:Lang["bbcode-title-text-size"],onClick:function(t){e.showSubMenu(t,"font_size")}},{button_class:"cmty-bbcode-text-color",stub:"color",title:Lang["bbcode-title-text-color"],onClick:function(t){e.showSubMenu(t,"font_color")}},{button_class:"cmty-bbcode-quote",title:Lang["bbcode-title-quote"],stub:"quote"},{button_class:"cmty-bbcode-hide",title:Lang["bbcode-title-hide"],stub:"hide"},{button_class:"cmty-bbcode-code",title:Lang["bbcode-title-code"],stub:"code"},{button_class:"cmty-bbcode-smiley",title:Lang["bbcode-title-smiley"],onClick:function(t){e.showSubMenu(t,"smiley")}},{button_class:"cmty-bbcode-img",title:Lang["bbcode-title-img"],stub:"img"},{button_class:"cmty-bbcode-url",title:Lang["bbcode-title-url"],stub:"url"},{has_permission:this.settings.master.fetchPermission("can_attach_files"),button_class:"cmty-bbcode-attachment",title:Lang["bbcode-title-attachment"],is_bbcode:!1,onClick:function(){e.openAttachmentPanel()}},{button_class:"cmty-bbcode-poll",title:Lang["bbcode-title-poll"],onClick:function(){e.togglePoll()},is_bbcode:!1}];_.each(t,function(t){var o;(!t.hasOwnProperty("has_permission")||t.has_permission)&&(("boolean"!=typeof t.is_bbcode||t.is_bbcode)&&(t.button_class+=" cmty-is-bbcode"),o=$("<div/>",{"class":t.button_class+" clickable cmty-bbcode-btn",title:t.hasOwnProperty("title")?t.title:""}),o.data("button_settings",t),o.on("click",function(i){("boolean"==typeof t.is_bbcode&&!t.is_bbcode||e.is_bbcode_enabled)&&(t.hasOwnProperty("onClick")?t.onClick(o):t.hasOwnProperty("stub")&&e.applyBbCode(t))}),e.$posting_buttons.append(o))})},events:{"click .cmty-posting-preview-bar":"previewPost","click .cmty-submit-button":"submitPost","keyup .cmty-post-textarea":"onPostKeypress","click .cmty-cancel-button,.cmty-cancel-posting-x":"onClickCancel","click .cmty-refresh-preview":"generatePreview",click:"onAnyClick","keydown .cmty-subject-input":"onSubjectKeypress",'change [name="cmty-post-extra-disable-bbcode"]':"onClickDisableBbCode","click .cmty-poll-cancel-btn":"onClickCancelPoll","click .cmty-preview-bar-attachments":"onClickPreviewBarAttachments"},onClickDisableBbCode:function(e){this.$el.toggleClass("cmty-bbcode-disabled",e.currentTarget.checked),this.is_bbcode_enabled=!e.currentTarget.checked},onClickPreviewBarAttachments:function(e){e.stopPropagation(),e.preventDefault()},onAnyClick:function(){this.hasOwnProperty("$submenu")&&!this.is_building_subwindow&&(this.$submenu.detach(),this.$active_submenu_button=null),this.is_building_subwindow=!1},onSubjectKeypress:function(){},onPostKeypress:function(){},setPreviewButton:function(){this.$preview_button.toggle(this.$post_box.val().length>8)},onClickClosePreview:function(){this.settings.hasOwnProperty("onClosePreview")&&this.settings.onClosePreview(),this.setHeight()},onClickPreviewBarAttachments:function(e){e.stopPropagation(),e.preventDefault(),this.openAttachmentPanel()},openAttachmentPanel:function(){this.hasOwnProperty("attachments_view")||(this.attachments_view=new ComViews.PostingAttachments({model:this.settings.master,parent_view:this})),this.attachments_view.show()},processAttachments:function(e){var t=e.dropzone,o=e.existing_attachments,i=this;this.attachments=[],_.each(o,function(e){i.attachments.push({url:e.url,existing:1,name:e.name})}),_.each(t.files,function(e){i.attachments.push({tmp_name:e.tmp_name,existing:0,name:e.name})}),this.styleAttachmentsButton()},styleAttachmentsButton:function(){var e,t=this.$(".cmty-bbcode-attachment");0!=t.length&&(0==this.attachments.length?(e=Lang["bbcode-title-attachment"],this.$el.removeClass("cmty-posting-with-attachments")):(e=Lang["bbcode-title-has-attachments"],this.$el.addClass("cmty-posting-with-attachments"),_.each(this.attachments,function(t){e+="\n  "+t.name})),t[0].title=e)},setHeight:function(){},applyBbCode:function(e){var t,o,i;o=this.$post_box.scrollTop(),t="["+e.stub,e.hasOwnProperty("secondary")&&(t+="="+e.secondary),t+="]",i="[/"+e.stub+"]",this.wrapTextareaSelection(t,i),this.$post_box.scrollTop(o)},showSubMenu:function(e,t){var o=this.$post_box[0].selectionStart,i=this.$post_box[0].selectionEnd;return this.is_building_subwindow=!1,this.$post_box[0].setSelectionRange(o,i),e===this.$active_submenu_button?void this.onAnyClick():(this.onAnyClick(),this.is_building_subwindow=!0,this.submenus.hasOwnProperty(t)||(this.submenus[t]=this.createSubMenu(e,t)),this.$posting_buttons.append(this.submenus[t]),this.$submenu=this.submenus[t],void(this.$active_submenu_button=e))},addContent:function(e){this.wrapTextareaSelection(e,"")},createSubMenu:function(e,t){var o,i,s,a=$('<div class="cmty-posting-submenu"></div>'),n=e.position(),r=this,l=!1;switch(t){case"font_color":a.addClass("cmty-posting-submenu-font-color"),_.each(Constants.bbCode.font_colors,function(t){var o;o=$('<div class="cmty-posting-font-color-swatch"></div>').css({"background-color":t}).on("click",function(){r.applyBbCode(_.extend(e.data("button_settings"),{secondary:t}))}),a.append(o)});break;case"smiley":a.addClass("cmty-posting-submenu-smileys"),s=$('<div class="cmty-posting-smiley-holder"></div>'),_.each(Constants.bbCode.smileys,function(e){var t;t=$('<img src="/assets/images/smilies/'+e[1]+'" alt="'+e[0]+'" title="'+e[0]+'" class="bbcode_smiley">'),t.on("click",function(){r.replaceTextareaSelection(" "+e[0]+" ")}),s.append(t)}),a.append(AoPS.Community.Views.buildCommunityScrollbar(s));break;case"font_size":a.addClass("cmty-posting-submenu-sizes"),_.each(Constants.bbCode.font_sizes,function(t){var o=$('<div class="cmty-posting-font-size" style="font-size:'+t.size+'%">'+t.text+"</div>").on("click",function(){r.applyBbCode(_.extend(e.data("button_settings"),{secondary:t.size}))});a.append(o)});break;case"extra_options":a.addClass("cmty-posting-submenu-extras"),i=Constants.bbCode.extra_options,this.canSetAnnounce()&&(i=i.concat([{property:"is_local_announcement",text:Lang["post-environ-extra-announce"],class_id:"cmty-post-extra-local-announce"}]),l=!0),this.canSetGlobalAnnounce()&&(i=i.concat([{property:"is_global_announcement",text:Lang["post-environ-global-announce"],class_id:"cmty-post-extra-global-announce"}]),l=!0),_.each(i,function(e){var t,o;(r.has_email_subscribe||"notify_email"!==e.property)&&(r.has_add_to_feed||"bookmark_feed"!==e.property)&&(o=r.extra_options.hasOwnProperty(e.property)&&r.extra_options[e.property],t=$('<label><input name="'+e.class_id+'" type="checkbox"'+(o?" checked":"")+"> "+e.text+"</label><br>").on("click",function(t){r.is_building_subwindow=!0,r.extra_options[e.property]=t.target.checked}),a.append(t))}),l&&(this.$announce_through=$('<div class="cmty-posting-announce-extra">'+Lang["post-environ-announce-through"]+'<br><input type="text" class="cmty-posting-announce-through" placeholder="yyyy-mm-dd"></div>'),a.append(r.$announce_through),this.$announce_through.on("click",function(e){e.stopPropagation()}),o=r.$announce_through.find("input"),ComViews.makeAnnounceDateInput(r.$announce_through.find("input")))}return a.css({left:n.left+parseInt(e.css("margin-left")),top:n.top+e.height()}),a},togglePoll:function(){this.has_poll?this.onClickCancelPoll():this.showPoll()},showPoll:function(){this.hasOwnProperty("$poll")||this.createPoll(),this.$el.addClass("cmty-posting-with-poll"),this.has_poll=!0,this.setHeight(),this.$poll_question.focus()},hidePoll:function(){this.$el.removeClass("cmty-posting-with-poll"),this.has_poll=!1,this.setHeight()},createPoll:function(){var e;e={lang_poll_question:Lang["poll-question"],lang_poll_options:Lang["poll-options"],lang_poll_options_desc:Lang["poll-options-desc"],lang_options_per:Lang["poll-options-per"],lang_poll_length:Lang["poll-length"],lang_len_unlimited:Lang["poll-unlimited"],lang_len_1_day:Lang["poll-len-1-day"],lang_len_2_days:Lang["poll-len-2-days"],lang_len_3_days:Lang["poll-len-3-days"],lang_len_1_week:Lang["poll-len-1-week"],lang_len_2_weeks:Lang["poll-len-2-weeks"],lang_len_1_month:Lang["poll-len-1-month"],lang_revoting:Lang["poll-revoting"],No:Lang.No,Yes:Lang.Yes,lang_cancel_poll:Lang["poll-cancel"]},this.$poll=$(this.getTemplate("#cmty-poll-build-tpl",e)),this.$poll_question=this.$poll.find("input.cmty-poll-question"),this.$poll_inputs=this.$poll.find("textarea.cmty-poll-inputs"),this.$el.find(".cmty-posting-box-container").before(this.$poll),this.has_poll_built=!0},onClickCancelPoll:function(){var e=this;this.$poll_question.val().length>0||this.$poll_inputs.val().length>0?AoPS.Ui.Modal.showConfirm(Lang["poll-cancel-confirm"],function(t){t&&e.hidePoll()},{title:Lang["poll-cancel-title"],confirm_button_ok:Lang["poll-cancel"],confirm_button_cancel:Lang["poll-cancel-no"],width:"450px"}):this.hidePoll()},canSetAnnounce:function(){return!1},canSetGlobalAnnounce:function(){return!1},wrapTextareaSelection:function(e,t){var o,i=this.$post_box.val(),s=this.$post_box[0].selectionStart,a=this.$post_box[0].selectionEnd;o=i.slice(0,s)+e+i.slice(s,a)+t+i.slice(a),this.$post_box.val(o),this.$post_box.focus(),this.$post_box[0].setSelectionRange(s+e.length,a+e.length)},replaceTextareaSelection:function(e){var t,o=this.$post_box.val(),i=this.$post_box[0].selectionStart,s=this.$post_box[0].selectionEnd;t=o.slice(0,i)+e+o.slice(s),this.$post_box.val(t),this.$post_box.focus(),this.$post_box[0].setSelectionRange(i+e.length,i+e.length)},previewPost:function(){if(!this.is_preview_processing){if(this.is_previewing)return this.$el.removeClass("cmty-posting-previewing"),this.is_previewing=!1,clearInterval(this.preview_interval),void this.onClickClosePreview();this.openPreviewWindow(),this.generatePreview()}},openPreviewWindow:function(){this.is_previewing=!0,this.$el.addClass("cmty-posting-previewing"),this.setHeight(),this.settings.hasOwnProperty("onPreview")&&this.settings.onPreview()},generatePreview:function(e){var t,o=this;if(arguments.length>0&&e.stopPropagation(),!this.is_preview_processing){if(!Utils.cmty_ajax.ajax_active)return void ComViews.showErrorAtopAModal(Utils.is_cmty_asleep?Lang["community-asleep-save"]:Lang["ajax-error-E_AJAX_UNKNOWN"]);this.is_preview_processing=!0,0===this.$post_box.val().length||this.extra_options.hasOwnProperty("disable_bbcode")&&this.extra_options.disable_bbcode?this.revealPreview(this.$post_box.val().replace(/\r?\n/g,"<br />")):(t=this.$preview_text.html(),this.$preview_text.html(""),this.$preview_text.append(this.$loader),this.settings.master.parseBBCode({text:this.$post_box.val(),post_format:"bbcode",onFinish:function(e){o.revealPreview(e.rendered_text)},onAjaxFilter:function(){o.revealPreview(t)},onError:function(e){var t;t=o.checkCommonErrors(e.error_code),AoPS.Ui.Modal.showAlertQuick(t.message,{width:"400px"}),"close"===t.action?(o.revealPreview(""),o.onClickClosePreview()):"reveal_rendered"===t.action&&(o.revealPreview(e.response.error_data),o.onClickClosePreview())}}))}},checkCommonErrors:function(e){var t="",o="";switch(e){case"E_QUOTE_DEPTH":t=Lang["posting-quote-depth"],o="close";break;case"E_HIDE_DEPTH":t=Lang["posting-hide-depth"],o="close";break;case"E_NAUGHTY_TERM_USED":t=Lang["new-topic-banned-term"],o="close";break;case"E_INVALID_CHARACTER":t=Lang["new-topic-invalid-character"],o="close";break;case"E_LATEX_ERROR":t=Lang["posting-latex-error"],o="reveal_rendered";break;case"E_ASY_ERROR":t=Lang["posting-asy-error"],o="reveal_rendered";break;case"E_POST_TOO_SHORT":t=Lang["new-topic-post-too-short"],o="close";break;case"E_POST_TOO_LONG":t=Lang["new-topic-post-too-long"],o="close";break;case"E_POST_TOO_LONG_PYTHON":t=Lang["new-topic-post-too-long-python"],o="close";break;case"E_TOPIC_TITLE_TOO_SHORT":t=Lang["new-topic-title-too-short"],o="close";break;case"E_TOPIC_TITLE_TOO_LONG":t=Lang["new-topic-title-too-long"],o="close";break;case"E_NO_FLOODING":t=Lang["posting-no-flooding-error"],o="close";break;case"E_NO_SUCH_CATEGORIES":t=Lang["new-topic-category-deleted"],o="close";break;case"E_BLACKLISTED":t=Lang["new-topic-blacklist-trigger"],o="close";break;case"E_NEW_USER_TEXT_BLACKLIST":t=Lang["new-topic-blacklist-text-trigger"],o="close";break;case"E_INVALID_ANNOUNCE_DATE":t=Lang["post-environ-invalid-announce-date"],o="close";break;case"E_IMG_ERROR":t=Lang["post-environ-image-error"],o="close";break;case"E_ANNOUNCE_DATE_IN_PAST":t=Lang["post-environ-announce-date-too-early"],o="close";break;default:o="no_error_match"}return{action:o,message:t}},revealPreview:function(e){this.$loader.detach(),this.$preview_text.html(e),this.setHeight(),this.is_preview_processing=!1,"function"==typeof this.settings.onRevealPreview&&this.settings.onRevealPreview()},previewCron:function(){this.settings.master.parseBBCode({text:this.$post_box.val(),onFinish:_.bind(function(e){this.$preview_text,$("<div></div>").html(e.rendered_text);this.$preview_text.html(result),"function"==typeof this.setHeight&&this.setHeight()},this)})},submitPost:function(){},fetchPostContent:function(){return this.$post_box.val()},checkPost:function(){var e,t,o=$.trim(this.fetchPostContent()).length;if(!Utils.cmty_ajax.ajax_active)return ComViews.showErrorAtopAModal(Utils.is_cmty_asleep?Lang["community-asleep-save"]:Lang["ajax-error-E_AJAX_UNKNOWN"]),!1;if(o<Constants.min_post_length)return this.showError(Lang["new-topic-post-too-short"]),!1;if(o>Constants.max_post_length)return this.showError(Lang["new-topic-post-too-long"]),!1;if(this.has_poll&&(this.$poll_question.val().length>0||this.$poll_inputs.val().length>0)){if(e=$.trim(this.$poll_question.val()).length,0==e)return this.showError(Lang["poll-no-question-error"]),!1;if(e<Constants.min_poll_question_length)return this.showError(Lang["poll-question-too-short"]),!1;if(e>Constants.max_poll_question_length)return this.showError(Lang["poll-question-too-long"]),!1;if(t=$.trim(this.$poll_inputs.val()),0==t)return this.showError(Lang["poll-no-inputs-error"]),!1}return!0},showError:function(e){AoPS.Ui.Modal.showAlert(e)},checkTitle:function(){return $.trim(this.$title_box.val()).length<Constants.min_topic_title_length?(this.showError(Lang["new-topic-title-too-short"]),!1):!0},onClose:function(){this.hasOwnProperty("preview_interval")&&clearInterval(this.preview_interval),this.hasOwnProperty("attachments_view")&&this.attachments_view.close()}}),ComViews.PostingAttachments=AoPS.View.extend({template_id:"#cmty-posting-attachments-tpl",className:"cmty-posting-attachments",initialize:function(e){var t=this,o=AoPS.Utils.getKeyChain(e.parent_view,"settings","post_model");this.parent_view=e.parent_view,_.isUndefined(o)?this.existing_attachments=[]:this.existing_attachments=o.get("attachments"),this.$el.html(this.getTemplate(this.template_id,{lang_upload:Lang["post-attachments-default"],has_existing_attachments:this.existing_attachments.length>0,attachments:this.existing_attachments,lang_attach_done:Lang["post-attachments-done"],lang_already_attached:Lang["post-attachments-already-attached"]})),this.$post_attachments=this.$("#post-attachments"),this.$post_attachments.dropzone({url:"/m/community/ajax.php",maxFiles:Constants.max_attachments_per_post-this.existing_attachments.length,addRemoveLinks:!0,sending:function(e,t,o){o.append("a","upload_post_attachment")},removedfile:function(e){var o;return t.parent_view.processAttachments(t),null!=(o=e.previewElement)&&o.parentNode.removeChild(e.previewElement),this._updateMaxFilesReachedClass()},accept:function(e,t){/[^a-zA-Z0-9\.\ \_\-]/.test(e.name)?t("err-invalid-character"):t()},fallback:function(){AoPS.Ui.Modal.showAlert(Lang["err-dropzone-fallback"],{width:"450px"}),setTimeout(function(){AoPS.Ui.Modal.closeTopModal()},100)},maxFilesize:AoPS.Community.Constants.max_attachment_size/1e3,success:function(e,o){if(o.hasOwnProperty("error_code")){switch(o.error_code){case"E_TOO_MANY_FILES":error_msg=Lang["edit-avatar-too-many"];break;case"E_NO_FILE_SENT":error_msg=Lang["edit-avatar-no-file"];break;case"E_FILE_TOO_LARGE":error_msg=Lang["post-attachments-file-too-big"];break;case"E_NO_PERMISSION":error_msg=Lang["post-attachments-no-permission"];break;case"E_BAD_FILE_TYPE":error_msg=Utils.formatString(Lang["post-attachments-bad-file-type"],[e.name]);break;case"E_SPOOFED_FILE":error_msg=Lang["post-attachments-spoofed"];break;default:error_msg=Lang["unexpected-error-code"]+o.error_code}ComViews.showErrorAtopAModal(error_msg),this.removeFile(e)}else e.tmp_name=o.response.tmp_name,$(e.previewElement).addClass("dz-success"),t.parent_view.processAttachments(t)},error:function(e,t){"err-invalid-character"===t?ComViews.showErrorAtopAModal(Lang["post-attachments-invalid-character"]):"File is too big"===t.substr(0,15)?ComViews.showErrorAtopAModal(Lang["post-attachments-file-too-big"]):"You can't upload files of this type"===t.substr(0,35)&&ComViews.showErrorAtopAModal(Utils.formatString(Lang["post-attachments-bad-file-type"],[e.name])),this.removeFile(e)}}),this.dropzone=this.$post_attachments[0].dropzone},events:{"click .post-attachment-existing-row .aops-font":"removeExistingAttachment","click .cmty-attach-done":"onClickDone"},removeExistingAttachment:function(e){var t,o,i=e.currentTarget;o=$(i.parentNode).find("input").val(),t=_.findWhere(this.existing_attachments,{url:o}),this.existing_attachments=_.without(this.existing_attachments,t),this.dropzone.options.maxFiles=Constants.max_attachments_per_post-this.existing_attachments.length,0==this.existing_attachments.length?this.$(".post-attachments-existing").remove():i.parentNode.parentNode.removeChild(i.parentNode),this.parent_view.processAttachments(this)},onClickDone:function(){Modal.closeTopModal()},show:function(){var e=this;this.$el.showModal({title:Lang["post-attachments-title"],width:"400px",frame_class:"aops-modal-standard cmty-upload-modal",onClose:function(){e.parent_view.$post_box.focus()}})}}),ComViews.throwPolymathConfirm=function(e){var t;t=new ComViews.PolymathConfirmation(e),t.$el.showModal({type:"confirm",width:"450px",close_on_button_click:!1,scrollable:!0,onButtonClick:function(o){o?t.$('input[name="agree"]')[0].checked&&(t.$('input[name="is_student"]')[0].checked||t.$('input[name="is_student"]')[1].checked)?(ComViews.throwLoaderBlockingMessage(Lang["polymath-confirm-blocker"]),AoPS.Community.MasterModel.sendPolymathConfirm({category_id:e.category_id,student_type:t.$('input[name="is_student"]:checked').val(),onFinish:function(){Modal.closeTopModal(),Modal.closeTopModal()},onError:function(e){Modal.showAlert(Utils.formatString(Lang["polymath-confirm-unknown-error"],[e.error_code]),{width:"400px",onClose:function(){Modal.closeTopModal(),Modal.closeTopModal()}})}})):ComViews.showErrorAtopAModal(Lang["polymath-force-choice"]):Modal.closeTopModal()},onClose:function(){t.close()}})},ComViews.PolymathConfirmation=AoPS.View.extend({template_id:"#cmty-polymath-confirm-tpl",initialize:function(e){this.$el.html(this.getTemplate(this.template_id,{error_message:e.error}))}}),ComViews.NewTopic=ComViews.PostingEnviron.extend({className:ComViews.PostingEnviron.prototype.className+" cmty-new-topic-popup",topic_type:"forum",render:function(){var e=this;this.model.get("master").get("current_user").get("posting_subscribe_new_topic")&&(this.extra_options.notify_email=!0,this.extra_options.bookmark_feed=!0),this.$el.append(this.getTemplate(this.template_id,{category_name:this.model.get("category_name"),has_subject:!0,has_forum:!0,has_halp:this.model.get("has_halp")&&this.model.get("master").fetchPermission("can_post_as_halp"),has_tags:!0,has_recipients:!1,is_new_pm:this.is_new_pm,lang_view_attachments:Lang["new-topic-preview-bar-attachments"],lang_subject:Lang["new-topic-subject"],lang_tags:Lang["new-topic-tags"],lang_recipients:Lang["new-topic-to"],lang_post_anonymous:Lang["new-topic-post-anon"],lang_preview:Lang["new-topic-preview"],lang_close_preview:Lang["new-topic-close-preview"],lang_refresh:Lang["new-topic-refresh-preview"],max_post_length:Constants.max_post_length,max_title_length:Constants.max_topic_title_length,has_source:this.model.get("has_source"),lang_source:Lang["topic-cell-source"],max_source_length:Constants.max_source_length,source_placeholder:Lang["new-topic-source-placeholder"]})),this.$source=this.$("input.cmty-source-input"),this.$el.find(".cmty-posting-forum-name").css({"background-color":this.model.get("main_color")}),this.in_autotag_delete=!1,this.removed_autotags=[],Utils.autotagger.dictionary=this.model.getTermTagDictionary(),this.model.get("allow_autotag")&&this.model.get("has_source")&&this.$source.on("keyup",function(t){e.onSourceKeypress(t)}),this.tag_warning_issued=!1,this.finishRender(),this.autotagging_disabled=this.model.get("master").get("current_user").get("turn_off_autotagging")},finishRender:function(){var e=this;this.appendTagBox(),$(window).on("resize.new-topic-"+this.cid,function(){e.setHeight()}),this.$el.showModal({frame_class:"cmty-posting-modal",mask_fade_in_speed:200,scrollable:!1,draggable:!0,draggable_options:{containment:"window"},max_width:"1000px",onClickMask:function(t){return e.onClickCancel(),!1},onClickX:function(){return e.onClickCancel(),!1}}),this.$el.find(".cmty-subject-input").focus(),this.setHeight(),this.listenTo(Backbone,"community_disabled",this.onDeactivated),ComViews.setTabTarget(this.$("textarea"),this.$(".cmty-submit-button")),ComViews.setTabTarget(this.$(".cmty-cancel-button"),this.$(".cmty-subject-input")),ComViews.setTabTarget(this.$(".cmty-submit-button"),this.$(".cmty-cancel-button")),ComViews.setTabTarget(this.$('input[type="text"]').last(),this.$("textarea"))},onSubjectKeypress:function(e){var t=e.which||e.keyCode;this.model.get("allow_autotag")&&32===t&&this.processTextForAutotagging(e.currentTarget.value.substr(0,e.currentTarget.selectionStart))},onSourceKeypress:function(e){var t=e.which||e.keyCode;this.model.get("allow_autotag")&&32===t&&this.processTextForAutotagging(e.currentTarget.value.substr(0,e.currentTarget.selectionStart))},onPostKeypress:function(e){var t=e.which||e.keyCode,o=this.$post_box.val();this.model.get("allow_autotag")&&(32===t||13===t)&&(o=o.substr(0,e.currentTarget.selectionStart),this.processTextForAutotagging(o))},processTextForAutotagging:function(e){var t,o,i,s=[],a=this;this.autotagging_disabled||_.isUndefined(e)||0===e.length||(t=_.last(e.replace(/(;|:|\.|,|\r\n|\n|\r)/gm," ").replace(/\s{2,}/g," ").trim().split(" "),3),i=t[t.length-1].toLowerCase(),t.length>1&&(o=t[t.length-2].toLowerCase()+" "+i,s=s.concat(Utils.autotagger.tag(o)),3===t.length&&(s=s.concat(Utils.autotagger.tag(t[0].toLowerCase()+" "+o)))),s=s.concat(Utils.autotagger.tag(i)),_.each(s,function(e){_.isUndefined(_.findWhere(a.removed_autotags,{item_id:e.id}))&&a.editable_tagbox.submitItemSilent({item_id:e.id,label:e.text,term_text:e.term_text,term_id:e.term_id,item_forum_id:a.model.get("category_id"),is_visible:!0,main_color:a.model.get("main_color"),secondary_color:a.model.get("secondary_color"),tag_source:"auto"})}))},removeAllAutoTags:function(){var e=this.editable_tagbox.$items,t=this;this.in_autotag_delete=!0,_.each(e,function(e){e.data("item").hasOwnProperty("tag_source")&&"auto"===e.data("item").tag_source&&t.editable_tagbox.removeItem(e)}),this.in_autotag_delete=!1},onClickCancel:function(){this.fetchPostContent().length>Constants.posting_warn_limit?AoPS.Ui.Modal.showConfirm(Lang["new-topic-are-sure"],_.bind(function(e){e?(AoPS.Ui.Modal.closeAllModals(),this.close()):AoPS.Ui.Modal.closeTopModal()},this),{confirm_button_cancel:Lang["new-topic-confirm-cancel"],confirm_button_ok:Lang["new-topic-confirm-OK"],close_on_button_click:!1}):AoPS.Ui.Modal.closeAllModals()},canSetAnnounce:function(){return this.model.getPermission("c_can_announce")},canSetGlobalAnnounce:function(){return this.model.getPermission("c_can_global_announce")},validatePost:function(){return this.checkPost()&&this.checkTitle()?!0:!1},parseSubmittedTags:function(){var e=this;return this.settings.hasOwnProperty("tags")?_.map(this.settings.tags,function(t){return{item_id:0,value:t,item_forum_id:e.model.get("category_id"),main_color:e.model.get("main_color"),secondary_color:e.model.get("secondary_color"),label:t,is_visible:!0,is_special:e.settings.hasOwnProperty("special_item")&&e.settings.special_item.toLowerCase()===t.toLowerCase()}}):[]},appendTagBox:function(){var e=this.parseSubmittedTags(),t=this;this.editable_tagbox=new ComViews.EditableTagBox({category:this.model,items:e,input_on_blur:!0,onAddItem:function(e,o){t.checkSpecialItem(e,o),t.setHeight()},tryToRemoveItem:function(e){var o,i=$(":focus"),s=i===t.editable_tagbox.$input_box;o=e instanceof jQuery?e.data("item"):e,t.fetchSpecialItemText().toLowerCase()===o.label.toLowerCase()?Modal.showConfirm(Utils.formatString(Lang["new-topic-remove-link-confirm"],[t.model.get("category_name")]),function(o){o&&t.editable_tagbox.removeItem(e),s?t.editable_tagbox.$input_box.focus():i.focus()},{width:"450px"}):t.editable_tagbox.removeItem(e)},onRemoveItem:function(e){!t.in_autotag_delete&&e.hasOwnProperty("tag_source")&&"auto"===e.tag_source&&t.removed_autotags.push(e),t.setHeight()}}),this.$el.find(".cmty-tags-line").append(this.editable_tagbox.$el)},checkSpecialItem:function(e,t){var o=this.fetchSpecialItemText();o.toLowerCase()===e.label.toLowerCase()&&t.addClass("cmty-special-item");
},fetchSpecialItemText:function(){return"string"==typeof this.settings.special_item?this.settings.special_item:""},setHeight:function(){var e=this.has_poll?this.$poll.outerHeight():0;total_height_others=e+this.$el.find(".cmty-posting-top").outerHeight()+this.$el.find(".cmty-posting-button-row").outerHeight()+this.$el.find(".cmty-posting-preview-bar").outerHeight(),parent_height=this.$el.height(),this.is_previewing?(this.$el.find(".cmty-posting-box-container").height((parent_height-total_height_others)/2),this.$(".cmty-post-preview").height((parent_height-total_height_others)/2)):this.$el.find(".cmty-posting-box-container").height(parent_height-total_height_others)},submitPost:function(){var e,t,o,i,s=this,a=!1;return this.validatePost()?(this.model.get("allow_autotag")&&(this.processTextForAutotagging(this.$title_box.val()),this.model.get("has_source")&&this.processTextForAutotagging(this.$source.val())),this.model.get("category_id")===Constants.olympiad_forum_id?this.tag_warning_issued||0!==this.editable_tagbox.items.length&&this.doesEssentialTagExist(Constants.essential_tags_olympiad)||(a=!0,e=Lang["new-topic-olympiad-tags-warning"],o=Lang["new-topic-olympiad-tag-warning-title"],t="#cmty-olympiad-tag-modal-tpl",this.tag_warning_issued=!0):this.model.get("category_id")===Constants.college_math_forum_id&&(this.tag_warning_issued||0!==this.editable_tagbox.items.length&&this.doesEssentialTagExist(Constants.essential_tags_college)||(a=!0,e=Lang["new-topic-college-tags-warning"],o=Lang["new-topic-college-tag-warning-title"],t="#cmty-college-tag-modal-tpl",this.tag_warning_issued=!0)),void(a?(i=$(this.getTemplate(t,{message:e})),i.showModal({title:o,width:"460px"}),i.find(".cmty-item-tag").on("click",function(e){var t=s.editable_tagbox.items.length;t===Constants.max_tags_per_topic&&s.editable_tagbox.removeItem(s.editable_tagbox.items[t-1]),s.editable_tagbox.buildNewItem({item_id:parseInt(e.currentTarget.getAttribute("tag_id")),value:e.currentTarget.innerHTML,item_forum_id:s.model.get("category_id"),main_color:s.model.get("main_color"),secondary_color:s.model.get("secondary_color"),label:e.currentTarget.innerHTML,is_special:!1}),Modal.closeTopModal()})):0===this.editable_tagbox.items.length&&"forum"===this.topic_type?AoPS.Ui.Modal.showConfirm(Lang["new-topic-no-tags-message"],function(e){e?s.finishSubmitPost(!0):AoPS.Ui.Modal.closeTopModal()},{confirm_button_ok:Lang["new-topic-no-tags-confirm-yes"],confirm_button_cancel:Lang["new-topic-no-tags-confirm-no"],width:"400px",close_on_button_click:!1}):this.finishSubmitPost(!1))):!1},doesEssentialTagExist:function(e){var t,o=e.length,i=[];for(i=_.map(this.editable_tagbox.items,function(e){return e.value.toLowerCase()}),t=0;o>t;t++)if(_.indexOf(i,e[t])>-1)return!0;return!1},isPostingAsSheriff:function(){return this.is_new_pm&&this.model.get("master").fetchPermission("can_pm_as_sheriff")&&this.$(".cmty-posting-sheriff input")[0].checked},isPostingAsHalp:function(){return this.model.get("has_halp")&&this.model.get("master").fetchPermission("can_post_as_halp")&&this.$(".cmty-posting-halp input")[0].checked},finishSubmitPost:function(e){var t,o=this,i=this.$title_box.val();this.prepareToSubmitPost(e),t=_.extend({category_id:this.model.get("category_id"),topic_type:this.topic_type,title:i,has_poll:0,allow_latex_errors:this.allow_latex_errors,target_url:this.settings.hasOwnProperty("target_url")?this.settings.target_url:"",target_text:this.settings.hasOwnProperty("target_text")?this.settings.target_text:"",post_text:this.fetchPostContent(),post_as_halp:this.isPostingAsHalp(),attachments:this.attachments,pm_as_sheriff:this.isPostingAsSheriff(),tags:this.editable_tagbox.items,linked_tag:"string"==typeof this.settings.special_item?this.settings.special_item:"",removed_autotags:this.hasOwnProperty("removed_autotags")?this.removed_autotags:[],hidden_tags:this.settings.hasOwnProperty("hidden_tags")?this.settings.hidden_tags:[],restricted_tags:this.settings.hasOwnProperty("restricted_tags")?this.settings.restricted_tags:[],source:_.isUndefined(this.$source)?"":this.$source.val(),onFinish:function(e){var t=e.topic_id;ComViews.delayModalClearing({onClose:function(){o.onPostedNewTopic({topic:e.topic_model,topic_id:t,title:i}),o.close()}})},onDeactivated:function(){o.onDeactivated()},onError:function(e){var t,i;"string"==typeof Lang["new-topic-err-"+e.error_code]?t=Lang["new-topic-err-"+e.error_code]:"E_TOPIC_FORUM_LOCKED"===e.error_code?(t=Lang["new-topic-forum-locked"],o.model.setFrontEndLocked(!0)):"E_NO_PERMISSION"===e.error_code?t=o.model.get("category_id")===Constants.private_messages_id?AoPS.isUserLimited()?Lang["new-pm-no-permission-limited"]:Lang["new-pm-no-permission"]:Lang["new-topic-no-permission"]:"E_AJAX_TIMEOUT"===e.error_code?t=Lang["new-topic-timeout"]:"E_USER_EXCLUDE_SELF"===e.error_code?(i=o.removeParticipant(e.response.error_data),t=Utils.formatString(Lang["private-user-excluded"],[i])):"E_USER_EXCLUDED_FROM_PM"===e.error_code?(i=o.removeParticipant(e.response.error_data),t=Utils.formatString(Lang["private-user-excluded-by-system"],[i])):"E_TOO_MANY_PARTICIPANTS"===e.error_code?t=Lang["private-new-msg-too-many-participants"]:"E_POLYMATH_NOT_OPTED_IN"===e.error_code||(bbcode_error=o.checkCommonErrors(e.error_code),"reveal_rendered"===bbcode_error.action&&(o.openPreviewWindow(),o.revealPreview(e.response.error_data)),t=bbcode_error.message,"no_error_match"===bbcode_error.action&&(t=Lang["unexpected-error-code"]+e.error_code)),"E_LATEX_ERROR"===e.error_code||"E_ASY_ERROR"===e.error_code?o.throwLatexErrorMessage(e.error_code):"E_POLYMATH_NOT_OPTED_IN"===e.error_code?(AoPS.Ui.Modal.closeTopModal(),ComViews.throwPolymathConfirm({category_id:o.model.get("category_id"),error:Lang["polymath-new-topic-confirm"]})):AoPS.Ui.Modal.showAlertQuick(t,{width:"400px",onClose:function(){AoPS.Ui.Modal.closeTopModal()}})},recipients:this.hasOwnProperty("editable_recipient_box")?_.map(this.editable_recipient_box.items,function(e){return e.user_id}):[]},this.extra_options),t.announce_through=this.hasOwnProperty("$announce_through")?this.$announce_through.find("input").val():"",this.has_poll&&(t.has_poll=1,t.poll_data={question:this.$poll_question.val(),allow_revote:this.$poll.find('select[name="poll-revoting"]').val(),num_selections:this.$poll.find('select[name="poll-num-options"]').val(),options:this.$poll_inputs.val(),length:this.$poll.find('select[name="poll-length"]').val()}),this.settings.master.submitNewTopic(t)},onDeactivated:function(){Modal.closeAllModals(),this.close()},prepareToSubmitPost:function(e){this.title=this.$title_box.val(),e?ComViews.replaceWithLoaderBlockingMessage(this.sending_blocker):ComViews.throwLoaderBlockingMessage(this.sending_blocker),this.listenTo(this.settings.master.get("topics"),"add",this.checkAddedTopic)},onPostedNewTopic:function(e){var t=this.settings.hasOwnProperty("url_cmty_path")?this.settings.url_cmty_path:"";"private"===e.topic.get("topic_type")&&this.model.get("master").get("current_user").get("pm_archive_on_send")||((!this.model.get("is_private")||ComViews.onPMPage())&&Backbone.history.navigate(t+"/c"+this.model.get("category_id")+"h"+e.topic_id+"_"+ComViews.convertToUrlFragment(e.title),{trigger:!0}),"function"==typeof this.settings.onSuccess&&this.settings.onSuccess(e))},onClose:function(){this.editable_tagbox.close(),$(window).off("resize.new-topic-"+this.cid)}}),ComViews.NewReply=ComViews.PostingEnviron.extend({has_subject:!1,has_forum:!1,has_source:!1,no_permission_lang_property:"new-reply-no-permission",no_permission_limited_lang_property:"new-reply-no-permission-limited",render:function(){this.sending_to_database=!1,this.$el.append(this.getTemplate(this.template_id,_.defaults(this.settings,{has_subject:this.has_subject,has_forum:this.has_forum,category_name:this.has_forum&&this.settings.topic.get("category_name"),has_tags:!1,has_halp:!1,is_new_pm:this.is_new_pm,has_source:this.has_source,lang_view_attachments:Lang["new-topic-preview-bar-attachments"],lang_subject:Lang["new-topic-subject"],lang_preview:Lang["new-topic-preview"],lang_close_preview:Lang["new-topic-close-preview"],lang_refresh:Lang["new-topic-refresh-preview"],max_post_length:Constants.max_post_length,max_title_length:Constants.max_topic_title_length,lang_source:Lang["topic-cell-source"],max_source_length:Constants.max_source_length,source_placeholder:Lang["new-topic-source-placeholder"]}))),this.has_forum&&this.$el.find(".cmty-posting-forum-name").css({"background-color":this.settings.topic.get("category_main_color")}),ComViews.setTabTarget(this.$("textarea"),this.$(".cmty-submit-button")),ComViews.setTabTarget(this.$(".cmty-submit-button"),this.$("textarea"))},submitPost:function(){var e=this.$post_box.val(),t=this;return this.checkPost()?("private"===this.settings.topic.get("topic_type")&&this.checkParticipants(),this.throwBlockingMessage(),this.sending_to_database=!0,this.settings.master.submitPost(_.extend({category_id:this.settings.category_id,post_text:e,topic_id:this.settings.topic_id,attachments:this.attachments,topic:this.settings.topic,allow_latex_errors:this.allow_latex_errors,onDeactivated:function(){Modal.closeAllModals()},onError:function(o){var i,s=o.error_code,a=o.response.error_data;t.sending_to_database=!1,"E_TOPIC_FORUM_LOCKED"===o.error_code?(i=Lang["new-reply-forum-locked"],t.settings.master.setCategoryLockStatus(t.settings.topic.get("category_id"),!0)):"E_NOT_LOGGED_IN"===s?i=Lang["new-reply-logged-out-warning"]+'<br/><div style="text-align:center">							<textarea rows="4" style="width:80%">'+e+"</textarea>":"E_NO_PERMISSION"===s?i=AoPS.isUserLimited()?Lang[t.no_permission_limited_lang_property]:Lang[t.no_permission_lang_property]:"E_TOPIC_LOCKED"===s?i=Lang["new-reply-locked"]:"E_NEW_USER_LIMITED"===s?i=Lang["new-reply-err-E_NEW_USER_LIMITED"]:"E_AJAX_TIMEOUT"===s?i=Lang["new-reply-timeout"]:"E_POLYMATH_NOT_OPTED_IN"===s||(bbcode_error=t.checkCommonErrors(s),"no_error_match"===bbcode_error.action?i=Lang["unexpected-error-code"]+s:("reveal_rendered"===bbcode_error.action&&"function"==typeof t.openPreviewWindow&&(t.openPreviewWindow(),t.revealPreview(a)),i=bbcode_error.message)),"E_LATEX_ERROR"===s||"E_ASY_ERROR"===s?t.throwLatexErrorMessage(s):"E_POLYMATH_NOT_OPTED_IN"===s?(AoPS.Ui.Modal.closeTopModal(),ComViews.throwPolymathConfirm({category_id:t.settings.category_id,error:Lang["polymath-reply-confirm"]})):AoPS.Community.Views.showError(i)}},this.extra_options)),this.settings.hasOwnProperty("onSubmit")&&this.settings.onSubmit(),this.onFinishSubmit(),!1):!1},throwBlockingMessage:function(){ComViews.throwLoaderBlockingMessage(Lang["topic-full-new-reply-blocker"])},checkParticipants:function(){var e=this.settings.topic;1!==e.get("participants").length&&1==_.filter(e.get("participants"),function(e){return!e.removed}).length&&AoPS.Ui.Flyout.display(Lang["private-reply-no-listeners"])},onErrorInPosting:function(){},onFinishSubmit:function(){},onClickCancel:function(){this.fetchPostContent().length>Constants.posting_warn_limit?AoPS.Ui.Modal.showConfirm(Lang["topic-full-reply-confirm"],_.bind(function(e){e&&this.closeReply()},this),{confirm_button_cancel:Lang["topic-full-reply-confirm-cancel"],confirm_button_ok:Lang["topic-full-reply-confirm-OK"]}):this.closeReply()},closeReply:function(){this.settings.hasOwnProperty("onCancel")&&this.settings.onCancel(),$("#community-all").removeClass("reply-focused"),$(window).trigger("resize"),this.close()}}),ComViews.EditPost=ComViews.PostingEnviron.extend({has_email_subscribe:!1,has_add_to_feed:!1,className:ComViews.PostingEnviron.prototype.className+" cmty-new-topic-popup cmty-edit-post",render:function(){this.has_source=this.has_source&&this.settings.topic.get("can_have_source"),this.settings.post_model.get("attachment")&&(this.attachments=_.map(this.settings.post_model.get("attachments"),function(e){return{href:e.href,existing:!0,name:e.name,url:e.url}})),AoPS.Community.Views.NewReply.prototype.render.apply(this),"bbcode"!==this.settings.post_model.get("post_format")&&(this.extra_options.disable_bbcode=!0,this.is_bbcode_enabled=!1,this.$el.addClass("cmty-bbcode-disabled")),this.settings.hasOwnProperty("input_text")&&this.$el.find("textarea").val(this.settings.input_text),$(window).on("resize.edit-post-"+this.cid,_.bind(function(){this.setHeight()},this)),this.has_source&&(this.$source=this.$("input.cmty-source-input"),this.$source.val(_.unescape(this.settings.topic.get("source")))),this.has_subject&&this.$(".cmty-subject-input").val(_.unescape(this.settings.topic.get("topic_title")))},setHeight:ComViews.NewTopic.prototype.setHeight,submitPost:function(){return this.checkPost()?this.has_subject&&!this.checkTitle()?!1:void this.requestReason():!1},requestReason:function(){var e=this,t=$(this.getTemplate("#cmty-edit-post-reason-tpl",{lang_instructions:Lang["edit-post-reason-info"]}));t.showAlert({title:Lang["edit-post-reason-heading"],width:"400px",focus_on_alert:!1,frame_class:"cmty-edit-reason-modal aops-modal-standard",onButtonClick:function(){var o=t.find("textarea").val().substr(0,255);e.sendEdit(o)},close_on_button_click:!1}),t.find("textarea").focus(),t.on("keydown",function(o){var i=o.which||o.keyCode;13===i&&(o.metaKey||o.ctrlKey)&&(e.sendEdit(t.find("textarea").val().substr(0,255)),o.stopPropagation(),o.preventDefault())})},sendEdit:function(e){var t=this,o=this.$post_box.val();ComViews.replaceWithLoaderBlockingMessage(Lang["edit-send-blocker"]),this.settings.post_model.edit(_.extend({edited_text:this.$post_box.val(),edit_reason:e,allow_latex_errors:this.allow_latex_errors,source:this.has_source?this.$source.val():"",attachments:this.attachments,topic_title:this.has_subject?this.$title_box.val():"",onError:function(e){var i,s=e.error_code;"E_TOPIC_FORUM_LOCKED"===s?(i=Lang["new-topic-forum-locked"],t.settings.topic.get("master").setCategoryLockStatus(t.settings.topic.get("category_id"),!0)):"E_NOT_LOGGED_IN"===s?i=Lang["edit-post-logged-out-warning"]+'<br/><div style="text-align:center">							<textarea rows="4" style="width:80%">'+o+"</textarea>":"E_NO_PERMISSION"===s?i=Lang["edit-post-no-permission"]:"E_NO_SUCH_POST"===s?i=Lang["edit-post-no-post"]:"E_NO_EDIT_MADE"===s?i=Lang["edit-post-nothing-changed"]:"E_AJAX_TIMEOUT"===s?i=Lang["error-timeout"]:(bbcode_error=t.checkCommonErrors(s),"reveal_rendered"===bbcode_error.action&&(t.openPreviewWindow(),t.revealPreview(e.response.error_data)),i=bbcode_error.message),"E_LATEX_ERROR"===s||"E_ASY_ERROR"===s?t.throwLatexErrorMessage(s):AoPS.Ui.Modal.showAlertQuick(i,{width:"400px",onClose:function(){AoPS.Ui.Modal.closeTopModal()}})},onFinish:function(){setTimeout(function(){t.close(),AoPS.Ui.Modal.closeAllModals()},Constants.new_topic_modal_delay)}},this.extra_options))},onClickCancel:function(){AoPS.Ui.Modal.showConfirm(Lang["topic-full-edit-confirm"],_.bind(function(e){e&&(this.settings.hasOwnProperty("onCancel")&&this.settings.onCancel(),AoPS.Ui.Modal.closeAllModals(),this.close())},this),{confirm_button_cancel:Lang["topic-full-reply-confirm-cancel"],confirm_button_ok:Lang["topic-full-edit-confirm-OK"]})},onClose:function(){$(window).off("resize.edit-post-"+this.cid)}}),ComViews.EditFirstPost=ComViews.EditPost.extend({has_subject:!0,has_forum:!0,has_source:!0}),ComViews.NewPrivateConversation=ComViews.NewTopic.extend({topic_type:"private",has_email_subscribe:!1,has_add_to_feed:!1,is_new_pm:!0,autotagging_disabled:!0,sending_blocker:Lang["new-pm-send-blocker"],render:function(){var e=[];this.$el.append(this.getTemplate(this.template_id,_.defaults(this.settings,{has_subject:!0,has_tags:!0,has_recipients:!0,has_halp:!1,is_private:this.is_new_pm,can_pm_as_sheriff:this.model.get("master").fetchPermission("can_pm_as_sheriff"),has_forum:!1,lang_post_as_sheriff:Lang["new-topic-post-as-sheriff"],lang_view_attachments:Lang["new-topic-preview-bar-attachments"],max_post_length:Constants.max_post_length,max_title_length:Constants.max_topic_title_length,lang_subject:Lang["new-topic-subject"],lang_tags:Lang["new-topic-tags"],lang_recipients:Lang["new-topic-to"],lang_preview:Lang["new-topic-preview"],lang_close_preview:Lang["new-topic-close-preview"],lang_refresh:Lang["new-topic-refresh-preview"],has_source:!1}))),this.$el.addClass("cmty-new-private-conversation"),this.tag_warning_issued=!1,this.settings.hasOwnProperty("preset_recipients")&&(e=this.settings.preset_recipients),this.editable_recipient_box=new ComViews.EditableRecipientBox({model:this.settings.master,items:e,onAddItem:_.bind(function(){this.setHeight()},this),onRemoveItem:_.bind(function(){this.setHeight()},this)}),this.$el.find(".cmty-private-recipients").append(this.editable_recipient_box.$el),this.finishRender()},checkRecipients:function(){return!0},removeParticipant:function(e){var t,o=_.find(this.editable_recipient_box.items,function(t){return parseInt(t.user_id)===e});return _.isUndefined(o)?"":(t="string"==typeof o.value?o.value:o.label,this.editable_recipient_box.removeItem(o),t)},validatePost:function(){return this.checkPost()&&this.checkTitle()&&this.checkRecipients()?!0:!1},canSetAnnounce:function(){return!1},canSetGlobalAnnounce:function(){return!1}}),ComViews.ReportPost=AoPS.View.extend({template_id:"#cmty-report-post-tpl",className:"cmty-report-post cmty-modal-form aops-modal-standard",initialize:function(){this.$el.append(this.getTemplate(this.template_id,{username:this.model.get("username"),spam_text:Lang["topic-full-report-item-spam"],warez_text:Lang["topic-full-report-item-warez"],cheat_text:Lang["topic-full-report-item-cheat"],other_text:Lang["topic-full-report-item-other"]}))},events:{"submit form":"onFormSubmit","click input[type=button]":"onClickCancel"},onClickCancel:function(){AoPS.Ui.Modal.closeAllModals(),this.close()},onFormSubmit:function(e){var t=this.$el.find("select").val(),o=this.$el.find("textarea").val();return this.model.report(t,o),AoPS.Ui.Modal.showAlert(Lang["topic-full-report-report-sent"],{onClose:function(){AoPS.Ui.Modal.closeAllModals()}}),this.close(),e.preventDefault(),e.stopPropagation(),!1}}),ComViews.DeletePost=AoPS.View.extend({template_id:"#cmty-delete-post-tpl",className:"cmty-delete-post cmty-modal-form aops-modal-standard",initialize:function(e){this.topic=e.topic,this.$el.append(this.getTemplate(this.template_id,{username:this.model.get("username"),can_hard_delete:this.topic.getPermission("c_can_hard_delete"),is_first_post:1===this.model.get("post_number")}))},events:{"submit form":"onFormSubmit","click input[type=button]":"onClickCancel"},onClickCancel:function(){AoPS.Ui.Modal.closeAllModals(),this.close()},onFormSubmit:function(e){var t=!1,o=this;return this.topic.getPermission("c_can_hard_delete")&&(t="hard"===this.$el.find("input[name=delete_option]:checked").val()),AoPS.Community.Views.throwBlockingMessage(Lang["topic-full-delete-post-pending"]),this.model["delete"]({hard_delete:t,onFinish:function(e){e.hasOwnProperty("topic_deleted")&&e.topic_deleted||AoPS.Community.Views.delayModalClearing({onClose:function(){o.close()}})},onError:function(e){var t,o=e.error_code;t="E_NO_PERMISSION"===o?Lang["delete-post-no-permission"]:"E_NOT_LAST_POST"===o?Lang["delete-post-not-last-post"]:"E_HARD_DELETE"===o?Lang["topic-full-undelete-hard"]:"E_NO_DELETING_FIRST_POST"===o?Lang["delete-post-sniped"]:Lang["unexpected-error-code"]+o,AoPS.Community.Views.showError(t)}}),e.preventDefault(),e.stopPropagation(),!1}}),ComViews.PostReports=AoPS.View.extend({template_id:"#cmty-post-reports-tpl",initialize:function(){this.listenTo(this.model.get("reported_posts"),"add",this.addReportedPost),this.listenTo(this.model.get("reported_posts"),"remove",this.onPostReportFetchFinished),this.reported_post_views=[],this.$loader=AoPS.Page.buildLoader(),this.$el.html(this.getTemplate(this.template_id,{page_title:Lang["post-report-admin-page-title"],top_text:Lang["post-report-admin-page-text"],loader:Lang["post-report-admin-loading"],none_found:Lang["post-report-admin-none"]})),this.$initial_loading=this.$el.find(".cmty-post-reports-loader"),this.$none=this.$el.find(".cmty-post-reports-none-found"),this.$reported_posts=this.$el.find(".cmty-post-reports-container"),this.listenTo(this.model,"post_reports_fetched",this.onPostReportFetchFinished)},addReportedPost:function(e){if("unresolved"===e.get("status")){var t=new ComViews.PostReport({model:e});this.reported_post_views.push(t),this.$reported_posts.append(t.$el)}},onAddToPage:function(e){var t=this;this.$initial_loading.show(),this.$none.hide(),this.focus=e,this.model.fetchReportedPosts(),this.goToFocus(),this.interval=setInterval(function(){t.model.fetchReportedPosts()},Constants.reported_posts_interval),this.model.get("all_past_reported_posts_fetched")||$(window).on("scroll."+this.model.cid,function(e){window.innerHeight+window.pageYOffset+10>=document.body.offsetHeight&&!t.model.get("loading_post_reports")&&t.model.get("reported_posts").length>0&&!t.model.get("all_past_reported_posts_fetched")&&(t.$el.append(t.$loader),t.model.fetchReportedPosts({fetch_before:t.model.get("reported_posts").last().get("inserted_at"),onFinish:function(){t.$loader.detach(),t.model.get("all_past_reported_posts_fetched")&&t.$el.append('<div class="cmty-no-more-reports">'+Lang["post-report-no-more"]+"</div>")}}))})},goToFocus:function(){var e,t;this.focus.hasOwnProperty("post_id")?(t=this.focus.post_id,e=_.find(this.reported_post_views,function(e){return e.model.get("post_id")===t})):this.focus.hasOwnProperty("topic_id")&&(t=this.focus.topic_id,e=_.find(this.reported_post_views,function(e){return e.model.get("topic_id")===t})),_.isUndefined(e)||this.goToTargetReport(e)},goToTargetReport:function(e){this.focus={},window.scrollTo(0,e.$el.offset().top)},onRemoveFromPage:function(){clearInterval(this.interval),$(window).off("scroll."+this.model.cid+" touchmove."+this.model.cid)},onPostReportFetchFinished:function(){this.$initial_loading.hide(),this.$none.toggle(_.isUndefined(this.model.get("reported_posts").findWhere({status:"unresolved"}))),this.goToFocus(),this.focus={}},onClose:function(){_.each(this.reported_post_views,function(e){e.close()})}}),ComViews.PostReportPostWindow=ComViews.Post.extend({removePostFromTopic:function(){}}),ComViews.PostReport=AoPS.View.extend({template_id:"#cmty-post-report-tpl",className:"cmty-admin-post-report",initialize:function(){this.post_view=new ComViews.PostReportPostWindow({model:this.model.get("post"),topic:{model:this.model.get("post").get("topic")}}),this.render(),this.listenTo(this.model,"change:status",this.onChangeStatus),this.listenTo(this.model.get("post"),"change:deleted",this.onPostDeleted),this.listenTo(this.model.get("post").get("topic"),"change:deleted",this.onTopicDeleted)},events:{"click .cmty-post-report-admin-btn .btn":"onClickResolved","click .cmty-pm-reporter":"onClickPMReporter","click .cmty-pm-poster":"onClickPMPoster"},render:function(){var e,t,o,i,s=this.model.get("post").get("topic");this.model.get("category_id")===Constants.private_messages_id?(e="/x"+this.model.get("post").get("poster_id"),t=this.model.get("post").get("username")+" "+Lang["Private-Messages"]):(e="/c"+this.model.get("category_id"),t=this.model.get("category_name")),i=e+"h"+s.get("topic_id"),o="blog"!=this.model.get("category_type"),this.$el.html(this.getTemplate(this.template_id,{category_name:t,category_url:AoPS.Community.Views.makeLinkUrl(e),mark_for_push_state:o,topic_title:s.get("topic_title"),topic_url:AoPS.Community.Views.makeLinkUrl(i),reported_by_text:Lang["post-report-admin-reported-by"],reported_date_text:Lang["post-report-admin-reported-date"],user_link:"/community/user/"+this.model.get("reporter_user_id"),details_text:Lang["post-report-admin-details"],details:this.model.get("details").length>0?this.model.get("details"):"None given",reported_by:this.model.get("username"),for_text:Lang["post-report-admin-for"],short_reason:Lang["topic-full-report-item-"+this.model.get("reason_short")],reported_date:Utils.makePrettyTime(this.model.get("inserted_at")),show_first_post_note:1===this.model.get("post").get("post_number"),first_post_note:Lang["post-report-first-post-note"],lang_pm_poster:Lang["post-report-admin-pm-poster"],lang_pm_reporter:Lang["post-report-admin-pm-reporter"],lang_send_pm:Lang["post-report-admin-pm"]})),this.$el.find(".feed-topic-forum").css({"background-color":this.model.get("main_color"),color:this.model.get("secondary_color")}),this.$el.find(".cmty-post-report-post").append(this.post_view.$el)},onClose:function(){this.post_view.close()},onClickPMReporter:function(e){ComViews.launchNewPrivateMessage({user_id:parseInt(this.model.get("reporter_user_id")),username:this.model.get("username"),is_admin:!1})},onClickPMPoster:function(e){var t,o,i=this.model.get("post_data");i.hasOwnProperty("real_poster_id")&&i.real_poster_id>0?(t=parseInt(i.real_poster_id),o=i.real_poster_username):(t=parseInt(i.poster_id),o=i.username),ComViews.launchNewPrivateMessage({user_id:t,username:o,is_admin:this.model.get("post_data").admin})},onClickResolved:function(){var e=this;AoPS.Ui.Modal.showConfirm(this.getTemplate("#cmty-post-report-settle-confirm-tpl",{message:Lang["post-report-admin-confirm"],notes:Lang["post-report-admin-notes"]}),function(t){t?(AoPS.Community.Views.throwBlockingMessage(Lang["post-report-admin-block"]),e.model.settle({onFinish:function(){AoPS.Community.Views.delayModalClearing()},notes:$(".cmty-post-report-settle-note").val(),onError:function(e){var t;"E_NOT_LOGGED_IN"===e.error_code?t=Lang["logged-out"]:"E_NO_PERMISSION"===e.error_code&&(t=Lang["post-report-admin-no-permission"]),AoPS.Community.Views.showError(t)}})):AoPS.Ui.Modal.closeAllModals()},{title:Lang["post-report-admin-confirm-title"],close_on_button_click:!1,max_width:"400px"})},onChangeStatus:function(){"resolved"===this.model.get("status")&&this.$el.fadeTo(500,0,_.bind(function(){this.close()},this))},onPostDeleted:function(){this.model.get("post").get("topic").get("num_reports");this.model.decrementNumReports(),this.model.set("status","resolved")},onTopicDeleted:function(){this.model.set("status","resolved")}}),ComViews.SearchPage=AoPS.View.extend({template_id:"#cmty-search-page-tpl",className:"cmty-search-page",initialize:function(e){this.init_options=e,this.init_options.is_private=e.preset_settings.hasOwnProperty("is_private")&&e.preset_settings.is_private,this.render(),this.init_options.is_private&&this.$el.addClass("cmty-private-search")},render:function(){this.$el.html(this.getTemplate(this.template_id,{lang_Search_Page_Title:this.init_options.is_private?Lang["search-page-private-title"]:Lang["search-page-title"]})),this.search_form=new ComViews.SearchForm(this.init_options),this.$(".form").append(this.search_form.$el)},onAddToPage:function(){this.search_form.$("input").first().focus()}}),ComViews.SearchForm=AoPS.View.extend({template_id:"#cmty-search-form-tpl",className:"cmty-search-form",supported_presets:["forums"],initialize:function(e){var t=this;this.search_page_id=e.search_page_id,this.master=this.model,this.include_users=[],this.forums=[],this.is_private=e.hasOwnProperty("is_private")&&e.is_private,e.hasOwnProperty("preset_settings")&&_.each(this.supported_presets,function(o){e.preset_settings.hasOwnProperty(o)&&(t[o]=e.preset_settings[o])}),this.search_expanded=!1,this.render()},render:function(){var e=this;this.$el.html(this.getTemplate(this.template_id,{})),this.$search_term=this.$('[name="search-term"]'),this.include_user_list=new ComViews.EditableValidatedUserList({model:this.master,items:this.include_users}),this.forum_list=new ComViews.EditableForumList({model:this.master,items:this.forums,ajax_call:"fetch_search_forum_autocomplete"}),this.$(".cmty-search-posters-include").append(this.include_user_list.$el),this.$(".cmty-search-forums-include").prepend(this.forum_list.$el),this.$dates_options=this.$(".cmty-search-dates-select > select"),this.$dates_range=this.$(".cmty-search-dates-range"),this.$dates_range_from=this.$dates_range.find("input.cmty-search-from"),this.$dates_range_to=this.$dates_range.find("input.cmty-search-to"),this.$dates_range_from.datepicker({defaultDate:"+1w",changeMonth:!0,changeYear:!0,numberOfMonths:1,yearRange:"2003:c",minDate:new Date(2003,0,1),maxDate:0,beforeShow:function(){$("#ui-datepicker-div").addClass("cmty-search-datepicker")},onClose:function(t){$("#ui-datepicker-div").removeClass("cmty-search-datepicker"),e.$dates_range_to.datepicker("option","minDate",t)}}),this.$dates_range_to.datepicker({defaultDate:"+1w",changeMonth:!0,changeYear:!0,numberOfMonths:1,yearRange:"2003:c",minDate:new Date(2003,0,1),maxDate:0,beforeShow:function(){$("#ui-datepicker-div").addClass("cmty-search-datepicker")},onClose:function(t){$("#ui-datepicker-div").removeClass("cmty-search-datepicker"),e.$dates_range_from.datepicker("option","maxDate",t)}}),this.$("input.enter-to-search").on("keydown",function(t){var o=t.which||t.keyCode;13===o&&e.onClickSearch()})},events:{"click a.cmty-search-expand-link":"onClickTextToggle","click .cmty-search-clear":"onClickClear","click .cmty-search-go":"onClickSearch","change .cmty-search-dates-select > select":"onSelectDateOption"},onClickTextToggle:function(e){this.$el.toggleClass("cmty-search-expanded"),this.search_expanded=!this.search_expanded,e.stopPropagation(),e.preventDefault()},onClickClear:function(e){this.include_user_list.close(),this.forum_list.close(),this.include_users=[],this.forums=[],this.render()},onSelectDateOption:function(e){var t=parseInt(this.$dates_options.val());this.$dates_range.toggle(-1===t)},onClickSearch:function(e){var t,o,i,s,a,n,r,l={},c="";return this.include_user_list.$input_box.val().length>0||this.forum_list.$input_box.val().length>0?void this.validateInput():(this.search_expanded?(i=this.$('[name="title"]').val(),i.length>0&&(l.title=i),i=this.$('[name="source"]').val(),i.length>0&&(l.source=i),i=this.$('[name="post-text"]').val(),i.length>0&&(l.post_text=i),i=this.$('[name="tags"]').val(),i.length>0&&(l.tags=i),l.first_post=this.$('[name="first-post"]').is(":checked")?1:0):(t=this.$search_term.val(),t.length>0&&(l.search_text=t,o=encodeURIComponent(t),c="_"+o)),this.include_user_list.items.length>0&&(l.include_users=_.pluck(this.include_user_list.items,"user_id")),this.forum_list.items.length>0&&(l.forums=_.pluck(this.forum_list.items,"category_id"),l.forums_action=this.$('input[name="forum_option"]:checked').val()),l.sort_by=this.$('input[name="sort_by"]:checked').val(),this.is_private&&(l.forums_action="include",l.forums=[1]),s=parseInt(this.$dates_options.val()),-1===s?(a=moment(this.$dates_range_from.val()),a=a.isValid()?a.format("X"):0,n=moment(this.$dates_range_to.val()),n=n.isValid()?n.add("days",1).format("X"):0):s>0&&(n=moment().format("X"),a=n-s),a>0&&(l.start_date=a),n>0&&(l.end_date=n),void(_.keys(l).length>0&&(r=this.master.buildSearchCategory(l),r.set("search_page_id",this.search_page_id),Backbone.history.navigate("q"+r.get("search_id")+c,{trigger:!0,replace:!1}))))},validateInput:function(){var e,t=this,o=this.include_user_list.$input_box.val(),i=this.forum_list.$input_box.val();ComViews.throwBlockingMessage(Lang["search-validation-blocker"]),this.master.validateSearchInput({username:o,forum:i,onFinish:function(s){var a,n=!1;s.hasOwnProperty("user")&&(s.user.is_valid?(a={user_id:s.user.user_id,item_id:s.user.user_id,label:s.user.username,value:s.user.username,is_admin:s.user.is_admin},t.include_user_list.buildNewItem(a)):(n=!0,e=Utils.formatString(Lang["search-err-no-such-user"],[o]))),!n&&s.hasOwnProperty("forum_found")&&(s.forum_found?(s.forum_data.label=s.forum_data.value,t.forum_list.buildNewItem(s.forum_data)):(n=!0,e=Utils.formatString(Lang["search-err-no-such-forum"],[i]))),n?ComViews.showError(e):setTimeout(function(){t.onClickSearch()},500)},onError:function(e){}})}}),ComViews.UserProfile=AoPS.View.extend({template_id:"#cmty-user-profile-tpl",className:"cmty-user-profile cmty-folder-top",location:"user_profile",friend_click_path:"/user/",router_base:"/community",main_profile_plain_settings:["joined_at","status","goals","interests","website","school","location","occupation"],activity_settings:[{attribute:"last_visit_pretty",
title_lang_attr:"user-profile-last-visit",is_html:!0},{attribute:"num_posts",title_lang_attr:"user-profile-total-posts"},{attribute:"primary_blog_id",title_lang_attr:"user-profile-blog",nowrap:!0},{attribute:"thanks_given",title_lang_attr:"user-profile-thanks-given"},{attribute:"thanks_received",title_lang_attr:"user-profile-thanks-received"}],initialize:function(e){var t="",o=this;this.is_session_user=this.model.get("user_id")===AoPS.session.user_id,this.$no_friends=$('<div class="cmty-no-friends">'+Lang["user-profile-no-friends"]+"</div>"),this.compress_top_fora="boolean"==typeof e.compress_top_fora?e.compress_top_fora:!1,this.render(),this.is_session_user&&(_.each(this.main_profile_plain_settings,function(e){t+=" change:"+e}),this.listenTo(this.model,t,this.fillMainProfile),this.listenTo(this.model,"change:friends_exclude",function(){o.model.set("show_friends",!o.model.get("friends_exclude")),o.render()}))},events:{"click .cmty-user-profile-pm":"onClickMessage","click .cmty-user-add-new-friend":"onClickAddNewFriend","click .cmty-user-add-this-friend":"onClickAddThisFriend","click .cmty-toggle-user-bookmark":"onClickBookmark","click .cmty-user-add-note":"onClickAddNote","click .cmty-ban-link":"onClickBan"},render:function(){var e,t=this.model,o=this;e=t.get("show_friends")&&(this.is_session_user||t.get("friends").length>0),this.$el.html(this.getTemplate(this.template_id,{username:t.get("username"),user_id:t.get("user_id"),can_pm:t.get("can_pm"),is_admin:AoPS.session.a,is_this_user_admin:t.get("is_admin"),is_limited:AoPS.session.a&&t.get("is_limited"),is_session_user:this.is_session_user,is_inactive:AoPS.session.a&&!t.get("is_activated")&&!t.get("is_banned"),is_banned:AoPS.session.a&&t.get("is_banned"),is_coppa_blocked:AoPS.session.a&&t.get("is_coppa_blocked"),avatar:t.get("avatar"),is_bookmarked:t.get("is_bookmarked"),lang_Message:Lang.Message,has_notes:AoPS.session.a&&!this.is_session_user&&t.get("user_notes").length>0,notes:t.get("user_notes"),can_oneclick_ban:!t.get("is_banned")&&_.indexOf(Constants.can_oneclick_ban,AoPS.session.user_id)>-1,lang_User_Profile:Lang["user-profile-title"],lang_INACTIVE:Lang["user-profile-INACTIVE"],lang_LIMITED:Lang["user-profile-LIMITED"],lang_BANNED:Lang["user-profile-BANNED"],lang_COPPA:Lang["user-profile-COPPA"],lang_Activity:Lang["user-profile-activity"],lang_Notes:Lang.Notes,lang_AddNote:Lang["Add-Note"],lang_By:Lang.By,lang_At:Lang.At,lang_Note:Lang.Note,show_friends:e,can_edit:this.is_session_user||this.model.get("master").fetchPermission("can_edit_other_profiles"),lang_edit_profile:Lang["edit-profile-title"],lang_Friends:Lang["user-profile-friends"],can_befriend:t.get("can_befriend"),lang_Add_Friend:Lang["user-profile-add-friend"],title_add_friend:Lang["user-profile-add-friend-title"],title_pm:Lang["user-profile-pm-title"],can_add_friends:this.is_session_user&&t.get("can_request_friend")})),this.is_session_user&&AoPS.isUserLimited()&&(this.limited_user_note=new ComViews.LimitedUserMessage({}),this.$(".cmty-category-cell-heading").after(this.limited_user_note.$el)),this.$main_profile=this.$(".cmty-user-profile-main-info"),this.$activity=this.$(".cmty-user-profile-activity > .cmty-user-profile-data"),this.fillMainProfile(),t.has("top_fora")?this.buildActivityBox():(this.$activity_loader=AoPS.Page.buildLoader(),t.fetchTopFora({onFinish:function(){o.$activity_loader.detach(),o.buildActivityBox()},onError:function(){o.$activity_loader.detach()}})),this.is_session_user&&!this.model.get("friends_exclude")&&(this.$friends_public_toggle=this.$(".cmty-user-profile-friends-toggle"),this.setFriendsPublicToggle(),this.listenTo(t,"change:friends_show_profile",this.setFriendsPublicToggle),this.$friends_public_toggle.on("click",function(){t.set("friends_show_profile",!t.get("friends_show_profile")),t.setUserSetting({value:t.get("friends_show_profile")?1:0,field:"friends_show_profile"})})),e&&(this.$friends_box=this.$(".cmty-friends-box"),this.$loader=AoPS.Page.buildLoader(),t.get("friends_initialized")?(this.buildFriends(),this.startListeners()):(this.$friends_box.append(this.$loader),t.fetchFriends({fetch_type:"initial",onFinish:function(e){o.buildFriends(),o.startListeners()}}))),this.setBookmark(),this.listenTo(this.model,"change:is_bookmarked",this.setBookmark)},setBookmark:function(){var e,t,o,i;this.is_session_user||(e=this.$(".cmty-toggle-user-bookmark"),this.model.get("is_bookmarked")?(t="C",i=Lang["bookmark-remove"],o=Lang["bookmark-remove-user-title"]):(t="B",i=Lang["bookmark-follow"],o=Lang["bookmark-user-title"]),e.find(".aops-font").text(t),e.find(".cmty-user-bookmark-tagline").text(i),e[0].title=o)},setFriendsPublicToggle:function(){var e=this.model.get("friends_show_profile");this.$friends_public_toggle.text(e?"h":"#"),this.$friends_public_toggle[0].title=Lang[e?"user-profile-friend-toggle-off":"user-profile-friend-toggle-on"]},onAddToPage:function(){this.startListeners()},onRemoveFromPage:function(){this.stopListeners()},buildActivityBox:function(){var e=this,t=this.model;_.each(this.activity_settings,function(o){var i,s,a=o.attribute;if(("last_visit_pretty"!==o.attribute||t.get("show_last_visit"))&&t.has(a)&&("number"==typeof t.get(a)||t.get(a).length>0)){if("primary_blog_id"==a){if(!(t.get(a)>0))return;s={is_html:!0,nowrap:e.compress_top_fora,has_fora:!1,content:'<a href="/community/c'+t.get(a)+'">'+t.get("primary_blog_name")+"</a>"}}else if("num_posts"===a&&(t.get("num_posts")>0||t.has("top_fora")&&t.get("top_fora").length>0)){if(top_fora=t.has("top_fora")?t.get("top_fora"):[],i=!_.isUndefined(_.findWhere(top_fora,{in_count:!1})),has_search_note=!_.isUndefined(_.findWhere(top_fora,{has_search:!1})),e.compress_top_fora){var n=7-(t.get("show_last_visit")?1:0)-(t.get("primary_blog_id")>0?1:0)-(i||has_search_note);top_fora=_.first(top_fora,n)}s={is_html:!0,content:t.get(a)+' (<a data-cmty href="/community/u'+t.get("user_id")+'">'+Lang["user-profile-click-for-posts"]+"</a>)",has_fora:!0,user_id:t.get("user_id"),top_fora:top_fora,nowrap:!1,has_count_note:i,lang_count_note:Lang["user-profile-no-count-note"],has_search_note:has_search_note,lang_search_note:Lang["user-profile-no-search-note"]};var r=0;_.each(top_fora,function(e){var t=e.total.toString().length;t>r&&(r=t)}),5>r&&e.$el.addClass("cmty-profile-"+r+"-digits")}else s={is_html:"boolean"==typeof o.is_html?o.is_html:!1,has_fora:!1,nowarp:!1,content:t.get(a)};s.title=Lang[o.title_lang_attr],AoPS.session.a&&("thanks_given"===o.attribute&&t.has("nothanks_given")&&(s.is_html=!0,s.content+=" ("+t.get("nothanks_given")+' <span class="aops-font">_</span>)'),"thanks_received"===o.attribute&&t.has("nothanks_received")&&(s.is_html=!0,s.content+=" ("+t.get("nothanks_received")+' <span class="aops-font">_</span>)')),e.$activity.append(e.getTemplate("#cmty-user-profile-data-row-tpl",s))}})},fillMainProfile:function(){var e=this,t=this.model;this.$main_profile.empty(),_.each(this.main_profile_plain_settings,function(o){var i;if("status"===o&&e.is_session_user&&!t.get("is_new_user"))i=ComViews.buildEditableRow(e.constructEditableRowSettings(o)),e.model.get("master").fetchPermission("can_edit_profile")||i.renderUneditable(),e.$main_profile.append(i.$element);else if("primary_blog_id"===o){if(!(t.get(o)>0))return;e.$main_profile.append(e.getTemplate("#cmty-user-profile-data-row-tpl",{is_html:!1,has_fora:!1,nowrap:!1,title:Lang["user-profile-blog"],content:'<a href="/community/c'+t.get(o)+'">'+t.get("primary_blog_name")+"</a>"}))}else t.has(o)&&t.get(o).length>0&&e.$main_profile.append(e.getTemplate("#cmty-user-profile-data-row-tpl",{is_url:"website"===o,is_html:!1,nowrap:!1,url:"website"===o?Utils.formatUrl(t.get(o)):"",content:t.get(o),title:Lang["user-profile-"+o]}))})},constructEditableRowSettings:function(e){var t=this;return{label:Lang["user-profile-"+e],placeholder:Lang["edit-profile-"+e+"-placeholder"],submit_on_enter:!0,content:t.model.get(e),length_limit:Constants.profile_field_length_limit,action:_.partial(function(e,o,i){"email"===e&&ComViews.throwLoaderBlockingMessage(Lang["edit-profile-email-change=blocker"]),t.model.setUserSetting({field:e,value:o,set_from:t.location,onFinish:function(s){"email"===e&&(i.contents=t.model.get(e),i.reset(),AoPS.Ui.Modal.showAlert(Utils.formatString(Lang["edit-profile-new-email"],[o,t.model.get("email")]),{title:Lang["edit-profile-email-change-title"],width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals()}}))},onCancel:function(){},onError:function(s){var a,n="flyout";switch(s.error_code){case"E_NAUGHTY_TERM_USED":a=Utils.formatString(Lang["edit-profile-inappropriate-term"],[i.label]);break;case"E_NO_PERMISSION":a=Lang["edit-profile-no-perm"];break;case"E_NOT_LOGGED_IN":a=Lang["edit-profile-not-logged-in"];break;case"E_EMAIL_NOT_AVAILABLE":a=Utils.formatString(Lang["edit-profile-email-not-available"],[o]),n="modal";break;case"E_INVALID_EMAIL":a=Utils.formatString(Lang["edit-profile-email-not-valid"],[o]),n="modal";break;case"E_EMAIL_NOT_CHANGED":a=Utils.formatString(Lang["edit-profile-email-not-valid"],[o]);break;case"E_AJAX_CANCEL":return void("email"===e?(i.contents=t.model.get(e),i.reset()):t.model.set(e,o));default:a=Utils.formatString(Lang["edit-profile-unknown-error"],[i.label,s.error_code])}i.contents=t.model.get(e),i.reset(),"flyout"===n?AoPS.Ui.Flyout.display(a):AoPS.Ui.Modal.showAlertQuick(a,{width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals()}})}})},e)}},buildFriends:function(){var e=this.model,t=this;this.$loader.detach(),0===e.get("friends").length?this.$friends_box.append(this.$no_friends):_.each(e.get("friends"),function(e){t.$friends_box.append(t.buildFriendBox(e,!1))}),this.is_session_user&&e.get("friend_requests").length>0&&(this.$friend_requests_box=$('<div class="cmty-friend-requests-box"></div>'),this.$friend_requests_box.append('<div class="cmty-friend-requests-warning">'+Lang["friends-warning"]+"</div>"),this.$friend_requests_wrapper=ComViews.buildCommunityScrollbar(this.$friend_requests_box),this.$friends_box.before(this.$friend_requests_wrapper),this.$friend_requests_wrapper.find(".aops-scroll-bar").on("slider_at_end",function(){t.fetchMoreFriendRequests()}),_.each(e.get("friend_requests"),function(e){t.$friend_requests_box.append(t.buildFriendBox(e,!0))}),this.setFriendRequestsStyle())},fetchMoreFriendRequests:function(){var e=this,t=this.model;t.get("loading_friends")||t.get("all_requests_loaded")||(e.$friend_requests_box.append(e.$loader),t.fetchFriends({fetch_type:"friend_requests",onFinish:function(o){e.$loader.detach(),_.each(o.friend_requests,function(t){e.$friend_requests_box.append(e.buildFriendBox(t,!0))}),t.get("all_requests_loaded")&&e.$el.find(".aops-scroll-bar").off("slider_at_end")}}))},startListeners:function(){var e=this.model,t=this;!e.get("all_friends_loaded")&&e.get("friends").length>0&&$(window).on("scroll.user"+e.get("user_id")+" touchmove.user"+e.get("user_id"),function(o){window.innerHeight+window.pageYOffset+50>=document.body.offsetHeight&&(e.get("loading_friends")||e.get("all_friends_loaded")||(t.$friends_box.append(t.$loader),e.fetchFriends({fetch_type:"friends",onFinish:function(o){t.$loader.detach(),_.each(o.loaded_friends,function(e){t.$friends_box.append(t.buildFriendBox(e,!1))}),e.get("all_friends_loaded")&&$(window).off("scroll.user"+e.get("user_id")+" touchmove.user"+e.get("user_id"))}})))})},stopListeners:function(){$(window).off("scroll.user"+this.model.get("user_id"))},buildFriendBox:function(e,t){var o=this,i=$(this.getTemplate("#cmty-friend-box-tpl",{avatar:e.avatar,username:e.username,is_admin:e.is_admin,is_request:t,message:t?Lang["user-profile-friend-request"]:e.status,lang_DECLINE:Lang["user-profile-friend-DECLINE"],lang_ACCEPT:Lang["user-profile-friend-ACCEPT"]}));return this.is_session_user&&!t&&i.find(".cmty-unfriend").on("click",function(t){o.unFriend(e,i),t.stopPropagation()}),t&&(i.find(".cmty-friend-decline").on("click",function(t){o.closeFriendRequest(e,i,"denied"),t.stopPropagation()}),i.find(".cmty-friend-accept").on("click",function(t){o.closeFriendRequest(e,i,"accepted"),t.stopPropagation()})),i.on("click.backbone",function(t){ComViews.followUrlOnClick(t,o.friend_click_path+e.user_id,o.router_base,"")}),i},closeFriendRequest:function(e,t,o){var i=this;this.model.closeFriendRequest({user_id:e.user_id,action:o,onFinish:function(t){"accepted"===o&&(i.$friends_box.prepend(i.buildFriendBox(t.new_friend_data,!1)),i.$no_friends.detach()),Flyout.display(Utils.formatString(Lang["user-profile-friend-request-"+o],[e.username]))},onError:function(t){"E_NO_REQUEST_AVAILABLE"===t.error_code?msg=Utils.formatString(Lang["user-profile-err-no-request-available"],[e.username]):msg=Utils.formatString(Lang["err-unknown"],[t.error_code]),Flyout.display(msg)}}),t.fadeOut(500,function(){t.remove()}),this.model.get("friend_requests").length<6&&!this.model.get("all_requests_loaded")&&this.fetchMoreFriendRequests(),this.setFriendRequestsStyle()},setFriendRequestsStyle:function(){var e=this.model.get("friend_requests").length,t="cmty-three-requests",o="cmty-many-requests";0===e&&this.model.get("all_requests_loaded")&&this.$friend_requests_wrapper.detach(),this.$friend_requests_wrapper.toggleClass(t,3===e),this.$friend_requests_wrapper.toggleClass(o,e>3)},onClickMessage:function(e){return ComViews.launchNewPrivateMessage({user_id:this.model.get("user_id"),username:this.model.get("username"),is_admin:this.model.get("is_admin")}),_.isUndefined(e)?void 0:(e.stopPropagation(),e.preventDefault(),!1)},onClickBan:function(e){AoPS.Community.MasterModel.banAsSpammer({user_id:this.model.get("user_id")}),$(e.currentTarget).hide()},onClickAddNote:function(){var e=this.$('textarea[name="cmty-user-note-input"]').val(),t=this;e.length<5||(AoPS.Community.Views.throwBlockingMessage(Lang["user-profile-add-note"]),setTimeout(function(){t.model.addNote({note_text:e,onFinish:function(){location.reload()}})},1e3))},onClickAddNewFriend:function(){var e,t,o,i=0,s=this;e=$(this.getTemplate("#cmty-add-friend-tpl",{lang_instructions:Lang["user-profile-add-friend-instructions"],lang_new_friend:Lang["user-profile-new-friend"],placeholder:Lang["Enter-username"]})),o=e.find("input"),Utils.buildUsernameAutocomplete(o,{ajax_call:"fetch_username_matches",autocomplete_settings:{onSelect:function(s,a){var n=e.find(".cmty-chosen-new-friend");parseInt(a.item.user_id)===AoPS.session.user_id?AoPS.Ui.Modal.showAlertQuick(Lang["user-profile-no-friend-self"],{onButtonClick:function(){o.val(""),o.focus()}}):(i=a.item.user_id,t=a.item.label,o.hide(),n.html(a.item.label),1==parseInt(a.item.is_admin)&&n.addClass("cmty-user-admin")),s.stopPropagation(),s.preventDefault()}}}),e.showModal({type:"confirm",title:Lang["user-profile-add-friend-modal-title"],width:"450px",close_on_button_click:!1,force_response:!0,onButtonClick:function(e){if(e){if(0===i){if(i=o.val(),0===i.length)return AoPS.Ui.Modal.showAlert(Lang["user-profile-add-friend-none-chosen"]),void(i=0);t=i}s.sendFriendRequest(i,t)}else AoPS.Ui.Modal.closeAllModals()}}),o.focus()},onClickAddThisFriend:function(){var e=this;AoPS.Ui.Modal.showConfirm(Utils.formatString(Lang["user-profile-send-request-check"],[this.model.get("username")]),function(t){t?e.sendFriendRequest(e.model.get("user_id"),e.model.get("username")):AoPS.Ui.Modal.closeAllModals()},{close_on_button_click:!1,force_response:!0})},onClickBookmark:function(e){e.preventDefault(),e.stopPropagation(),AoPS.session.logged_in?AoPS.isUserLimited()?Modal.showMessage(Lang["bookmark-limited-user"],{width:"450px"}):this.model.get("master").setUserBookmarkState({user:this.model,new_state:!this.model.get("is_bookmarked")}):AoPS.Ui.buildLoginConfirm(Lang["bookmark-not-logged-in"])},sendFriendRequest:function(e,t){var o=this;AoPS.Community.Views.throwBlockingMessage(Lang["user-profile-friend-request-pending"]),this.model.get("master").submitFriendRequest({new_friend:e,onFinish:function(e){setTimeout(function(){AoPS.Ui.Modal.closeAllModals(),o.$el.find(".cmty-user-add-this-friend").remove()},Constants.message_readability_delay)},onError:function(e){var o;switch(e.error_code){case"E_NO_PERMISSION_TO_REQUEST_FRIEND":o=Lang["user-profile-err-no-perm-friend"];break;case"E_ALREADY_FRIENDS":o=Utils.formatString(Lang["user-profile-err-already-friend"],[t]);break;case"E_NO_FRIEND_SELF":o=Lang["user-profile-no-friend-self"];break;case"E_REQUEST_FROM_POTENTIAL_EXISTS":o=Utils.formatString(Lang["user-profile-err-they-asked-you"],[t]);break;case"E_YOU_ALREADY_REQUESTED":o=Utils.formatString(Lang["user-profile-err-already-asked"],[t]);break;case"E_NOT_TAKING_FRIEND_REQUESTS":o=Utils.formatString(Lang["user-profile-err-not-taking-requests"],[t]);break;default:o=Utils.formatString(Lang["err-unknown"],[e.error_code])}setTimeout(function(){AoPS.Ui.Modal.showAlert(o,{onClose:function(){AoPS.Ui.Modal.closeAllModals()},width:"450px"})},Constants.message_readability_delay)}})},unFriend:function(e,t){var o=this.model,i=this;AoPS.Ui.Modal.showConfirm(Utils.formatString(Lang["user-profile-unfriend-confirm"],[e.username]),function(s){s&&(o.unFriend({user_id:e.user_id}),t.fadeOut(400,function(){t.remove()}),0===o.get("friends").length&&i.$friends_box.append(i.$no_friends)),AoPS.Ui.Modal.closeAllModals()},{confirm_button_ok:Lang.YES,confirm_button_cancel:Lang.NO})},onClose:function(){this.hasOwnProperty("limited_user_note")&&this.limited_user_note.close()}}),ComViews.CategoryUserCell=AoPS.View.extend({template_id:"#cmty-bookmarked-user-cell-tpl",className:"cmty-category-cell cmty-category-cell-user",initialize:function(){this.render()},render:function(){this.$el.html(this.getTemplate(this.template_id,{username:this.model.get("username"),user_id:this.model.get("user_id"),can_befriend:this.model.get("can_befriend"),user_tooltip:Lang["user-cell-visit-profile"],lang_Add_Friend:Lang["user-profile-add-friend"],title_add_friend:Lang["user-profile-add-friend-title"],title_pm:Lang["user-profile-pm-title"],lang_Message:Lang.Message,can_pm:this.model.get("can_pm"),status:this.model.get("status")})),this.user_profile=new ComViews.UserProfile({model:this.model,compress_top_fora:!0}),this.$(".cmty-category-cell-bottom").append(this.user_profile.$el)},events:{"click .cmty-user-cell-pm":"onClickMessage","click .cmty-add-cell-friend":"onClickAddNewFriend"},onClickMessage:ComViews.UserProfile.prototype.onClickMessage,onClickAddNewFriend:ComViews.UserProfile.prototype.onClickAddNewFriend}),ComViews.EditUserProfile=AoPS.View.extend({template_id:"#cmty-edit-profile-tpl",className:ComViews.UserProfile.prototype.className,location:"edit_user_profile",profile_fields:["email"].concat(_.without(ComViews.UserProfile.prototype.main_profile_plain_settings,"joined_at")),initialize:function(){this.is_current_user=this.model===this.model.get("master").get("current_user"),this.render(),this.listenTo(this.model,"status_changed",this.onStatusChange)},render:function(){var e,t,o,i=this,s=this.model.get("is_new_user"),a=this.profile_fields.length,n=[];if(t=this.is_current_user?this.model.get("master").fetchPermission("can_edit_profile"):this.model.get("master").fetchPermission("can_edit_other_profiles"),this.$el.html(this.getTemplate(this.template_id,{is_current_user:this.is_current_user,user_id:this.model.get("user_id"),username:this.model.get("username"),is_limited_user:AoPS.isUserLimited(),lang_limited_user:Lang["edit-profile-limited-user"],lang_Edit_Profile:Lang["edit-profile-title"],lang_Profile_Info:Lang["edit-profile-profile-info"],lang_Edit_Avatar:Lang["edit-profile-edit-avatar"],lang_Delete_Avatar:Lang["edit-profile-delete-avatar"],lang_Change_Password:Lang["edit-profile-change-password"],lang_Current_Password:Lang["edit-profile-current-password"],lang_New_Password:Lang["edit-profile-new-password"],lang_Retype_Password:Lang["edit-profile-retype-password"],can_add_avatar:this.model.get("master").fetchPermission(this.is_current_user?"can_add_avatar":"can_edit_other_profiles"),has_avatar:this.model.get("avatar")!==Constants.default_avatar,retype_password_placeholder:Lang["edit-profile-retype-password-placeholder"],new_password_placeholder:Lang["edit-profile-new-password-placeholder"],current_password_placeholder:Lang["edit-profile-current-password-placeholder"],avatar:this.model.get("avatar"),password_length:Constants.max_password_length,lang_SUBMIT:Lang.Submit.toUpperCase()})),this.$profile=this.$(".cmty-user-profile-main-info"),this.$current_password=this.$('input[name="current-password"]'),this.$new_password=this.$('input[name="new-password"]'),this.$confirm_password=this.$('input[name="confirm-password"]'),this.$password_buttons=this.$(".cmty-password-buttons"),this.$password_warning=this.$(".cmty-password-warning"),this.$(":password").on("input",function(){i.checkPasswordFields()}).on("keydown",function(e){var t=e.which||e.keyCode;13===t&&i.onClickSubmitPassword()}),!AoPS.isUserLimited())for(e=0;a>e;e++)o=this.profile_fields[e],s&&"email"!==o||(row=ComViews.buildEditableRow(ComViews.UserProfile.prototype.constructEditableRowSettings.apply(this,[o])),t||"email"===o||row.renderUneditable(),n.push(row),("email"!==o||this.is_current_user)&&(n[e].$input.on("keydown",_.partial(function(e,t){var o=t.which||t.keyCode;13===o&&n[(e+1)%a].$input.focus()},e)),i.$profile.append(row.$element)))},events:{"click .cmty-password-submit":"onClickSubmitPassword","click .cmty-user-edit-avatar":"onClickEditAvatar","click .cmty-user-delete-avatar":"onClickDeleteAvatar"},emptyAllPasswordFields:function(){this.$current_password.val(""),this.$new_password.val(""),this.$confirm_password.val("")},checkPasswordFields:function(){var e=this.$current_password.val(),t=this.$new_password.val(),o=this.$confirm_password.val();return this.$password_buttons.hide(),this.$password_warning.hide(),0===t.length||0===o.length?!1:t!==o?(this.$password_warning.text(Lang["edit-profile-passwords-dont-match"]),this.$password_warning.show(),!1):0===e.length?(this.$password_warning.text(Lang["edit-profile-enter-password"]),this.$password_warning.show(),!1):o.length<Constants.min_password_length?(this.$password_warning.text(Lang["edit-profile-password-too-short"]),this.$password_warning.show(),!1):(this.$password_buttons.show(),!0)},onClickSubmitPassword:function(){var e=this,t=this.$current_password.val(),o=this.$new_password.val();this.$confirm_password.val();this.$password_buttons.hide(),this.checkPasswordFields()&&(ComViews.throwBlockingMessage(Lang["edit-profile-submit-new-password"]),e.emptyAllPasswordFields(),this.model.submitNewPassword({new_password:o,old_password:t,onFinish:function(e){ComViews.delayModalClearing({onClose:function(){AoPS.Ui.Flyout.display(Lang["edit-profile-password-changed"])}})},onError:function(t){switch(t.error_code){case"E_INVALID_PASSWORD":msg=Lang["edit-profile-invalid-password"];break;case"E_INVALID_COMMON_PASSWORD":msg=Lang["edit-profile-invalid-common-password"];break;default:msg=Utils.formatString(Lang["edit-profile-unknown-error"],[this_row.label,t.error_code])}setTimeout(function(){AoPS.Ui.Modal.showAlertQuick(msg,{width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals(),e.$current_password.focus()}})},Constants.message_readability_delay)}}))},onClickEditAvatar:function(){var e;e=new ComViews.EditAvatar({model:this.model})},onClickDeleteAvatar:function(){self=this,Modal.showConfirm(Utils.formatString(Lang["edit-profile-delete-avatar-confirm"],[this.is_current_user?Lang["edit-profile-your"]:Lang["edit-profile-this-user"]]),function(e){e?(Modal.replaceTopModal({type:"message",body:Lang["edit-profile-deleting-avatar"],closeX:!1,force_response:!0,frame_class:"aops-modal-quick"}),self.model.deleteAvatar({onError:function(e){},onFinish:function(e){location.reload()}})):Modal.closeAllModals()},{title:Lang["edit-profile-delete-avatar"],close_on_button_click:!1})},onStatusChange:function(e){"edit_user_profile"!==e.set_from&&this.render()}}),ComViews.EditAvatar=AoPS.View.extend({template_id:"#cmty-edit-avatar-tpl",className:"cmty-edit-avatar",initialize:function(){var e,t=this;this.$el.html(this.getTemplate(this.template_id,{lang_upload:Lang["edit-avatar-default-message"]})),e=this.$("#edit-avatar"),e.dropzone({url:"/m/community/ajax.php",maxFiles:1,sending:function(e,o,i){i.append("a","upload_avatar"),i.append("user_id",t.model.get("user_id"))},thumbnailWidth:30,thumbnailHeight:30,accept:function(e,t){/[^a-zA-Z0-9\.\ \_\-]/.test(e.name)?t("err-invalid-character"):t()},fallback:function(){AoPS.Ui.Modal.showAlert(Lang["err-dropzone-fallback"],{width:"450px"}),setTimeout(function(){AoPS.Ui.Modal.closeTopModal()},100)},maxFilesize:AoPS.Community.Constants.max_avatar_file_size/1e3,success:function(e,t){if(t.hasOwnProperty("error_code")){switch(t.error_code){case"E_TOO_MANY_FILES":error_msg=Lang["edit-avatar-too-many"];break;case"E_NO_FILE_SENT":error_msg=Lang["edit-avatar-no-file"];break;case"E_IMAGE_DIMENSIONS_TOO_LARGE":error_msg=Lang["edit-avatar-dimensions-too-big"];break;case"E_FILE_TOO_LARGE":error_msg=Lang["edit-avatar-file-too-big"];break;case"E_NO_PERMISSION":error_msg=Lang["edit-avatar-no-permission"];break;case"E_IMPROPER_AVATAR_FILE_TYPE":error_msg=Lang["edit-avatar-bad-file-type"];break;default:error_msg=Lang["unexpected-error-code"]+t.error_code}ComViews.showErrorAtopAModal(error_msg),this.removeFile(e)}else $(e.previewElement).addClass("dz-success"),location.reload()},error:function(e,t){"err-invalid-character"===t?ComViews.showErrorAtopAModal(Lang["post-attachments-invalid-character"]):"File is too big"===t.substr(0,15)?ComViews.showErrorAtopAModal(Lang["edit-avatar-file-too-big"]):"You can't upload files of this type"===t.substr(0,35)&&ComViews.showErrorAtopAModal(Lang["edit-avatar-bad-file-type"]),this.removeFile(e)},acceptedFiles:"image/*"}),this.$el.showModal({title:Lang["edit-avatar-title"],width:"250px",frame_class:"aops-modal-standard cmty-upload-avatar-modal"})}}),ComViews.edit_community_yn_options=[{value:"1",label:Lang.Yes},{value:"0",label:Lang.No}],ComViews.EditCommunitySettings=AoPS.View.extend({className:"cmty-folder-top",template_id:"#cmty-edit-cmty-settings-tpl",sections:[{heading:Lang["edit-settings-general-heading"],settings:[{model_field:"hidden"},{model_field:"base_view",options:[{value:"main",label:Lang["edit-settings-main-base-view"]},{value:"portal",label:Lang["edit-settings-portal-base-view"]}]}]},{heading:Lang["edit-settings-friends-heading"],settings:[{model_field:"friends_show_profile"},{model_field:"friends_exclude",action:function(e,t,o){0===parseInt(e)?(t.model.setUserSetting({value:e,field:"friends_exclude"}),t.flashRow(o)):Modal.showConfirm(Lang["edit-settings-no-friends-confirm"],function(i){i?(t.model.setUserSetting({value:e,field:"friends_exclude"}),t.flashRow(o)):o.find("select")[0].value="0"},{width:"450px",title:Lang["edit-settings-no-friends-confirm-title"]})}}]},{heading:Lang["edit-settings-posting-heading"],settings:[{model_field:"posting_subscribe_new_topic"},{model_field:"posting_subscribe_reply"},{model_field:"posting_fullscreen_reply"},{model_field:"warn_on_snipes",options:[{value:"none",label:Lang.None},{value:"flyout",label:Lang.Flyout},{value:"modal",label:Lang.Popup}]},{model_field:"forum_view",options:[{value:"full",label:Lang.Tall},{value:"condensed",label:Lang.Short}],refresh_page:!0},{model_field:"turn_off_autotagging"},{model_field:"hide_avatars"},{model_field:"hide_tags_on_topic"}]},{heading:Lang["edit-settings-pm-heading"],settings:[{model_field:"pm_email"},{model_field:"pm_archive_on_send"},{model_field:"pm_live_notify",options:[{value:"none",label:Lang.None},{value:"flyout",label:Lang.Flyout},{value:"modal",label:Lang.Popup}]},{model_field:"pm_exclude_self"},{type:"link_w_label",action:function(e){Modal.showConfirm(Lang["edit-settings-archive-confirm"],function(t){t&&(e.archiveAllPrivates(),AoPS.Ui.Flyout.display(Lang["edit-settings-privates-archived"]))},{width:"450px"})},link_text:Lang["edit-settings-archive-pm-btn"],link_label:Lang["edit-settings-archive-pm-label"]},{type:"link_w_label",action:function(e){Modal.showConfirm(Lang["edit-settings-remove-confirm"],function(t){t&&(e.removeFromAllPrivates(),AoPS.Ui.Flyout.display(Lang["edit-settings-privates-removed"]))},{width:"450px"})},link_text:Lang["edit-settings-remove-from-pm-btn"],link_label:Lang["edit-settings-remove-from-pm-label"]}]},{heading:Lang["edit-settings-feed-heading"],settings:[{model_field:"hide_feed"},{model_field:"show_tags_on_feed"},{model_field:"global_feed_type",options:[{value:"full",label:Lang.Full},{value:"custom",label:Lang.Custom}],refresh_page:!0}]}],initialize:function(){this.appendBookmarkSections(),this.render(),this.listenTo(this.model,"change:friends_show_profile",this.render)},appendBookmarkSections:function(){var e=this;_.each(["topics","forums","tags"],function(t){var o={};o.heading=Utils.formatString(Lang["edit-settings-bkmk-heading"],[t]),o.settings=[],_.each(["all","feed","email"],function(e){var i;i={type:"link_w_label",link_text:Lang["edit-settings-bkmk-link-"+e],link_label:Utils.formatString(Lang["edit-settings-bkmk-"+e+"-label"],[t]),action:function(o){Modal.showConfirm(Utils.formatString(Lang["edit-settings-bkmk-"+e+"-confirm"],[t]),function(i){i?(ComViews.throwBlockingMessage(Lang["edit-settings-please-wait-bkmk"]),o.clearBookmarks({bookmark_section:t,clear_type:e,onFinish:function(){setTimeout(function(){location.reload()},1e3)}})):Modal.closeAllModals()},{width:"450px",close_on_button_click:!1})}},o.settings.push(i)}),e.sections.push(o)})},render:function(){var e,t=this,o=0;this.$el.html(this.getTemplate(this.template_id,{lang_Page_Title:Lang["edit-settings-page-title"]})),_.each(this.sections,function(i){var s=$(t.getTemplate("#cmty-user-profile-card-tpl",{title:i.heading})),a=s.find(".cmty-user-profile-data");o%2===0&&(e=$('<div class="cmty-user-profile-row"></div>'),t.$el.append(e)),e.append(s),o++,_.each(i.settings,function(e){var o,i,s,n;n=_.extend({type:"select",bold:!1,refresh_page:!1},e),s=e.hasOwnProperty("action")?function(o){e.action(o,t,i)}:function(e){t.model.setUserSetting({value:e,field:n.model_field,onFinish:function(){n.refresh_page&&location.reload()}}),t.flashRow(i)},"select"===n.type?(o=t.model.get(n.model_field),i=ComViews.buildSelectRow({options:n.hasOwnProperty("options")?n.options:ComViews.edit_community_yn_options,bold:n.bold,selected:"boolean"==typeof o?o?"1":"0":o,action:s,text:Lang["edit-settings-"+n.model_field+"-label"]})):"link_w_label"===n.type&&(i=ComViews.buildLinkLabelRow({bold:n.bold,link_text:n.link_text,link_label:n.link_label,action:function(){n.action(t.model)}})),a.append(i)})})},events:{"click a.cmty-advanced-hotkeys":"onClickHotkeys"},onClickHotkeys:function(e){this.hasOwnProperty("hotkeys_modal")||(this.hotkeys_modal=this.getTemplate("#cmty-advanced-hotkeys-modal-tpl",{})),Modal.showMessage(this.hotkeys_modal,{title:Lang["edit-settings-hotkeys-modal-title"],width:"600px"}),e.stopPropagation(),e.preventDefault()},flashRow:function(e){e.addClass("cmty-select-row-flash").removeClass("cmty-select-row-flash",1e3)}}),ComViews.FAQ=AoPS.View.extend({className:"cmty-faq-panel",initialize:function(){this.$loader=AoPS.Page.buildLoader(),this.$el.append(this.$loader),this.render()},render:function(){var e=this;this.$el.cmtyLoadFromFile({filename:AoPS.bootstrap_data.datastore_path+"cms/community/lang_en/help.html",onFinish:function(){e.$loader.detach(),e.$(".grey-panel .header").add(".grey-panel .toggle").on("click",function(e){$(this).parent().toggleClass("closed")})}})},events:{"click .old-site-jump":"onClickOldSiteJump"},onClickOldSiteJump:function(){var e=this.$(".old-site-changes");e.removeClass("closed"),window.scrollTo(0,e.offset().top-20)}}),ComViews.Memberlist=AoPS.View.extend({template_id:"#cmty-memberlist-master-tpl",className:"cmty-memberlist",initialize:function(e){this.render(),this.stub=e.stub,this.user_list=new AoPS.Community.Models.UserList({stub:this.stub}),this.$loader=AoPS.Page.buildLoader(),this.$no_matches=$('<div class="cmty-memberlist-none">'+Lang["memberlist-no-matches"]+"</div>"),this.startMemberlist(),this.$input.val(this.stub),this.setArrows()},render:function(){var e=this;this.$el.html(this.getTemplate(this.template_id,{
lang_page_title:Lang["memberlist-page-title"],lang_user_search:Lang["memberlist-user-search"],lang_Username:Lang.Username,lang_placeholder:Lang["memberlist-user-search-placeholder"],lang_search_button:Lang.SEARCH,has_email:AoPS.session.a,has_IP:AoPS.session.a,lang_Joined:Lang["memberlist-joined"],lang_Last_Visit:Lang["memberlist-last-visit"],lang_Email:Lang.Email,lang_IP:Lang.IP,lang_Posts:Lang["memberlist-posts"],lang_Thanks:Lang["memberlist-thanks"],tooltip_posts:Lang["memberlist-posts-tooltip"],tooltip_thanks:Lang["memberlist-thanks-tooltip"]})),this.$input=this.$("input"),this.$table=this.$("table > tbody"),this.$input.on("keydown",function(t){var o=t.which||t.keyCode;13===o&&e.buildFromInput()})},events:{"click .cmty-user-search-row .btn":"buildFromInput","click th.clickable":"onClickTableHead","click span.cmty-ban-link":"onClickBan"},startMemberlist:function(){0===this.user_list.get("users").length?this.fetchMoreUsers():this.addUsers(this.user_list)},addUsers:function(e){this.$table.append(this.getTemplate("#cmty-memberlist-rows-tpl",{users:e,has_email:AoPS.session.a,has_IP:AoPS.session.a}))},onAddToPage:function(){var e=this;this.$input.focus(),$(window).on("scroll",function(){document.documentElement.clientHeight+$(document).scrollTop()>=document.body.offsetHeight-80&&e.fetchMoreUsers()})},onRemoveFromPage:function(){$(window).off("scroll")},onClickTableHead:function(e){var t=e.currentTarget.getAttribute("sort-on");t!==this.user_list.get("sort_column")?sort_direction=this.getDefaultDirection(t):sort_direction="ASC"===this.user_list.get("sort_direction")?"DESC":"ASC",this.rebuildList({sort_column:t,sort_direction:sort_direction})},getDefaultDirection:function(e){return"username"===e||"joined_at"===e?"ASC":"DESC"},fetchMoreUsers:function(){var e=this;this.user_list.get("all_fetched")||this.user_list.get("is_loading")||(this.$el.append(this.$loader),this.user_list.fetchMoreUsers({onFinish:function(t){e.$loader.detach(),t.hasOwnProperty("new_users")&&t.new_users.length>0&&e.addUsers(t.new_users),0==e.user_list.get("users").length&&e.$el.append(e.$no_matches)}}))},buildFromInput:function(){var e=this.user_list.get("sort_column");this.rebuildList({sort_column:e,sort_direction:this.user_list.get("sort_direction")})},rebuildList:function(e){e.stub=this.$input.val(),this.$no_matches.detach(),(e.stub!==this.user_list.get("stub")||e.sort_direction!==this.user_list.get("sort_direction")||e.sort_column!==this.user_list.get("sort_column"))&&(this.$table.empty(),this.user_list.destroy(),this.user_list=this.user_list=new AoPS.Community.Models.UserList(e),this.fetchMoreUsers(),this.setArrows())},setArrows:function(){var e=this.user_list.get("sort_direction"),t=this.user_list.get("sort_column");this.$table.parent().find("th .aops-font").remove(),this.$table.parent().find('[sort-on="'+t+'"]').append('<span class="aops-font">'+("DESC"===e?" S":" T"))},onClickBan:function(e){AoPS.Community.MasterModel.banAsSpammer({user_id:e.currentTarget.getAttribute("user_id")}),$(e.currentTarget).hide()}}),ComViews.getCategoryAdminCatType=function(e){switch(e){case"forum_class":e="forum"}return e},ComViews.fetchCategoryAdminBlocks=function(e){var t=[];switch(e){case"forum":case"forum_class":t=["GeneralInfo","Permissions"];break;case"blog":t=["GeneralInfo","Permissions","BlogSettings","BlogCss"];break;case"view_tags":t=["GeneralInfo","Permissions","ContentsViewTags"];break;case"view_posts":t=["GeneralInfo","Permissions","ContentsViewPosts"];break;case"view_topics":t=["GeneralInfo","Permissions","ContentsViewTopics"];break;case"blogroll":t=["GeneralInfo","Permissions","ContentsBlogroll"];break;case"folder":t=["GeneralInfo","Permissions","ContentsFolder"];break;case"folder_forums":t=["GeneralInfo","Permissions","ContentsFolderForums"];break;case"folder_collections":t=["GeneralInfo","Permissions","ContentsFolderCollections"];break;case"my_forums":case"my_blogs":case"my_collections":t=["GeneralInfo","ContentsFolder"];break;case"bookmark_topics":t=["GeneralInfo","ContentsViewTopics"];break;case"bookmark_users":t=["GeneralInfo","ContentsBookmarkUsers"];break;case"bookmark_tags":t=["GeneralInfo","ContentsViewTags"];break;case"bookmark_forums":t=["GeneralInfo","ContentsFolderForums"]}return t=_.map(t,function(e){return"CategoryAdminBlock"+e})},ComViews.CategoryAdmin=AoPS.View.extend({className:"cmty-category-admin",initialize:function(e){""===this.model.get("category_type"),this.is_building_new=0===this.model.get("category_id"),this.is_creating=!1,this.render()},render:function(){var e,t=this;this.constructTitle(),e=ComViews.fetchCategoryAdminBlocks(ComViews.getCategoryAdminCatType(this.model.get("category_type"))),0===e.length,t.block_views=[],_.each(e,function(e){var o=new ComViews[e]({model:t.model});t.$el.append(o.$el),t.block_views.push(o)}),this.is_building_new&&this.$el.append('<div class="buttons"><button class="cmty-create-category btn btn-primary">'+Lang["cat-admin-create-button"]+"</button></div>")},events:{"click .cmty-create-category":"onClickCreate"},onClickCreate:function(){var e,t=this.block_views.length,o=this;if(!this.is_creating){for(this.is_creating=!0,e=0;t>e;e++)if(!this.block_views[e].validateNewCategorySettings())return void(this.is_creating=!1);AoPS.Ui.Modal.showConfirm(Lang["cat-admin-create-"+(this.model.get("is_public")?"public":"private")+"-"+this.model.getAdminLangType()+"-warning"],function(e){e?o.createNewCategory():(o.is_creating=!1,AoPS.Ui.Modal.closeAllModals())},{width:"450px",confirm_button_cancel:"NO!",confirm_button_ok:"YES!",close_on_button_click:!1})}},createNewCategory:function(){var e=this;AoPS.Ui.Modal.replaceTopModal({type:"message",body:Lang["cat-admin-create-category-blocker"],frame_class:"aops-modal-quick",force_response:!0,closeX:!1}),this.is_creating=!1,this.model.burnNewCategory({onFinish:function(t){var o;o=e.checkIfOneMoreStep()?"/community/category-admin/"+t.category_id:"/community/c"+t.category_id+"_"+ComViews.convertToUrlFragment(e.model.get("category_name")),window.location.replace(o)},onError:function(t){var o;if(_.isUndefined(Lang["cat-admin-error-"+t.error_code]))o=Lang["unexpected-error-code"]+t.error_code;else switch(o=Lang["cat-admin-error-"+t.error_code],t.error_code){case"E_NO_PERMISSION":o=o+Utils.displayCategoryType(e.model.get("category_type"))+".";break;case"E_NO_SUCH_CATEGORY_TYPE":o+=e.model.get("category_type")}AoPS.Ui.Modal.showAlertQuick(o,{width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals()}})}})},checkIfOneMoreStep:function(){return-1===_.indexOf(["forum","forum_class","blog"],this.model.get("category_type"))},constructTitle:function(){},onClose:function(){_.each(this.block_views,function(e){e.close()})}}),ComViews.CategoryAdminTitleBar=AoPS.View.extend({initialize:function(){var e=0===this.model.get("category_id"),t=Utils.displayCategoryType(this.model.get("category_type")),o=!1,i=0;this.model.has("class_id")&&(o=!0,i=this.model.get("class_id")),e?this.$el.html(this.getTemplate("#cmty-build-new-cat-heading-tpl",{lang_Type:Utils.capitalizeFirstLetter(Lang[t]),lang_Create:Lang.Create})):this.$el.html(this.getTemplate("#cmty-cat-info-page-heading-tpl",{lang_Type:Utils.capitalizeFirstLetter(Lang[t]),lang_TYPE:Lang[t].toUpperCase(),has_push_state_attr:"blog"!==this.model.get("category_type"),lang_Info:Lang.Info,category_id:this.model.get("category_id"),return_target:this.getUrlEnd(),name:this.model.get("category_name"),lang_BACK_TO:Lang["Back-to"].toUpperCase(),lang_button_class:Lang["cat-admin-back-to-class"],lang_button_cmty:Lang["cat-admin-back-to-cmty"],class_id:i,has_class:o}))},getUrlEnd:function(){switch(this.model.get("category_type")){case"my_collections":return"my-collections";case"my_forums":return"my-forums";case"my_blogs":return"my-blogs";default:return"c"+this.model.get("category_id")}}}),ComViews.CategoryAdminBlockGeneralInfo=AoPS.View.extend({template_id:"#cmty-category-admin-general-info-tpl",className:"aops-panel cmty-cat-admin-gen-info",initialize:function(){var e,t=this.model.getAdminLangType(),o=0===this.model.get("category_id"),i=this.model.getPermission("c_can_edit_core_data"),s=!o&&this.model.getPermission("c_can_delete_category"),a=!o&&this.model.getPermission("c_can_hard_delete_cat"),n=!o&&this.model.getPermission("c_can_settle_report"),r=!o&&this.model.get("master").fetchPermission("can_access_log"),l=s||a||r||n,c=this,d=s?a?Lang["cat-admin-soft-delete"]:Lang["cat-admin-delete"]:"";e=!o&&("forum"===this.model.get("category_type")||"forum_class"===this.model.get("category_type"))&&AoPS.session.logged_in&&"custom"===this.model.get("master").get("feed").get("global_feed_type"),this.$el.html(this.getTemplate(this.template_id,{title:Lang["cat-admin-general-info"],description_heading:Lang["cat-admin-description-heading"],can_edit_core_data:i,lang_view_log:Lang["cat-admin-view-log"],category_id:this.model.get("category_id"),lang_name_warning:Lang["cat-admin-cat-name-warning"],category_name:this.model.get("category_name"),category_description:this.model.get("short_description").length>0?this.model.get("short_description"):i?"":Lang["cat-admin-no-description"],has_admin_row:l,can_settle_reports:n,lang_reported_posts:Lang["cat-admin-reported-posts"],can_soft_delete:s,lang_soft_delete:d,lang_hard_delete:Lang["cat-admin-hard-delete"],can_hard_delete:a,can_access_log:r,has_buttons:i&&!o,name_heading:Lang["cat-admin-"+t+"-name"],name_placeholder:Lang["cat-admin-"+t+"-name-placeholder"],description_placeholder:Lang["cat-admin-"+t+"-desc-placeholder"],max_name_length:Constants.max_category_name_length,max_description_length:Constants.max_category_description_length,Save:Lang.Save,Reset:Lang.Reset,can_edit_global_feed:e,global_feed_heading:Lang["cat-admin-in-global-feed"],lang_Yes:Lang.Yes,lang_No:Lang.No,is_class_forum:"forum_class"===this.model.get("category_type"),lang_automatically_included:Lang["cat-admin-global-automatic"],lang_see_faq:Lang["cat-admin-global-feed-help"],is_in_global_feed:e&&_.indexOf(this.model.get("master").get("feed").get("global_feed_fora"),this.model.get("category_id"))>-1})),i&&(this.$category_name=this.$el.find('input[name="collection-name"]'),this.$category_description=this.$el.find('input[name="collection-description"]'),o||(this.$footer=this.$el.find(".footer"),this.$category_name.add(this.$category_description).on("input",function(){c.activateSaveButton()})),this.cacheData()),!o&&this.model.get("is_forum")&&this.model.getPermission("c_can_edit_admin_items")&&(this.$el.append('<div class="cmty-admin-only-line">'+Lang["cat-admin-admin-item-warning"]+"</div>"),_.each(["include_in_count","include_in_thank_count","include_in_nothank_count","include_in_dynamic_collections"],function(e){c.buildEditableBitSetting(e)}))},hasSystemColor:function(){var e=_.pluck(Lang["cat-admin-category-colors"],"color");return _.indexOf(e),this.model.get("main_color").toLowerCase()>-1},prepareColors:function(){var e=_.clone(Lang["cat-admin-category-colors"]),t=this.model.get("main_color").toLowerCase();return _.each(e,function(e){e.checked=t===e.color}),e},buildSettingGroup:function(e){return $('<div class="form-group"><div><label>'+Lang["cat-admin-label-"+e]+"</label></div>")},buildStaticSetting:function(e){var t=this.buildSettingGroup(e),o=this.model.get(e);"boolean"==typeof o&&(o=o?Lang.Yes:Lang.No),t.append("<div>"+o+"</div>"),this.$el.append(t)},buildEditableBitSetting:function(e){var t=this,o=this.buildSettingGroup(e),i=$(this.getTemplate("#yes-no-select-tpl",{value:this.model.get(e),Yes:Lang.Yes,No:Lang.No}));i.on("change",function(o){ComViews.EditCommunitySettings.prototype.flashRow(i.parent().parent()),t.updateBitSetting(e,o.target.options[o.target.selectedIndex].value)}),o.append($("<div></div>").append(i)),this.$el.append(o)},updateBitSetting:function(e,t){this.model.setAdminItemSetting({setting:e,value:parseInt(t)}),this.model.set(e,1==parseInt(t))},events:{"click .cmty-cat-admin-gen-save":"onClickSave","click .cmty-cat-admin-gen-reset":"onClickReset","click .cmty-soft-delete-cat":"onClickSoftDelete","click .cmty-hard-delete-cat":"onClickHardDelete",'change select[name="cmty-cat-admin-global-feed-setting"]':"onChangeGlobalFeedSetting"},onClickReset:function(){this.resetToCachedData(),this.$footer.hide()},onChangeGlobalFeedSetting:function(){var e;e=this.$('select[name="cmty-cat-admin-global-feed-setting"]').val(),this.model.updateGlobalFeedSetting({new_setting:e,onFinish:function(){location.reload()},onError:function(e){var t;t=Lang.hasOwnProperty("cat-admin-global-err-"+e.error_code)?Lang["cat-admin-global-err-"+e.error_code]:Lang["err-unknown"],AoPS.Ui.Modal.showAlert(t,{width:"450px",onClose:function(){location.reload()}})}})},onClickSoftDelete:function(){this.onClickDelete("soft")},onClickHardDelete:function(){this.onClickDelete("hard")},onClickDelete:function(e){var t=this;Modal.showConfirm(Utils.formatString(Lang["cat-admin-"+e+"-delete-confirm"],[this.model.get("category_name")]),function(o){o?(ComViews.throwLoaderBlockingMessage(Lang["cat-admin-delete-blocker"]),setTimeout(function(){t.model["delete"]({delete_type:e,onFinish:function(e){window.location.href="/community"},onError:function(e){var t;switch(e.error_code){case"E_PROTECTED":t=Lang["cat-admin-delete-protected"];break;case"E_CATEGORY_NOT_FOUND":t=Lang["cat-admin-delete-not-found"];break;case"E_NO_PERMISSION":t=Lang["cat-admin-delete-no-permission"];break;default:t=Lang["unexpected-error-code"]+e.error_code}ComViews.showError(t)}})},1e3)):Modal.closeAllModals()},{width:"450px",close_on_button_click:!1})},cacheData:function(){this.cached_name=this.$category_name.val(),this.cached_description=this.$category_description.val()},resetToCachedData:function(){this.$category_name.val(this.cached_name),this.$category_description.val(this.cached_description)},activateSaveButton:function(){this.$footer.show()},onClickSave:function(){var e=this;this.validateNewCategorySettings()&&(ComViews.throwLoaderBlockingMessage(Lang["saving-blocker"]),this.$footer.hide(),this.model.saveCoreDataToDb({onFinish:function(){setTimeout(function(){AoPS.Ui.Modal.closeAllModals(),e.cacheData(),AoPS.Ui.Flyout.display(Lang["data-saved-reload"])},Constants.message_readability_delay_short)},onError:function(t){"E_NO_PERMISSION"===t.error_code?error_msg=Lang["cat-admin-gen-info-error-E_NO_PERMISSION"]:error_msg=Lang["cat-admin-error-"+t.error_code],error_msg+="<br><br>"+Lang["cat-admin-error-nothing-saved"],AoPS.Ui.Modal.showAlert(error_msg,{width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals(),e.activateSaveButton()}})}}))},validateNewCategorySettings:function(){return this.$category_name.val().length<Constants.min_category_name_length?(AoPS.Ui.Modal.showAlertQuick(Lang["cat-admin-"+Utils.simplifyCategoryType(this.model.get("category_type"))+"-name-too-short"]),!1):(this.model.set("category_name",this.$category_name.val()),this.model.set("short_description",this.$category_description.val()),!0)}}),ComViews.CategoryAdminBlockPermissions=AoPS.View.extend({template_id:"#cmty-category-admin-permissions-tpl",className:"aops-panel cmty-cat-admin-perm-panel",initialize:function(){this.is_new=0===this.model.get("category_id"),this.is_new&&this.model.get("users").push({user_id:AoPS.session.user_id,username:AoPS.session.username,is_admin:AoPS.session.a,role:"owner"}),this.isUserPermissionAvailable()||AoPS.session.a?(this.user_box_views=[],this.render(),this.listenTo(this.model,"change:is_public change:is_locked change:has_source",this.setHelpers),this.buildHelper()):this.$el.html(this.getTemplate("#cmty-category-admin-permissions-private-coll-tpl",{title:Lang["cat-admin-permissions-title"],explanation:Lang["cat-admin-private-collection-perms"]}))},buildHelper:function(){var e=this.category_type_specific_settings.help_template_id;this.$help=$(this.getTemplate(e,{}))},render:function(){var e,t=this.model.getPermission("c_can_lock_category");e="forum"===this.model.get("category_type")?"forum":"blog"===this.model.get("category_type")?"blog":"collection",this.category_type_specific_settings=this.fetchRenderData(),this.$el.html(this.getTemplate(this.template_id,{is_new:this.is_new,header_text:Lang["cat-admin-permissions-header-"+e],title:Lang["cat-admin-permissions-title"],lang_private:Lang.Private,can_edit_public:this.is_new||this.model.getPermission("c_can_change_is_public"),lang_public:Lang.Public,public_private_heading:Lang["cat-admin-permissions-public-heading"],is_locked_heading:Lang["cat-admin-permissions-is-locked"],can_lock:t,lang_open:Lang["cat-admin-permissions-open"],lang_locked:Lang["cat-admin-permissions-locked"],is_public:this.model.get("is_public"),is_locked:this.model.get("is_locked"),has_source_toggle:!this.is_new&&"forum"==this.model.get("category_type")&&this.model.getPermission("c_can_edit_core_data"),has_source_heading:Lang["cat-admin-permissions-has-source"],inheritance_heading:Lang["cat-admin-permissions-inherit-head"],lang_No:Lang.No,lang_Yes:Lang.Yes,has_source:this.model.get("has_source"),can_set_inheritance:!this.is_new&&this.model.getPermission("c_can_set_role_inherit")})),this.$is_locked=this.$el.find('select[name="cmty-category-admin-is-locked"]'),"forum"===this.model.get("category_type")&&(this.$has_source=this.$el.find('select[name="cmty-category-admin-has-source"]')),this.is_new&&(this.$is_public=this.$el.find('select[name="cmty-category-admin-is-public"]')),this.addUserBoxes(),this.setHelpers(),this.model.getPermission("c_can_set_role_inherit")&&(this.$role_inheritance=this.$(".cmty-category-admin-role-inherit"),this.listenTo(this.model,"change:role_inheritance_parent",this.constructRoleInheritance),this.constructRoleInheritance())},events:{'change select[name="cmty-category-admin-is-public"]':"onChangeIsPublic",'change select[name="cmty-category-admin-is-locked"]':"onChangeIsLocked",'change select[name="cmty-category-admin-has-source"]':"onChangeSource","click .cmty-cat-admin-help":"onClickHelp"},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-perms-help-title"],width:"600px",scrollable:!0})},onChangeIsPublic:function(){var e,t=this;e="blog"===this.model.get("category_type")?this.model.get("is_public")?"cat-admin-set-blog-private-warning":"cat-admin-set-blog-public-warning":"cat-admin-is-public-confirm-warning",this.is_new?(this.model.set("is_public",1===parseInt(this.$is_public.val())),this.addUserBoxes()):Modal.showConfirm(Lang[e],function(e){e?(ComViews.throwBlockingMessage(Lang["cat-admin-is-public-blocker"]),t.model.toggleIsPublic({onFinish:function(e){location.reload()},onError:function(e){var o;o="E_NO_PERMISSION"===e.error_code?Lang["cat-admin-gen-info-error-E_NO_PERMISSION"]:Lang["cat-admin-error-"+e.error_code],o+="<br><br>"+Lang["cat-admin-error-nothing-saved"],AoPS.Ui.Modal.showAlert(o,{width:"450px",onClose:function(){AoPS.Ui.Modal.closeAllModals(),t.resetIsPublic()}})}})):Modal.closeAllModals()},{close_on_button_click:!1,width:"550px",onClose:function(){t.resetIsPublic()}})},constructRoleInheritance:function(){this.model.has("role_inheritance_parent")&&!_.isNull(this.model.get("role_inheritance_parent"))?this.renderInheritanceParent():this.renderInheritanceInput(),this.$role_inheritance.append('<div class="cmty-cat-admin-inherit-info"><span class="cmty-category-admin-helper">'+Utils.formatString(Lang["cat-admin-inheritance-info"],[Utils.simplifyCategoryType(this.model.getAdminLangType())])+"</span></div>")},check_can_remove:!0,can_remove_all:!1,url_cmty_path:"",push_state_attribute:"data-cmty",url_router_base:"/community",constructItem:ComViews.Itembox.prototype.constructItem,renderInheritanceParent:function(){var e=$('<span class="aops-font clickable">J</span>');self=this,this.$role_inheritance.empty(),this.$role_inheritance.append(this.constructItem(this.model.get("role_inheritance_parent"))),this.$role_inheritance.prepend(e),e.on("click",function(){self.removeInheritanceParent()}).css({color:this.model.get("role_inheritance_parent").item_main_color})},removeInheritanceParent:function(){this.model.set("role_inheritance_parent",null),this.model.get("category_id")>0&&this.model.removeInheritanceParent()},renderInheritanceInput:function(){var e=this;this.$role_inheritance.empty(),this.$role_inheritance_input=$('<input type="text">'),this.$role_inheritance.append(this.$role_inheritance_input),Utils.buildCategoryAutocomplete(this.$role_inheritance_input,{ajax_call:"fetch_inherits_from_autocomplete",additional_ajax_settings:{category_id:this.model.get("category_id"),category_type:this.model.get("category_type")},autocomplete_settings:{onSelect:function(t,o){0===e.model.get("category_id")?e.model.set("role_inheritance_parent",{item_id:o.item.category_id,item_text:o.item.label,item_type:o.item.category_type,item_forum_id:o.item.item_forum_id,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:!1,item_subtitle:o.item.short_description}):(ComViews.throwLoaderBlockingMessage(Lang["cat-admin-set-role-inherit"]),e.model.setRoleInheritanceParent({parent_id:o.item.category_id,onFinish:function(t){window.location.href="/community/category-admin/"+e.model.get("category_id")},onError:function(e){var t;switch(e.error_code){case"E_NO_PERMISSION":t=Lang["cat-admin-set-inherit-no-perm"];break;case"E_INVALID_PARENT_TYPE":t=Lang["cat-admin-set-inherit-invalid-parent"];break;case"E_CANT_INHERIT_FROM_SELF":t=Lang["cat-admin-no-inherit-from-self"];break;default:t=Lang["unexpected-error-code"]+code}AoPS.Community.Views.showError(t)}})),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})},resetIsPublic:function(){this.$('select[name="cmty-category-admin-is-public"]').val(this.model.get("is_public")?1:0)},onChangeIsLocked:function(){this.model.setLockedStatus({is_locked:1===parseInt(this.$is_locked.val())})},onChangeSource:function(){this.model.setHasSource({has_source:1===parseInt(this.$has_source.val())})},addUserBoxes:function(){var e=this,t=this.model.get("is_public"),o=this.$el.find(".cmty-category-admin-users");if(o.empty(),this.closeUserBoxes(),!t){if(this.is_new&&"folder"===this.model.get("category_type"))return;if(!this.is_new&&!AoPS.session.a&&_.indexOf(["folder","folder_forums","folder_collections"],this.model.get("category_type"))>-1)return}_.each(this.category_type_specific_settings.user_boxes,function(i){var s=$('<div class="form-group"></div>'),a=null;t&&i.show_if_category_public||!t&&i.show_if_category_private?(s.append("<div><label>"+i.title+"</label></div>"),e.model.getPermission("c_can_edit_"+i.role)?a=new ComViews.ToggleableUserListCategoryAdmin({role:i.role,model:e.model}):i.show_only_if_can_edit||(a=new ComViews.StaticUserList({is_editable:!1,no_users_message:"owner"===i.role?Lang["cat-admin-site-admins-are-admins"]:Lang["cat-admin-no-users-with-this-role"],user_list:_.filter(e.model.get("users"),function(e){return e.role===i.role}),onMatchLoggedInUser:function(t,o){var s;e.model.get("can_remove_self")&&(s=$(' <span class="cmty-delete-item aops-font">J</span>'),t.find("span").append(s),s.on("click",function(t){Modal.showConfirm(Utils.formatString(Lang["cat-admin-permissions-remove-self"],[i.title,e.model.get("category_name")]),function(t){t?(ComViews.throwBlockingMessage(Lang["please-wait"]),e.model.removeUser({user_id:o.user_id,onFinish:function(){setTimeout(function(){location.reload()},500)},onError:function(e){ComViews.showError(Lang["unexpected-error-code"]+e.error_code)}})):Modal.closeAllModals()},{width:"450px",close_on_button_click:!1}),t.stopPropagation(),t.preventDefault()}))}})),_.isNull(a)||(e.user_box_views.push(a),s.append(a.$el),o.append(s))):e.model.removeUsersByRole(i.role)}),this.isUserPermissionAvailable()?(this.$(".cmty-cat-admin-perm-is-locked").show(),this.$(".cmty-category-admin-users").show(),this.$(".cmty-cat-admin-perm-set-inheritance").show()):(this.$(".cmty-cat-admin-perm-is-locked").hide(),this.$(".cmty-category-admin-users").hide(),this.$(".cmty-cat-admin-perm-set-inheritance").hide())},isUserPermissionAvailable:function(){return this.model.get("is_public")||_.indexOf(Constants.categories_with_private_roles,this.model.get("category_type"))>-1},closeUserBoxes:function(){_.each(self.user_box_views,function(e){e.close()})},fetchRenderData:function(){var e={show_if_category_public:!0,show_if_category_private:!0,show_only_if_can_edit:!1};switch(this.model.get("category_type")){case"forum":case"forum_class":return{public_helper:Lang["cat-admin-permissions-forum-public-helper"],private_helper:Lang["cat-admin-permissions-forum-private-helper"],locked_helper:Lang["cat-admin-permissions-forum-locked-helper"],open_helper:Lang["cat-admin-permissions-forum-open-helper"],has_source_helper:Lang["cat-admin-permissions-forum-has-source-helper"],no_source_helper:Lang["cat-admin-permissions-forum-no-source-helper"],user_boxes:[_.defaults({title:Lang.Administrators,role:"owner",box_class:"cmty-cat-admin-administrators"},e),_.defaults({title:Lang.Moderators,role:"mod",box_class:"cmty-cat-admin-moderators"},e),_.defaults({title:Lang.Users,role:"registered_user",box_class:"cmty-cat-admin-users",show_if_category_public:!1},e),_.defaults({title:Lang.Banned,role:"deny",box_class:"cmty-cat-admin-banned-users",show_if_category_private:!1,show_only_if_can_edit:!0},e)],help_template_id:"#cmty-cat-admin-perm-forum-help-tpl"};case"blog":return{public_helper:Lang["cat-admin-permissions-blog-public-helper"],private_helper:Lang["cat-admin-permissions-blog-private-helper"],locked_helper:Lang["cat-admin-permissions-blog-locked-helper"],open_helper:Lang["cat-admin-permissions-blog-open-helper"],help_template_id:"#cmty-cat-admin-perm-blog-help-tpl",user_boxes:[_.defaults({title:Lang.Administrators,role:"owner",box_class:"cmty-cat-admin-administrators"},e),_.defaults({title:Lang.Contributors,role:"contributor",box_class:"cmty-cat-admin-contributors"},e),_.defaults({title:Lang.Readers,role:"reader",box_class:"cmty-cat-admin-readers",show_if_category_public:!1},e),_.defaults({title:Lang.Banned,role:"deny",box_class:"cmty-cat-admin-banned-users",show_if_category_private:!1,show_only_if_can_edit:!0},e)]};case"my_forums":case"my_collections":return{public_helper:Lang["cat-admin-permissions-collection-public-helper"],private_helper:Lang["cat-admin-permissions-collection-private-helper"],locked_helper:Lang["cat-admin-permissions-collection-locked-helper"],open_helper:Lang["cat-admin-permissions-collection-open-helper"],help_template_id:"#cmty-cat-admin-perm-collection-help-tpl",user_boxes:[_.defaults({title:Lang.Administrators,role:"owner",box_class:"cmty-cat-admin-administrators"},e)]};default:return{public_helper:Lang["cat-admin-permissions-collection-public-helper"],private_helper:Lang["cat-admin-permissions-collection-private-helper"],locked_helper:Lang["cat-admin-permissions-collection-locked-helper"],open_helper:Lang["cat-admin-permissions-collection-open-helper"],help_template_id:"#cmty-cat-admin-perm-collection-help-tpl",user_boxes:[_.defaults({title:Lang.Administrators,role:"owner",box_class:"cmty-cat-admin-administrators"},e),_.defaults({title:Lang.Moderators,role:"mod",box_class:"cmty-cat-admin-moderators"},e),_.defaults({title:Lang.Users,role:"registered_user",box_class:"cmty-cat-admin-users",show_if_category_public:!1},e),_.defaults({title:Lang.Banned,role:"deny",box_class:"cmty-cat-admin-banned-users",show_if_category_private:!1,show_only_if_can_edit:!0},e)]}}},setHelpers:function(){var e=this.model.get("is_public")?this.category_type_specific_settings.public_helper:this.category_type_specific_settings.private_helper,t=this.model.get("is_locked")?this.category_type_specific_settings.locked_helper:this.category_type_specific_settings.open_helper,o=this.model.get("is_locked")?"k":"2";this.$el.find(".cmty-category-admin-is-public-helper").html(e),this.$el.find(".cmty-category-admin-is-locked-helper").html(t),this.$el.find(".cmty-category-lock-status").html(o),this.$(".cmty-cat-admin-locked-label").html(this.model.get("is_locked")?Lang["cat-admin-permissions-locked"]:Lang["cat-admin-permissions-open"]),"forum"===this.model.get("category_type")&&this.$(".cmty-category-admin-has-source-helper").html(this.model.get("has_source")?this.category_type_specific_settings.has_source_helper:this.category_type_specific_settings.no_source_helper)},onClose:function(){this.closeUserBoxes()},validateNewCategorySettings:function(){return!0}}),ComViews.CategoryAdminBlockContents=AoPS.View.extend({template_id:"#cmty-category-admin-contents-new-tpl",className:"aops-panel cmty-cat-admin-contents",can_additems_in_admin:!0,initialize:function(){_.indexOf(["bookmark_topics","bookmark_forums","bookmark_tags","my_forums","my_collections","my_blogs","view_posts","view_topics","view_tags"],this.model.get("category_type"))>-1?this.has_help=!0:this.has_help=!1,this.has_help&&(this.$help=$(this.getTemplate("#cmty-cat-admin-contents-"+this.model.get("category_type")+"-help-tpl",{}))),this.is_bookmark=this.model.get("is_bookmark_category"),0===this.model.get("category_id")?this.renderConstructingCollection():(this.$loader=AoPS.Page.buildLoader(),this.edit_window_created=!1,this.render()),this.listenTo(this.model,"item_added",this.onClickCancel)},renderConstructingCollection:function(){this.$el.html(this.getTemplate("#cmty-category-admin-contents-info-tpl",{title:Lang["cat-admin-contents-title"],info:Lang["cat-admin-contents-building-info"]}))},render:function(){var e=this.model.canAddItem(),t=this.model.canRemoveItem();this.$el.html(this.getTemplate(this.template_id,{can_edit_items:e||t,title:Lang["cat-admin-contents-title"],has_help:this.has_help,lang_help:Lang["cat-admin-contents-help-tooltip"],title_editing:Lang["cat-admin-contents-title-editing"],lang_description:Lang["cat-admin-contents-desc-heading"],lang_contents_desc:Lang["cat-admin-contents-desc-"+this.model.get("category_type")],show_sort_type:e||t,lang_current_state:Lang["cat-admin-contents-current-state"],lang_sort_heading:Lang["cat-admin-contents-sort-heading"],lang_sort_type:this.model.getSortDescription(this.model.get("item_sort_type")),lang_edit_contents:Lang["cat-admin-contents-edit-btn"]})),this.$contents=this.$(".cmty-cat-admin-contents-current-state"),this.$edit_contents=this.$(".cmty-cat-admin-edit-window"),this.cat_cell=new(ComViews.fetchCategoryCellConstructor(this.model.get("category_type")))({model:this.model}),this.$contents.append(this.cat_cell.$el)},events:{"click .cmty-admin-edit-contents-btn":"onClickEdit","click .cmty-cat-admin-help":"onClickHelp","click .cmty-cat-admin-edit-cancel":"onClickCancel","click .cmty-cat-admin-edit-save":"onClickSave","click .cmty-cat-admin-available-tab":"onClickAvailableTab","click .cmty-cat-admin-edit-tab":"onClickEditTab"},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-contents-help-title"],width:"600px",scrollable:!0})},onClickEdit:function(){this.edit_window_created||(ComViews.throwBlockingMessage(Lang["cmty-cat-admin-edit-contents-fetch"]),this.constructEditContents()),this.$edit_contents.show(),this.$el.addClass("cmty-editing-contents"),this.setFocus()},setFocus:function(){var e=this.$('input[type="text"]');e.length>0&&e.first().focus()},onClickCancel:function(){this.hasOwnProperty("$edit_contents")&&(this.$edit_contents.empty(),this.$edit_contents.hide()),this.$el.removeClass("cmty-editing-contents"),this.model.unset("items_for_edit"),this.edit_window_created=!1},onClickSave:function(){var e=this.model.getPermission("c_can_change_sort_type"),t=this,o=this.getSortType();"manual"===o&&this.resortModelItemEdits(),ComViews.throwLoaderBlockingMessage(Lang["cat-admin-contents-save-blocker"]),this.model.saveItemEdits({change_sort_type:e&&this.$sort_type.val()!==this.model.get("item_sort_type"),sort_type:o,onError:function(e){var o;return"E_CATEGORY_LOCKED"===e.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),t.model.set("is_locked",!0),void t.onClickCancel()):(o=Lang["cat-admin-contents-save-error"],o+="string"==typeof Lang["cat-admin-contents-save-error-"+e.error_code]?Lang["cat-admin-contents-save-error-"+e.error_code]:Utils.formatString(Lang["cat-admin-contents-unexpected-error"],[e.error_code]),
AoPS.Ui.Modal.showAlert(o,{width:"450px",onButtonClick:function(){}}),void 0)},onFinish:function(){location.reload()}})},resortModelItemEdits:function(){var e=[];this.$edit_items.find(".cmty-admin-contents-edit-row").each(function(t){e.push($(this).data("row_obj").item)}),this.model.set("items_for_edit",e)},constructEditContents:function(){var e=this.model.canAddItem(),t=this;this.model.canRemoveItem();this.$edit_contents.html(this.getTemplate("#cmty-category-admin-edit-contents-tpl",{can_add_items:e,lang_sort_heading:Lang["cat-admin-contents-sort-heading"],can_change_sort:this.model.getPermission("c_can_change_sort_type"),lang_save:Lang.Save.toUpperCase(),lang_cancel:Lang.Cancel.toUpperCase(),category_title:this.model.get("category_name"),category_desc:this.model.get("short_description"),is_my_category:this.model.get("is_my_category"),lang_current_items:Lang["cat-admin-contents-current-tab"],lang_available_items:Lang["cat-admin-contents-available-tab"]})),this.model.getPermission("c_can_change_sort_type")&&(this.$sort_type=this.$edit_contents.find('select[name="cmty-item-sort-type"]'),_.each(this.model.get("allowed_item_sort_types"),function(e){var o=t.model.getSortDescription(e),i='<option value="'+e+'" '+(t.model.get("item_sort_type")===e?"selected":"")+">"+o+"</option>";t.$sort_type.append(i)}),this.$sort_type.on("change",function(){t.onSortTypeChange()})),this.$edit_items_header=this.$edit_contents.find(".cmty-cat-admin-content-items-header"),this.$edit_items=this.$edit_contents.find(".cmty-cat-admin-contents-edit-list"),this.edit_window_created=!0,this.model.get("is_my_category")&&e&&(this.$available_items=this.$edit_contents.find(".cmty-cat-admin-available-item-list")),this.constructEditableItems(),this.setSortableStatus(),this.can_additems_in_admin&&e&&!this.model.get("is_my_category")&&!this.is_bookmark&&(this.$items_input=this.$edit_contents.find(".cmty-cat-admin-add-item"),this.constructItemsInput())},onSortTypeChange:function(){this.sortRows(),this.setSortableStatus()},setSortableStatus:function(){"manual"===this.getSortType()?this.$edit_items.sortable():this.$edit_items.is(":ui-sortable")&&this.$edit_items.sortable("destroy")},getSortType:function(){return this.model.getPermission("c_can_change_sort_type")?this.$sort_type.val():this.model.get("item_sort_type")},sortRows:function(){var e=this.$edit_items.find(".cmty-admin-contents-edit-row"),t=this.getSortType(),o=this,i=function(e){return 0};"abc"===t?i=function(e){return $(e).data("row_obj").item.item_text.toLowerCase()}:"system"===t?i=function(e){return parseInt(-$(e).data("row_obj").item.item_score)}:"manual"===t&&(i=function(e){return parseInt(-$(e).data("row_obj").item.item_level)});var s=_.sortBy(e,i);_.each(s,function(e){o.$edit_items.append($(e))})},sortAvailableRows:function(){var e=this.$available_items.find(".cmty-admin-contents-edit-row"),t=this,o=function(e){return $(e).data("row_obj").item.item_text.toLowerCase()},i=_.sortBy(e,o);_.each(i,function(e){t.$available_items.append($(e))})},constructEditableItems:function(){var e=this;this.$edit_items.append(this.$loader),this.model.fetchItemsForEdit({onFinish:function(){e.$loader.detach(),e.renderItems(),$(window).scrollTop(e.$el.offset().top),setTimeout(function(){Modal.closeAllModals()},700)},onError:function(){}})},constructAvailableItems:function(){var e=this;_.each(this.model.get("available_items"),function(t){var o;o=e.constructAvailableRow(t),e.$available_items.append(o.$row)})},onClickAvailableTab:function(){this.$edit_items.hide(),this.$available_items.show(),this.$edit_contents.find(".cmty-cat-admin-available-tab").addClass("active-tab"),this.$edit_contents.find(".cmty-cat-admin-edit-tab").removeClass("active-tab")},onClickEditTab:function(){this.$edit_items.show(),this.$available_items.hide(),this.$edit_contents.find(".cmty-cat-admin-edit-tab").addClass("active-tab"),this.$edit_contents.find(".cmty-cat-admin-available-tab").removeClass("active-tab")},renderItems:function(){var e=this;_.each(this.model.get("items_for_edit"),function(t){var o;o=e.constructRow(t),e.$edit_items.append(o.$row)}),this.model.get("is_my_category")&&this.constructAvailableItems()},constructRow:function(e){var t,o,i,s=this.constructItem(e),a={item:e,$item:s},n=this;return a.$row=$('<div class="cmty-admin-contents-edit-row"></div>'),this.model.canRemoveItem()&&(t=$('<div title="'+Lang["cmty-admin-delete-item"]+'" class="cmty-delete-item aops-font">J</div>'),t.on("click",function(t){n.deleteItem(e)}),a.$row.append(t)),this.model.get("is_bookmark_category")&&(o=$('<div class="cmty-edit-bookmark"><label title="'+Lang["cat-admin-contents-subscribe"]+'"><input type="checkbox" '+(e.is_watched?"checked":"")+'><span class="aops-font">D</span></label></div>'),o.find("input").on("change",function(t){e.edit_state="edited",e.is_watched=this.checked?1:0}),i=$('<div class="cmty-edit-bookmark"><label title="'+Lang["cat-admin-contents-feed"]+'"><input type="checkbox" '+(e.in_feed?"checked":"")+'><span class="aops-font">E</span></label></div>'),i.find("input").on("change",function(t){e.edit_state="edited",e.in_feed=this.checked?1:0}),a.$row.append(o),a.$row.append(i)),a.$row.data("row_obj",a),a.$row.append(a.$item),a},fetchRowByItem:function(e,t){var o,i,s=e.find(".cmty-admin-contents-edit-row"),a=s.length;for(o=0;a>o;o++)if(i=$(s[o]).data("row_obj").item,t.item_id===i.item_id&&t.item_forum_id===i.item_forum_id&&t.item_type===i.item_type)return $(s[o]).data("row_obj");return null},addItem:function(e){var t,o,i,s=this;if(!this.model.canAddEditItems())return setTimeout(function(){Modal.showAlert(Utils.formatString(Lang["cat-admin-contents-limit-exceeded"],[s.model.get("item_limit")]))},10),!0;if(0===e.item_id||_.isUndefined(t=this.model.fetchEditItem(e)))this.model.get("is_my_category")&&this.removeFromAvailableItems(e),"view_posts"===this.model.get("category_type")?this.addNewItem(e):(i=this.fetchRowByItem(this.$edit_items,e),e.edit_state="added",_.isNull(i)?this.addNewItem(e):(this.model.addToEditItems(e),i.$row.show()));else{if("deleted"!==t.edit_state)return o="view_posts"===this.model.get("category_type")?Utils.formatString(Lang["cat-admin-view_posts-already-holds"],[e.item_id]):e.item_text,AoPS.Ui.Modal.showAlertQuick(Utils.formatString(Lang["cat-admin-contents-already-holds"],[o]),{onClose:function(){Modal.closeAllModals()}}),!1;"view_posts"===this.model.get("category_type")?this.addNewItem(e):(t.edit_state="saved",i=this.fetchRowByItem(this.$edit_items,e),_.isNull(i)?this.addNewItem(i):i.$row.show()),this.model.get("is_my_category")&&this.removeFromAvailableItems(e)}return!0},addNewItem:function(e){var t=this.constructRow(e);this.model.addToEditItems(e),this.addNewRow(t)},addNewRow:function(e){this.$edit_items.append(e.$row),"manual"!==this.getSortType()&&this.sortRows(),this.resortModelItemEdits()},deleteItem:function(e){var t=this.fetchRowByItem(this.$edit_items,e);"deleted"!==e.edit_state&&(this.model.deleteEditItem(e),"added"===e.edit_state?_.isNull(t)||t.$row.remove():t.$row.fadeOut(200),this.model.get("is_my_category")&&this.addToAvailableItems(e))},addToAvailableItems:function(e){var t=this.fetchRowByItem(this.$available_items,e);this.model.addToAvailableItems(e),_.isNull(t)&&(t=this.constructAvailableRow(e)),this.$available_items.append(t.$row),this.sortAvailableRows()},removeFromAvailableItems:function(e){var t=this.fetchRowByItem(this.$available_items,e);_.isNull(t)||t.$row.remove(),this.model.removeAvailableItem(e)},constructItem:ComViews.Itembox.prototype.constructItem,constructItemsInput:function(){},url_router_base:"/community",push_state_attribute:"data-cmty",url_cmty_path:"",check_can_remove:!1,validateNewCategorySettings:function(){return!0}}),ComViews.CategoryAdminBlockContentsViewTopics=ComViews.CategoryAdminBlockContents.extend({constructItem:function(e){var t;return t=$('<div class="cmty-cat-admin-topic-item"><div class="cmty-cat-admin-topic-title"><a data-cmty href="/community/h'+e.item_id+'">'+e.item_text+'</a></div><span class="cmty-cat-admin-in"> '+Lang["in"]+' </span><div class="cmty-cat-admin-topic-forum">'+e.item_category_name+"</div></div>"),t.css({color:e.item_main_color}),t.find("a").css({color:e.item_main_color}),t},constructItemsInput:function(){var e=this;this.$items_input.empty(),this.$items_input.append('<div class="cmty-admin-new-contents-add-head">'+Lang["cat-admin-add-heading-topic"]+'</div><input type="text" class="cmty-admin-new-contents-view_topics cmty-admin-new-contents-category"					placeholder="'+Lang["cat-admin-add-content-topic-placeholder"]+'"><button class="btn btn-primary">'+Lang.Submit+"</button>"),this.$items_input.find("input").on("keydown",function(t){var o=t.which||t.keyCode;13==o&&e.onSubmitTopic()}),this.$items_input.find("button").on("click",function(t){e.onSubmitTopic()})},onSubmitTopic:function(){var e,t=this.$items_input.find("input").val(),o=this,i=0;/^[1-9]\d*$/.test(t)?i=parseInt(t):(e=t.split("/"),t=e[e.length-1],t=t.match(/(?:h\d+)/),_.isNull(t)||(i=parseInt(t[0].substring(1)))),0===i?(this.$items_input.find("input").val(""),Modal.showAlert(Lang["cmty-admin-add-topic-error"],{width:"450px"})):(this.$items_input.find("input").val(""),ComViews.throwLoaderBlockingMessage(Lang["cmty-admin-add-topic-blocker"]),this.model.fetchTopicEditItem({topic_id:i,onFinish:function(e){o.addItem(e.topic_item)&&Modal.closeAllModals()},onError:function(e){var t;switch(e.error_code){case"E_TOPIC_PRIVATE":t=Lang["cmty-admin-add-topic-err-private"];break;case"E_NOT_FORUM_TOPIC":t=Lang["cmty-admin-add-topic-err-not-forum"];break;case"E_NO_SUCH_TOPIC":t=Lang["cmty-admin-add-topic-err-no-topic"];break;case"E_NO_PERMISSION":t=Lang["cmty-admin-add-topic-err-no-permission"];break;default:t=Lang["unexpected-error-code"]+e.error_code}ComViews.showError(t)}}))}}),ComViews.CategoryAdminBlockContentsViewPosts=ComViews.CategoryAdminBlockContents.extend({post_views:[],post_types:{forum_post:{has_label:!0,has_post:!0,has_hide:!1,has_custom:!1},forum_hidden_post:{has_label:!1,has_post:!0,has_hide:!0,has_custom:!1},custom_text:{has_label:!0,has_post:!1,has_hide:!1,has_custom:!0},custom_hidden_text:{has_label:!1,has_post:!1,has_hide:!0,has_custom:!0}},constructItem:function(e){var t,o=$('<div class="cmty-cat-admin-edit-post-view"></div>');return t=ComViews.ItemboxPosts.prototype.constructItem.apply(this,[e]),o.append(t),o},constructItemsInput:function(){var e,t=this;e=$(this.getTemplate("#cmty-category-admin-add-post-tpl",{max_label_length:Constants.view_post_max_label_len,max_hide_label_length:Constants.view_post_max_hide_label_len})),this.$items_input.empty(),this.$items_input.removeClass("cmty-cat-admin-edit-row"),this.$items_input.append(e),this.$items_input.find("select").on("change",function(e){t.setupPostType(this.value)}),this.setupPostType("forum_post"),this.$items_input.find("button").on("click",function(e){t.processItemInput()})},setFocus:function(){this.setupPostType("forum_post")},setupPostType:function(e){var t=this.$(".cmty-admin-new-"+e);this.$(".cmty-admin-new-post-option").hide(),t.show(),t.find("input").first().focus()},processItemInput:function(){var e,t,o=this.$('select[name="cmty-cat-admin-post-type"]').val(),i=this.$(".cmty-admin-new-"+o),s=this,a="",n=0,r="",l="",c="",d=this.post_types[o];return d.has_label&&(a=i.find('input[name="cmty-admin-new-contents-post-label"]').val(),a.length>Constants.view_post_max_label_len&&(c="E_LABEL_TOO_LONG")),d.has_post&&(e=i.find('input[name="cmty-admin-new-contents-post"]').val(),/^[1-9]\d*$/.test(e)?n=parseInt(e):(t=e.split("/"),e=t[t.length-1],e=e.match(/(?:p\d+)/),_.isNull(e)||(n=parseInt(e[0].substring(1))),0===n&&(c="E_INVALID_POST_ID"))),d.has_hide&&(r=i.find('input[name="cmty-admin-new-contents-hidden-text"]').val(),r.length>Constants.view_post_max_hide_label_len&&(c="E_HIDE_LABEL_TOO_LONG")),d.has_custom&&(l=i.find('textarea[name="cmty-admin-new-contents-custom-text"]').val(),0===l.length&&(c="E_NO_CUSTOM_TEXT_ENTERED")),""!==c?void this.processError(c):(ComViews.throwLoaderBlockingMessage(Lang["cat-admin-post-construct-blocker"]),void this.model.createViewPostItem({post_type:o,post_label:a,post_id:n,hide_label:r,custom_text:l,onFinish:function(e){s.addItem(e.new_item)&&Modal.closeAllModals(),s.$('input[type="text"]').val(""),s.$("textarea").val("")},onError:function(e){s.processError(e.error_code)}}))},processError:function(e){var t;t="string"==typeof Lang["cmty-admin-new-post-error-"+e]?Lang["cmty-admin-new-post-error-"+e]:Lang["unexpected-error-code"]+e,ComViews.showError(t)}}),ComViews.CategoryAdminBlockContentsViewTags=ComViews.CategoryAdminBlockContents.extend({constructItem:function(e){this.category_id=e.item_forum_id;var t=ComViews.Itembox.prototype.constructItem.apply(this,[e]),o=$('<div class="cmty-cat-admin-view_tags-tag"><span class="cmty-cat-admin-in">'+Lang["in"]+' </span><span class="cmty-cat-admin-view_tags-forum">'+e.item_category_name+"</span></div>");return o.css({color:e.item_main_color}),o.prepend(t),this.category_id=this.model.get("category_id"),o},constructItemsInput:function(){var e=this,t={};this.$items_input.empty(),this.$items_input.append('<div class="cmty-admin-new-contents-add-head">'+Lang["cat-admin-add-heading-"+this.model.get("category_type")]+'</div><input type="text" class="cmty-admin-new-contents-category"					placeholder="'+Lang["cat-admin-add-content-tag-forum-placeholder"]+'">'),this.model.get("is_public")&&(t.is_public_setting=1),Utils.buildCategoryAutocomplete(this.$items_input.find("input"),{ajax_call:"fetch_forum_autocomplete",additional_ajax_settings:t,autocomplete_settings:{onSelect:function(t,o){e.buildTagInput({item_id:o.item.category_id,item_text:o.item.label,item_type:o.item.category_type,item_forum_id:o.item.item_forum_id,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:o.item.can_remove,item_subtitle:o.item.short_description}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})},buildTagInput:function(e){var t,o=this;this.$items_input.empty(),this.$items_input.html(this.getTemplate("#cmty-cat-admin-add-content-tags-tpl",{lang_Forum:Lang.Forum,lang_Tag:Lang.Tag,tag_placeholder:Lang["cat-admin-contents-tag-placeholder"]})),this.current_forum=e,this.category=this.model.get("master").fetchCategory(e.item_id),_.isUndefined(this.category)&&(this.category=this.model.get("master").constructTemporaryCategory({category_type:e.item_type,category_id:e.item_id,main_color:e.item_main_color,secondary_color:e.item_secondary_color,category_name:e.item_text})),t=AoPS.Community.Views.Itembox.prototype.constructItem.apply({push_state_attribute:"data-cmty",check_can_remove:!0,can_remove_all:!0,url_router_base:"/community",url_cmty_path:"",onClickDelete:function(){o.onClickCloseForum()}},[e]),this.$items_input.find(".cmty-cat-admin-contents-add-tag-forum").append(t),this.$input_box=this.$items_input.find("input"),AoPS.Community.Views.buildTagAutocomplete({$input_box:this.$input_box,show_no_results_msg:!0,model:this.category,submitNewItem:function(t){var i;if("/open"===t.label.substr(0,5)&&(t.label=e.item_text),t.item_id>0){var s={in_feed:0,is_watched:0,item_category_name:e.item_text,item_forum_id:parseInt(t.item_forum_id),item_id:parseInt(t.item_id),item_level:0,item_main_color:t.main_color,item_secondary_color:t.secondary_color,item_text:t.label,item_type:"tag"};o.addItem(s),o.buildTagInput(e)}else i=o.$input_box.val(),o.buildTagInput(e),o.$input_box.val(i)}}),this.$input_box.focus()},onClickCloseForum:function(e){this.constructItemsInput(),this.$items_input.find("input").focus()}}),ComViews.CategoryAdminBlockContentsFolder=ComViews.CategoryAdminBlockContents.extend({new_contents_autocomplete_ajax:"fetch_add_contents_categories_autocomplete",constructAvailableRow:function(e){var t,o=this.constructItem(e),i={item:e,$item:o},s=this;return i.$row=$('<div class="cmty-admin-contents-edit-row"></div>'),this.model.getPermission("c_can_add_item")&&(t=$('<div class="cmty-add-available-item aops-font">+</div>'),t.on("click",function(t){s.addItem(e)}),i.$row.append(t)),i.$row.data("row_obj",i),i.$row.append(i.$item),i},constructItemsInput:function(){var e=this,t={};this.$items_input.append('<div class="cmty-admin-new-contents-add-head">'+Lang["cat-admin-add-heading-"+this.model.get("category_type")]+'</div><input type="text" class="cmty-admin-new-contents-category"				placeholder="'+Lang["cat-admin-add-content-"+this.model.get("category_type")+"-placeholder"]+'">'),this.$new_item_input=this.$items_input.find("input"),this.model.get("is_public")&&(t.is_public_setting=1),Utils.buildCategoryAutocomplete(this.$new_item_input,{ajax_call:this.new_contents_autocomplete_ajax,additional_ajax_settings:t,autocomplete_settings:{onSelect:function(t,o){e.parsePotentialNewContents({item_id:o.item.category_id,item_text:o.item.label,item_type:o.item.category_type,item_forum_id:o.item.item_forum_id,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:o.item.can_remove,item_level:0,item_score:o.item.last_post_time,item_subtitle:o.item.short_description,item_is_public:o.item.is_public,edit_state:"added",id:0}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})},parsePotentialNewContents:function(e){e.item_id===this.model.get("category_id")?AoPS.Ui.Modal.showAlertQuick(Lang["cat-admin-contents-no-adding-to-self"]):this.addItem(e),this.$new_item_input.val(""),this.$new_item_input.focus()},onAddItemError:function(e,t){"E_CATEGORY_LOCKED"===e.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),this.model.set("is_locked",!0),this.render()):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-add-category-error"],[t.item_text,e.error_code])),this.model.removeItem(t)},onClickDeleteItem:function(e){var t=this;this.model.removeItemDb({item:e,remove_from_client_immediately:!0,onError:function(o){"E_CATEGORY_LOCKED"===o.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),t.model.addItem(e),t.model.set("is_locked",!0),t.render()):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-remove-tag-error"],[e.item_text])),t.model.addItem(e)}})},addItemToExistingCategory:function(e){var t=this;this.model.addItemDb({item:e,add_to_client_immediately:!0,onError:function(o){t.onAddItemError(o,e)}})},onClose:function(){this.itembox_view.close()}}),ComViews.CategoryAdminBlockContentsBookmarkUsers=ComViews.CategoryAdminBlockContentsFolder.extend({can_additems_in_admin:!1}),ComViews.CategoryAdminBlockContentsBlogroll=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_blogs_autocomplete"}),ComViews.CategoryAdminBlockContentsFolderForums=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_forum_autocomplete"}),ComViews.CategoryAdminBlockContentsFolderCollections=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_folder_collections_contents_autocomplete"}),ComViews.CategoryAdminBlockContentsFolderOld=AoPS.View.extend({template_id:"#cmty-category-admin-contents-tpl",className:"aops-panel cmty-cat-admin-contents",new_contents_autocomplete_ajax:"fetch_add_contents_categories_autocomplete",initialize:function(){this.$help=$(this.getTemplate("#cmty-cat-admin-contents-"+ComViews.getCategoryAdminCatType(this.model.get("category_type"))+"-help-tpl",{})),this.render()},events:{"click .cmty-cat-admin-help":"onClickHelp"},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-contents-help-title"],width:"600px",scrollable:!0})},render:function(){var e=this.model.canAddItem(),t=this.model.canRemoveItem(),o=this;this.$el.html(this.getTemplate(this.template_id,{can_add_item:e,title:Lang["cat-admin-contents-title"],lang_add:Lang["cat-admin-contents-add-item"],lang_contents:Lang["cat-admin-contents-items-header"]})),this.$contents=this.$el.find(".cmty-admin-location-containers"),this.itembox_view=new ComViews.Itembox({model:this.model,check_can_remove:t,can_remove_all:!0,onDeleteItem:function(e){o.onClickDeleteItem(e)}}),this.$contents.append(this.itembox_view.$el),e&&(this.$content_add=this.$el.find(".cmty-cat-admin-content-add"),this.constructContentsInput())},onClickDeleteItem:function(e){var t=this;this.model.removeItemDb({item:e,remove_from_client_immediately:!0,onError:function(o){"E_CATEGORY_LOCKED"===o.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),t.model.addItem(e),t.model.set("is_locked",!0),t.render()):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-remove-tag-error"],[e.item_text])),t.model.addItem(e)}})},constructContentsInput:function(){var e=this,t={};this.$content_add.append('<input class="cmty-admin-new-contents-category"				placeholder="'+Lang["cat-admin-add-content-"+this.model.get("category_type")+"-placeholder"]+'">'),this.$new_item_input=this.$content_add.find("input"),this.model.get("is_public")&&(t.is_public_setting=1),Utils.buildCategoryAutocomplete(this.$new_item_input,{ajax_call:this.new_contents_autocomplete_ajax,additional_ajax_settings:t,autocomplete_settings:{onSelect:function(t,o){e.parsePotentialNewContents({item_id:o.item.category_id,item_text:o.item.label,item_type:o.item.category_type,item_forum_id:o.item.item_forum_id,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:o.item.can_remove,item_subtitle:o.item.short_description}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})},parsePotentialNewContents:function(e){e.item_id===this.model.get("category_id")?AoPS.Ui.Modal.showAlertQuick(Lang["cat-admin-contents-no-adding-to-self"]):_.isUndefined(this.model.fetchItem(e))?this.model.get("category_id")>0?this.addItemToExistingCategory(e):this.model.addItem(e):AoPS.Ui.Modal.showAlertQuick(Utils.formatString(Lang["cat-admin-contents-already-holds"],[e.item_text])),this.$new_item_input.val(""),this.$new_item_input.focus()},onAddItemError:function(e,t){"E_CATEGORY_LOCKED"===e.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),this.model.removeItem(t),this.model.set("is_locked",!0),this.render()):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-add-category-error"],[t.item_text,e.error_code])),this.model.removeItem(t)},addItemToExistingCategory:function(e){var t=this;this.model.addItemDb({item:e,add_to_client_immediately:!0,onError:function(o){t.onAddItemError(o,e)}})},onClose:function(){this.itembox_view.close()},validateNewCategorySettings:function(){return 0===this.model.get("items").length?(AoPS.Ui.Modal.showAlertQuick(Lang["cat-admin-no-empty-collections"]),!1):!0}}),ComViews.CategoryAdminBlockContentsBookmarkForums=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_forum_autocomplete",addItemToExistingCategory:function(e){var t=this;ComViews.fireBookmarkModal("forum",_.bind(function(o){var i=_.defaults({state:o},e);this.model.get("master").addBookmarkForumViaAdmin({item:i,onError:function(o){t.onAddItemError(o,e)}})},this))}}),ComViews.CategoryAdminBlockContentsMyForums=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_add_contents_my_forums_autocomplete"}),ComViews.CategoryAdminBlockContentsMyCollections=ComViews.CategoryAdminBlockContentsFolder.extend({new_contents_autocomplete_ajax:"fetch_add_contents_my_collections_autocomplete"}),ComViews.CategoryAdminBlockContentsViewTagsOld=ComViews.CategoryAdminBlockContentsFolder.extend({onClickCloseForum:function(e){this.constructContentsInput(),this.$content_add.find("input").focus()},constructContentsInput:function(){var e=this;this.$content_add.empty(),this.$content_add.append('<input class="cmty-admin-new-contents-category"					placeholder="'+Lang["cat-admin-add-content-tag-forum-placeholder"]+'">'),Utils.buildCategoryAutocomplete(this.$content_add.find("input"),{ajax_call:"fetch_forum_autocomplete",autocomplete_settings:{onSelect:function(t,o){e.buildTagInput({item_id:o.item.category_id,item_text:o.item.label,item_type:o.item.category_type,item_forum_id:o.item.item_forum_id,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:o.item.can_remove,item_subtitle:o.item.short_description}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})},buildTagInput:function(e){var t,o=this;this.$content_add.empty(),this.$content_add.html(this.getTemplate("#cmty-cat-admin-add-content-tags-tpl",{lang_Forum:Lang.Forum,lang_Tag:Lang.Tag,tag_placeholder:Lang["cat-admin-contents-tag-placeholder"]})),this.current_forum=e,this.category=this.model.get("master").fetchCategory(e.item_id),_.isUndefined(this.category)&&(this.category=this.model.get("master").constructTemporaryCategory({category_type:e.item_type,category_id:e.item_id,main_color:e.item_main_color,secondary_color:e.item_secondary_color,category_name:e.item_text})),t=AoPS.Community.Views.Itembox.prototype.constructItem.apply({push_state_attribute:"data-cmty",check_can_remove:!0,can_remove_all:!0,onClickDelete:function(){o.onClickCloseForum()}},[e]),this.$content_add.find(".cmty-cat-admin-contents-add-tag-forum").append(t),this.$input_box=this.$content_add.find("input"),AoPS.Community.Views.buildTagAutocomplete({$input_box:this.$input_box,show_no_results_msg:!0,model:this.category,submitNewItem:function(e){o.addItem(e)}}),this.$input_box.focus()},addItem:function(e){var t=this,o={item_id:parseInt(e.item_id),item_type:"tag",item_forum_id:parseInt(e.item_forum_id),item_text:e.value,item_main_color:e.main_color,item_secondary_color:e.secondary_color};_.isUndefined(this.model.fetchItem(o))?this.model.get("category_id")>0?this.addItemToExistingCategory(o):this.model.addItem(o):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-added-tag-already"],[o.item_text,t.current_forum.item_text])),this.buildTagInput(this.current_forum)},addItemToExistingCategory:function(e){var t=this;this.model.addItemDb({item:e,add_to_client_immediately:!0,onError:function(o){"E_CATEGORY_LOCKED"===o.error_code?(AoPS.Ui.Modal.showAlert(Lang["cat-admin-contents-locked-error"]),t.model.removeItem(e),t.model.set("is_locked",!0),t.render()):AoPS.Ui.Flyout.display(Utils.formatString(Lang["cat-admin-contents-add-tag-error"],[e.item_text,t.current_forum.item_text])),t.model.removeItem(e)}})}}),ComViews.CategoryAdminBlockContentsBookmarkTags=ComViews.CategoryAdminBlockContentsViewTags.extend({addItemToExistingCategory:function(e){var t=this;ComViews.fireBookmarkModal("tag",_.bind(function(o){this.model.get("master").addTagBookmark({item:_.defaults(o,e),onError:function(o){t.onAddItemError(o,e)}})},this))}}),ComViews.CategoryAdminBlockLocation=AoPS.View.extend({template_id:"#cmty-category-admin-location-tpl",className:"aops-panel cmty-cat-admin-location",initialize:function(){this.display_type=Utils.displayCategoryType(this.model.get("category_type")),this.render(),this.$help=$(this.getTemplate("#cmty-cat-admin-location-help-tpl",{type:this.display_type,lang_contained_in:Lang["cat-admin-location-contained-in"]}))},events:{"click .cmty-cat-admin-help":"onClickHelp"},buildHelper:function(){var e=this.category_type_specific_settings.help_template_id;this.$help=$(this.getTemplate(e,{}))},render:function(){var e=this;this.$el.html(this.getTemplate(this.template_id,{can_add_to_folders:AoPS.session.logged_in,placeholder:Lang["cat-admin-add-to-location-placeholder"],title:Lang["cat-admin-location-title"],lang_add_to:Lang["cat-admin-location-add-to"],lang_contained_in:Lang["cat-admin-location-contained-in"]})),this.$contained_in=this.$el.find(".cmty-admin-location-containers"),AoPS.session.logged_in&&(this.$input_box=this.$el.find("input"),Utils.buildCategoryAutocomplete(this.$input_box,{ajax_call:"fetch_containers_autocomplete",additional_ajax_settings:{item_type:this.model.get("category_type")},autocomplete_settings:{onSelect:function(t,o){e.parsePotentialNewContainer({item_id:o.item.category_id,item_text:o.item.label,item_type:"folder",item_forum_id:0,item_main_color:o.item.main_color,item_secondary_color:o.item.secondary_color,item_can_remove:o.item.can_remove,item_subtitle:o.item.short_description}),t.stopPropagation(),t.preventDefault()}},show_no_results_msg:!0})),this.itembox_view=new ComViews.Itembox({model:this.model.get("container_model"),check_can_remove:!0,can_remove_all:!1,onDeleteItem:function(t){e.onClickDeleteContainer(t)}}),this.$contained_in.append(this.itembox_view.$el)},parsePotentialNewContainer:function(e){var t=this;e.item_id===this.model.get("category_id")?AoPS.Ui.Modal.showAlertQuick(Lang["cat-admin-contents-no-adding-to-self"]):this.model.get("container_model").addItem({item:e,onError:function(o){"E_ALREADY_ADDED"===o.error_code&&AoPS.Ui.Modal.showAlert(Utils.formatString(Lang["cat-admin-location-exists"],[t.display_type,e.item_text]))}}),this.$input_box.val(""),this.$input_box.focus()},onClickDeleteContainer:function(e){var t=this;this.model.get("category_id")>0?AoPS.Ui.Modal.showConfirm(Lang["cat-admin-delete-container-1"]+" <b>"+e.item_text+"</b>?",function(o){o&&t.model.get("container_model").removeItem(e),AoPS.Ui.Modal.closeAllModals()},{width:"450px"}):t.model.get("container_model").removeItem(e)},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-location-help-title"],width:"600px",scrollable:!0})},validateNewCategorySettings:function(){return!0},onClose:function(){this.itembox_view.close()}}),ComViews.CategoryAdminBlockBlogSettings=AoPS.View.extend({template_id:"#cmty-category-admin-blog-extras-tpl",className:"aops-panel",initialize:function(){var e=["show_profile_info","show_stats","show_shoutbox","show_contributors","show_tags"],t=["blog_post_comment_text","blog_comments_text","blog_one_comment_text","blog_no_comments_text"],o=this,i=this.model.getPermission("c_can_edit_core_data");i&&(e.push("is_primary_blog"),this.model.set("is_primary_blog",this.model.get("category_id")===this.model.get("master").get("current_user").get("primary_blog_id"))),this.$el.html(this.getTemplate(this.template_id,{title:Lang["cat-admin-blog-settings-title"]})),_.each(t,function(e){i?o.buildEditableInputSetting(e):o.buildStaticSetting(e)}),this.intervals={},_.each(e,function(e){i?o.buildEditableBitSetting(e):o.buildStaticSetting(e)}),this.$help=$(this.getTemplate("#cmty-cat-admin-blog-settings-help-tpl",{}))},events:{"click .cmty-cat-admin-help":"onClickHelp"},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-blog-settings-help-title"],width:"600px",scrollable:!0})},buildSettingGroup:function(e){return $('<div class="form-group"><div><label>'+Lang["cat-admin-blog-label-"+e]+"</label></div>")},buildStaticSetting:ComViews.CategoryAdminBlockGeneralInfo.prototype.buildStaticSetting,buildEditableBitSetting:ComViews.CategoryAdminBlockGeneralInfo.prototype.buildEditableBitSetting,updateBitSetting:function(e,t){this.model.setBitBlogSetting({setting:e,value:1==parseInt(t),onError:function(e){ComViews.showError(Lang["change-blog-err-"+e.error_code])}})},buildEditableInputSetting:function(e){var t=this,o=this.buildSettingGroup(e),i=$('<input class="form-control" type="text" maxlength="'+Constants.max_blog_comments_text_length+'" value="'+this.model.get(e)+'">');i.on("input",function(o){t.prepareSaveInput(i,e)}),o.append($("<div></div>").append(i)),this.$el.append(o)},prepareSaveInput:function(e,t){var o=this,i=e.val();this.intervals.hasOwnProperty(t)&&clearTimeout(this.intervals[t]),this.intervals[t]=setTimeout(function(){o.saveInput(t,i)},Constants.cat_admin_save_input_delay)},saveInput:function(e,t){this.model.setStringBlogSetting({setting:e,value:t,onFinish:function(t){AoPS.Ui.Flyout.close(),AoPS.Ui.Flyout.display(Lang["cat-admin-blog-label-"+e]+" "+Lang.saved+".")},onError:function(e){ComViews.showError(Lang["change-blog-err-"+e.error_code])}})},validateNewCategorySettings:function(){
return!0}}),ComViews.CategoryAdminBlockBlogCss=AoPS.View.extend({template_id:"#cmty-cat-admin-blog-css-tpl",className:"aops-panel",initialize:function(){var e,t=this,o=this.model.get("category_id")>0,i=o&&this.model.getPermission("c_can_edit_core_data");e=o?i?Lang["cat-admin-blog-css-existing-info"]:this.model.has("css")&&this.model.get("css").length>0?Lang["cat-admin-blog-css-no-perm"]:"":Lang["cat-admin-blog-css-new-info"],this.$el.html(this.getTemplate(this.template_id,{title:Lang["cat-admin-blog-css-title"],blog_exists:o,blog_message:e,Save:Lang.Save,Reset:Lang.Reset,Delete:Lang.Delete,content:this.model.has("css")?this.model.get("css"):Lang["cat-admin-blog-css-default-css"],can_edit:i,placeholder:i?Lang["cat-admin-blog-css-enter"]:Lang["cat-admin-blog-css-none"]})),this.$css=this.$("textarea"),i&&(this.$css.on("keyup",function(){t.onKeyPress()}),this.$save=this.$(".cmty-cat-admin-blog-css-save"),this.$reset=this.$(".cmty-cat-admin-blog-css-reset"),this.$delete=this.$(".cmty-cat-admin-blog-css-delete"),this.resetButtonVisibility()),this.$help=$(this.getTemplate("#cmty-cat-admin-blog-css-help-tpl",{}))},validateNewCategorySettings:function(){return!0},events:{"click .cmty-cat-admin-blog-css-save":"onClickSave","click .cmty-cat-admin-blog-css-reset":"onClickReset","click .cmty-cat-admin-blog-css-delete":"onClickDelete","click .cmty-cat-admin-help":"onClickHelp"},onClickHelp:function(){this.$help.showModal({frame_class:"cmty-cat-admin-helper-modal aops-modal-standard",title:Lang["cat-admin-blog-css-help-title"],width:"600px",scrollable:!0})},onKeyPress:function(){this.$save.show(),this.$reset.show()},resetButtonVisibility:function(){this.$reset.hide(),this.$save.hide(),this.$delete.toggle(this.model.has("css")&&this.model.get("css").length>0)},onClickReset:function(){var e=this.model.has("css")?this.model.get("css"):"";this.$css.val(e),this.resetButtonVisibility()},onClickSave:function(){var e=this,t=e.$css.val();Modal.showConfirm(Lang["cat-admin-blog-css-save-sure"],function(o){o?(ComViews.throwBlockingMessage(Lang["cat-admin-blog-css-save-block"]),e.model.setNewCss({new_css:e.$css.val(),onFinish:function(){e.model.set("css",t),e.resetButtonVisibility(),setTimeout(function(){Modal.closeAllModals()},500)},onError:function(t){e.throwEditError(t)}})):Modal.closeAllModals()},{close_on_button_click:!1,width:"450px"})},throwEditError:function(e){var t;t="E_NO_PERMISSION"===e.error_code?Lang["cat-admin-blog-css-no-perm-err"]:Lang["unexpected-error-code"]+e.error_code,AoPS.Community.Views.showError(t)},onClickDelete:function(){var e=this;Modal.showConfirm(Lang["cat-admin-blog-css-delete-sure"],function(t){t?(ComViews.throwBlockingMessage(Lang["cat-admin-blog-css-delete-block"]),e.model.deleteCss({onFinish:function(){e.$css.val(""),e.model.unset("css"),e.resetButtonVisibility(),setTimeout(function(){Modal.closeAllModals()},500)},onError:function(t){e.throwEditError(t)}})):Modal.closeAllModals()},{close_on_button_click:!1,width:"450px"})}}),ComViews}(AoPS.Community.Views||{}),AoPS.Feed=function(e){var t=AoPS.Community.Lang;AoPS.Community.Utils;return e.preloaded_topic=null,e.preload_feed_tag_id=0,e.preload_feed_tag_text="",e.constructFeed=function(){var e,t;if(AoPS.Community.is_active)return"object"==typeof this.community_master?{community_master:this.community_master,feed_master:this.feed_master,feed_view:this.feed_view}:(AoPS.Community.hasOwnProperty("MasterModel")||(AoPS.Community.MasterModel=new AoPS.Community.Models.Master({in_community:!1})),this.community_master=AoPS.Community.MasterModel,this.feed_master=new AoPS.Community.Models.Feed({master:this.community_master}),this.feed_view=new AoPS.Feed.Views.FeedMaster({model:this.feed_master}),AoPS.Feed.Master=this.feed_master,AoPS.bootstrap_data.hasOwnProperty("preload_feed_focus_topic")&&(AoPS.Feed.preloaded_topic=this.community_master.processPotentialNewTopic(AoPS.bootstrap_data.preload_feed_focus_topic)),AoPS.bootstrap_data.hasOwnProperty("preload_feed_tag_id")&&(AoPS.Feed.preload_feed_tag_id=parseInt(AoPS.bootstrap_data.preload_feed_tag_id)),AoPS.bootstrap_data.hasOwnProperty("preload_feed_tag_text")&&(AoPS.Feed.preload_feed_tag_text=AoPS.bootstrap_data.preload_feed_tag_text),_.isNull(AoPS.Feed.preloaded_topic)||(e=AoPS.Feed.preloaded_topic.get("category_id"),this.feed_view.$el.addClass("feed-preloaded-topic")),$("body").append(this.feed_view.$el),_.isNull(AoPS.Feed.preloaded_topic)||(t="string"==typeof AoPS.bootstrap_data.page_feed_preload_title?AoPS.bootstrap_data.page_feed_preload_title:"Linked Item Topics",this.openPageFeed({category_id:e,tag_id:AoPS.Feed.preload_feed_tag_id,tag_text:AoPS.Feed.preload_feed_tag_text,subtitle:t}),this.feed_master.set("focus_topic",AoPS.Feed.preloaded_topic)),{community_master:this.community_master,feed_master:this.feed_master,feed_view:this.feed_view})},e.setPageFeedSubtitle=function(e){var t;AoPS.Community.is_active&&(t=this.feed_view.page_subfeed.view.$el.find(".feed-subtitle"),this.feed_master.get("page_subfeed_settings").subtitle=e,0===e.length?this.feed_view.page_subfeed.view.$el.find(".feed-subtitle").remove():t.length>0?t.html(e):(t='<div class="feed-subtitle">'+e+"</div>",this.feed_view.page_subfeed.view.$el.find(".feed-subfeed-header").after(t)))},e.setPageFeed=function(e){var t,o=!1;if(AoPS.Community.is_active){if(t=this.feed_master.get("page_subfeed_settings"),this.feed_view.$el.removeClass("feed-hide-page-feed"),"number"==typeof arguments[0]){if(0===e)return;e={category_id:arguments[0]},1===arguments.length?e.tag_id=0:("number"==typeof arguments[1]?e.tag_id=arguments[1]:e.tag_text=arguments[1],3===arguments.length&&(e.subtitle=arguments[2]))}else e=_.extend({tag_id:0,subtitle:""},e);return t.hasOwnProperty("category_id")&&e.hasOwnProperty("category_id")&&t.category_id===e.category_id?e.hasOwnProperty("tag_id")&&e.tag_id>0?t.hasOwnProperty("tag_id")&&parseInt(t.tag_id)===e.tag_id||(o=!0):e.hasOwnProperty("tag_text")&&e.tag_text.length>0?t.hasOwnProperty("tag_text")&&t.tag_text===e.tag_text||(o=!0):t.hasOwnProperty("tag_id")&&parseInt(t.tag_id)>0&&(o=!0):o=!0,o&&this.feed_master.set("page_subfeed_settings",e),o}},e.hidePageFeed=function(){AoPS.Community.is_active&&(this.feed_view.$el.addClass("feed-hide-page-feed"),this.feed_view.page_subfeed===this.feed_view.active_subfeed&&this.feed_view.closeFeed())},e.closePageFeed=function(){AoPS.Community.is_active&&this.feed_view.page_subfeed===this.feed_view.active_subfeed&&(AoPS.Feed.feed_master.set("focus_topic",null),this.feed_view.closeFeed())},e.openPageFeed=function(e){if(!AoPS.Community.is_active)return void AoPS.Ui.Modal.showAlert(t["err-community-disabled"]);if("number"==typeof arguments[0]){if(0===e)return;e={category_id:arguments[0],subtitle:""},1===arguments.length?e.tag_id=0:"number"==typeof arguments[1]?e.tag_id=arguments[1]:(e.tag_id=0,e.tag_text=arguments[1]),3===arguments.length&&(e.subtitle=arguments[2])}else e=_.extend({tag_id:0},e);this.setPageFeed(e)||!AoPS.Feed.feed_view.isPageSubfeedOpen()||e.hasOwnProperty("force_open")&&e.force_open?this.activatePageSubfeed():this.closePageFeed()},e.activatePageSubfeed=function(){this.feed_view.activatePageSubfeed(),this.feed_view.showFeed()},e.activateGlobalSubfeed=function(){"object"==typeof this.feed_view.global_subfeed&&this.feed_view.openFeed(this.feed_view.global_subfeed,0)},e.startNewTopic=function(e){if(!AoPS.Community.is_active)return void AoPS.Ui.Modal.showAlert(t["err-community-disabled"]);if(0===e.category_id)return void AoPS.Community.Views.showError(t["feed-no-forum"]);var o=this.community_master.fetchCategory(e.category_id),i=_.extend({tags:[],target_url:"",target_text:"",subtitle:"",content:"",linked_tag:"",filter_tag:"",hidden_tags:[],restricted_tags:[],onSuccess:function(){}},e);AoPS.session.logged_in?AoPS.isUserLimited()?AoPS.Ui.Modal.showMessage(t["cat-cell-no-perm-limited-user"],{width:"450px"}):_.isUndefined(o)?AoPS.Ui.Modal.showMessage(t["new-topic-no-category"]):o.getPermission("c_can_start_topic")||o.getPermission("c_undo_global_ban")?(""!==i.linked_tag&&(i.tags=_.without(i.tags,i.linked_tag),i.tags.push(i.linked_tag)),i.special_item=i.linked_tag,delete i.linked_tag,i.model=o,i.filter_tag=i.filter_tag.length>0?i.filter_tag:i.target_url,i.master=this.community_master,new AoPS.Feed.Views.NewTopic(i)):AoPS.Ui.Modal.showMessage(t["cat-cell-no-perm-start-topic"]):AoPS.Ui.buildLoginConfirm(t["new-topic-not-logged-in"])},e.buildNewTopicButton=function(e){var t=$('<div class="new-topic-btn" title="Start topic about this">V</div>');return this.activateNewTopicButton(_.extend({$button:t},e))},e.activateNewTopicButton=function(e){return e.$button.on("click",function(){AoPS.Feed.startNewTopic(e)}),e.$button},e.buildOpenFeedButton=function(e){var t=$('<div class="open-feed-btn" title="View discussions about this">t</div>');return this.activateOpenFeedButton(_.extend({$button:t},e))},e.activateOpenFeedButton=function(e){return e.$button.on("click",function(){AoPS.Feed.openPageFeed(e)}),e.$button},e.onFeedRoute=function(t){_.isNull(t)&&(t=""),"/"===t.substr(0,1)&&(t=t.substr(1)),AoPS.Community.hasOwnProperty("MasterModel")||e.constructFeed(),Backbone.history.navigate(t,{trigger:!0,replace:!0});var o=AoPS.Community.MasterModel.get("focus_topic");_.isNull(o)||(AoPS.Feed.activatePageSubfeed(),AoPS.Feed.feed_master.set("focus_topic",o)),AoPS.Community.MasterModel.set("focus_topic",null)},e.openTopic=function(e){if(AoPS.Community.is_active){var t=AoPS.Community.MasterModel.fetchTopicById(e),o=this,i=AoPS.Feed.feed_master.get("focus_topic");return(!_.isNull(i)&&e===i.get("topic_id")||AoPS.Feed.feed_view.past_topic_id===e)&&AoPS.Feed.feed_view.isPageSubfeedOpen()?void this.closePageFeed():void(_.isNull(t)||_.isUndefined(t)?(AoPS.Feed.activatePageSubfeed(),this.feed_view.throwTopicBlocker(),t=AoPS.Community.MasterModel.fetchTopicFromDb({topic_id:e,onFinish:function(e){AoPS.Feed.feed_master.set("focus_topic",e.topic,{no_ajax_override:!0})},onError:function(e){o.onTopicError(e)}})):(AoPS.Feed.activatePageSubfeed(),AoPS.Feed.feed_master.set("focus_topic",t,{no_ajax_override:!0})))}},e.onTopicError=function(e){var o;switch(e.error_code){case"E_NO_SUCH_TOPIC":o=t["feed-no-topic"];break;case"E_NO_PERMISSION":o=t["feed-no-read-permission"];break;default:o=AoPS.Community.Utils.formatString(t["err-unknown"],[e.error_code])}AoPS.Feed.feed_view.cleanTopicWindow(),AoPS.Community.Views.showError(o)},e.openTopicSetFeed=function(e){if(AoPS.Community.is_active){var t,o=arguments[0],i=!1,s=this,a=AoPS.Feed.feed_view.isPageSubfeedOpen(),n=Array.prototype.slice.apply(arguments).slice(1),r=AoPS.Feed.feed_master.get("focus_topic");if(t=this.setPageFeed.apply(this,n),(!_.isNull(r)&&r.get("topic_id")===o||AoPS.Feed.feed_view.past_topic_id===o)&&a&&!t)return void this.closePageFeed();AoPS.Feed.feed_view.feed_open||(this.openPageFeed.apply(this,n),i=!0),this.activatePageSubfeed(),i?setTimeout(function(){s.openTopic(o)},1.1*AoPS.Feed.feed_view.animate_speed):this.openTopic(o)}},e}(AoPS.Feed||{}),AoPS.Feed=AoPS.Feed||{},AoPS.Feed.Views=function(e){var t=AoPS.Community.Lang,o=AoPS.Community.Utils,i=AoPS.Ui.Flyout;return e.processFeedTopicIsReadChange=function(t){t.topic.get("is_read")&&t.$button.hasClass("feed-subfeed-new-topic")&&e.checkSubfeedUnread(t)},e.checkSubfeedUnread=function(e){e.list.length>AoPS.Community.Constants.max_length_feed_list_read_check||(unread_topic=e.list.findWhere({is_read:!1}),_.isUndefined(unread_topic)?e.$button.removeClass("feed-subfeed-new-topic"):e.list.length>0&&e.$button.addClass("feed-subfeed-new-topic"))},e.FeedMaster=AoPS.View.extend({template_id:"#feed-master-tpl",feed_open:!1,animate_speed:200,active_subfeed:null,active_topic_view:null,id:"feed-wrapper",topic_views:[],subfeeds:[],has_page_feed:!1,cached_page_subfeed_views:{},initialize:function(){var e=this;this.$el.html(this.getTemplate(this.template_id,{})),this.$tabs=this.$el.find("#feed-tabs"),this.$topics_list=this.$el.find("#feed-topic-list"),this.$topic=this.$el.find("#feed-topic"),this.$topic_loader=AoPS.Page.buildLoader(),this.$el.on("mousedown",function(e){e.stopPropagation()}),e.past_topic_id=0,$("body").on("click.feed",function(t){e.past_topic_id=0}),this.feed_animated=!1,this.community_master=this.model.get("master"),this.model=this.community_master.get("feed"),this.constructSubfeeds(),this.listenTo(this.model,"change:focus_topic",this.buildTopic),this.listenTo(this.community_master.get("current_user"),"change:show_tags_on_feed",this.processShowTags),this.processShowTags(),this.listenTo(this.model,"change:page_subfeed_settings",this.onNewPageSubfeed),this.listenTo(this.community_master,"change:fullscreen_mode",function(t){"feed"===e.community_master.previous("fullscreen_mode")?e.offFullscreen():"feed"===e.community_master.get("fullscreen_mode")&&e.onFullscreen()}),this.setVisibility(),AoPS.session.logged_in&&this.listenTo(this.community_master.get("current_user"),"change:hide_feed",this.setVisibility),this.community_master.get("current_user").get("hide_avatars")&&this.$el.addClass("cmty-hide-avatars"),this.listenTo(this.community_master.get("current_user"),"change:hide_avatars",function(){e.$el.toggleClass("cmty-hide-avatars",e.community_master.get("current_user"))}),this.listenTo(Backbone,"community_disabled",this.onCommunityDisabled),this.listenTo(Backbone,"close_feed_topic",this.onTriggerCloseFeedTopic),o.startIdleMonitor(),o.activateLatexOnclick()},events:{"click .feed-subfeed-header":"closeFeed","click .feed-resort":"onClickResort"},onCommunityDisabled:function(){i.display(t["feed-community-disabled"]),this.hideFeed()},onFullscreen:function(){this.$topic.left_css=this.$topic.is_dragged?this.$topic.css("left"):"",this.$topic.top_css=this.$topic.is_dragged?this.$topic.css("top"):"",this.$topic.css({left:"",top:""}),this.$topic.draggable("disable")},offFullscreen:function(){this.$topic.css({left:this.$topic.left_css,top:this.$topic.top_css}),this.$topic.draggable("enable")},setVisibility:function(){AoPS.session.logged_in&&1==this.community_master.get("current_user").get("hide_feed")?this.hideFeed():this.showFeed()},processShowTags:function(){this.$el.toggleClass("cmty-show-feed-tags",this.community_master.get("current_user").get("show_tags_on_feed"))},hideFeed:function(){this.$el.addClass("feed-hidden")},showFeed:function(){AoPS.Community.is_active&&this.$el.removeClass("feed-hidden")},onTriggerCloseFeedTopic:function(){this.model.set("focus_topic",null),"feed"===this.community_master.get("fullscreen_mode")&&(this.community_master.set("fullscreen_mode","none"),$(window).trigger("resize"))},constructSubfeeds:function(){var e,o,i,s=[];for(this.global_subfeed=this.addSubfeed({header_text:t["feed-global-subfeed-header"],id:"feed-global-tab",title:"full"===this.model.get("global_feed_type")?t["feed-tab-global-title"]:t["feed-tab-global-custom-title"],icon_letter:"a",category:new AoPS.Community.Models.CategoryGlobal({master:this.community_master})}),AoPS.session.logged_in&&(this.addSubfeed({header_text:t["feed-ego-subfeed-header"],id:"feed-egosearch-tab",title:t["feed-tab-my-topics-title"],icon_letter:"w",category:new AoPS.Community.Models.CategoryUsersTopics({master:this.community_master,user_id:AoPS.session.user_id})}),e=this.community_master.fetchCategory(1),this.addSubfeed({header_text:t["feed-messages-subfeed-header"],id:"feed-privates-tab",title:t["feed-tab-private-title"],icon_letter:"m",can_post:!0,can_post_title:t["feed-new-private-conversation"],category:e,onClickNewTopic:_.bind(function(){e.getPermission("c_can_start_topic")||e.getPermission("c_undo_global_ban")?this.launchNewPrivate():AoPS.Ui.Modal.showMessage(t[AoPS.isUserLimited()?"new-pm-no-permission-limited":"new-pm-no-permission"],{width:"450px"})},this)}),this.constructBookmarksSubfeed()),i=0;i<this.subfeeds.length;i++)o=this.subfeeds[i].view.topics_list_view,s.push(o.collection.constructAjaxCall(o.constructFetchMoreTopicsOptions()));this.hasOwnProperty("bookmark_subfeed")&&(o=this.bookmark_subfeed.view.active_subfeed.topics_list_view,s.push(o.collection.constructAjaxCall(o.constructFetchMoreTopicsOptions()))),this.model.fetchInitialSubfeedTopics(s)},launchNewPrivate:function(){var t=this.community_master.fetchCategory(1);new e.NewPrivateConversation({category_name:"",category_id:1,model:t,master:this.community_master})},removeSubfeedListeners:function(e){e.view.stopListening(e.view.filtered_list)},addSubfeedListeners:function(e){var t=this;e.view.hasOwnProperty("filtered_list")&&(e.view.listenTo(e.view.filtered_list,"add",function(o){t.active_subfeed!==e&&(o.get("is_read")||e.$button.addClass("feed-subfeed-new-topic"))}),e.view.listenTo(e.view.filtered_list,"change:is_read",function(t){AoPS.Feed.Views.processFeedTopicIsReadChange({topic:t,list:e.view.filtered_list,$button:e.$button})}))},addSubfeed:function(t){var o={$button:$("<div>",{id:t.id,"class":"feed-tab aops-font",text:t.icon_letter,title:t.title}),view:{}},i=this;return this.$tabs.append(o.$button),o.view=new e.Subfeed(_.defaults({model:t.category},t)),o.$button.on("click",function(){i.onButtonClick(o)}),this.addSubfeedListeners(o),this.subfeeds.push(o),o},onButtonClick:function(e){this.model.get("initialized")&&(this.feed_animated||(this.feed_open?this.active_subfeed===e?this.closeFeed():(this.closeSubfeed(this.active_subfeed),this.activateSubfeed(e,0)):this.openFeed(e)))},closeSubfeed:function(e){this.stopListening(Backbone,"topic_cell_marked_for_deletion"),e.view.$el.detach(),e.view.hasOwnProperty("topics_list_view")&&("function"==typeof e.view.topics_list_view.processUpdatedTopicVisibility&&e.view.topics_list_view.processUpdatedTopicVisibility(),e.view.topics_list_view.on_page=!1),e.view.$(".feed-resort").hide(),this.model.set("focus_topic",null),_.isNull(this.active_topic_view)||(this.active_topic_view.onRemoveFromFeed(),this.active_topic_view=null),e.$button.removeClass("feed-subfeed-button-selected")},activateSubfeed:function(e,t){var o=this;e!==this.active_subfeed&&(_.isUndefined(e.view.topics_list_view)||_.isUndefined(e.view.topics_list_view.collection)||!_.isUndefined(e.view.topics_list_view.collection.topics_loading)&&e.view.topics_list_view.collection.topics_loading||AoPS.Community.Utils.cmty_ajax.cancelAll({cancel_type:"feed"}),this.revealSubfeedView(e),_.isNull(this.active_subfeed)?e.$button.addClass("feed-subfeed-button-selected"):this.active_subfeed.$button!=e.$button&&(this.active_subfeed.$button.removeClass("feed-subfeed-new-topic"),e.$button.addClass("feed-subfeed-button-selected")),this.active_subfeed=e,this.topic_cell_delete_listener=this.listenTo(Backbone,"topic_cell_marked_for_deletion",function(e){o.active_subfeed.view.topics_list_view===e.topics_list&&o.active_subfeed.view.$(".feed-resort").show()}))},revealSubfeedView:function(e){this.$topics_list.append(e.view.$el),e.view.hasOwnProperty("topics_list_view")&&"function"==typeof e.view.topics_list_view.onAddToFeed&&e.view.topics_list_view.onAddToFeed()},openFeed:function(e){var t=this;this.feed_animated||(this.activateSubfeed(e,this.animate_speed),this.feed_animated=!0,t.feed_open=!0,this.$el.addClass("feed-open",{duration:this.animate_speed,complete:function(){t.feed_animated=!1}}),this.community_master.hasLongNewItemInterval()&&(AoPS.Community.Constants.new_item_check_interval=AoPS.Community.Constants.new_item_check_interval_short))},closeFeed:function(){var e=this;this.feed_animated||(AoPS.Community.Utils.cmty_ajax.cancelAll({cancel_type:"feed"}),_.isNull(this.active_subfeed)||this.active_subfeed.$button.removeClass("feed-subfeed-button-selected"),this.feed_animated=!0,this.$el.removeClass("feed-open",this.animate_speed,"swing",_.bind(function(){_.isNull(this.active_subfeed)||(this.closeSubfeed(this.active_subfeed),this.active_subfeed=null,e.feed_animated=!1)},this)),this.model.set("focus_topic",null),this.feed_open=!1,this.community_master.hasLongNewItemInterval()&&(AoPS.Community.Constants.new_item_check_interval=AoPS.Community.Constants.new_item_check_interval_long))},onClickResort:function(e){this.resortActiveSubfeed(),$(e.currentTarget).hide(),e.stopPropagation(),e.preventDefault()},resortActiveSubfeed:function(){_.isNull(this.active_subfeed)||(this.active_subfeed.view.topics_list_view.processUpdatedTopicVisibility(),this.active_subfeed.view.topics_list_view.setPopoutVisibility())},constructBookmarksSubfeed:function(){var o={$button:$("<div>",{id:"feed-bookmark-tab",text:"E",title:t["feed-tab-bookmark-title"],"class":"feed-tab aops-font"}),name:"bookmarks",view:{}};o.view=new e.Bookmarks({model:this.model,feed_view:this,parent_subfeed_object:o}),this.$tabs.append(o.$button),o.$button.on("click",_.bind(function(){this.onButtonClick(o)},this)),this.bookmark_subfeed=o},closeActiveTopicView:function(){this.active_topic_view.onRemoveFromFeed(),this.active_topic_view.$el.detach(),this.active_topic_view=null},cleanTopicWindow:function(){var e=!_.isNull(this.active_topic_view),t=this.model.get("focus_topic");this.$topic_loader.detach(),e&&this.closeActiveTopicView(),this.$topic.empty(),_.isNull(t)&&(this.$topic.hide(),$("body").off("mousedown.feed"))},throwTopicBlocker:function(){this.cleanTopicWindow(),this.openTopicWindow(),this.$topic.append(this.$topic_loader)},openTopicWindow:function(){var e=this;this.$topic.show(),this.$topic.data("draggable")||(this.$topic.is_dragged=!1,this.$topic.draggable({containment:"window",drag:function(){e.$topic.is_dragged=!0}}))},buildTopic:function(){var t,o,i=this,s=!1,a=!_.isNull(this.active_topic_view),n=this.model.get("focus_topic");this.cleanTopicWindow(),_.isNull(n)||(t=_.find(this.topic_views,function(e){return e.model===n}),o={model:n,route_category_id:n.get("category_id"),reveal_type:this.model.get("focus_topic_show_from")},_.isUndefined(t)||t.route_category_id!==n.get("category_id")&&(this.topic_views=_.without(this.topic_views,t),t.close(),s=!0),(_.isUndefined(t)||s)&&(t=new e.TopicFull(o),this.topic_views.push(t)),this.active_topic_view=t,this.openTopicWindow(),a||$("body").on("mousedown.feed",function(){AoPS.Ui.Modal.isModalVisible()||(_.isNull(i.model.get("focus_topic"))||(i.past_topic_id=i.model.get("focus_topic").get("topic_id")),i.model.set("focus_topic",null))}),this.$topic.append(this.active_topic_view.$el),this.active_topic_view.onAddToFeed(o))},onNewPageSubfeed:function(){this.has_page_feed||this.constructPageSubfeed(),this.setPageSubfeed(),this.page_subfeed.$button.removeClass("feed-subfeed-new-topic"),this.page_subfeed.view.hasOwnProperty("topics_list_view")&&(_.isUndefined(this.page_subfeed.view.topics_list_view.collection.findWhere({is_read:!1}))||this.page_subfeed.$button.addClass("feed-subfeed-new-topic"))},constructPageSubfeed:function(){var e=this;this.page_subfeed={$button:$("<div>",{id:"feed-page-tab","class":"feed-tab aops-font",text:"p",title:t["feed-tab-page-feed-title"]})},this.page_subfeed.$button.on("click",function(){e.onButtonClick(e.page_subfeed)}),this.$tabs.find(".feed-tab").first().after(this.page_subfeed.$button),this.subfeeds.push(this.page_subfeed),this.page_subfeed_settings={category_id:0,tag_id:0,tag_text:""},this.page_subfeed_loader=this.constructPageSubfeedView(null,this.page_subfeed_settings),this.page_subfeed.view=this.page_subfeed_loader,this.has_page_feed=!0},constructPageSubfeedView:function(o,i){var s,a={header_text:t["feed-page-subfeed-header"],can_post:!1,can_post_title:"",re_sort_feed:t["feed-resort"],close_feed:t["feed-close"],has_settings:!1};return _.isNull(o)?(s=$('<div class="cmty-subfeed"></div>').append(this.getTemplate("#feed-subfeed-header-tpl",a)),s.append(AoPS.Page.buildLoader()),subfeed_view={$el:s,stopListening:function(){}}):(subfeed_view=new e.Subfeed(_.defaults({model:o,tag_id:i.tag_id,subtitle:i.hasOwnProperty("subtitle")?i.subtitle:""},a)),subfeed_view.filtered_list.topics_loading||0!=subfeed_view.topics_list_view.collection.length||subfeed_view.topics_list_view.fetchMoreTopics(),this.cachePageSubfeedView(subfeed_view,i)),subfeed_view},cachePageSubfeedView:function(e,t){var o=AoPS.Community.Views.convertToUrlFragment(t.tag_text);this.cached_page_subfeed_views[t.category_id+"-"+t.tag_id+"-"+o]=e,o.length>0&&t.tag_id>0&&(this.cached_page_subfeed_views[t.category_id+"-0-"+o]=e,this.cached_page_subfeed_views[t.category_id+t.tag_id+"-"]=e)},setPageSubfeed:function(){var e,t,o=this;this.isNewPageSubfeed()&&(this.removeSubfeedListeners(this.page_subfeed),this.page_subfeed.view.hasOwnProperty("$el")&&this.page_subfeed.view.$el.detach(),new_settings=this.cleanPageSubfeedSettings(this.model.get("page_subfeed_settings")),t=this.fetchCachedPageSubfeed(new_settings),_.isNull(t)?(e=this.community_master.fetchCategory(new_settings.category_id),_.isUndefined(e)?(this.page_subfeed.view=this.page_subfeed_loader,new_settings.tag_id>0||""===new_settings.tag_text?this.community_master.buildCategory({category_id:new_settings.category_id,onFinish:function(){o.setPageSubfeed()}}):this.community_master.buildCategoryAndTag({category_id:new_settings.category_id,tag_text:new_settings.tag_text,onFinish:function(e){new_settings.tag_id=e.tag_id,o.model.set("page_subfeed_settings",new_settings)}})):0===new_settings.tag_id&&""!==new_settings.tag_text?this.community_master.fetchTagId({tag_text:new_settings.tag_text,onFinish:function(e){new_settings.tag_id=e.tag_id,o.model.set("page_subfeed_settings",new_settings)}}):this.page_subfeed.view=this.constructPageSubfeedView(e,new_settings)):(this.page_subfeed.view=t,AoPS.Feed.setPageFeedSubtitle(new_settings.hasOwnProperty("subtitle")?new_settings.subtitle:"")),this.addSubfeedListeners(this.page_subfeed),this.active_subfeed===this.page_subfeed&&this.revealSubfeedView(this.page_subfeed))},isPageSubfeedOpen:function(){return this.feed_open&&this.isPageSubfeedActive()},isPageSubfeedActive:function(){return this.active_subfeed===this.page_subfeed},activatePageSubfeed:function(){this.feed_open?(this.isPageSubfeedActive()||_.isNull(this.active_subfeed)||this.closeSubfeed(this.active_subfeed),this.activateSubfeed(this.page_subfeed,0)):this.openFeed(this.page_subfeed)},isNewPageSubfeed:function(){var e=this.cleanPageSubfeedSettings(this.model.get("page_subfeed_settings")),t=this.cleanPageSubfeedSettings(this.page_subfeed_settings);return e.category_id!==t.category_id?!0:(0===e.tag_id&&t.tag_id>0&&e.tag_text===t.tag_text&&(this.model.get("page_subfeed_settings").tag_id=t.tag_id),0===e.tag_id||t.tag_id?e.tag_text!==t.tag_text:e.tag_id!==t.tag_id)},cleanPageSubfeedSettings:function(e){return _.extend({category_id:0,tag_id:0,tag_text:""},e)},fetchCachedPageSubfeed:function(e){var t=AoPS.Community.Views.convertToUrlFragment(e.tag_text),o=e.category_id+"-"+e.tag_id+"-";if(0!==e.tag_id){if(this.cached_page_subfeed_views.hasOwnProperty(o))return this.cached_page_subfeed_views[o];if(o+=t,this.cached_page_subfeed_views.hasOwnProperty(o))return this.cached_page_subfeed_views[o]}return o=e.category_id+"-0-"+t,this.cached_page_subfeed_views.hasOwnProperty(o)?this.cached_page_subfeed_views[o]:null},onClose:function(){_.each(this.subfeeds,function(e){e.view.close()}),_.each(_.properties(this.cached_page_subfeed_views),function(e){e.close()})}}),e.Subfeed=AoPS.View.extend({className:"cmty-subfeed",initialize:function(o){var i,s=o.hasOwnProperty("subtitle")&&o.subtitle.length>0,a=o.hasOwnProperty("tag_id")&&o.tag_id>0?[{tag_forum_id:this.model.get("category_id"),tag_id:o.tag_id}]:[];if(this.settings=o,this.community_master=this.model.get("master"),a.length>0){var i=new AoPS.Community.Models.CategoryViewTags({category_id:0,master:this.community_master,permissions:this.model.get("permissions"),category_type:"view_tags",items:[{item_forum_id:a[0].tag_forum_id,item_id:a[0].tag_id}]}),n=i.get("active_topics");if(this.model.get("active_topics").each(function(e){e.hasTag(o.tag_id)&&n.add(e)}),AoPS.Feed.preload_feed_tag_id>0&&AoPS.Feed.preload_feed_tag_id===o.tag_id&&!_.isNull(AoPS.Feed.preloaded_topic)){var r=this.community_master.processPotentialNewTopics(AoPS.bootstrap_data.page_feed_preload_topics,!1);n.add(r),i.set("all_topics_loaded",AoPS.bootstrap_data.page_feed_all_topics_fetched)}this.filtered_list=this.community_master.fetchFilteredTopicList({category:i,category_id:0})}else this.filtered_list=this.community_master.fetchFilteredTopicList({category:this.model,category_id:this.model.get("category_id"),tag_ids:a});this.topics_list_view=new e.TopicsList({collection:this.filtered_list,main_color:this.model.get("main_color"),secondary_color:this.model.get("secondary_color"),category_id:0,master:this.community_master}),this.$el.append(this.getTemplate("#feed-subfeed-header-tpl",{header_text:o.header_text,can_post:o.hasOwnProperty("can_post")?o.can_post:!1,can_post_title:o.hasOwnProperty("can_post_title")?o.can_post_title:"",has_settings:!1,has_subtitle:s,close_feed:t["feed-close"],re_sort_feed:t["feed-re-sort"],subtitle:o.hasOwnProperty("subtitle")?o.subtitle:""})),s&&this.$el.addClass("cmty-subfeed-w-subtitle"),this.$el.append(this.topics_list_view.$el)},events:{"click .feed-new-topic":"onClickNewTopic"},onClickNewTopic:function(e){return this.settings.hasOwnProperty("onClickNewTopic")&&this.settings.onClickNewTopic(),e.stopPropagation(),e.preventDefault(),!1},onClose:function(){this.topics_list_view.close()}}),e.Bookmarks=AoPS.View.extend({subfeed_array:[],template_id:"#feed-bookmarks-tpl",className:"cmty-subfeed cmty-subfeed-w-subtitle",initialize:function(e){var o,i,s=this;for(this.parent_subfeed_object=e.parent_subfeed_object,this.feed_view=e.feed_view,this.feed_bookmark_categories=[],this.$el.html(this.getTemplate("#feed-subfeed-header-tpl",{header_text:t["feed-bookmarks-subfeed-header"],has_settings:!1})),this.$el.append(this.getTemplate(this.template_id,{forums_checked:1&this.model.get("feed_setting"),tags_checked:2&this.model.get("feed_setting"),topics_checked:4&this.model.get("feed_setting")})),this.$checkboxes=this.$el.find(":checkbox"),this.community_master=this.model.get("master"),this.feed_bookmark_categories[1]=this.buildFeedCategory("tag"),this.feed_bookmark_categories[2]=this.buildFeedCategory("topic"),this.feed_bookmark_categories[4]=this.buildFeedCategory("forum"),o=3;7>=o;o++)4!==o&&(i=[],_.each([1,2,4],function(e){e&o&&i.push(s.feed_bookmark_categories[e])}),this.feed_bookmark_categories[o]=new AoPS.Community.Models.CategoryConglomeration({master:this.community_master,categories:i}));for(this.subfeed_array[0]={is_built:!0,topics_list_view:{$el:$('<div class="feed-no-bookmarks">'+t["feed-no-bookmark-options-checked"]+"</div>"),no_bookmarks_checked:!0}},o=1;7>=o;o++)this.subfeed_array[o]={is_built:!1};this.constructTopicsListView(this.model.get("feed_setting")),this.active_subfeed=this.subfeed_array[this.model.get("feed_setting")],this.$el.append(this.active_subfeed.topics_list_view.$el),this.topics_list_view=this.active_subfeed.topics_list_view,this.model.get("feed_setting")>0&&this.startListeningToActiveList()},constructTopicsListView:function(t){var o,i;i=this.community_master.constructTopicListFilter({category:this.feed_bookmark_categories[t]}),o=new AoPS.Community.Models.TopicList({category:this.feed_bookmark_categories[t],master:this.community_master,tag_ids:[],filter:i}),this.subfeed_array[t].filtered_list=o.get("filtered_topic_list"),this.subfeed_array[t].topics_list_view=new e.TopicsListBookmarks({collection:this.subfeed_array[t].filtered_list,main_color:this.feed_bookmark_categories[t].get("main_color"),secondary_color:this.feed_bookmark_categories[t].get("secondary_color"),category_id:0,master:this.community_master}),this.subfeed_array[t].is_built=!0},events:{"click :checkbox":"onCheckboxClick"},onCheckboxClick:function(e){for(var t=0,o=this.$checkboxes,i=0;2>=i;i++)o[i].checked&&(t+=parseInt(o[i].value));this.model.set("feed_setting",t),this.onBookmarkSettingChange()},onBookmarkSettingChange:function(){var e=this.model.get("feed_setting");this.$(".feed-resort").hide(),this.stopListening(this.active_subfeed.filtered_list),this.active_subfeed.topics_list_view.on_page=!1,this.active_subfeed.topics_list_view.$el.detach(),this.active_subfeed.topics_list_view.hasOwnProperty("no_bookmarks_checked")&&this.active_subfeed.topics_list_view.no_bookmarks_checked||(this.active_subfeed.topics_list_view.processUpdatedTopicVisibility(),
this.model.set("focus_topic",null)),this.subfeed_array[e].is_built||this.constructTopicsListView(e),this.active_subfeed=this.subfeed_array[e],e>0&&(this.active_subfeed.filtered_list.category.hasItems()?this.active_subfeed.topics_list_view.onAddToFeed():(this.active_subfeed.topics_list_view.on_page=!0,this.active_subfeed.topics_list_view.appendNoMoreTopicsMessage())),this.$el.append(this.active_subfeed.topics_list_view.$el),this.topics_list_view=this.active_subfeed.topics_list_view,e>0&&this.startListeningToActiveList()},startListeningToActiveList:function(){var e=this;this.listenTo(this.active_subfeed.filtered_list,"add",function(t){e.feed_view.active_subfeed!==e.parent_subfeed_object&&(t.get("is_read")||e.parent_subfeed_object.$button.addClass("feed-subfeed-new-topic"))}),this.listenTo(this.active_subfeed.filtered_list,"change:is_read",function(t){AoPS.Feed.Views.processFeedTopicIsReadChange({topic:t,list:e.active_subfeed.filtered_list,$button:e.parent_subfeed_object.$button})})},buildFeedCategory:function(e){var t,o,i,s=this.community_master.get("bookmarked_"+e+"_category");return i="topic"===e?"feed_topics":"view_"+e+"s",o={category_type:i,items:_.filter(s.get("items"),function(e){return e.hasOwnProperty("in_feed")&&1===e.in_feed})},"topic"===e&&(o.bookmark_topic_category_id=this.community_master.get("bookmarked_topic_category").get("category_id")),t=this.community_master.constructNewCategory(o),t.listenTo(s,"item_added",_.bind(function(e){e.in_feed&&this.addItem(e)},t)),t.listenTo(s,"item_removed",_.bind(function(e){e.in_feed&&this.removeItem(e)},t)),t}}),e.TopicFull=AoPS.Community.Views.TopicFull.extend({template_id:"#feed-topic-full-tpl",viewing_source:"feed",scrollbar_settings:{autosize:!1},initialize:function(e){this.feed=this.model.get("master").get("feed"),AoPS.Community.Views.TopicFull.prototype.initialize.apply(this,[e])},onClickClose:function(e){this.feed.set("focus_topic",null),this.fullscreen_triggered_by_reply=!1,this.model.get("master").set("fullscreen_mode","none"),this.is_full_reply=!1,$(window).trigger("resize"),e.stopPropagation(),e.preventDefault()},onAddToFeed:function(e){this.onAddToPage(e)},onDelete:function(){var e=arguments.length>1&&arguments[2].hasOwnProperty("deleted_by_me")&&arguments[2].deleted_by_me;this.model.get("deleted")&&this.feed.get("focus_topic")==this.model&&(e?AoPS.Ui.Modal.closeAllModals():AoPS.Ui.Modal.showAlert(t["feed-topic-full-message-deleted"]),this.close(),this.feed.set("focus_topic",null))},onClickFullReply:function(){"feed"===this.model.get("master").get("fullscreen_mode")?this.completeReplyClick("full"):this.onClickReply()},onClickFullScreen:function(){this.performFullScreenEvents(!1)},performFullScreenEvents:function(e){var t,o="none"===this.model.get("master").get("fullscreen_mode")?"feed":"none";this.model.get("master").set("fullscreen_mode",o),"none"===this.model.get("master").get("fullscreen_mode")?(this.is_full_reply=!1,AoPS.Community.Views.removeFullReplyStyle()):(this.is_full_reply=!0,AoPS.Community.Views.setFullReplyStyle()),this.model.get("master").get("feed").trigger(t),$(window).trigger("resize")},doExtraInitialization:function(){this.$el.find(".feed-topic-forum").css({"background-color":this.model.get("category_main_color"),color:this.model.get("category_secondary_color")}),this.$category_top=this.$el.find(".feed-topic-forum"),this.listenTo(this.feed,"change:focus_topic_show_from change:focus_topic",this.parseFeedFocusChange)},parseFeedFocusChange:function(){this.model===this.feed.get("focus_topic")&&(this.reveal_type=this.feed.get("focus_topic_show_from"),this.setInitialPostBoxLocation())},setArchiveStatus:function(){this.hasOwnProperty(this.$archive_status)||(this.$archive_status=$('<span class="cmty-topic-archive clickable"></span>'),this.$(".cmty-topic-bookmark").replaceWith(this.$archive_status)),this.$archive_status.append('<span class="aops-icon">(</span>'),this.$archive_status[0].title=t["private-archive-topic"]},completeParticipantStatusChange:function(){var e=this.model.get("master");this.feed.set("focus_topic",null),e.get("my_privates").trigger("check_for_more_topics")},onRemoveFromFeed:function(){this.onRemoveFromPage()},removeFocusListener:function(){this.stopListening(this.feed,"change:focus_topic")},setFocusListener:function(){this.listenTo(this.feed,"change:focus_topic",this.onChangeFocusTopic)},fetchFocusTopic:function(){return this.feed.get("focus_topic")}}),e.TopicCell=AoPS.Community.Views.TopicCell.extend({full_topics_popup:!0,in_feed:!0,events:{click:"onClickTopic","click .cmty-topic-cell-jump-to-bottom":"onClickJumpToBottom","click .cmty-topic-cell-close-topic":"onClickClose","click .cmty-topic-cell-goto-unread":"onClickGoToUnread","click .cmty-topic-cell-post a":"onClickLinkInCell"},onClickTopic:function(e){return e.ctrlKey||e.metaKey?("user_search_topics"===this.topic_list.collection.category.get("category_type")?this.onClickMyTopicsCell(e):this.openInNewTab(),void e.stopPropagation()):(this.master.get("feed").set({focus_topic_show_from:"show_from_start",focus_topic:this.model}),void e.stopPropagation())},onClickMyTopicsCell:function(e){var i,s=this;i=o.formatString(t["feed-my-topics-onclick"],[e.ctrlKey?t["control-click"]:t["command-click"]]),AoPS.Ui.Modal.showButtons(i,[{text:t["feed-my-topics-open-new"],value:1},{text:t["feed-my-topics-remove"],value:0}],function(e){1===e?s.openInNewTab():(s.model.setMyStatus({status:"removed"}),s.topic_list.collection.remove(s.model))},{width:"450px"}),e.stopPropagation()},openInNewTab:function(){var e="/c"+this.model.get("category_id")+"h"+this.model.get("topic_id");window.open("/community"+e,"_blank")},onClickLinkInCell:function(e){e.preventDefault()},onClickClose:function(e){return this.master.get("feed").set("focus_topic",null),e.stopPropagation(),!1},onClickJumpToBottom:function(e){this.master.get("feed").set({focus_topic_show_from:"show_from_end",focus_topic:this.model}),e.stopPropagation(),e.preventDefault()},onClickGoToUnread:function(e){this.master.get("feed").set({focus_topic_show_from:"show_unread",focus_topic:this.model}),e.stopPropagation(),e.preventDefault()},setFocusWatchBehavior:function(){this.listenTo(this.model,"change:is_feed_focus",this.checkFocusTopic),this.checkFocusTopic()},checkFocusTopic:function(){this.is_focus=this.model.get("is_feed_focus"),this.processFocusTopicStatusChange()}}),e.TopicCellPopout=e.TopicCell.extend({parent:e.TopicCell,buildTopic:AoPS.Community.Views.TopicCellPopout.prototype.buildTopic,createStuntDouble:function(){var e=this;AoPS.Community.Views.TopicCellPopout.prototype.createStuntDouble.apply(this),this.$stunt_double.find(".cmty-topic-cell-jump-to-bottom").on("click",function(t){e.onClickJumpToBottom(t)}),this.$stunt_double.find(".cmty-topic-cell-close-topic").on("click",function(t){e.onClickClose(t)}),this.$stunt_double.on("click",function(t){e.onClickTopic(t)})},constructWatchersLine:AoPS.Community.Views.TopicCellPopout.prototype.constructWatchersLine,onClose:function(){this.$stunt_double.remove()}}),e.TopicsList=AoPS.Community.Views.TopicsList.extend({fetch_topics_on_build:!1,list_location:"feed",topicView:e.TopicCell,popoutView:e.TopicCellPopout,onAddToFeed:function(){this.on_page=!0,this.checkQueuedUpTopicBoxes(),this.parseFocusTopic(),this.setFocusListener(),this.checkMoreTopicsNeeded(),this.checkIfEnoughCells()},setFocusListener:function(){this.listenTo(this.master.get("feed"),"change:focus_topic",this.parseFocusTopic)},processUpdatedTopicVisibility:AoPS.Community.Views.TopicsList.prototype.processUpdatedTopicVisibility,getFocusTopic:function(){return this.master.get("feed").get("focus_topic")}}),e.TopicsListBookmarks=e.TopicsList.extend({initialize:function(e){AoPS.Community.Views.TopicsList.prototype.initialize.apply(this,[e]),this.$nothing_bookmarked=$('<div class="cmty-no-more-topics">'+t["topics-list-nothing-bookmarked"]+"</div>")},onCollectionReset:function(){this.$nothing_bookmarked.detach(),AoPS.Community.Views.TopicsList.prototype.onCollectionReset.apply(this)},appendNoMoreTopicsMessage:function(){this.$loader.detach(),this.collection.length>0?(this.$nothing_bookmarked.detach(),this.$topics_box.append(this.$no_more_topics)):(this.$no_more_topics.detach(),this.$topics_box.append(this.$nothing_bookmarked))}}),e.NewTopic=AoPS.Community.Views.NewTopic.extend({onPostedNewTopic:function(e){e.topic.has("linked_tag_removed")&&e.topic.get("linked_tag_removed")?(this.model.get("master").get("feed").set("focus_topic",e.topic),AoPS.Feed.activateGlobalSubfeed()):(AoPS.Feed.openPageFeed({category_id:this.model.get("category_id"),tag_text:this.settings.hasOwnProperty("filter_tag")?this.settings.filter_tag:this.settings.target_url,subtitle:this.settings.hasOwnProperty("subtitle")?this.settings.subtitle:"",force_open:!0}),this.model.get("master").get("feed").set("focus_topic",e.topic)),"function"==typeof this.settings.onSuccess&&this.settings.onSuccess(e)}}),e.NewPrivateConversation=AoPS.Community.Views.NewPrivateConversation.extend({onPostedNewTopic:function(e){var o=this.model.get("master");return"private"===e.topic.get("topic_type")&&o.get("current_user").get("pm_archive_on_send")?void i.display(t["new-topic-pm-archived"]):void o.get("feed").set("focus_topic",e.topic)}}),e}(AoPS.Feed.Views||{});
//# sourceMappingURL=cmtymin_core.js.map